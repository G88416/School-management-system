

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        :root {
            /* Default Theme (Purple Gradient) */
            --primary-gradient-start: #667eea;
            --primary-gradient-end: #764ba2;
            --text-color: #fff;
            --card-bg: rgba(255, 255, 255, 0.25);
            --card-bg-hover: rgba(255, 255, 255, 0.35);
            --sidebar-bg: rgba(255, 255, 255, 0.15);
            --sidebar-border: rgba(255, 255, 255, 0.3);
            --table-bg: rgba(255, 255, 255, 0.1);
            --table-th-bg: rgba(255, 255, 255, 0.2);
            --btn-toggle-bg: rgba(255, 255, 255, 0.2);
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, var(--primary-gradient-start) 0%, var(--primary-gradient-end) 100%);
            color: var(--text-color);
            min-height: 100vh;
            transition: background 0.5s ease;
        }
        .sidebar {
            background: var(--sidebar-bg);
            backdrop-filter: blur(15px);
            border-right: 1px solid var(--sidebar-border);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease, background 0.5s ease;
            z-index: 1000;
            box-shadow: 0 0 40px rgba(0, 0, 0, 0.2);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
            box-shadow: 0 4px 15px rgba(255, 255, 255, 0.1);
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.35);
            font-weight: 600;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.2);
        }
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric {
            background: linear-gradient(135deg, var(--card-bg), var(--card-bg-hover));
            border: 1px solid var(--sidebar-border);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .card-metric:hover { 
            transform: translateY(-8px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.2);
            background: linear-gradient(135deg, var(--card-bg-hover), var(--card-bg));
        }
        .table {
            background: var(--table-bg);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
            transition: background 0.5s ease;
        }
        .table th { background: var(--table-th-bg); color: var(--text-color); transition: background 0.5s ease; }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            color: #333;
        }
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: var(--btn-toggle-bg);
            border: none;
            color: var(--text-color);
            transition: background 0.5s ease;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .login-title {
            font-weight: 700;
            color: #1e3c72;
            text-align: center;
        }
        .report-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        .lesson-plan { background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 10px; margin: 10px 0; }
        
        /* Theme Generator Styles */
        .theme-option {
            cursor: pointer;
            text-align: center;
            transition: transform 0.3s ease;
        }
        .theme-option:hover {
            transform: scale(1.05);
        }
        .theme-preview {
            width: 120px;
            height: 80px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
            border: 3px solid transparent;
            transition: all 0.3s ease;
            position: relative;
        }
        .theme-option.active .theme-preview {
            border-color: #fff;
            box-shadow: 0 6px 20px rgba(255, 255, 255, 0.4);
        }
        .theme-option.active .theme-check {
            display: block !important;
            color: #fff;
            font-size: 2rem;
            animation: checkPop 0.3s ease;
        }
        .theme-name {
            font-weight: 500;
            font-size: 0.9rem;
            color: var(--text-color);
        }
        @keyframes checkPop {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        
        /* Enhanced Teachers Module Styles */
        #teachers .nav-tabs {
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 10px;
        }
        #teachers .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0 5px;
            transition: all 0.3s;
        }
        #teachers .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            color: #fff;
        }
        #teachers .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.2));
            color: #fff;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        #teachers .tab-content {
            background: rgba(255, 255, 255, 0.05);
            padding: 25px;
            border-radius: 15px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
        }
        
        /* Enhanced Wellness Section Styles */
        #employee-wellness .card-metric {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.3), rgba(168, 85, 247, 0.3));
            border: 1px solid rgba(255, 255, 255, 0.4);
            transition: all 0.3s;
        }
        #employee-wellness .card-metric:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
        }
        #employee-wellness .card-metric i {
            color: rgba(255, 255, 255, 0.9);
        }
        #wellness-activities, #wellness-tips, #wellness-tracking, #wellness-support {
            background: rgba(255, 255, 255, 0.08);
            padding: 20px;
            border-radius: 12px;
            min-height: 300px;
        }
        .wellness-activity-item {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid rgba(99, 102, 241, 0.8);
            transition: all 0.3s;
        }
        .wellness-activity-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        /* Responsive Wellness Section */
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
            
            #employee-wellness .row {
                flex-direction: column;
            }
            #employee-wellness .card-metric {
                margin-bottom: 15px;
            }
            #teachers .nav-tabs {
                flex-wrap: wrap;
            }
            #teachers .nav-tabs .nav-link {
                font-size: 0.85rem;
                padding: 8px 10px;
            }
        }
        @media (max-width: 576px) {
            #teachers .tab-content {
                padding: 15px;
            }
            .card-metric h5 {
                font-size: 0.9rem;
            }
            .card-metric h3 {
                font-size: 1.3rem;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Online/Offline Status Indicator -->
        <div id="onlineStatus" style="position: fixed; top: 20px; right: 80px; z-index: 1100;">
            <span id="statusIndicator" class="badge bg-success shadow">
                <i class="fas fa-wifi me-1"></i>Online
            </span>
        </div>
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="admin-only non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="admin-only non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Finance Management</span></a></li>
                <li class="teacher-only non-student"><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li class="teacher-only non-student"><a href="#teachers" class="nav-link" onclick="showSection('teachers')"><i class="fas fa-chalkboard-teacher me-2"></i><span class="nav-text">Advanced Teachers</span></a></li>
                <li class="teacher-only non-student"><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li class="admin-only non-student"><a href="#eventsManagement" class="nav-link" onclick="showSection('eventsManagement')"><i class="fas fa-calendar-check me-2"></i><span class="nav-text">Events Management</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#studentTimetable" class="nav-link" onclick="showSection('studentTimetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Time Table</span></a></li>
                <li class="student-only"><a href="#studentExamination" class="nav-link" onclick="showSection('studentExamination')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Assessment</span></a></li>
                <li class="student-only"><a href="#studentInbox" class="nav-link" onclick="showSection('studentInbox')"><i class="fas fa-inbox me-2"></i><span class="nav-text">Inbox</span></a></li>
                <li class="student-only"><a href="#studentUploadWork" class="nav-link" onclick="showSection('studentUploadWork')"><i class="fas fa-upload me-2"></i><span class="nav-text">Upload Work</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li class="parent-only"><a href="#parentPortal" class="nav-link" onclick="showSection('parentPortal')"><i class="fas fa-home me-2"></i><span class="nav-text">Parent Portal</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>
            <!-- Admission Management -->
            <section id="admission" class="section d-none admin-only">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel/PDF/Word)</button>
                <button class="btn btn-danger mb-3" onclick="resetAdmissions()">Reset Admission (Save to Vault)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <style>
                    #admission table.sasams-format {
                        width: 100%;
                        border-collapse: collapse;
                        font-family: Arial, sans-serif;
                        font-size: 12px;
                        background: rgba(255, 255, 255, 0.95);
                        color: #333;
                    }
                    #admission table.sasams-format th,
                    #admission table.sasams-format td {
                        border: 1px solid #ddd;
                        padding: 8px;
                        text-align: left;
                    }
                    #admission table.sasams-format th {
                        background-color: #f2f2f2;
                        font-weight: bold;
                        color: #333;
                    }
                    #admission table.sasams-format tr:nth-child(even) {
                        background-color: #f9f9f9;
                    }
                    #admission table.sasams-format caption {
                        font-weight: bold;
                        margin-bottom: 10px;
                        font-size: 14px;
                        color: #333;
                        background: rgba(255, 255, 255, 0.95);
                        padding: 10px;
                        border-radius: 5px;
                    }
                </style>
                <table class="sasams-format">
                    <caption id="sasamsCaption">SA-SAMS v25.3.0 - Learner and Parent Info (3.1.13) - <span id="admissionReportDate"></span></caption>
                    <thead>
                        <tr>
                            <th colspan="9">LEARNER DETAILS</th>
                            <th colspan="4">FATHER DETAILS</th>
                            <th colspan="4">MOTHER DETAILS</th>
                        </tr>
                        <tr>
                            <th>Number</th>
                            <th>Surname</th>
                            <th>First Name</th>
                            <th>Gender</th>
                            <th>Grade</th>
                            <th>Class</th>
                            <th>Cell#</th>
                            <th>Email</th>
                            <th>Language</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Email</th>
                            <th>Cell#</th>
                            <th>Name</th>
                            <th>Surname</th>
                            <th>Email</th>
                            <th>Cell#</th>
                        </tr>
                    </thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>
            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <button class="btn btn-info mb-3" onclick="showBulkStudentModal()">Bulk Import Students (CSV/Excel/PDF/Word)</button>
                <button class="btn btn-danger mb-3" onclick="resetAllStudents()">Reset All Students</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student Number</th><th>Surname</th><th>First Name</th><th>Gender</th><th>Grade</th><th>Class</th><th>Cell</th><th>Email</th><th>Language</th><th>Father Name</th><th>Father Surname</th><th>Father Email</th><th>Father Cell</th><th>Mother Name</th><th>Mother Surname</th><th>Mother Email</th><th>Mother Cell</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>
            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="showBulkAttendanceModal()">Bulk Mark Attendance</button>
                <button class="btn btn-secondary mb-3" onclick="showImportAttendanceModal()">Import Attendance (CSV/Excel)</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <button class="btn btn-danger mb-3" onclick="resetAttendance()">Reset Attendance (Save to Vault)</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Finance Management -->
            <section id="fees" class="section d-none admin-only">
                <h2>Finance Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/PDF/Word)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <button class="btn btn-danger mb-3" onclick="resetFees()">Reset Fees (Save to Vault)</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>
            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="timetableTeacher" class="form-control" onchange="highlightTeacherSchedule()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showAddTimeSlotModal()">Add Time Slot</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" onclick="checkTimetableConflicts()">Check Conflicts</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>
            <!-- Advanced Teachers Module -->
            <section id="teachers" class="section d-none teacher-only">
                <h2>Advanced Teachers Module</h2>
                <ul class="nav nav-tabs mb-3" id="teachersTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#lesson-plans" onclick="renderLessonPlans()">Lesson Plans</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#grading" onclick="renderGrading()">Grading</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#resources" onclick="renderResources()">Resources</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#student-progress" onclick="renderStudentProgress()">Student Progress</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#upload-work" onclick="renderUploadWork()">Upload Work</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#calendar" onclick="renderCalendar()">Calendar</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-services" onclick="renderHRServices()">HR Services</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#employee-wellness" onclick="renderEmployeeWellness()">Employee Wellness</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#teacher-chat" onclick="renderTeacherChat()">Chat</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#teacher-incidents" onclick="loadTeacherIncidents()">Incident Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#work-vault" onclick="renderWorkVault()">Work Vault</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="lesson-plans">
                        <button class="btn btn-primary mb-3" onclick="showAddLessonPlanModal()">Add Lesson Plan</button>
                        <div id="lessonPlansList"></div>
                    </div>
                    <div class="tab-pane fade" id="grading">
                        <button class="btn btn-primary mb-3" onclick="showAddGradeModal()">Add Grade</button>
                        <select id="gradingClass" class="form-control mb-3" onchange="loadGrading()">
                            <option value="">Select Class</option>
                        </select>
                        <table class="table table-striped">
                            <thead><tr><th>Student</th><th>Subject</th><th>Grade</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="gradingTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="resources">
                        <button class="btn btn-primary mb-3" onclick="showAddResourceModal()">Add Resource</button>
                        <div id="resourcesList"></div>
                    </div>
                    <div class="tab-pane fade" id="student-progress">
                        <select id="progressStudent" class="form-control mb-3" onchange="loadStudentProgress()">
                            <option value="">Select Student</option>
                        </select>
                        <canvas id="progressChart" class="mt-4"></canvas>
                        <div id="progressDetails"></div>
                    </div>
                    <div class="tab-pane fade" id="upload-work">
                        <h4>Upload Work Files</h4>
                        <p>Upload student assignments, work, and documents in CSV, PDF, Word, or Excel formats.</p>
                        <div class="mb-3">
                            <label class="form-label">Select File(s)</label>
                            <input type="file" id="workFileUpload" class="form-control" multiple accept=".csv,.pdf,.doc,.docx,.xls,.xlsx">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Assignment/Work Title</label>
                            <input type="text" id="workTitle" class="form-control" placeholder="Enter title">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Class/Grade</label>
                            <select id="workClass" class="form-control">
                                <option value="">Select Class</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea id="workDescription" class="form-control" rows="3" placeholder="Enter description"></textarea>
                        </div>
                        <button class="btn btn-primary mb-3" onclick="uploadWorkFile()">
                            <i class="fas fa-upload me-2"></i>Upload Work
                        </button>
                        <hr>
                        <h5>Uploaded Work Files</h5>
                        <div id="uploadedWorkList"></div>
                    </div>
                    <div class="tab-pane fade" id="calendar">
                        <h4>Teacher's Calendar</h4>
                        <div class="row mb-3">
                            <div class="col-md-8">
                                <button class="btn btn-primary mb-3" onclick="showAddCalendarEventModal()">
                                    <i class="fas fa-plus me-2"></i>Add Event
                                </button>
                                <button class="btn btn-secondary mb-3 ms-2" onclick="renderCalendar()">
                                    <i class="fas fa-sync me-2"></i>Refresh
                                </button>
                            </div>
                            <div class="col-md-4">
                                <input type="month" id="calendarMonth" class="form-control" onchange="renderCalendar()">
                            </div>
                        </div>
                        <div id="calendarView"></div>
                        <hr>
                        <h5>Upcoming Events</h5>
                        <div id="upcomingEventsList"></div>
                    </div>
                    <div class="tab-pane fade" id="hr-services">
                        <h4>HR Services - Apply for Leave</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card card-metric p-3">
                                    <h5>Leave Balance</h5>
                                    <div class="row">
                                        <div class="col-6">
                                            <small>Annual Leave</small>
                                            <h4 id="annualLeaveBalance">15</h4>
                                        </div>
                                        <div class="col-6">
                                            <small>Sick Leave</small>
                                            <h4 id="sickLeaveBalance">10</h4>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showApplyLeaveModal()">
                                    <i class="fas fa-plus me-2"></i>Apply for Leave
                                </button>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <h5>Leave Calendar</h5>
                                <div class="mb-3">
                                    <input type="month" id="leaveCalendarMonth" class="form-control" onchange="renderLeaveCalendar()">
                                </div>
                                <div id="leaveCalendarView"></div>
                            </div>
                        </div>
                        <hr>
                        <h5>My Leave Requests</h5>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Leave Type</th>
                                    <th>Start Date</th>
                                    <th>End Date</th>
                                    <th>Days</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="myLeaveRequestsTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="employee-wellness">
                        <h4>Advanced Employee Wellness Program</h4>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-heartbeat fa-2x mb-2"></i>
                                    <h5>Wellness Score</h5>
                                    <h3 id="wellnessScore">85%</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-running fa-2x mb-2"></i>
                                    <h5>Activities</h5>
                                    <h3 id="activitiesCount">12</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-apple-alt fa-2x mb-2"></i>
                                    <h5>Health Tips</h5>
                                    <h3 id="healthTipsCount">8</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-calendar-check fa-2x mb-2"></i>
                                    <h5>Check-ins</h5>
                                    <h3 id="checkInsCount">5</h3>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="card card-metric p-3">
                                    <h5>Wellness Resources</h5>
                                    <ul class="nav nav-pills mb-3" id="wellnessTabs">
                                        <li class="nav-item">
                                            <a class="nav-link active" data-bs-toggle="pill" href="#wellness-activities">Activities</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="pill" href="#wellness-tips">Health Tips</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="pill" href="#wellness-tracking">Tracking</a>
                                        </li>
                                        <li class="nav-item">
                                            <a class="nav-link" data-bs-toggle="pill" href="#wellness-support">Support</a>
                                        </li>
                                    </ul>
                                    <div class="tab-content">
                                        <div class="tab-pane fade show active" id="wellness-activities">
                                            <h6>Available Wellness Activities</h6>
                                            <button class="btn btn-primary btn-sm mb-3" onclick="showAddWellnessActivityModal()">
                                                <i class="fas fa-plus me-2"></i>Log Activity
                                            </button>
                                            <div id="wellnessActivitiesList"></div>
                                        </div>
                                        <div class="tab-pane fade" id="wellness-tips">
                                            <h6>Daily Health Tips</h6>
                                            <div id="healthTipsList"></div>
                                        </div>
                                        <div class="tab-pane fade" id="wellness-tracking">
                                            <h6>Wellness Tracking</h6>
                                            <div class="mb-3">
                                                <label class="form-label">Weight (kg)</label>
                                                <input type="number" id="weightInput" class="form-control mb-2" placeholder="Enter weight">
                                                <label class="form-label">Mood (1-10)</label>
                                                <input type="range" id="moodInput" class="form-range" min="1" max="10" value="7">
                                                <span id="moodValue">7</span>
                                                <button class="btn btn-primary mt-2" onclick="saveWellnessTracking()">
                                                    <i class="fas fa-save me-2"></i>Save
                                                </button>
                                            </div>
                                            <canvas id="wellnessTrackingChart" class="mt-4"></canvas>
                                        </div>
                                        <div class="tab-pane fade" id="wellness-support">
                                            <h6>Wellness Support</h6>
                                            <p>Contact our wellness team for support and guidance.</p>
                                            <button class="btn btn-primary" onclick="showWellnessSupportModal()">
                                                <i class="fas fa-phone me-2"></i>Contact Support
                                            </button>
                                            <div class="mt-3">
                                                <h6>Resources</h6>
                                                <ul>
                                                    <li><a href="#" class="text-white">Mental Health Resources</a></li>
                                                    <li><a href="#" class="text-white">Physical Fitness Programs</a></li>
                                                    <li><a href="#" class="text-white">Nutrition Guidelines</a></li>
                                                    <li><a href="#" class="text-white">Stress Management</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="teacher-chat">
                        <h4>Teacher Chat</h4>
                        <p class="text-muted">Send messages to students and reply to admin communications.</p>
                        
                        <ul class="nav nav-pills mb-3">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="pill" href="#chat-students">Message Students</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#chat-admin">Admin Messages</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#chat-history">Chat History</a>
                            </li>
                        </ul>
                        
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="chat-students">
                                <div class="row">
                                    <div class="col-md-4">
                                        <div class="card" style="background: rgba(255, 255, 255, 0.1); max-height: 500px; overflow-y: auto;">
                                            <div class="card-header">
                                                <h6><i class="fas fa-users me-2"></i>Students</h6>
                                                <input type="text" class="form-control form-control-sm mt-2" id="studentSearchChat" placeholder="Search students..." oninput="filterChatStudents()">
                                            </div>
                                            <div class="list-group list-group-flush" id="chatStudentsList"></div>
                                        </div>
                                    </div>
                                    <div class="col-md-8">
                                        <div class="card" style="background: rgba(255, 255, 255, 0.1);">
                                            <div class="card-header">
                                                <h6 id="chatStudentName">Select a student to start chatting</h6>
                                            </div>
                                            <div class="card-body" style="height: 350px; overflow-y: auto;" id="chatMessagesContainer">
                                                <p class="text-muted text-center">No messages yet. Select a student to begin.</p>
                                            </div>
                                            <div class="card-footer">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="chatMessageInput" placeholder="Type your message..." disabled>
                                                    <button class="btn btn-primary" onclick="sendChatMessage()" id="sendChatBtn" disabled>
                                                        <i class="fas fa-paper-plane"></i> Send
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="chat-admin">
                                <div class="card" style="background: rgba(255, 255, 255, 0.1);">
                                    <div class="card-header">
                                        <h6><i class="fas fa-user-shield me-2"></i>Admin Conversations</h6>
                                    </div>
                                    <div class="card-body" style="max-height: 400px; overflow-y: auto;" id="adminMessagesContainer">
                                        <!-- Admin messages will be loaded here -->
                                    </div>
                                    <div class="card-footer">
                                        <div class="mb-2">
                                            <input type="text" class="form-control mb-2" id="adminMessageSubject" placeholder="Subject">
                                            <textarea class="form-control mb-2" id="adminMessageText" rows="3" placeholder="Type your message to admin..."></textarea>
                                            <button class="btn btn-primary" onclick="sendAdminMessage()">
                                                <i class="fas fa-paper-plane me-2"></i>Send to Admin
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="chat-history">
                                <div class="card" style="background: rgba(255, 255, 255, 0.1);">
                                    <div class="card-header">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6><i class="fas fa-history me-2"></i>Chat History</h6>
                                            <button class="btn btn-sm btn-outline-light" onclick="clearChatHistory()">
                                                <i class="fas fa-trash me-1"></i>Clear History
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body" style="max-height: 500px; overflow-y: auto;" id="chatHistoryContainer">
                                        <!-- Chat history will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="teacher-incidents">
                        <h4>Incident Reports (Read-Only)</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>View incident reports for your students. These reports are managed by the administration.
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-control" id="teacherIncidentTypeFilter" onchange="loadTeacherIncidents()">
                                    <option value="">All Types</option>
                                    <option value="behavioral">Behavioral</option>
                                    <option value="academic">Academic</option>
                                    <option value="medical">Medical</option>
                                    <option value="disciplinary">Disciplinary</option>
                                    <option value="positive">Positive Recognition</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-control" id="teacherIncidentStudentFilter" onchange="loadTeacherIncidents()">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="teacherIncidentDateFilter" onchange="loadTeacherIncidents()">
                            </div>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Student</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Description</th>
                                    <th>Action Taken</th>
                                    <th>Reported By</th>
                                </tr>
                            </thead>
                            <tbody id="teacherIncidentsTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="work-vault">
                        <h4><i class="fas fa-vault me-2"></i>Work Vault - Student Submissions</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>View all student work submissions in one place. Filter by student, class, or date.
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <select class="form-control" id="workVaultStudentFilter" onchange="renderWorkVault()">
                                    <option value="">All Students</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <select class="form-control" id="workVaultClassFilter" onchange="renderWorkVault()">
                                    <option value="">All Classes</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <input type="date" class="form-control" id="workVaultDateFilter" onchange="renderWorkVault()">
                            </div>
                            <div class="col-md-3">
                                <input type="text" class="form-control" placeholder="Search..." id="workVaultSearch" oninput="debounce(renderWorkVault, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-file-alt fa-2x mb-2"></i>
                                    <h5>Total Submissions</h5>
                                    <h3 id="totalSubmissions">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-clock fa-2x mb-2"></i>
                                    <h5>Today's Submissions</h5>
                                    <h3 id="todaySubmissions">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <h5>Unique Students</h5>
                                    <h3 id="uniqueStudents">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-calendar-week fa-2x mb-2"></i>
                                    <h5>This Week</h5>
                                    <h3 id="weekSubmissions">0</h3>
                                </div>
                            </div>
                        </div>
                        <div id="workVaultList"></div>
                    </div>
                </div>
            </section>
            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="showEnterMarksModal()">Enter Marks</button>
                <button class="btn btn-success mb-3" onclick="generateAllReportCards()">Generate All Report Cards</button>
                <button class="btn btn-warning mb-3" onclick="generateHallTickets()">Generate Hall Tickets</button>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="examGradeFilter" class="form-control" onchange="renderExams()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="examSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderExams, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Grade</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
                <div id="marksEntry" class="mt-4 d-none">
                    <h3>Enter Marks for <span id="marksExamName"></span></h3>
                    <table class="table table-striped">
                        <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                        <tbody id="marksTable"></tbody>
                    </table>
                    <button class="btn btn-primary" onclick="saveMarks()">Save</button>
                </div>
            </section>
            <!-- Enhanced HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <ul class="nav nav-tabs mb-3" id="hrTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hr-staff" onclick="renderStaff()">Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-payroll" onclick="renderPayrolls()">Payroll</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-leaves" onclick="renderLeaves()">Leaves</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-performance" onclick="renderReviews()">Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-recruitment" onclick="renderJobs()">Recruitment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-audit" onclick="renderAudit()">Audit Trail</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-teachers" onclick="renderTeachersReadOnly()">Teachers Info (Read-Only)</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-employee-wellness" onclick="renderEmployeeWellnessAdmin()">Advanced Employee Wellness</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="hr-staff">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddStaffModal()">Add Staff</button>
                                <button class="btn btn-success ms-2" onclick="showBulkStaffModal()">Bulk Import Staff</button>
                                <button class="btn btn-secondary ms-2" onclick="syncStaffBiometric()">Sync Biometric</button>
                                <button class="btn btn-info ms-2" onclick="generateStaffReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search staff..." id="staffSearch" oninput="debounce(renderStaff, 300)()">
                                    <select id="staffFilterRole" class="form-select" style="max-width: 150px;" onchange="renderStaff()">
                                        <option value="">All Roles</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Active</h5><h3 id="activeStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Salary</h5><h3 id="avgSalary">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Cert Expiry</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-payroll">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddPayrollModal()">Add Payroll</button>
                                <button class="btn btn-info ms-2" onclick="generatePayroll()">Generate Payroll</button>
                                <button class="btn btn-success ms-2" onclick="exportPayrollToExcel()">Export Payroll</button>
                                <button class="btn btn-warning ms-2" onclick="calculateCompliance()">Check Compliance</button>
                            </div>
                            <div class="col-md-6">
                                <input type="month" id="payrollMonthFilter" class="form-control" onchange="renderPayrolls()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Payroll</h5><h3 id="totalPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Deductions</h5><h3 id="totalDeductions">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Net Payroll</h5><h3 id="netPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Score</h5><h3 id="complianceScore">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Month</th><th>Salary</th><th>Deductions</th><th>Tax</th><th>UIF</th><th>Net</th><th>Actions</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-leaves">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddLeaveModal()">Add Leave Request</button>
                                <button class="btn btn-info ms-2" onclick="generateLeaveReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="leaveDateFilter" class="form-control" onchange="renderLeaves()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Requests</h5><h3 id="totalLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending</h5><h3 id="pendingLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Approved</h5><h3 id="approvedLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Rejected</h5><h3 id="rejectedLeaves">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Type</th><th>Date</th><th>Days</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="leavesTable"></tbody>
                        </table>
                        <canvas id="leaveChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-performance">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddReviewModal()">Add Review</button>
                                <button class="btn btn-info ms-2" onclick="generatePerformanceReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="reviewDateFilter" class="form-control" onchange="renderReviews()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Score</h5><h3 id="avgScore">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Reviews</h5><h3 id="totalReviews">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Goals Achieved</h5><h3 id="goalsAchieved">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Feedback</h5><h3 id="pendingFeedback">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="reviewsTable"></tbody>
                        </table>
                        <canvas id="performanceChart" class="mt-4 hr-chart"></canvas>
                    </div>
                    <div class="tab-pane fade" id="hr-recruitment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddJobModal()">Add Job</button>
                                <button class="btn btn-success ms-2" onclick="showApplyJobModal()">Apply</button>
                                <button class="btn btn-info ms-2" onclick="generateRecruitmentReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" placeholder="Search jobs..." id="jobSearch" oninput="debounce(renderJobs, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Applications</h5><h3 id="totalApplications">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Interviews Scheduled</h5><h3 id="interviewsScheduled">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Hire Rate</h5><h3 id="hireRate">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Title</th><th>Department</th><th>Applications</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-audit">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-info" onclick="generateAuditReport()">Generate Report</button>
                                <button class="btn btn-success ms-2" onclick="exportAuditToExcel()">Export</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="date" id="auditDateFilter" class="form-control" onchange="renderAudit()">
                                    <select id="auditActionFilter" class="form-select" style="max-width: 150px;" onchange="renderAudit()">
                                        <option value="">All Actions</option>
                                        <option value="Update">Update</option>
                                        <option value="Delete">Delete</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Entries</h5><h3 id="totalAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's</h5><h3 id="todayAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>High Risk</h5><h3 id="highRiskAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Issues</h5><h3 id="complianceIssues">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th><th>Risk</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-teachers">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>This is a read-only view of the Teachers Module information.
                        </div>
                        <ul class="nav nav-tabs mb-3" id="teachersReadOnlyTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="tab" href="#ro-lesson-plans" onclick="renderLessonPlansReadOnly()">Lesson Plans</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#ro-grading" onclick="renderGradingReadOnly()">Grading</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#ro-resources" onclick="renderResourcesReadOnly()">Resources</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#ro-upload-work" onclick="renderUploadWorkReadOnly()">Uploaded Work</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="tab" href="#ro-calendar" onclick="renderCalendarReadOnly()">Calendar</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="ro-lesson-plans">
                                <div id="roLessonPlansList"></div>
                            </div>
                            <div class="tab-pane fade" id="ro-grading">
                                <select id="roGradingClass" class="form-control mb-3" onchange="loadGradingReadOnly()">
                                    <option value="">Select Class</option>
                                </select>
                                <table class="table table-striped">
                                    <thead><tr><th>Student</th><th>Subject</th><th>Grade</th><th>Comments</th></tr></thead>
                                    <tbody id="roGradingTable"></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="ro-resources">
                                <div id="roResourcesList"></div>
                            </div>
                            <div class="tab-pane fade" id="ro-upload-work">
                                <div id="roUploadedWorkList"></div>
                            </div>
                            <div class="tab-pane fade" id="ro-calendar">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <input type="month" id="roCalendarMonth" class="form-control" onchange="renderCalendarReadOnly()">
                                    </div>
                                </div>
                                <div id="roCalendarView"></div>
                                <hr>
                                <h5>Upcoming Events</h5>
                                <div id="roUpcomingEventsList"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="hr-employee-wellness">
                        <h4>Advanced Employee Wellness Management</h4>
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddWellnessProgramModal()">
                                    <i class="fas fa-plus me-2"></i>Add Wellness Program
                                </button>
                                <button class="btn btn-success ms-2" onclick="exportWellnessReport()">
                                    <i class="fas fa-file-export me-2"></i>Export Report
                                </button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" class="form-control" placeholder="Search wellness programs..." id="wellnessSearch" oninput="debounce(renderWellnessPrograms, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-users fa-2x mb-2"></i>
                                    <h5>Participants</h5>
                                    <h3 id="totalWellnessParticipants">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-project-diagram fa-2x mb-2"></i>
                                    <h5>Programs</h5>
                                    <h3 id="totalWellnessPrograms">0</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-chart-line fa-2x mb-2"></i>
                                    <h5>Avg Engagement</h5>
                                    <h3 id="avgWellnessEngagement">0%</h3>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="card card-metric p-3 text-center">
                                    <i class="fas fa-smile fa-2x mb-2"></i>
                                    <h5>Satisfaction</h5>
                                    <h3 id="wellnessSatisfaction">0%</h3>
                                </div>
                            </div>
                        </div>
                        <ul class="nav nav-pills mb-3" id="wellnessAdminTabs">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="pill" href="#wellness-programs" onclick="renderWellnessPrograms()">Programs</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#wellness-participants" onclick="renderWellnessParticipants()">Participants</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#wellness-analytics" onclick="renderWellnessAnalytics()">Analytics</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#wellness-resources-admin" onclick="renderWellnessResourcesAdmin()">Resources</a>
                            </li>
                        </ul>
                        <div class="tab-content">
                            <div class="tab-pane fade show active" id="wellness-programs">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Program Name</th>
                                            <th>Category</th>
                                            <th>Participants</th>
                                            <th>Start Date</th>
                                            <th>Status</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wellnessProgramsTable"></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="wellness-participants">
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Name</th>
                                            <th>Department</th>
                                            <th>Wellness Score</th>
                                            <th>Activities</th>
                                            <th>Last Check-in</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wellnessParticipantsTable"></tbody>
                                </table>
                            </div>
                            <div class="tab-pane fade" id="wellness-analytics">
                                <div class="row mb-3">
                                    <div class="col-md-12">
                                        <h5>Wellness Trends</h5>
                                        <canvas id="wellnessTrendsChart" class="hr-chart"></canvas>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <h5>Program Participation</h5>
                                        <canvas id="wellnessParticipationChart" class="hr-chart"></canvas>
                                    </div>
                                    <div class="col-md-6">
                                        <h5>Health Score Distribution</h5>
                                        <canvas id="wellnessScoreChart" class="hr-chart"></canvas>
                                    </div>
                                </div>
                            </div>
                            <div class="tab-pane fade" id="wellness-resources-admin">
                                <button class="btn btn-primary mb-3" onclick="showAddWellnessResourceModal()">
                                    <i class="fas fa-plus me-2"></i>Add Resource
                                </button>
                                <table class="table table-striped">
                                    <thead>
                                        <tr>
                                            <th>Title</th>
                                            <th>Type</th>
                                            <th>Category</th>
                                            <th>Views</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="wellnessResourcesTable"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Communication -->
            <section id="communication" class="section d-none non-student">
                <h2>Communication</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showSendMessageModal()"><i class="fas fa-envelope me-2"></i>Send Message</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success" onclick="showAnnouncementsModal()"><i class="fas fa-bullhorn me-2"></i>View Announcements</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-info" onclick="startLiveChat()"><i class="fas fa-comments me-2"></i>Live Chat</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-danger" onclick="clearAllCommunications()"><i class="fas fa-trash me-2"></i>Clear All</button>
                    </div>
                </div>
                <div id="messagesContainer"></div>
                
                <!-- Live Chat Section -->
                <div id="liveChatContainer" class="d-none mt-4">
                    <div class="card" style="background: rgba(255, 255, 255, 0.1); border-radius: 15px;">
                        <div class="card-header" style="background: rgba(255, 255, 255, 0.2);">
                            <div class="d-flex justify-content-between align-items-center">
                                <h4><i class="fas fa-comments me-2"></i>Live Chat - All Students & Teachers</h4>
                                <button class="btn btn-sm btn-danger" onclick="closeLiveChat()">
                                    <i class="fas fa-times"></i> Close
                                </button>
                            </div>
                            <small class="text-muted">Real-time communication for students and teachers</small>
                        </div>
                        <div class="card-body" style="height: 400px; overflow-y: auto; background: rgba(0, 0, 0, 0.2);" id="liveChatMessages">
                            <!-- Chat messages will appear here -->
                        </div>
                        <div class="card-footer" style="background: rgba(255, 255, 255, 0.1);">
                            <div class="input-group">
                                <input type="text" id="liveChatInput" class="form-control" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendLiveChatMessage()">
                                <button class="btn btn-primary" onclick="sendLiveChatMessage()">
                                    <i class="fas fa-paper-plane me-2"></i>Send
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Events Management -->
            <section id="eventsManagement" class="section d-none admin-only">
                <h2>Events Management</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>Manage school events and automatically send notifications to parents and teachers.
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Total Events</h5>
                            <h3 id="totalEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Upcoming Events</h5>
                            <h3 id="upcomingEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Past Events</h5>
                            <h3 id="pastEvents">0</h3>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card card-metric p-3">
                            <h5>Notifications Sent</h5>
                            <h3 id="eventNotificationsSent">0</h3>
                        </div>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <button class="btn btn-primary" onclick="showAddEventModal()"><i class="fas fa-plus me-2"></i>Add Event</button>
                        <button class="btn btn-success ms-2" onclick="showAddExcursionModal()"><i class="fas fa-bus me-2"></i>Add Excursion</button>
                        <button class="btn btn-warning ms-2" onclick="showAddFundraisingModal()"><i class="fas fa-hand-holding-usd me-2"></i>Add Fundraising</button>
                        <button class="btn btn-info ms-2" onclick="showUpcomingEventsCalendar()"><i class="fas fa-calendar me-2"></i>View Calendar</button>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select class="form-control" id="eventTypeFilter" onchange="filterEvents()">
                            <option value="">All Event Types</option>
                            <option value="excursion">Excursion</option>
                            <option value="fundraising">Fundraising</option>
                            <option value="sports">Sports Day</option>
                            <option value="cultural">Cultural Event</option>
                            <option value="academic">Academic Event</option>
                            <option value="meeting">Parent-Teacher Meeting</option>
                            <option value="ceremony">Ceremony</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="date" class="form-control" id="eventDateFilter" onchange="filterEvents()">
                    </div>
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Search events..." id="eventSearch" oninput="filterEvents()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Event Name</th>
                            <th>Type</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Location</th>
                            <th>Participants</th>
                            <th>Status</th>
                            <th>Notifications</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventsTable"></tbody>
                </table>
            </section>
            <!-- Content Management -->
            <section id="content" class="section d-none admin-only">
                <h2>Content Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddContentModal()">Add Content</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search content..." id="contentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchContent()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Title</th><th>Type</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports</h2>
                <div class="row mb-3">
                    <div class="col-md-12">
                        <button class="btn btn-primary" onclick="showAddIncidentModal()">
                            <i class="fas fa-plus me-2"></i>Add Incident Report
                        </button>
                        <button class="btn btn-info ms-2" onclick="viewAllIncidents()">
                            <i class="fas fa-list me-2"></i>View All Incidents
                        </button>
                    </div>
                </div>
                <select id="reportType" class="form-select mb-3" style="width: auto;">
                    <option value="attendance">Attendance Report</option>
                    <option value="fees">Fee Report</option>
                    <option value="exams">Exam Report</option>
                    <option value="hr">HR Report</option>
                    <option value="incidents">Incident Reports</option>
                    <option value="events">Events Report</option>
                </select>
                <button class="btn btn-primary mb-3" onclick="generateReport()">Generate</button>
                <button class="btn btn-success mb-3" onclick="exportReport()">Export</button>
                <div id="reportOutput" class="d-none"></div>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>Settings</h2>
                <div class="row">
                    <div class="col-md-6">
                        <h5>SMS Integration (WinSMS)</h5>
                        <div class="mb-3">
                            <label>Username</label>
                            <input type="text" id="smsUsername" class="form-control" placeholder="WinSMS Username">
                        </div>
                        <div class="mb-3">
                            <label>Password</label>
                            <input type="password" id="smsPassword" class="form-control" placeholder="WinSMS Password">
                        </div>
                        <button class="btn btn-primary" onclick="saveSMSSettings()">Save SMS Settings</button>
                    </div>
                    <div class="col-md-6">
                        <h5>HR Settings</h5>
                        <div class="mb-3">
                            <label>Annual Leave Days</label>
                            <input type="number" id="annualLeaveDays" class="form-control" value="21">
                        </div>
                        <div class="mb-3">
                            <label>UIF Rate (%)</label>
                            <input type="number" id="uifRate" class="form-control" value="1" step="0.1">
                        </div>
                        <button class="btn btn-primary" onclick="updateHRSettings()">Update HR Settings</button>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-6">
                        <h5>AI Integration (ChatGPT-4 API)</h5>
                        <div class="mb-3">
                            <label>API Key</label>
                            <input type="password" id="chatGPTApiKey" class="form-control" placeholder="Enter ChatGPT-4 API Key">
                        </div>
                        <div class="mb-3">
                            <label>Model</label>
                            <select id="chatGPTModel" class="form-control">
                                <option value="gpt-4">GPT-4</option>
                                <option value="gpt-4-turbo">GPT-4 Turbo</option>
                                <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveChatGPTSettings()">Save ChatGPT Settings</button>
                        <button class="btn btn-secondary ms-2" onclick="configureChatGPTAPI()">Configure</button>
                    </div>
                    <div class="col-md-6">
                        <h5>AI Integration (Grok API)</h5>
                        <div class="mb-3">
                            <label>API Key</label>
                            <input type="password" id="grokApiKey" class="form-control" placeholder="Enter Grok API Key">
                        </div>
                        <div class="mb-3">
                            <label>Model</label>
                            <select id="grokModel" class="form-control">
                                <option value="grok-beta">Grok Beta</option>
                                <option value="grok-1">Grok-1</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="saveGrokSettings()">Save Grok Settings</button>
                        <button class="btn btn-secondary ms-2" onclick="configureGrokAPI()">Configure</button>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-12">
                        <h5>Enhanced Theme Generator</h5>
                        <p>Choose from 5 professional color themes to customize the appearance of the application.</p>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="d-flex flex-wrap gap-3" id="themeSelector">
                                    <!-- Theme 1: Default Purple -->
                                    <div class="theme-option" onclick="applyTheme('default')" data-theme="default">
                                        <div class="theme-preview" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                            <i class="fas fa-check theme-check d-none"></i>
                                        </div>
                                        <div class="theme-name">Default Purple</div>
                                    </div>
                                    
                                    <!-- Theme 2: Ocean Blue -->
                                    <div class="theme-option" onclick="applyTheme('ocean')" data-theme="ocean">
                                        <div class="theme-preview" style="background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);">
                                            <i class="fas fa-check theme-check d-none"></i>
                                        </div>
                                        <div class="theme-name">Ocean Blue</div>
                                    </div>
                                    
                                    <!-- Theme 3: Forest Green -->
                                    <div class="theme-option" onclick="applyTheme('forest')" data-theme="forest">
                                        <div class="theme-preview" style="background: linear-gradient(135deg, #134e5e 0%, #71b280 100%);">
                                            <i class="fas fa-check theme-check d-none"></i>
                                        </div>
                                        <div class="theme-name">Forest Green</div>
                                    </div>
                                    
                                    <!-- Theme 4: Sunset Orange -->
                                    <div class="theme-option" onclick="applyTheme('sunset')" data-theme="sunset">
                                        <div class="theme-preview" style="background: linear-gradient(135deg, #f46b45 0%, #eea849 100%);">
                                            <i class="fas fa-check theme-check d-none"></i>
                                        </div>
                                        <div class="theme-name">Sunset Orange</div>
                                    </div>
                                    
                                    <!-- Theme 5: Midnight Dark -->
                                    <div class="theme-option" onclick="applyTheme('midnight')" data-theme="midnight">
                                        <div class="theme-preview" style="background: linear-gradient(135deg, #232526 0%, #414345 100%);">
                                            <i class="fas fa-check theme-check d-none"></i>
                                        </div>
                                        <div class="theme-name">Midnight Dark</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Your selected theme will be saved automatically and persist across sessions. The Default Purple theme is the original theme.
                        </div>
                    </div>
                </div>
                <div class="mt-4">
                    <button class="btn btn-secondary" onclick="backupData()">Backup Data</button>
                    <button class="btn btn-warning ms-2" onclick="restoreData()">Restore Data</button>
                </div>
                <div class="mt-4">
                    <h5>Data Vault</h5>
                    <p>The vault stores all reset and archived data for recovery purposes.</p>
                    <div class="row mb-3">
                        <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Items</h5><h3 id="vaultTotalItems">0</h3></div></div>
                        <div class="col-md-3"><div class="card card-metric p-3"><h5>Attendance Resets</h5><h3 id="vaultAttendanceResets">0</h3></div></div>
                        <div class="col-md-3"><div class="card card-metric p-3"><h5>Student Resets</h5><h3 id="vaultStudentResets">0</h3></div></div>
                        <div class="col-md-3"><div class="card card-metric p-3"><h5>Fee Resets</h5><h3 id="vaultFeeResets">0</h3></div></div>
                    </div>
                    <button class="btn btn-info mb-3" onclick="showVaultViewer()">View Vault Contents</button>
                    <button class="btn btn-warning mb-3" onclick="exportVault()">Export Vault</button>
                    <button class="btn btn-danger mb-3" onclick="clearVault()">Clear Vault</button>
                    <div id="vaultContent" class="d-none mt-3">
                        <h6>Vault Contents</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead><tr><th>Timestamp</th><th>Type</th><th>Description</th><th>Actions</th></tr></thead>
                                <tbody id="vaultTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Parent Portal -->
            <section id="parentPortal" class="section d-none parent-only">
                <h2>Parent Portal</h2>
                <ul class="nav nav-tabs mb-3" id="parentTabs">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#parent-overview">Overview</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#parent-progress">Student Progress</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#parent-incidents">Incident Reports</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#parent-livechat">Live Chat</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="parent-overview">
                        <div id="parentChildInfo"></div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h4>Attendance</h4>
                                <div id="parentAttendance"></div>
                            </div>
                            <div class="col-md-6">
                                <h4>Fees</h4>
                                <div id="parentFees"></div>
                            </div>
                        </div>
                        <div class="row mt-4">
                            <div class="col-md-6">
                                <h4>Grades</h4>
                                <div id="parentGrades"></div>
                            </div>
                            <div class="col-md-6">
                                <h4>Announcements</h4>
                                <div id="parentAnnouncements"></div>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="parent-progress">
                        <h4>Student Progress Report</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>View detailed progress reports for your child.
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <div class="card card-metric p-3">
                                    <h5>Overall Average</h5>
                                    <h3 id="parentStudentAverage">0%</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card card-metric p-3">
                                    <h5>Attendance Rate</h5>
                                    <h3 id="parentStudentAttendance">0%</h3>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card card-metric p-3">
                                    <h5>Behavior Score</h5>
                                    <h3 id="parentStudentBehavior">0/10</h3>
                                </div>
                            </div>
                        </div>
                        <canvas id="parentProgressChart" class="mt-4"></canvas>
                        <div class="mt-4">
                            <h5>Subject-wise Performance</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Subject</th>
                                        <th>Current Grade</th>
                                        <th>Average Score</th>
                                        <th>Trend</th>
                                        <th>Teacher Comments</th>
                                    </tr>
                                </thead>
                                <tbody id="parentProgressTable"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="parent-incidents">
                        <h4>Incident Reports (Read-Only)</h4>
                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>View incident reports related to your child. These reports are managed by the administration.
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <select class="form-control" id="parentIncidentTypeFilter" onchange="loadParentIncidents()">
                                    <option value="">All Types</option>
                                    <option value="behavioral">Behavioral</option>
                                    <option value="academic">Academic</option>
                                    <option value="medical">Medical</option>
                                    <option value="disciplinary">Disciplinary</option>
                                    <option value="positive">Positive Recognition</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <input type="date" class="form-control" id="parentIncidentDateFilter" onchange="loadParentIncidents()">
                            </div>
                        </div>
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Type</th>
                                    <th>Severity</th>
                                    <th>Description</th>
                                    <th>Action Taken</th>
                                    <th>Reported By</th>
                                </tr>
                            </thead>
                            <tbody id="parentIncidentsTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="parent-livechat">
                        <h4>Live Chat with School</h4>
                        <div class="alert alert-info">
                            <i class="fas fa-comments me-2"></i>Chat with teachers and request meetings.
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <button class="btn btn-primary" onclick="showRequestMeetingModal()">
                                    <i class="fas fa-calendar-plus me-2"></i>Request Meeting with Teacher
                                </button>
                            </div>
                        </div>
                        <div class="card" style="background: rgba(255, 255, 255, 0.1); border-radius: 15px;">
                            <div class="card-header" style="background: rgba(255, 255, 255, 0.2);">
                                <h5><i class="fas fa-comments me-2"></i>Parent-Teacher Chat</h5>
                            </div>
                            <div class="card-body" style="height: 400px; overflow-y: auto; background: rgba(0, 0, 0, 0.2);" id="parentChatMessages">
                                <p class="text-center text-muted">No messages yet. Start a conversation!</p>
                            </div>
                            <div class="card-footer" style="background: rgba(255, 255, 255, 0.1);">
                                <div class="input-group">
                                    <input type="text" id="parentChatInput" class="form-control" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendParentChat()">
                                    <button class="btn btn-primary" onclick="sendParentChat()">
                                        <i class="fas fa-paper-plane me-2"></i>Send
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h5>Meeting Requests</h5>
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Teacher</th>
                                        <th>Type</th>
                                        <th>Requested Date</th>
                                        <th>Time</th>
                                        <th>Status</th>
                                        <th>Notes</th>
                                    </tr>
                                </thead>
                                <tbody id="parentMeetingRequestsTable"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            <!-- Student Time Table (Read-Only) -->
            <section id="studentTimetable" class="section d-none student-only">
                <h2>My Time Table</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>This is a read-only view of your class timetable.
                </div>
                <div id="studentTimetableContainer">
                    <p class="text-center">Loading your timetable...</p>
                </div>
            </section>
            <!-- Student Examination (Read-Only) -->
            <section id="studentExamination" class="section d-none student-only">
                <h2>My Assessments</h2>
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>View your upcoming assessments and past results.
                </div>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <label class="form-label">Filter by Assessment Type:</label>
                        <select class="form-control" id="assessmentTypeFilter" onchange="loadStudentExamination()">
                            <option value="">All Types</option>
                            <option value="test">Test</option>
                            <option value="project">Project</option>
                            <option value="exam">Exam</option>
                            <option value="assignment">Assignment</option>
                        </select>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Upcoming Assessments</h5>
                            <h3 id="studentUpcomingExams">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Average Score</h5>
                            <h3 id="studentAvgScore">0%</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Completed Assessments</h5>
                            <h3 id="studentCompletedExams">0</h3>
                        </div>
                    </div>
                </div>
                <h4 class="mt-4">Upcoming Assessments</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Date</th>
                            <th>Time</th>
                            <th>Duration</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="studentExamTable"></tbody>
                </table>
                <h4 class="mt-4">My Results</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Type</th>
                            <th>Subject</th>
                            <th>Assessment</th>
                            <th>Date</th>
                            <th>Score</th>
                            <th>Grade</th>
                            <th>Comments</th>
                        </tr>
                    </thead>
                    <tbody id="studentResultsTable"></tbody>
                </table>
            </section>
            <!-- Student Inbox -->
            <section id="studentInbox" class="section d-none student-only">
                <h2>My Inbox</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-envelope me-2"></i>View messages from teachers and send messages to your teachers.
                </div>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <button class="btn btn-primary" onclick="showSendTeacherMessageModal()">
                            <i class="fas fa-paper-plane me-2"></i>Send Message to Teacher
                        </button>
                    </div>
                    <div class="col-md-4">
                        <div class="input-group">
                            <input type="text" class="form-control" placeholder="Search messages..." id="studentInboxSearch">
                            <button class="btn btn-outline-secondary" onclick="searchStudentInbox()">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-control" id="studentInboxFilter" onchange="loadStudentInbox()">
                            <option value="all">All Messages</option>
                            <option value="unread">Unread</option>
                            <option value="important">Important</option>
                            <option value="sent">Sent by Me</option>
                        </select>
                    </div>
                </div>
                <div id="studentInboxContainer"></div>
            </section>
            <!-- Student Upload Work -->
            <section id="studentUploadWork" class="section d-none student-only">
                <h2>My Work Submissions</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-upload me-2"></i>Submit your homework, projects, and assignments here.
                </div>
                
                <!-- Submit New Work Form -->
                <div class="card mb-4" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header" style="background: rgba(255, 255, 255, 0.2);">
                        <h5><i class="fas fa-plus-circle me-2"></i>Submit New Work</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Assignment Title</label>
                                <input type="text" id="studentWorkTitle" class="form-control" placeholder="e.g., Math Homework Chapter 5">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Subject</label>
                                <select id="studentWorkSubject" class="form-control">
                                    <option value="">Select Subject</option>
                                    <option value="Mathematics">Mathematics</option>
                                    <option value="English">English</option>
                                    <option value="Science">Science</option>
                                    <option value="History">History</option>
                                    <option value="Geography">Geography</option>
                                    <option value="Art">Art</option>
                                    <option value="Physical Education">Physical Education</option>
                                    <option value="Other">Other</option>
                                </select>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Description / Notes</label>
                            <textarea id="studentWorkDescription" class="form-control" rows="3" placeholder="Add any notes or comments about your submission..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Upload Files (PDF, Word, Images, etc.)</label>
                            <input type="file" id="studentWorkFiles" class="form-control" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.txt">
                            <small class="text-muted">You can select multiple files</small>
                        </div>
                        <button class="btn btn-primary" onclick="submitStudentWork()">
                            <i class="fas fa-paper-plane me-2"></i>Submit Work
                        </button>
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Submitted</h5>
                            <h3 id="studentSubmittedWork">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Pending</h5>
                            <h3 id="studentPendingWork">0</h3>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card card-metric p-3">
                            <h5>Graded</h5>
                            <h3 id="studentGradedWork">0</h3>
                        </div>
                    </div>
                </div>
                <h4 class="mt-4">My Submissions</h4>
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Assignment</th>
                            <th>Subject</th>
                            <th>Submitted Date</th>
                            <th>Files</th>
                            <th>Status</th>
                            <th>Grade</th>
                            <th>Feedback</th>
                        </tr>
                    </thead>
                    <tbody id="studentWorkTable"></tbody>
                </table>
            </section>
            <!-- AI Research for Students -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div class="alert alert-success mb-3">
                    <i class="fas fa-lightbulb me-2"></i>Use our advanced AI to help with your research, homework, and learning!
                </div>
                <div class="row mb-3">
                    <div class="col-md-8">
                        <textarea id="researchQuery" class="form-control" rows="3" placeholder="Ask a detailed research question or describe what you'd like to learn..."></textarea>
                    </div>
                    <div class="col-md-4">
                        <select id="aiProvider" class="form-control mb-2">
                            <option value="chatgpt">ChatGPT</option>
                            <option value="grok">Grok</option>
                        </select>
                        <select id="researchCategory" class="form-control mb-2">
                            <option value="general">General Research</option>
                            <option value="science">Science</option>
                            <option value="mathematics">Mathematics</option>
                            <option value="history">History</option>
                            <option value="literature">Literature</option>
                            <option value="geography">Geography</option>
                            <option value="technology">Technology</option>
                        </select>
                        <button class="btn btn-primary w-100" onclick="researchWithAI()">
                            <i class="fas fa-search me-2"></i>Research
                        </button>
                        <button class="btn btn-secondary w-100 mt-2" onclick="clearResearch()">
                            <i class="fas fa-eraser me-2"></i>Clear
                        </button>
                    </div>
                </div>
                <div id="researchResults"></div>
                <div id="researchHistory" class="mt-4"></div>
            </section>
            <!-- Modals -->
            <!-- New Admission Modal -->
            <div class="modal fade" id="addAdmissionModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">New Admission - SA-SAMS Format</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info text-dark">
                                <strong>SA-Sams Format:</strong> Complete all required fields according to South African School Administration standards.
                            </div>
                            <h6 class="text-dark mt-3">Learner Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionAccession" class="form-control mb-2" placeholder="Student Number *" required>
                                    <input type="text" id="admissionSurname" class="form-control mb-2" placeholder="Surname *" required>
                                    <input type="text" id="admissionFirstName" class="form-control mb-2" placeholder="First Name *" required>
                                    <select id="admissionGender" class="form-control mb-2">
                                        <option value="">Select Gender</option>
                                        <option value="Male">Male</option>
                                        <option value="Female">Female</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <input type="text" id="admissionGrade" class="form-control mb-2" placeholder="Grade *" required>
                                    <input type="text" id="admissionClass" class="form-control mb-2" placeholder="Class">
                                    <input type="text" id="admissionCell" class="form-control mb-2" placeholder="Cell#">
                                    <input type="email" id="admissionEmail" class="form-control mb-2" placeholder="Email">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <select id="admissionHomeLanguage" class="form-control mb-2">
                                        <option value="">Select Home Language</option>
                                        <option value="English">English</option>
                                        <option value="Afrikaans">Afrikaans</option>
                                        <option value="isiZulu">isiZulu</option>
                                        <option value="isiXhosa">isiXhosa</option>
                                        <option value="Sesotho">Sesotho</option>
                                        <option value="Setswana">Setswana</option>
                                        <option value="Sepedi">Sepedi</option>
                                        <option value="Xitsonga">Xitsonga</option>
                                        <option value="siSwati">siSwati</option>
                                        <option value="Tshivenda">Tshivenda</option>
                                        <option value="isiNdebele">isiNdebele</option>
                                    </select>
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Father Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionFatherName" class="form-control mb-2" placeholder="Father Name">
                                    <input type="text" id="admissionFatherSurname" class="form-control mb-2" placeholder="Father Surname">
                                </div>
                                <div class="col-md-6">
                                    <input type="email" id="admissionFatherEmail" class="form-control mb-2" placeholder="Father Email">
                                    <input type="text" id="admissionFatherCell" class="form-control mb-2" placeholder="Father Cell#">
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Mother Details</h6>
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" id="admissionMotherName" class="form-control mb-2" placeholder="Mother Name">
                                    <input type="text" id="admissionMotherSurname" class="form-control mb-2" placeholder="Mother Surname">
                                </div>
                                <div class="col-md-6">
                                    <input type="email" id="admissionMotherEmail" class="form-control mb-2" placeholder="Mother Email">
                                    <input type="text" id="admissionMotherCell" class="form-control mb-2" placeholder="Mother Cell#">
                                </div>
                            </div>
                            <h6 class="text-dark mt-3">Additional Information</h6>
                            <input type="text" id="admissionUsername" class="form-control mb-2" placeholder="Student Username">
                            <input type="password" id="admissionPassword" class="form-control mb-2" placeholder="Student Password">
                            <select id="admissionStatus" class="form-control mb-2">
                                <option value="Pending">Pending</option>
                                <option value="Approved">Approved</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAdmission()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Student Modal -->
            <div class="modal fade" id="addStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Student</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info text-dark">
                                <strong>SA-Sams Format:</strong> Complete all required fields according to South African School Administration standards.
                            </div>
                            <input type="text" id="studentAccession" class="form-control mb-2" placeholder="Accession Number *" required>
                            <input type="text" id="studentSurname" class="form-control mb-2" placeholder="Surname *" required>
                            <input type="text" id="studentFirstName" class="form-control mb-2" placeholder="First Name *" required>
                            <input type="text" id="studentIdNumber" class="form-control mb-2" placeholder="ID Number / Birth Certificate Number">
                            <input type="date" id="studentDateOfBirth" class="form-control mb-2" placeholder="Date of Birth">
                            <select id="studentGender" class="form-control mb-2">
                                <option value="">Select Gender</option>
                                <option value="Male">Male</option>
                                <option value="Female">Female</option>
                            </select>
                            <select id="studentHomeLanguage" class="form-control mb-2">
                                <option value="">Select Home Language</option>
                                <option value="English">English</option>
                                <option value="Afrikaans">Afrikaans</option>
                                <option value="isiZulu">isiZulu</option>
                                <option value="isiXhosa">isiXhosa</option>
                                <option value="Sesotho">Sesotho</option>
                                <option value="Setswana">Setswana</option>
                                <option value="Sepedi">Sepedi</option>
                                <option value="Xitsonga">Xitsonga</option>
                                <option value="siSwati">siSwati</option>
                                <option value="Tshivenda">Tshivenda</option>
                                <option value="isiNdebele">isiNdebele</option>
                            </select>
                            <input type="text" id="studentGrade" class="form-control mb-2" placeholder="Grade *" required>
                            <input type="text" id="studentParent" class="form-control mb-2" placeholder="Parent/Guardian Name">
                            <input type="text" id="studentParentContact" class="form-control mb-2" placeholder="Parent Contact Number">
                            <input type="text" id="studentAddress" class="form-control mb-2" placeholder="Residential Address">
                            <input type="text" id="studentEducator" class="form-control mb-2" placeholder="Educator">
                            <select id="studentStatus" class="form-control mb-2">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStudent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Student Import Modal -->
            <div class="modal fade" id="bulkStudentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Students (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="alert alert-info mb-3 text-dark">
                                <strong>SA-Sams Format Requirements:</strong> Your file should contain the following columns:
                                <br><strong>Required:</strong> Surname, FirstName, Grade, Accession Number
                                <br><strong>Optional:</strong> IDNumber, DateOfBirth, Gender, HomeLanguage, ParentName, ParentContact, Address
                                <br>Example: <code>Accession,Surname,FirstName,Grade,IDNumber,DateOfBirth,Gender,HomeLanguage</code>
                            </div>
                            <input type="file" id="studentFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="studentPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStudents()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Attendance Marking Modal -->
            <div class="modal fade" id="attendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="hidden" id="attendanceStudentId">
                            <p id="attendanceStudentName"></p>
                            <input type="date" id="attendanceModalDate" class="form-control mb-2">
                            <select id="attendanceStatus" class="form-control mb-2">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Late">Late</option>
                            </select>
                            <textarea id="attendanceNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveAttendanceMark()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Attendance Modal -->
            <div class="modal fade" id="bulkAttendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Mark Attendance</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="date" id="bulkAttendanceDate" class="form-control mb-2">
                            <select id="bulkStatus" class="form-control mb-2">
                                <option value="Present">All Present</option>
                                <option value="Absent">All Absent</option>
                            </select>
                            <select id="bulkClass" class="form-control mb-2">
                                <option value="">All Classes</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="bulkMarkAttendance()">Mark</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Import Attendance Modal -->
            <div class="modal fade" id="importAttendanceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Import Attendance (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="attendanceFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="attendancePreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAttendance()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Generate Invoice Modal -->
            <div class="modal fade" id="generateInvoiceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Generate Invoice</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="invoiceStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="number" id="invoiceAmount" class="form-control mb-2" placeholder="Amount (R)">
                            <input type="date" id="invoiceDueDate" class="form-control mb-2">
                            <textarea id="invoiceDescription" class="form-control mb-2" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInvoice()">Generate</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Upload Fees Modal -->
            <div class="modal fade" id="bulkUploadFeesModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Upload Fees (CSV/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="feesFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="feesPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkFees()">Upload</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Time Slot Modal -->
            <div class="modal fade" id="addTimeSlotModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Time Slot</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="timeSlotGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="timeSlotDay" class="form-control mb-2">
                                <option value="Monday">Monday</option>
                                <option value="Tuesday">Tuesday</option>
                                <option value="Wednesday">Wednesday</option>
                                <option value="Thursday">Thursday</option>
                                <option value="Friday">Friday</option>
                            </select>
                            <input type="time" id="timeSlotTime" class="form-control mb-2">
                            <input type="text" id="timeSlotSubject" class="form-control mb-2" placeholder="Subject/Teacher">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveTimeSlot()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Exam Modal -->
            <div class="modal fade" id="addExamModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Exam</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="examName" class="form-control mb-2" placeholder="Exam Name">
                            <input type="date" id="examDate" class="form-control mb-2">
                            <input type="text" id="examSubject" class="form-control mb-2" placeholder="Subject">
                            <select id="examGrade" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="examStatus" class="form-control mb-2">
                                <option value="Scheduled">Scheduled</option>
                                <option value="Completed">Completed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveExam()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Payroll Modal -->
            <div class="modal fade" id="addPayrollModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Payroll</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="payrollStaff" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <input type="month" id="payrollMonth" class="form-control mb-2">
                            <input type="number" id="payrollSalary" class="form-control mb-2" placeholder="Gross Salary (R)">
                            <input type="number" id="payrollDeductions" class="form-control mb-2" placeholder="Deductions (R)">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="savePayroll()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Send Message Modal -->
            <div class="modal fade" id="sendMessageModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Message</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="messageRecipient" class="form-control mb-2">
                                <option value="all-students">All Students</option>
                                <option value="all-parents">All Parents</option>
                                <option value="all-staff">All Staff</option>
                            </select>
                            <textarea id="messageText" class="form-control mb-2" placeholder="Message text"></textarea>
                            <div class="form-check">
                                <input type="checkbox" id="sendViaSMS" class="form-check-input">
                                <label class="form-check-label">Send via SMS (WinSMS)</label>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Enhanced Announcements Modal -->
            <div class="modal fade" id="announcementsModal">
                <div class="modal-dialog modal-xl">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title"><i class="fas fa-bullhorn me-2"></i>Announcements Center</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs mb-3" id="announcementsTabs">
                                <li class="nav-item">
                                    <a class="nav-link active" data-bs-toggle="tab" href="#view-announcements">View Announcements</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#create-announcement">Create Announcement</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#create-poster">Create Poster</a>
                                </li>
                                <li class="nav-item">
                                    <a class="nav-link" data-bs-toggle="tab" href="#upload-video">Upload Video</a>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="view-announcements">
                                    <h6>Recent Announcements</h6>
                                    <div id="announcementsList"></div>
                                </div>
                                <div class="tab-pane fade" id="create-announcement">
                                    <h6>Create New Announcement</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Title</label>
                                        <input type="text" id="announcementTitle" class="form-control" placeholder="Enter announcement title">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Content</label>
                                        <textarea id="announcementContent" class="form-control" rows="5" placeholder="Enter announcement content"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Priority</label>
                                        <select id="announcementPriority" class="form-control">
                                            <option value="Low">Low</option>
                                            <option value="Medium" selected>Medium</option>
                                            <option value="High">High</option>
                                            <option value="Urgent">Urgent</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Target Audience</label>
                                        <select id="announcementAudience" class="form-control">
                                            <option value="All">All</option>
                                            <option value="Students">Students</option>
                                            <option value="Parents">Parents</option>
                                            <option value="Staff">Staff</option>
                                            <option value="Teachers">Teachers</option>
                                        </select>
                                    </div>
                                    <button class="btn btn-primary" onclick="createAnnouncement()">
                                        <i class="fas fa-paper-plane me-2"></i>Publish Announcement
                                    </button>
                                </div>
                                <div class="tab-pane fade" id="create-poster">
                                    <h6>Create Event Poster</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Poster Title</label>
                                        <input type="text" id="posterTitle" class="form-control" placeholder="Event name">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Event Date</label>
                                        <input type="date" id="posterDate" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Event Time</label>
                                        <input type="time" id="posterTime" class="form-control">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" id="posterLocation" class="form-control" placeholder="Event location">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Description</label>
                                        <textarea id="posterDescription" class="form-control" rows="3" placeholder="Event description"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Upload Image (Optional)</label>
                                        <input type="file" id="posterImage" class="form-control" accept="image/*">
                                    </div>
                                    <button class="btn btn-success" onclick="createPoster()">
                                        <i class="fas fa-image me-2"></i>Generate Poster
                                    </button>
                                    <div id="posterPreview" class="mt-3"></div>
                                </div>
                                <div class="tab-pane fade" id="upload-video">
                                    <h6>Upload Video Announcement</h6>
                                    <div class="mb-3">
                                        <label class="form-label">Video Title</label>
                                        <input type="text" id="videoTitle" class="form-control" placeholder="Enter video title">
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Video Description</label>
                                        <textarea id="videoDescription" class="form-control" rows="3" placeholder="Enter video description"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Upload Video File</label>
                                        <input type="file" id="videoFile" class="form-control" accept="video/*">
                                        <small class="text-muted">Supported formats: MP4, MOV, AVI (Max 100MB)</small>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Or Video URL</label>
                                        <input type="url" id="videoURL" class="form-control" placeholder="https://youtube.com/watch?v=...">
                                        <small class="text-muted">Paste YouTube, Vimeo, or other video link</small>
                                    </div>
                                    <button class="btn btn-info" onclick="uploadVideo()">
                                        <i class="fas fa-upload me-2"></i>Upload Video
                                    </button>
                                    <div id="videoPreview" class="mt-3"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Content Modal -->
            <div class="modal fade" id="addContentModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Content</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="contentTitle" class="form-control mb-2" placeholder="Title">
                            <select id="contentType" class="form-control mb-2">
                                <option value="Article">Article</option>
                                <option value="Video">Video</option>
                                <option value="Document">Document</option>
                            </select>
                            <textarea id="contentBody" class="form-control mb-2" placeholder="Content"></textarea>
                            <input type="file" id="contentFile" class="form-control mb-2">
                            <select id="contentStatus" class="form-control">
                                <option value="Draft">Draft</option>
                                <option value="Published">Published</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveContent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Admission Modal -->
            <div class="modal fade" id="bulkAdmissionModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Admissions (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="admissionsFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="admissionsPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkAdmissions()">Import</button>
                            <button type="button" class="btn btn-secondary" onclick="clearBulkAdmissionNotification()">Clear</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Bulk Staff Import Modal -->
            <div class="modal fade" id="bulkStaffModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Bulk Import Staff (CSV/Excel/PDF/Word)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="file" id="staffFile" class="form-control" accept=".csv,.xlsx,.pdf,.doc,.docx">
                            <div id="staffPreview" class="mt-3"></div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="uploadBulkStaff()">Import</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Staff Modal -->
            <div class="modal fade" id="addStaffModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="staffModalTitle">Add Staff</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="staffName" class="form-control mb-2" placeholder="Full Name">
                            <select id="staffRole" class="form-control mb-2">
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                                <option value="Support">Support</option>
                            </select>
                            <input type="text" id="staffDepartment" class="form-control mb-2" placeholder="Department">
                            <input type="number" id="staffSalary" class="form-control mb-2" placeholder="Salary (R)">
                            <input type="text" id="staffTax" class="form-control mb-2" placeholder="Tax Number">
                            <input type="text" id="staffUif" class="form-control mb-2" placeholder="UIF Number">
                            <input type="date" id="staffCertExpiry" class="form-control mb-2" placeholder="Cert Expiry">
                            <input type="text" id="staffUsername" class="form-control mb-2" placeholder="Staff Username">
                            <input type="password" id="staffPassword" class="form-control mb-2" placeholder="Staff Password">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveStaff()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Leave Modal -->
            <div class="modal fade" id="addLeaveModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Leave Request</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="leaveStaff" class="form-control mb-2"></select>
                            <select id="leaveType" class="form-control mb-2">
                                <option value="Annual">Annual</option>
                                <option value="Sick">Sick</option>
                                <option value="Maternity">Maternity</option>
                            </select>
                            <input type="date" id="leaveDate" class="form-control mb-2">
                            <input type="number" id="leaveDays" class="form-control mb-2" placeholder="Days">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLeave()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Review Modal -->
            <div class="modal fade" id="addReviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Performance Review</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="reviewStaff" class="form-control mb-2"></select>
                            <input type="date" id="reviewDate" class="form-control mb-2">
                            <input type="number" id="reviewScore" class="form-control mb-2" placeholder="Score (0-100)" min="0" max="100">
                            <textarea id="reviewComments" class="form-control mb-2" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveReview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Job Modal -->
            <div class="modal fade" id="addJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="jobModalTitle">Add Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="jobTitle" class="form-control mb-2" placeholder="Job Title">
                            <input type="text" id="jobDepartment" class="form-control mb-2" placeholder="Department">
                            <textarea id="jobDescription" class="form-control mb-2" placeholder="Description"></textarea>
                            <select id="jobStatus" class="form-control">
                                <option value="Open">Open</option>
                                <option value="Closed">Closed</option>
                            </select>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveJob()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Apply Job Modal -->
            <div class="modal fade" id="applyJobModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Apply for Job</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="applyJobSelect" class="form-control mb-2"></select>
                            <input type="text" id="applicantName" class="form-control mb-2" placeholder="Name">
                            <input type="email" id="applicantEmail" class="form-control mb-2" placeholder="Email">
                            <input type="tel" id="applicantPhone" class="form-control mb-2" placeholder="Phone">
                            <textarea id="applicantCoverLetter" class="form-control mb-2" placeholder="Cover Letter"></textarea>
                            <input type="file" id="applicantResume" class="form-control">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="submitApplication()">Submit</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Schedule Interview Modal -->
            <div class="modal fade" id="scheduleInterviewModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Schedule Interview</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="interviewApplicant" class="form-control mb-2" readonly>
                            <input type="datetime-local" id="interviewDateTime" class="form-control mb-2">
                            <select id="interviewType" class="form-control mb-2">
                                <option value="In-person">In-person</option>
                                <option value="Video">Video</option>
                            </select>
                            <textarea id="interviewNotes" class="form-control" placeholder="Notes"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveInterview()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Lesson Plan Modal -->
            <div class="modal fade" id="addLessonPlanModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Lesson Plan</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="lessonTitle" class="form-control mb-2" placeholder="Title">
                            <select id="lessonSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="date" id="lessonDate" class="form-control mb-2">
                            <textarea id="lessonObjectives" class="form-control mb-2" placeholder="Objectives"></textarea>
                            <textarea id="lessonActivities" class="form-control mb-2" placeholder="Activities"></textarea>
                            <textarea id="lessonMaterials" class="form-control mb-2" placeholder="Materials"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveLessonPlan()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Grade Modal -->
            <div class="modal fade" id="addGradeModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Grade</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <select id="gradeStudent" class="form-control mb-2">
                                <!-- Populated dynamically -->
                            </select>
                            <select id="gradeSubject" class="form-control mb-2">
                                <option value="">Select Subject</option>
                                <option value="Math">Math</option>
                                <option value="Science">Science</option>
                                <option value="English">English</option>
                            </select>
                            <input type="number" id="gradeScore" class="form-control mb-2" placeholder="Score" min="0" max="100">
                            <textarea id="gradeComments" class="form-control" placeholder="Comments"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveGrade()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Resource Modal -->
            <div class="modal fade" id="addResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Resource</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="resourceTitle" class="form-control mb-2" placeholder="Title">
                            <input type="text" id="resourceUrl" class="form-control mb-2" placeholder="URL">
                            <select id="resourceType" class="form-control mb-2">
                                <option value="Document">Document</option>
                                <option value="Video">Video</option>
                                <option value="Link">Link</option>
                            </select>
                            <textarea id="resourceDescription" class="form-control" placeholder="Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveResource()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Calendar Event Modal -->
            <div class="modal fade" id="addCalendarEventModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Calendar Event</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <input type="text" id="eventTitle" class="form-control mb-2" placeholder="Event Title">
                            <input type="date" id="eventDate" class="form-control mb-2">
                            <input type="time" id="eventTime" class="form-control mb-2">
                            <select id="eventType" class="form-control mb-2">
                                <option value="Class">Class</option>
                                <option value="Meeting">Meeting</option>
                                <option value="Exam">Exam</option>
                                <option value="Event">Event</option>
                                <option value="Deadline">Deadline</option>
                            </select>
                            <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Event Description"></textarea>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-primary" onclick="saveCalendarEvent()">Save</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Notifications Modal -->
            <div class="modal fade" id="notificationsModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Notifications</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div id="notificationContent"></div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Wellness Program Modal -->
            <div class="modal fade" id="addWellnessProgramModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Wellness Program</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Program Name</label>
                                <input type="text" id="wellnessProgramName" class="form-control" placeholder="e.g., Yoga & Meditation">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select id="wellnessProgramCategory" class="form-control">
                                    <option value="Physical Fitness">Physical Fitness</option>
                                    <option value="Mental Health">Mental Health</option>
                                    <option value="Nutrition">Nutrition</option>
                                    <option value="Stress Management">Stress Management</option>
                                    <option value="Work-Life Balance">Work-Life Balance</option>
                                    <option value="General Wellness">General Wellness</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="wellnessProgramDescription" class="form-control" rows="3" placeholder="Describe the wellness program..."></textarea>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="wellnessProgramStartDate" class="form-control">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Duration (weeks)</label>
                                    <input type="number" id="wellnessProgramDuration" class="form-control" min="1" value="4" placeholder="e.g., 4">
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Target Participants</label>
                                <select id="wellnessProgramTarget" class="form-control">
                                    <option value="All Staff">All Staff</option>
                                    <option value="Teachers">Teachers Only</option>
                                    <option value="Admin Staff">Admin Staff Only</option>
                                    <option value="Support Staff">Support Staff Only</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Max Participants</label>
                                <input type="number" id="wellnessProgramMaxParticipants" class="form-control" min="1" value="20" placeholder="e.g., 20">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Facilitator</label>
                                <input type="text" id="wellnessProgramFacilitator" class="form-control" placeholder="e.g., Dr. Smith">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Status</label>
                                <select id="wellnessProgramStatus" class="form-control">
                                    <option value="Active">Active</option>
                                    <option value="Upcoming">Upcoming</option>
                                    <option value="Completed">Completed</option>
                                    <option value="Cancelled">Cancelled</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveWellnessProgram()">
                                <i class="fas fa-save me-2"></i>Save Program
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Add Wellness Resource Modal -->
            <div class="modal fade" id="addWellnessResourceModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add Wellness Resource</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Resource Title</label>
                                <input type="text" id="wellnessResourceTitle" class="form-control" placeholder="e.g., Stress Management Guide">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Type</label>
                                <select id="wellnessResourceType" class="form-control">
                                    <option value="Article">Article</option>
                                    <option value="Video">Video</option>
                                    <option value="Guide">Guide</option>
                                    <option value="Workshop">Workshop</option>
                                    <option value="External Link">External Link</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Category</label>
                                <select id="wellnessResourceCategory" class="form-control">
                                    <option value="Mental Health">Mental Health</option>
                                    <option value="Physical Fitness">Physical Fitness</option>
                                    <option value="Nutrition">Nutrition</option>
                                    <option value="Stress Management">Stress Management</option>
                                    <option value="General Wellness">General Wellness</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">URL/Link</label>
                                <input type="url" id="wellnessResourceUrl" class="form-control" placeholder="https://...">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea id="wellnessResourceDescription" class="form-control" rows="3" placeholder="Describe the resource..."></textarea>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveWellnessResource()">
                                <i class="fas fa-save me-2"></i>Save Resource
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Send Message to Teacher Modal (Student) -->
            <div class="modal fade" id="sendTeacherMessageModal">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Send Message to Teacher</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="mb-3">
                                <label class="form-label">Select Teacher</label>
                                <select id="teacherRecipient" class="form-control">
                                    <option value="">-- Select Teacher --</option>
                                    <option value="Mr. Smith">Mr. Smith (Mathematics)</option>
                                    <option value="Mrs. Johnson">Mrs. Johnson (English)</option>
                                    <option value="Dr. Brown">Dr. Brown (Science)</option>
                                    <option value="Ms. Davis">Ms. Davis (History)</option>
                                    <option value="Mr. Wilson">Mr. Wilson (Geography)</option>
                                    <option value="Coach Taylor">Coach Taylor (Physical Education)</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Subject</label>
                                <input type="text" id="messageSubject" class="form-control" placeholder="e.g., Question about Homework">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Message</label>
                                <textarea id="messageBody" class="form-control" rows="5" placeholder="Type your message here..."></textarea>
                            </div>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="markImportant">
                                    <label class="form-check-label" for="markImportant">
                                        Mark as Important
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="sendTeacherMessage()">
                                <i class="fas fa-paper-plane me-2"></i>Send Message
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Event Modal -->
        <div class="modal fade" id="addEventModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add School Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="eventName" class="form-control mb-2" placeholder="Event Name *" required>
                        <select id="eventType" class="form-control mb-2">
                            <option value="">Select Event Type *</option>
                            <option value="excursion">Excursion</option>
                            <option value="fundraising">Fundraising</option>
                            <option value="sports">Sports Day</option>
                            <option value="cultural">Cultural Event</option>
                            <option value="academic">Academic Event</option>
                            <option value="meeting">Parent-Teacher Meeting</option>
                            <option value="ceremony">Ceremony</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="date" id="eventDate" class="form-control mb-2" placeholder="Event Date *" required>
                        <input type="time" id="eventTime" class="form-control mb-2" placeholder="Event Time *" required>
                        <input type="text" id="eventLocation" class="form-control mb-2" placeholder="Location *" required>
                        <textarea id="eventDescription" class="form-control mb-2" rows="3" placeholder="Event Description"></textarea>
                        <select id="eventParticipants" class="form-control mb-2">
                            <option value="all">All Students & Staff</option>
                            <option value="students">Students Only</option>
                            <option value="staff">Staff Only</option>
                            <option value="parents">Parents Only</option>
                            <option value="specific">Specific Grades</option>
                        </select>
                        <div id="specificGradesContainer" class="d-none mb-2">
                            <input type="text" id="eventSpecificGrades" class="form-control" placeholder="Enter grades (e.g., Grade 8, Grade 9)">
                        </div>
                        <div class="form-check mb-2">
                            <input type="checkbox" id="eventSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="eventSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addEvent()">
                            <i class="fas fa-plus me-2"></i>Add Event
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Excursion Modal -->
        <div class="modal fade" id="addExcursionModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Excursion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="excursionName" class="form-control mb-2" placeholder="Excursion Name *" required>
                        <input type="date" id="excursionDate" class="form-control mb-2" placeholder="Date *" required>
                        <input type="time" id="excursionTime" class="form-control mb-2" placeholder="Departure Time *" required>
                        <input type="text" id="excursionDestination" class="form-control mb-2" placeholder="Destination *" required>
                        <input type="number" id="excursionCost" class="form-control mb-2" placeholder="Cost per Student (R)" min="0">
                        <textarea id="excursionDescription" class="form-control mb-2" rows="3" placeholder="Description and requirements"></textarea>
                        <input type="text" id="excursionGrades" class="form-control mb-2" placeholder="Grades participating (e.g., Grade 8, Grade 9)">
                        <input type="date" id="excursionDeadline" class="form-control mb-2" placeholder="Permission slip deadline">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="excursionSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="excursionSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-success" onclick="addExcursion()">
                            <i class="fas fa-bus me-2"></i>Add Excursion
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Fundraising Modal -->
        <div class="modal fade" id="addFundraisingModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Fundraising Event</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <input type="text" id="fundraisingName" class="form-control mb-2" placeholder="Event Name *" required>
                        <input type="date" id="fundraisingDate" class="form-control mb-2" placeholder="Date *" required>
                        <input type="time" id="fundraisingTime" class="form-control mb-2" placeholder="Time *" required>
                        <input type="text" id="fundraisingLocation" class="form-control mb-2" placeholder="Location *" required>
                        <input type="number" id="fundraisingGoal" class="form-control mb-2" placeholder="Fundraising Goal (R)" min="0">
                        <textarea id="fundraisingDescription" class="form-control mb-2" rows="3" placeholder="Description and purpose"></textarea>
                        <input type="text" id="fundraisingContact" class="form-control mb-2" placeholder="Contact Person">
                        <div class="form-check mb-2">
                            <input type="checkbox" id="fundraisingSendNotification" class="form-check-input" checked>
                            <label class="form-check-label" for="fundraisingSendNotification">
                                Send automatic notifications to parents and teachers
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-warning" onclick="addFundraising()">
                            <i class="fas fa-hand-holding-usd me-2"></i>Add Fundraising
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Request Meeting Modal -->
        <div class="modal fade" id="requestMeetingModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Request Meeting with Teacher</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select id="meetingTeacher" class="form-control mb-2">
                            <option value="">Select Teacher *</option>
                        </select>
                        <select id="meetingType" class="form-control mb-2">
                            <option value="">Meeting Type *</option>
                            <option value="virtual">Virtual Meeting</option>
                            <option value="in-person">In-Person Meeting</option>
                        </select>
                        <input type="date" id="meetingDate" class="form-control mb-2" placeholder="Preferred Date *" required>
                        <input type="time" id="meetingTime" class="form-control mb-2" placeholder="Preferred Time *" required>
                        <textarea id="meetingReason" class="form-control mb-2" rows="3" placeholder="Reason for meeting *" required></textarea>
                        <input type="text" id="meetingContact" class="form-control mb-2" placeholder="Your Contact Number">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitMeetingRequest()">
                            <i class="fas fa-calendar-plus me-2"></i>Request Meeting
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <!-- Add Incident Report Modal (Admin Only) -->
        <div class="modal fade" id="addIncidentModal">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Add Incident Report</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <select id="incidentStudent" class="form-control mb-2">
                            <option value="">Select Student *</option>
                        </select>
                        <select id="incidentType" class="form-control mb-2">
                            <option value="">Incident Type *</option>
                            <option value="behavioral">Behavioral</option>
                            <option value="academic">Academic</option>
                            <option value="medical">Medical</option>
                            <option value="disciplinary">Disciplinary</option>
                            <option value="positive">Positive Recognition</option>
                        </select>
                        <select id="incidentSeverity" class="form-control mb-2">
                            <option value="">Severity *</option>
                            <option value="low">Low</option>
                            <option value="medium">Medium</option>
                            <option value="high">High</option>
                        </select>
                        <input type="date" id="incidentDate" class="form-control mb-2" value="" required>
                        <textarea id="incidentDescription" class="form-control mb-2" rows="3" placeholder="Incident Description *" required></textarea>
                        <textarea id="incidentAction" class="form-control mb-2" rows="2" placeholder="Action Taken"></textarea>
                        <input type="text" id="incidentReporter" class="form-control mb-2" placeholder="Reported By" value="">
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="addIncidentReport()">
                            <i class="fas fa-plus me-2"></i>Add Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Global variables
        var currentUser = null;
        var editingJob = null;
        var editingStaffId = null;
        var editingReviewId = null;
        var students = [];
        var admissions = [];
        var fees = [];
        var timetable = {};
        var exams = [];
        var staff = [];
        var payrolls = [];
        var leaveRequests = [];
        var performanceReviews = [];
        var jobs = [];
        var auditLog = [];
        var contents = [];
        var messages = [];
        var announcements = [];
        var users = [];
        var hrSettings = { annualLeaveDays: 21, uifRate: 0.01 };
        var smsSettings = { username: '', password: '', senderId: 'BophelongSchool' };
        var chatGPTSettings = { apiKey: '', model: 'gpt-4', enabled: false };
        var grokSettings = { apiKey: '', model: 'grok-beta', enabled: false };
        var attendanceRecords = {};
        var lessonPlans = [];
        var grades = [];
        var resources = [];
        var uploadedWork = [];
        var calendarEvents = [];
        var dashboardChart = null;
        var leaveChart = null;
        var performanceChart = null;
        var progressChart = null;
        var dataVault = [];
        var teacherChats = [];
        var adminMessages = [];
        var selectedChatStudent = null;
        var isOnline = navigator.onLine;
        var offlineQueue = [];
        var schoolEvents = [];
        var meetingRequests = [];
        var incidentReports = [];
        var wellnessPrograms = [];
        // MX-4051 PDF Data
        var mx4051Data = [
            { class: '1A', accession: '2890', surname: 'CHAUKE', first_name: 'Nobule', educator: 'K MOGANE' },
            { class: '1A', accession: '2598', surname: 'FATLANA', first_name: 'Retumetse', educator: 'K MOGANE' },
            { class: '1A', accession: '2558', surname: 'KENANA', first_name: 'Dumpho', educator: 'K MOGANE' },
            { class: '1A', accession: '2445', surname: 'LUBENA', first_name: 'Manjela Jama', educator: 'K MOGANE' },
            { class: '1A', accession: '2565', surname: 'MABASOE', first_name: 'Victor', educator: 'K MOGANE' },
            { class: '1A', accession: '2370', surname: 'MAHLANGU', first_name: 'Sandile', educator: 'K MOGANE' },
            { class: '1A', accession: '2540', surname: 'MANCHUD', first_name: 'Khumo', educator: 'K MOGANE' },
            { class: '1A', accession: '2557', surname: 'MATHEBULA', first_name: 'Lungo', educator: 'K MOGANE' },
            { class: '1A', accession: '2597', surname: 'MONDLI', first_name: 'Thepo', educator: 'K MOGANE' },
            { class: '1A', accession: '2570', surname: 'NOZINYANA', first_name: 'Philo', educator: 'K MOGANE' },
            { class: '1A', accession: '2573', surname: 'PHLANE', first_name: 'Outshile', educator: 'K MOGANE' },
            { class: '1A', accession: '2496', surname: 'SAKOMA', first_name: 'Amogelang', educator: 'K MOGANE' },
            { class: '1A', accession: '2533', surname: 'SHUMBA', first_name: 'Zobride', educator: 'K MOGANE' },
            { class: '1A', accession: '20128', surname: 'THOBAKGALE', first_name: 'Aleng', educator: 'K MOGANE' },
            // Add more from other classes...
            { class: '1B', accession: '2542', surname: 'KHUMALO', first_name: 'Meliswe', educator: 'F NCUBE' },
            { class: '1B', accession: '2404', surname: 'MAHLANGU', first_name: 'Abigail', educator: 'F NCUBE' },
            { class: '1B', accession: '2546', surname: 'MAKOLA', first_name: 'Ndithulo', educator: 'F NCUBE' },
            { class: '1B', accession: '2559', surname: 'MANABE', first_name: 'Ningibi', educator: 'F NCUBE' },
            { class: '1B', accession: '2524', surname: 'SEHWANG', first_name: 'Gantile', educator: 'F NCUBE' },
            { class: '1B', accession: '2535', surname: 'YU DA', first_name: 'Massego', educator: 'F NCUBE' },
            { class: '1B', accession: '2545', surname: 'YU DA', first_name: 'Kanga', educator: 'F NCUBE' },
            // Continue for all classes...
            // For brevity, adding a few more
            { class: '2A', accession: '2408', surname: 'CHUMA', first_name: 'Jabu', educator: 'MS MOYO' },
            { class: '2A', accession: '2448', surname: 'LEPHAKU', first_name: 'Outshilemo', educator: 'MS MOYO' },
            { class: '3A', accession: '2211', surname: 'HAMZAT', first_name: 'Mercy', educator: 'R CHWAYO' },
            { class: '4A', accession: '2203', surname: 'AGYAPONG', first_name: 'Princess', educator: 'M KESWA' },
            { class: '5A', accession: '2405', surname: 'BOYS', first_name: 'Gcina', educator: 'NN DONDO' },
            { class: '6A', accession: '2012', surname: 'GUMESHE', first_name: 'Rudo', educator: 'NL TSIMA' },
            { class: '7A', accession: '2323', surname: 'BALOYI', first_name: 'Okoposi', educator: 'NP NTLOLE' },
            { class: '8A', accession: '2153', surname: 'BAMDLE', first_name: 'Michelle', educator: 'MC KGANAKGA' },
            { class: '9A', accession: '2435', surname: 'ARIES', first_name: 'Kayla', educator: 'G TSHILOANE' },
            { class: 'RA', accession: '2598', surname: 'DELEKILE', first_name: 'Boloto', educator: 'SB MALEKA' }
        ];
        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        // Load data from localStorage
        function loadData() {
            students = JSON.parse(localStorage.getItem('students') || '[]');
            admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
            fees = JSON.parse(localStorage.getItem('fees') || '[]');
            timetable = JSON.parse(localStorage.getItem('timetable') || '{}');
            exams = JSON.parse(localStorage.getItem('exams') || '[]');
            staff = JSON.parse(localStorage.getItem('staff') || '[]');
            payrolls = JSON.parse(localStorage.getItem('payrolls') || '[]');
            leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
            performanceReviews = JSON.parse(localStorage.getItem('performanceReviews') || '[]');
            jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
            auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
            contents = JSON.parse(localStorage.getItem('contents') || '[]');
            messages = JSON.parse(localStorage.getItem('messages') || '[]');
            announcements = JSON.parse(localStorage.getItem('announcements') || '[]');
            users = JSON.parse(localStorage.getItem('users') || '[]');
            hrSettings = JSON.parse(localStorage.getItem('hrSettings') || JSON.stringify(hrSettings));
            smsSettings = JSON.parse(localStorage.getItem('smsSettings') || JSON.stringify(smsSettings));
            chatGPTSettings = JSON.parse(localStorage.getItem('chatGPTSettings') || JSON.stringify(chatGPTSettings));
            grokSettings = JSON.parse(localStorage.getItem('grokSettings') || JSON.stringify(grokSettings));
            attendanceRecords = JSON.parse(localStorage.getItem('attendanceRecords') || '{}');
            lessonPlans = JSON.parse(localStorage.getItem('lessonPlans') || '[]');
            grades = JSON.parse(localStorage.getItem('grades') || '[]');
            resources = JSON.parse(localStorage.getItem('resources') || '[]');
            uploadedWork = JSON.parse(localStorage.getItem('uploadedWork') || '[]');
            calendarEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
            dataVault = JSON.parse(localStorage.getItem('dataVault') || '[]');
            schoolEvents = JSON.parse(localStorage.getItem('schoolEvents') || '[]');
            meetingRequests = JSON.parse(localStorage.getItem('meetingRequests') || '[]');
            incidentReports = JSON.parse(localStorage.getItem('incidentReports') || '[]');
            wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
            integrateEducatorsAsStaff();
            if (students.length === 0) generateDemoData();
            if (admissions.length === 0) initializeAdmissionData();
        }
        // Initialize admission data with default students - ALL 213 STUDENTS
        function initializeAdmissionData() {
            // Raw student data from problem statement - tab-separated format
            // Format: Number, Surname, FirstName, Gender, Grade, Class, Cell#, Email, Language, FatherName, FatherSurname, FatherEmail, FatherCell, MotherName, MotherSurname, MotherEmail, MotherCell
            const rawStudentData = `1	AGYAPONG	Princess	F	Grade 04	4A	0738012103		English					Olivia	AGYAPONG		
2	ARRIES	Kaylin	F	Grade 09	9A	0835918224		English	Francois	ARRIES		0783660823	Sharoline	ARRIES	SHAROLINEARRIES@GMAIL.COM	0680554938
3	BALOYI	Onkgopoditse	M	Grade 07	7A	0648264275		English					Sharon	BALOYI		0727841024
4	BAMIDELE	Michelle	F	Grade 08	8A	0766696262		English					Joyce	MOTSEPE		
5	BOYS	Ginolia	F	Grade 05	5A			English					Thandi	BOYS		0681182017
6	CHAKA	Tumelo	M	Grade 09	9A	0760522944		English		MAGOLEGO			Dimakatso	CHAKA		
7	CHAUKE	Nobuhle	F	Grade 10	10A			English					Emelina Nomsa	CHAUKE		0726002475
8	CHAUKE	Siyanda	F	Grade 07	7A	0793247842		English	Bafana	CHAUKE						
9	CHIMBIRO	Alaine	F	Grade 08	8A	0734638108		English	Chikwando				Nyarai	CHIMBIRO		
10	CHIRUME	Mafaro	F	Grade 05	5A	0732157461		English	Francis				Pers	CHIRUME		0732157462
11	CHIVIMA	Jayden	M	Grade 05	5A	0739202633		English	Anywau	CHIVIMA			Faustina	MAKAINGANWA		
12	CHIVIMA	Jayla	F	Grade 02	2A	0739202633		English	Anuwau	CHIRIMA			Faustina			
13	DELEKILE	Boiketlo	F	Grade R	RA	0787123382		English					Ziyanda	DELEKI		
14	DELEKILE	Mbali	F	Grade 09	9A	0837438666		English					Nomzamo	DELEKILE		
15	DZUKUSO	Ruvimbo	F	Grade 04	4A	074099665		English	Archbold	DZUKUSO			Pieti	ZHIRA		
16	FRANCIS	Phetogo	F	Grade 07	7A	0710256321		English	Johannes				Lesego	FRANCIS		
17	GWESHE	Rufaro	F	Grade 06	6A	0749145762		English	Desmond	GWESHE		0636900874	Huruva			
18	GWESHE	Tinotenda	F	Grade 07	7A	0626855114		English	Desmond	GWESHE			Julie	HURUVA		
19	HAMZAT	Mercy	F	Grade 03	3A	0715603020		English	Hamzat				Tebogo	MASITE		
20	HLALETHWA	Berritta	F	Grade R	RA	0782257768		English		NKWANA			Palesa	HLALETHWA		
21	HLONGWANE	Kgotso	M	Grade 10	10A	0797886667		English					Emily	HLONGWANE		0820517718
22	HLONGWANE	Tiyani	M	Grade R	RA			English					Cynthia	HLONGWANE		
23	JEKE	Perpetual	F	Grade R	RA			English					Hildah	BALOYI		
24	KEKANA	Dimpho	M	Grade 10	10A			English					Palesa	KEKANA		
25	KGAPHOLA	Itebogeleng	M	Grade R	RA	0837144622		English					Poriia	SEEKOEI		
26	KGOSANA	Lehlogonolo	M	Grade 09	9A	0785877954		English	Mpho	LETWABA		0734009661	Ingrid	KGOSANA		
27	KGOSANA	Polelo	M	Grade 04	4A	0791142645		English	Mpho	LETWAA			Christinah	KGOSANA		0785877954
28	KGWETE	Mulalo	M	Grade 06	6A			English	Alpheus	KGWETE		0711062122			
29	KHOZA	Kgomotso	M	Grade 09	9A	0834221060		English	Daniel	MABUNDA			Julliet	KHOZA		0834221060
30	KHOZA	Kgosi	M	Grade 03	3A			English					Julliet	KHOZA		0834221060
31	KHOZA	Laybon	M	Grade 08	8A			English					Nkateko	KHOZA		
32	KHUMALO	Melisizwe	M	Grade 01	1A			English	Nkeku	KHUMALO					
33	KUNENE	Mojalefa	M	Grade 10	10A	0761929171		English	Christy	KUNENE	CHRISTY.KUNENE@GMAIL.COM	0784575151	Thembi	KUNENE		0713919278
34	LAMOLA	Amogelang	F	Grade 06	6A	0765197804		English	Andy	MAHLANGU					
35	LANDANE	Thato	M	Grade 04	4A	0731875351		English	Ambrose				Pelo	HLABANGWANE		
36	LEBAMBO	Atlegang	F	Grade 03	3A			English					Sphiwe	LEBAMBO		0649541623
37	LEBISI	James	M	Grade 10	10A	0681449791		English	James	LEBISI		0784376819			
38	LEKGANYANE	Kaiki	F	Grade 07	7A	0790610833		English	Makgako	LEKGANYANE		0720971689	Solane	LEKGANYANE		0721123998
39	LEKHOTWANE	Lethabo	F	Grade R	RA			English					Khumotso	LEKHOTWANE		
40	LEPAKU	Ontshiametso	M	Grade 02	2A	0766585443		English					Dineo Georginah	LEPAKU		0769840436
41	LETSIKE	Suprise	M	Grade 02	2A			English					Matema	LETSIKE		0614558443
42	LISIMATI	Conland	M	Grade 08	8A	0823635637		English					Primrose	INGWANI		
43	LONGWE	Amelia	F	Grade 04	4A	0781820641		English	Matheus	LONGWE			Natasha	MWANSA		
44	LONGWE	Anita	F	Grade 07	7A	0781820641		English	Mathes	LONGWE		0781820641	Natasha	MWANGA		
45	LUKHULENI	Nikiwe	F	Grade 08	8A	0727983157		English					Isizulu	LEKHULENI		
46	MABASO	Surprise	M	Grade 10	10A			English					Thulile Precious	MABASO		
47	MABUELA	Gomolemo	M	Grade 06	6A	0735606807		English	Stephens				Lorraine	MABUELA		
48	MADEDE	Angela	F	Grade 07	7A	0822698218		English	Morgan				Privillage	MUZATA		
49	MADEDE	Prince	M	Grade 03	3A	0713159498		English	Morgn				Privillage	MUZATA		
50	MAELE	Rearabilwe	M	Grade 07	7A	0679237470		English	Kgomotso				Chrmaine	MAKU		0826446996
51	MAENGEDZE	Victor	M	Grade 10	10A	0788911237		English		MAENGEDZE			Loveness	PEYIYE		
52	MAEPA	Botshelo	F	Grade 08	8A			English					Dimakatso	MAEPA		
53	MAHLANGU	Abigail	F	Grade 01	1A	0609429366		English	Musa	MAHLANGU			Ntshenekane	LEKHOTWANE		0728619891
54	MAHLANGU	Mahlatse	M	Grade 10	10A			English					Petricia	MAHLANGU		0791434414
55	MAHLANGU	Thalia	F	Grade R	RA			English					Jennifer	LEKHOTWANE		
56	MAHLANGU	Zoe	F	Grade 05	5A	0636793507		English					Letta	MAHLANGU		
57	MAHWAMURE	Evan	M	Grade R	RA			English					Kudzai	CHINGARANDE		
58	MAILA	Lesedi	F	Grade 02	2A	0715156789		English					Matopong	MAILA		
59	MAILA	Sandile	M	Grade 10	10A			English					Ivy	MAILA		073245924180
60	MAKHELE	Thabiso	M	Grade 07	7A	0713030723		English	Paul	MAKHELE			Moropane	MOAGI		0826734069
61	MAKHELE	Tlotliso	F	Grade 01	1A	0713030723		English	Paul	MAKHELE						
62	MAKOLA	Kagisho	M	Grade 05	5A	0174485266		English		NCHABELENG			Phelehlave	MAKOLA		
63	MAKOLA	Nhlamulo	F	Grade 01	1A	0722723971		English					Dimakatso	MAKOLA		
64	MAKOLA	Ofentse	F	Grade 07	7A	0604126344		English	Londrick	SEUPE			Getrude	MAKOLA		0711729998
65	MAKWEVERA	Kim	F	Grade 05	5A	0626130952		English					Judith	MAKWRVERA		
66	MALATA	Thego	F	Grade 03	3A	0715034732		English					Lerato	MALATA		0715034732
67	MALEBYE	Siyabonga	M	Grade 06	6A	0738974171		English					Juliah	MALEBYE		
68	MALEKA	Dumisile	M	Grade R	RA			English					Sannah	MALEKA		
69	MALEKE	Bokang	M	Grade R	RA	07239096		English					Petunia	MKABELA		
70	MALEPE	Phemelo	M	Grade 05	5A	0760891344		English					Maitumelo	MALEPE		
71	MAMPHOLO	Zwavhudi	M	Grade 05	5A	0765710251		English					Rebone	MAMPHOLO		0765710251
72	MANALA	Rethabile	F	Grade 01	1A	0728098382		English	Abrey				Matobole	MANALA		
73	MANCHIDI	Khutso	M	Grade 10	10A			English	Tjlamsgale	MANCHIDI		0670342063			
74	MANDEYA	Anashe	F	Grade 04	4A	0722864753		English	Kudakwashe	MANDEYA					
75	MANGANYE	Faith	F	Grade 03	3A	0711482175		English	Muzi				Maria	MANGANYE		
76	MANGENJANI	Cliff	M	Grade 09	9A			English	Clive	MANGENYANI			Lindiwe	NTULI		
77	MANGWATO	Kabelo	M	Grade 07	7A	0711128530		English	Thabang	LEPOTA		0724695759		MANGWATO		
78	MANYIKE	Kamogelo	F	Grade 02	2A	0768338293		English					Lindiwe	MANYIKE		
79	MANYIKE	Thandolwethu	M	Grade 04	4A	0604349048		English	Johannes	MAHLANGU			Phindile	MANYIKE		
80	MAREDI	Khumo	M	Grade 03	3A			English					Diana	MREDI		072261539
81	MAREDI	Stanley	M	Grade 07	7A	0835960702		English	Innocent				Diana	MAREDI		
82	MARIRI	Lethabo	M	Grade 09	9A	0606870046		English	Solomon	MOAGI			Penelope	MARIRI		0849011176
83	MARUFU	Tumelo	M	Grade 10	10A			English	Shepherrd	MARUFU					
84	MASHABA	Hlompho	M	Grade R	RA			English	Mashaba	MASHABA					
85	MASHABA	Kobeli	M	Grade 08	8A	0724811082		English					Mikateko	MASHABA		
86	MASHAYAMOMBE	Brian	M	Grade 03	3A	0743722612		English					Steve	MASHAYAMOMBE		
87	MASILELA	Dineo	F	Grade 03	3A	0790446054		English					Bathabile	MASILELA		
88	MASINGA	Oratilwe	F	Grade 02	2A	0719014898		English					Jane	MASINGA		
89	MASINGA	Rearabiloe	F	Grade 02	2A			English	Ngangamuni	MACHEKE					
90	MATEKOANE	Koketso	M	Grade 04	4A	0183642604		English	Bernard	MARAKALALA			Maria			
91	MATHEBULA	Lungile	F	Grade 10	10A	0796805801		English	James	MAHLALELA					
92	MATHEBULA	Rivoningo	F	Grade 07	7A	0710412798		English					Millie	MATHEBULA		
93	MATHEGA	Opelong	M	Grade 07	7A	0725791972		English	Rakwena				Dorcas	MATHEGA		072591972
94	MATSILA	Tebogo	F	Grade 09	9A	0614049594		English					Mapula	MATSILA		
95	MATSILA	Tlotliso	F	Grade 03	3A			English					Mapula	MATSILA		0814566424
96	MAUBANE	Thabang	F	Grade 07	7A	0823635652		English					Mokete	NYALUNGA		
97	MAUNGANIDZE	Constance	F	Grade 06	6A	0734267361		English	Douglas	MAUNGANIDZE			Mukunyu			
98	MAUNGANIDZE	Prosper	M	Grade 02	2A			English	Douglas	MAYUNGANIDZE					
99	MDLOVU	Makayla	M	Grade 02	2A	0781112438		English	Sibonelo	MPUNGOSE			Neglecia	MDLOVU		
100	MDLULI	Tshepo	M	Grade 10	10A			English					Koketso	MDLULI		
101	MENTOOR	Chuene	M	Grade 09	9A	0824397657		English					Lesego	MENTOOR		
102	MHANGANI	Rhulani	F	Grade 09	9A			English	Mpho	MHLANGANI			Dinah			
103	MHLABENI	Mnqobi	M	Grade 01	1A	0735939520		English					Judith	MHLABENI		
104	MNISI	Lehlogonolo	M	Grade 05	5A	0826878961		English	Johannes	MAMPANE		0796106158		MNISI		
105	MODIBA	Bokamoso	F	Grade 06	6A	0764797308		English	Moeti	MODIBA			Khaiso			
106	MOEKELETSI	Maropeng	M	Grade R	RA			English					Sebwana	MOEKELETSI		
107	MOFOKENG	Khuthitsho	F	Grade 02	2A	0722008854		English					Nation	MOFOKENG		0766132342
108	MOHLALA	Lesedi	F	Grade 06	6A	0799133695		English		MOHLALA			Letta	MOHLALA		0799105695
109	MOHLALA	Lesego	F	Grade 09	9A	0799105695		English	Joseph	MONIALA		0769543408	Joseph			
110	MOHLALA	Oratile	M	Grade 01	1A			English					Annah Mapula	MOHLALA		
111	MOHLAMONYANE	Dimakatso	F	Grade 09	9A	0762753972		English	Abram	MOLOANTOA					
112	MOKALAPA	Nomusa	F	Grade 03	3A	06996681		English		MAHLANGU			Mohlakwana	MOKALAPA		
113	MOKHOTHU	Lehlohonolo	M	Grade 02	2A			English	Simon	TSHABALALA		0606115934			
114	MOKOENA	Gryaor	M	Grade R	RA			English					Dina	MOKOENA		
115	MOKOENA	Owami	M	Grade 07	7A	0781443501		English					Anna	MOKOENA		
116	MOLEKWA	Christinah	F	Grade R	RA	0637441569		English	Jackson	NGWENYA			Zandile			
117	MOLOTO	Dimpho	F	Grade 06	6A			English					Grace	MOLOTO	gracemoloto3@gmail.com	0661885138
118	MONALE	Reabetswe	M	Grade 09	9A	0659428683		English					Tshepiso	MONALE		
119	MONAMA	Thami	M	Grade 10	10A	0713155135		English					Theresa	MONAMA		
120	MONYEKI	Mpho	M	Grade 10	10A	0765223412		English					Josephina	MONYEKI		
121	MOSOMA	Keitumetse	F	Grade 04	4A	0818634148		English					Forgiveness	MOSOMA		
122	MOSOMANE	Bokamoso	F	Grade 02	2A			English					Kgothatso	MOSOMANE	BOITUMELO.MOSOMANE@GMAIL.COM	0682357909
123	MOSOMANE	Keabetswe	F	Grade R	RA	0682357909		English					Kgothatso	MOSOMANE		
124	MOTENA	Njabulo	M	Grade 03	3A			English					Maria Connie	MOTEMA		
125	MOTLHODI	Rorisang	F	Grade R	RA			English					Matseko	MOTLHODI		
126	MOTONG	Kgotalo	F	Grade 03	3A			English					Winnie	MOTONG		0760162916
127	MOTONG	Kulani	M	Grade 05	5A			English					Winnie	MOTONG		0766916110
128	MPHAHLELE	Thabo	M	Grade 04	4A	0662579294		English	Sello	LETSOALO		0823520608			
129	MPHASHA	Matlala	M	Grade 03	3A	0818547003		English	Matome				Tintswalo	MPHASHA		
130	MTHIMUNYE	Ofentse	M	Grade 04	4A	0682406374		English	Tshite	MADIHLABA				MOKWANA		
131	MTSHWENE	Methembe	F	Grade 08	8A	0661812543		English					Jeaneth	MTSHWENE		
132	MUGORE	Dephine	F	Grade 04	4A			English					Kudzai	CHINGARANDE		
133	MUSUSA	Jayden	M	Grade 07	7A	0765983346		English	Muchineyi	MUSUSA			Dambaza	MAJURY		
134	MUSUSA	Sean	M	Grade 04	4A	0765983346		English	Muchineyi	MUSUSA					
135	MUTEMA	Ian	M	Grade 02	2A			English	Rodney	MUTEMA		0849678108	Sibmbisai	MUTEMA		0652106526
136	MUTYORARINGA	Lennon	M	Grade 07	7A	0723040849		English				0723060849	Stella	MUTYORARINGA		
137	MUTYORARINGA	Lennon	M	Grade 07	7A	0723040849		English					Stella	MUTYORARINGA		
138	MUZENDA	Joyce	F	Grade 06	6A	0847114393		English	Mazenda	EDISON			Patience	HOVE		
139	MZIMBA	Thapelo	M	Grade 08	8A	0842993607		English	Levy	MZIMBA		0820403170	Adolphin			
140	NAZO	Owethu	F	Grade R	RA			English	Siyabonga	NAZO					
141	NCUBE	Chriselda	F	Grade 05	5A	0789818509		English	Sifiso	NCUBE			Nomsa	KUTUDZA		
142	NCUBE	Mpumelelo	M	Grade 07	7A	0624284401		English					Moreblessing	NTINI		
143	NDABA	Molemo	M	Grade R	RA	0793209815		English	Joel	RAMOSHABA			Priscilla	NDABA		
144	NDALA	Leonard	M	Grade 07	7A	0729465451		English					Martha	NDAL		
145	NDHLOVU	Palesa	F	Grade 08	8A	0674967607		English					Assah	NDHLOVU		0712949125
146	NDLELA	Iminathi	M	Grade 08	8A	0655565886		English	sefso				Neziswa	NOBANGELA		
147	NDLOVU	Innocent	M	Grade 04	4A	067610360		English	Ephios	MATSANE		0762805947			
148	NDLOVU	Nelson	M	Grade 04	4A	0604800281		English					Amanda	NDLOVU		
149	NDOU	Kevin	M	Grade R	RA			English					Emily	NDOU		
150	NDOU	Mutondi	F	Grade 02	2A			English					Lerato	NDOU		
151	NDOU	Vendros	M	Grade R	RA			English					Emily	NDOU		
152	NDUKULU	Isabella	F	Grade R	RA			English					Mashudu	NDUKULU		
153	NGOBENI	Princess	F	Grade 03	3A			English					Mihloti	NGOENI		0786770806
154	NGOMANE	Nosibusiso	F	Grade 05	5A	0897288019		English	Sizo	NGOMANE					
155	NGWENYAMA	Phillip	M	Grade 10	10A	0699037446		English					Clever	NGWENYAMA		
156	NHAMBI	Jimmy	M	Grade 03	3A			English	Moses	NTHAMBI					
157	NKABINDE	Ofentse	F	Grade 02	2A			English					Nonhlanhla	NKABINDE		
158	NKADIMENG	Thabang	M	Grade 09	9A	0682875371		English					Itumeleng	NKADIMENG	THATO.MOKWENA@GMAIL.COM	0782552261
159	NKOANA	Tlotlang	F	Grade 05	5A	0798992865		English					Stella	NKOANA		
160	NKUNA	Ntsako	M	Grade 02	2A	0791674875		English					Marry	NKUNA		0660616578
161	NKWE	Mohau	F	Grade 04	4A	0721181022		English					Mpuseng	NKWE		
162	NTULI	Ntokozo	F	Grade 06	6A	0810515455		English	Bridgt				Simphiwe	NTULI		
163	NTULI	Ntokozo	F	Grade 06	6A	0810515455		English					Simphiwe	NTULI		
164	NYADZANI	Ompha	F	Grade 02	2A			English	Avhatakali Lesley	NYADZANI		0765063317			
165	NYAMANE	Mackyla	F	Grade 05	5A	0764788227		English					Silvence Sebongile	NYAMANE		0764788227
166	NYAMAROPA	Nyasha	F	Grade 02	2A			English	Forward	NYAMAROPA		0611075328	Sibusisiwe	HLONGWANE	HLONGWANEBUSI@GMAIL.COM	
167	NYARUVEMBO	Sonia	F	Grade 03	3A	0746200360		English	Taban	NYARUVEMBO					
168	PAPO	Reitumetse	F	Grade 09	9A	0605576391		English					Onicca	PAPO		
169	PHALANE	Serogole	F	Grade 10	10A	0722172577		English					Thuru	PHALANE		
170	PHALANE	Tumelo	M	Grade 09	9A	0766820226		English					Joyce	PHALANE		0860497999
171	PHETLA	Gift	M	Grade 05	5A	0725691292		English	Melusi				Florence	NCUBE		
172	PHIRI	Alemekezeke	F	Grade R	RA			English	Lefa P	PHIRI					
173	PHIRI	Onthatile	F	Grade 10	10A			English					Ayanda	PHIRI		
174	RAKGALAKANE	Thabo	M	Grade 03	3A			English					Suzan	RAKGALAKANE		
175	RAKGOTHO	Thapelo	M	Grade 03	3A			English	Thabo	RAKGOTHO		0722599853			
176	RAKOMA	Amogelang	M	Grade 10	10A	0608079614		English					Lesego	RAKOMA		0726501927
177	RAMOKGATLA	Bokamoso	M	Grade 02	2A	0822952941		English	Karinne				Thoko	RAMOKGATLA		0606411435
178	RAMOKGOPA	Katlego	M	Grade 08	8A	0839464815		English	Mack				Mmapula	RAMOKGOPA		
179	RATSHIVHADELO	Oluga	F	Grade 03	3A	0715663036		English	Mashudu	RATSHIVHADELO					
180	SADIKGE	Khuliso	M	Grade 03	3A	0820806467		English	Mulalo	SADIKGE				NGAKO		
181	SEEMA	Fezile	M	Grade 05	5A	0728450730		English	Raymond	MASEMOLA					
182	SEFAKO	Thandeka	F	Grade 05	5A	0679277866		English	Banny				Ivy	SEFAKO		
183	SEGODI	Masego Kayla	F	Grade R	RA			English					Nthabiseng Revien	SEGODI		
184	SELEKA	Amohelang	M	Grade 06	6A	0729898507		English					Zondi	SELEKA		
185	SELEMELA	Tshegofatso	F	Grade 09	9A			English	Mashilo	MAGORO					
186	SELEPE	Karabo	M	Grade 07	7A	0716231064		English					Pinky	SELEPE		
187	SERETLO	Odirile	M	Grade 10	10A	0828725943		English	Thabiso				Letta	NYAKALE		
188	SESHWENG	Kgasietsile	M	Grade 01	1A			English					Mphedi	SESHANG		
189	SGUDLA	Justice	M	Grade 09	9A	0768027363		English	Mlungisi	TAITO					
190	SHIBAMBU	Nkateko	F	Grade 05	5A	0615365661		English	Lazarus	SHIBAMBO			Vironica	MKHONDO		
191	SHUMBA	Nelson	M	Grade 09	9A	0814964733		English	Moses	SHUMBA		0826433477		NDABA		
192	SHUMBA	Zakhele	M	Grade 10	10A			English					Thoko	RAMAKGATLA		0820870157
193	SIMBINI	Amokelani	M	Grade 09	9A			English					Mamiki	SIMBINI		07907196
194	SINGO	Vhuthu	F	Grade 05	5A			English	Livhuwani Rodney	SINGO		0731273422				0832702980
195	SKOSANA	Ngobile	F	Grade 08	8A	0722469383		English	Percy	TJIANE		0617629522			
196	TAU	Happiness	M	Grade 03	3A	0791514602		English	Eric	THUBANE					
197	THOBAKGALE	Atlegang	M	Grade 10	10A	0824362308		English					Mashego	THOBAKGALE		
198	TICK	Angel	F	Grade 09	9A	0787114211		English	Jackson	TICK			Nleya			
199	TICK	Samuel	M	Grade 02	2A			English	Jackson	TICK	N/A	0761294251			HANNAHNBEYA@GMAIL.COM	0625398674
200	TJALE	Tokollo	M	Grade 08	8A	0796175000		English					Vellery	TJALE		
201	TLADI	Boitumelo	F	Grade 05	5A	0825463158		English	Thabo	MOKWANA					
202	TLADI	Masego	M	Grade 01	1A	0825463158		English	Thabo	MOKWANA					
203	TLADI	Steve	M	Grade 09	9A	0825443158		English	Thabo				Nancy	TLADI		0825463158
204	TWALA	Asimbonge	F	Grade 04	4A	0796522700		English					Ns	TWALA		
205	TYULU	Ikhona	F	Grade 07	7A	0648223127		English					Ntombie	TYULU		0648223127
206	XABA	Nqobile	F	Grade R	RA	0793583738		English					Nonkululeko	XABA		
207	XOZWA	Precious	F	Grade 02	2A	0723537400		English	George	LEBISI			Tembi	XOZWA		
208	YUDA	Keagan	M	Grade 01	1A			English					Mitchelle	MASHONGANYIKA		
209	ZIMBWA	Agnes	F	Grade 04	4A	0653625473		English	Kudakwashe	ZIMBWA		0691569583	Tenda			
210	ZINDERE	Wajeed	M	Grade 03	3A	0739945030		English					Jane	ZINDERE		
211	ZINDERE	Waleed	M	Grade 03	3A	0836213919		English					Jane	ZINDERE		
212	ZINDERE	Yasmis	F	Grade 09	9A	0832321195		English					Jane	ZINDERE		
213	ZWANE	Nqubeko	F	Grade 09	9A			English					Brenda	ZWANE`;
            
            // Parse the raw data
            const lines = rawStudentData.trim().split('\n');
            const initialAdmissions = [];
            
            lines.forEach(line => {
                const parts = line.split('\t');
                if (parts.length >= 9) {
                    const admission = {
                        accession: parts[0].trim(),
                        surname: parts[1].trim(),
                        firstName: parts[2].trim(),
                        gender: parts[3].trim(),
                        grade: parts[4].trim(),
                        classValue: parts[5].trim(),
                        cell: parts[6].trim(),
                        email: parts[7].trim(),
                        homeLanguage: parts[8].trim(),
                        fatherName: parts.length > 9 ? parts[9].trim() : '',
                        fatherSurname: parts.length > 10 ? parts[10].trim() : '',
                        fatherEmail: parts.length > 11 ? parts[11].trim() : '',
                        fatherCell: parts.length > 12 ? parts[12].trim() : '',
                        motherName: parts.length > 13 ? parts[13].trim() : '',
                        motherSurname: parts.length > 14 ? parts[14].trim() : '',
                        motherEmail: parts.length > 15 ? parts[15].trim() : '',
                        motherCell: parts.length > 16 ? parts[16].trim() : ''
                    };
                    initialAdmissions.push(admission);
                }
            });
            
            // Add all parsed admissions to the system
            initialAdmissions.forEach(admission => {
                const id = Date.now() + Math.random();
                const name = admission.firstName + ' ' + admission.surname;
                admissions.push({
                    id,
                    name,
                    ...admission,
                    username: '',
                    password: '',
                    status: 'Pending',
                    saSamsFormat: true
                });
                
                // Also add to students array for Student Information System
                students.push({
                    id,
                    name,
                    ...admission,
                    parent: admission.motherName + ' ' + admission.motherSurname,
                    status: 'Active',
                    educator: '',
                    saSamsFormat: true
                });
            });
            
            saveData();
            console.log(`Initialized ${initialAdmissions.length} students in admission and student information systems`);
        }
        // Generate demo data
        function generateDemoData() {
            // Demo data if needed
            saveData();
        }
        // Integrate educators from students as staff
        function integrateEducatorsAsStaff() {
            const educators = [...new Set(students.map(s => s.educator).filter(e => e && e !== 'Unknown'))];
            educators.forEach(educator => {
                if (!staff.find(s => s.name === educator)) {
                    const id = Date.now() + Math.random();
                    staff.push({
                        id,
                        name: educator,
                        role: 'Teacher',
                        department: 'Education',
                        salary: 30000,
                        taxNumber: 'T' + Date.now(),
                        uifNumber: 'U' + Date.now(),
                        certExpiry: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0],
                        status: 'Active'
                    });
                    users.push({
                        username: educator.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000),
                        password: 'teacher' + Math.floor(Math.random() * 1000),
                        name: educator,
                        role: 'Teacher'
                    });
                }
            });
            saveData();
        }
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('admissions', JSON.stringify(admissions));
            localStorage.setItem('fees', JSON.stringify(fees));
            localStorage.setItem('timetable', JSON.stringify(timetable));
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('staff', JSON.stringify(staff));
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
            localStorage.setItem('jobs', JSON.stringify(jobs));
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            localStorage.setItem('contents', JSON.stringify(contents));
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('announcements', JSON.stringify(announcements));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('hrSettings', JSON.stringify(hrSettings));
            localStorage.setItem('smsSettings', JSON.stringify(smsSettings));
            localStorage.setItem('chatGPTSettings', JSON.stringify(chatGPTSettings));
            localStorage.setItem('grokSettings', JSON.stringify(grokSettings));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            localStorage.setItem('lessonPlans', JSON.stringify(lessonPlans));
            localStorage.setItem('grades', JSON.stringify(grades));
            localStorage.setItem('resources', JSON.stringify(resources));
            localStorage.setItem('uploadedWork', JSON.stringify(uploadedWork));
            localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents));
            localStorage.setItem('dataVault', JSON.stringify(dataVault));
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
            localStorage.setItem('adminMessages', JSON.stringify(adminMessages));
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
            localStorage.setItem('schoolEvents', JSON.stringify(schoolEvents));
            localStorage.setItem('meetingRequests', JSON.stringify(meetingRequests));
            localStorage.setItem('incidentReports', JSON.stringify(incidentReports));
            localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
        }
        // Login function
        function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            let user = users.find(u => u.username === username && u.password === password);
            if (!user) {
                const fallback = {
                    'admin': { name: 'Admin User', role: 'Admin' },
                    'teacher': { name: 'Teacher User', role: 'Teacher' },
                    'parent': { name: 'Parent User', role: 'Parent' },
                    'student': { name: 'Student User', role: 'Student' }
                }[username];
                if (fallback && password === username + '123') {
                    user = fallback;
                }
            }
            if (user) {
                currentUser = user;
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('appContainer').style.display = 'block';
                updateVisibility();
                loadData();
                loadDashboard();
                renderHR();
                populateSelects();
                addNotification('Welcome back, ' + user.name + '!', 'info');
            } else {
                alert('Invalid credentials');
            }
        }
        // Biometric Login
        function biometricLogin() {
            alert('Biometric login simulated. Using default admin login.');
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            login();
        }
        // Update visibility
        function updateVisibility() {
            if (!currentUser) return;
            const role = currentUser.role.toLowerCase();
            // First, show/hide based on non-student class
            document.querySelectorAll('.non-student').forEach(el => el.style.display = role !== 'student' ? 'block' : 'none');
            // Then apply specific role restrictions (these override non-student)
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = role === 'teacher' ? 'block' : 'none');
            document.querySelectorAll('.parent-only').forEach(el => el.style.display = role === 'parent' ? 'block' : 'none');
            document.querySelectorAll('.student-only').forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
        }
        // Show section
        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
            document.getElementById(section).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            if (window.event && event.target) {
                event.target.closest('a').classList.add('active');
            }
            switch (section) {
                case 'dashboard': loadDashboard(); break;
                case 'admission': renderAdmissions(); break;
                case 'students': renderStudents(); break;
                case 'attendance': loadAttendance(); break;
                case 'fees': renderFees(); break;
                case 'timetable': loadTimetable(); break;
                case 'teachers': renderTeachers(); break;
                case 'exams': renderExams(); break;
                case 'hr': renderHR(); break;
                case 'communication': renderMessages(); break;
                case 'eventsManagement': loadEventsManagement(); break;
                case 'content': renderContents(); break;
                case 'reports': break;
                case 'settings': loadSettings(); updateVaultMetrics(); break;
                case 'parentPortal': loadParentPortal(); break;
                case 'aiResearch': loadResearchHistory(); break;
                case 'studentTimetable': loadStudentTimetable(); break;
                case 'studentExamination': loadStudentExamination(); break;
                case 'studentInbox': loadStudentInbox(); break;
                case 'studentUploadWork': loadStudentUploadWork(); break;
            }
        }
        // Toggle Sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const btn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
        }
        // Logout
        function logout() {
            currentUser = null;
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('username').value = '';
            document.getElementById('password').value = '';
        }
        // Populate selects
        function populateSelects() {
            // Students
            const studentSelects = document.querySelectorAll('select[id*="Student"], select[id*="student"]');
            studentSelects.forEach(select => {
                if (select.id === 'invoiceStudent') {
                    select.innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
                }
            });
            // Staff
            const staffSelects = document.querySelectorAll('select[id*="Staff"], select[id*="staff"]');
            staffSelects.forEach(select => {
                select.innerHTML = staff.map(s => `<option value="${s.id}">${s.name} (${s.role})</option>`).join('');
            });
            // Grades
            const gradeSelects = document.querySelectorAll('select[id*="Grade"], select[id*="grade"]');
            gradeSelects.forEach(select => {
                if (select.id === 'timetableGrade' || select.id === 'examGrade' || select.id === 'timeSlotGrade') {
                    select.innerHTML = '<option value="">Select Grade</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
                }
            });
            // Attendance class
            document.getElementById('attendanceClass').innerHTML = '<option value="">All Classes</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Bulk class
            document.getElementById('bulkClass').innerHTML = '<option value="">All Classes</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Timetable teacher
            document.getElementById('timetableTeacher').innerHTML = '<option value="">Select Teacher</option>' + staff.filter(s => s.role === 'Teacher').map(t => `<option value="${t.name}">${t.name}</option>`).join('');
            // Exam grade filter
            document.getElementById('examGradeFilter').innerHTML = '<option value="">All Grades</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            // Apply job select
            document.getElementById('applyJobSelect').innerHTML = jobs.filter(j => j.status === 'Open').map(j => `<option value="${j.id}">${j.title}</option>`).join('');
            // Leave staff, review staff, payroll staff
            ['leaveStaff', 'reviewStaff', 'payrollStaff'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.innerHTML = staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
            // Grading student
            document.getElementById('gradeStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            // Progress student
            document.getElementById('progressStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            // Grading class
            document.getElementById('gradingClass').innerHTML = '<option value="">Select Class</option>' + [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
        }
        // Dashboard
        // Real-time dashboard update interval
        let dashboardUpdateInterval = null;
        
        function loadDashboard() {
            updateDashboardMetrics();
            
            // Set up real-time updates every 30 seconds
            if (dashboardUpdateInterval) {
                clearInterval(dashboardUpdateInterval);
            }
            dashboardUpdateInterval = setInterval(() => {
                if (document.getElementById('dashboard').classList.contains('d-none')) {
                    // Dashboard is not visible, stop updating
                    clearInterval(dashboardUpdateInterval);
                    dashboardUpdateInterval = null;
                } else {
                    updateDashboardMetrics();
                }
            }, 30000); // Update every 30 seconds
        }
        
        function updateDashboardMetrics() {
            document.getElementById('totalStudents').textContent = students.length;
            const today = new Date().toISOString().split('T')[0];
            const todayAttendance = attendanceRecords[today] || {};
            const present = Object.values(todayAttendance).filter(a => a.status === 'Present').length;
            const attendanceRate = students.length > 0 ? Math.round((present / students.length) * 100) : 0;
            document.getElementById('todayAttendance').textContent = attendanceRate + '%';
            const pendingFeesTotal = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            document.getElementById('pendingFees').textContent = 'R' + pendingFeesTotal.toLocaleString();
            const upcomingExamsCount = exams.filter(e => new Date(e.date) > new Date() && e.status === 'Scheduled').length;
            document.getElementById('upcomingExams').textContent = upcomingExamsCount;
            document.getElementById('totalStaffDash').textContent = staff.length;
            const pendingLeavesCount = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('pendingLeavesDash').textContent = pendingLeavesCount;
            document.getElementById('openPositionsDash').textContent = jobs.filter(j => j.status === 'Open').length;
            const avgPerformance = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
            document.getElementById('avgPerformanceDash').textContent = avgPerformance + '%';
            
            // Update last refresh time indicator
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            let refreshIndicator = document.getElementById('dashboardRefreshTime');
            if (!refreshIndicator) {
                // Create refresh time indicator if it doesn't exist
                const dashboardSection = document.querySelector('#dashboard h2');
                if (dashboardSection) {
                    refreshIndicator = document.createElement('small');
                    refreshIndicator.id = 'dashboardRefreshTime';
                    refreshIndicator.className = 'text-muted ms-3';
                    refreshIndicator.style.fontSize = '0.7rem';
                    dashboardSection.appendChild(refreshIndicator);
                }
            }
            if (refreshIndicator) {
                refreshIndicator.innerHTML = `<i class="fas fa-sync-alt me-1"></i>Last updated: ${timeStr}`;
            }
            
            // Chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Staff', 'Pending Fees', 'Upcoming Exams'],
                    datasets: [{
                        data: [students.length, staff.length, pendingFeesTotal / 1000, upcomingExamsCount],
                        backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0']
                    }]
                },
                options: { responsive: true }
            });
        }
        
        // Trigger dashboard update when data changes
        function triggerDashboardUpdate() {
            if (!document.getElementById('dashboard').classList.contains('d-none')) {
                updateDashboardMetrics();
            }
        }
        // Import Class List from MX-4051 PDF
        function importClassListFromPDF() {
            mx4051Data.forEach(data => {
                const id = Date.now() + Math.random();
                const name = `${data.surname}, ${data.first_name}`;
                const grade = data.class;
                const parent = 'Parent ' + data.surname; // Mock
                const accession = data.accession;
                const educator = data.educator;
                if (!students.find(s => s.accession === accession)) {
                    students.push({
                        id,
                        name,
                        grade,
                        parent,
                        status: 'Active',
                        accession,
                        educator
                    });
                }
            });
            saveData();
            renderStudents();
            integrateEducatorsAsStaff();
            addNotification('MX-4051 class list imported successfully', 'success');
        }
        // Teachers Module
        function renderTeachers() {
            // Default to lesson plans
            renderLessonPlans();
        }
        function renderLessonPlans() {
            document.getElementById('lessonPlansList').innerHTML = lessonPlans.map(lp => `
                <div class="lesson-plan">
                    <h5>${lp.title}</h5>
                    <p><strong>Subject:</strong> ${lp.subject} | <strong>Date:</strong> ${lp.date}</p>
                    <p><strong>Objectives:</strong> ${lp.objectives}</p>
                    <p><strong>Activities:</strong> ${lp.activities}</p>
                    <p><strong>Materials:</strong> ${lp.materials}</p>
                    <button class="btn btn-sm btn-warning" onclick="editLessonPlan(${lp.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteLessonPlan(${lp.id})">Delete</button>
                </div>
            `).join('');
        }
        function showAddLessonPlanModal() {
            new bootstrap.Modal(document.getElementById('addLessonPlanModal')).show();
        }
        function saveLessonPlan() {
            const title = document.getElementById('lessonTitle').value;
            const subject = document.getElementById('lessonSubject').value;
            const date = document.getElementById('lessonDate').value;
            const objectives = document.getElementById('lessonObjectives').value;
            const activities = document.getElementById('lessonActivities').value;
            const materials = document.getElementById('lessonMaterials').value;
            if (title && subject && date) {
                const id = Date.now();
                lessonPlans.push({ id, title, subject, date, objectives, activities, materials });
                saveData();
                renderLessonPlans();
                bootstrap.Modal.getInstance(document.getElementById('addLessonPlanModal')).hide();
                addNotification('Lesson plan added', 'success');
            }
        }
        function editLessonPlan(id) {
            const lp = lessonPlans.find(l => l.id === id);
            if (lp) {
                document.getElementById('lessonTitle').value = lp.title;
                document.getElementById('lessonSubject').value = lp.subject;
                document.getElementById('lessonDate').value = lp.date;
                document.getElementById('lessonObjectives').value = lp.objectives;
                document.getElementById('lessonActivities').value = lp.activities;
                document.getElementById('lessonMaterials').value = lp.materials;
                // Override save
                const saveBtn = document.querySelector('#addLessonPlanModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => updateLessonPlan(id);
                new bootstrap.Modal(document.getElementById('addLessonPlanModal')).show();
            }
        }
        function updateLessonPlan(id) {
            const lp = lessonPlans.find(l => l.id === id);
            if (lp) {
                lp.title = document.getElementById('lessonTitle').value;
                lp.subject = document.getElementById('lessonSubject').value;
                lp.date = document.getElementById('lessonDate').value;
                lp.objectives = document.getElementById('lessonObjectives').value;
                lp.activities = document.getElementById('lessonActivities').value;
                lp.materials = document.getElementById('lessonMaterials').value;
                saveData();
                renderLessonPlans();
                addNotification('Lesson plan updated', 'success');
            }
            bootstrap.Modal.getInstance(document.getElementById('addLessonPlanModal')).hide();
            const saveBtn = document.querySelector('#addLessonPlanModal .btn-primary');
            saveBtn.textContent = 'Save';
            saveBtn.onclick = saveLessonPlan;
        }
        function deleteLessonPlan(id) {
            if (confirm('Delete lesson plan?')) {
                lessonPlans = lessonPlans.filter(l => l.id !== id);
                saveData();
                renderLessonPlans();
                addNotification('Lesson plan deleted', 'danger');
            }
        }
        function renderGrading() {
            const classFilter = document.getElementById('gradingClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            document.getElementById('gradingTable').innerHTML = filteredStudents.map(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                return `
                    <tr>
                        <td>${s.name}</td>
                        <td>Math</td> <!-- Mock subject -->
                        <td>${studentGrades[0]?.score || ''}</td>
                        <td>${studentGrades[0]?.comments || ''}</td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAddGradeModal(${s.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }
        function showAddGradeModal(studentId) {
            if (studentId) document.getElementById('gradeStudent').value = studentId;
            new bootstrap.Modal(document.getElementById('addGradeModal')).show();
        }
        function saveGrade() {
            const studentId = parseInt(document.getElementById('gradeStudent').value);
            const subject = document.getElementById('gradeSubject').value;
            const score = parseFloat(document.getElementById('gradeScore').value);
            const comments = document.getElementById('gradeComments').value;
            if (studentId && subject && score) {
                const id = Date.now();
                grades.push({ id, studentId, subject, score, comments });
                saveData();
                renderGrading();
                bootstrap.Modal.getInstance(document.getElementById('addGradeModal')).hide();
                addNotification('Grade added', 'success');
            }
        }
        function renderResources() {
            document.getElementById('resourcesList').innerHTML = resources.map(r => `
                <div class="lesson-plan">
                    <h5>${r.title}</h5>
                    <p><strong>Type:</strong> ${r.type} | <strong>URL:</strong> <a href="${r.url}" target="_blank">${r.url}</a></p>
                    <p>${r.description}</p>
                    <button class="btn btn-sm btn-warning" onclick="editResource(${r.id})">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="deleteResource(${r.id})">Delete</button>
                </div>
            `).join('');
        }
        function showAddResourceModal() {
            new bootstrap.Modal(document.getElementById('addResourceModal')).show();
        }
        function saveResource() {
            const title = document.getElementById('resourceTitle').value;
            const url = document.getElementById('resourceUrl').value;
            const type = document.getElementById('resourceType').value;
            const description = document.getElementById('resourceDescription').value;
            if (title && url) {
                const id = Date.now();
                resources.push({ id, title, url, type, description });
                saveData();
                renderResources();
                bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
                addNotification('Resource added', 'success');
            }
        }
        function editResource(id) {
            // Similar to editLessonPlan
            const r = resources.find(res => res.id === id);
            if (r) {
                document.getElementById('resourceTitle').value = r.title;
                document.getElementById('resourceUrl').value = r.url;
                document.getElementById('resourceType').value = r.type;
                document.getElementById('resourceDescription').value = r.description;
                // Override save
                const saveBtn = document.querySelector('#addResourceModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    r.title = document.getElementById('resourceTitle').value;
                    r.url = document.getElementById('resourceUrl').value;
                    r.type = document.getElementById('resourceType').value;
                    r.description = document.getElementById('resourceDescription').value;
                    saveData();
                    renderResources();
                    bootstrap.Modal.getInstance(document.getElementById('addResourceModal')).hide();
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveResource;
                };
                new bootstrap.Modal(document.getElementById('addResourceModal')).show();
            }
        }
        function deleteResource(id) {
            if (confirm('Delete resource?')) {
                resources = resources.filter(r => r.id !== id);
                saveData();
                renderResources();
                addNotification('Resource deleted', 'danger');
            }
        }
        function renderStudentProgress() {
            const studentId = parseInt(document.getElementById('progressStudent').value);
            if (studentId) {
                const studentGrades = grades.filter(g => g.studentId === studentId);
                const ctx = document.getElementById('progressChart').getContext('2d');
                if (progressChart) progressChart.destroy();
                progressChart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: studentGrades.map(g => g.subject),
                        datasets: [{
                            label: 'Scores',
                            data: studentGrades.map(g => g.score),
                            backgroundColor: '#36A2EB'
                        }]
                    },
                    options: { responsive: true }
                });
                document.getElementById('progressDetails').innerHTML = studentGrades.map(g => `
                    <p><strong>${g.subject}:</strong> ${g.score} - ${g.comments}</p>
                `).join('');
            }
        }
        function loadStudentProgress() {
            renderStudentProgress();
        }

        // Upload Work Functions
        function renderUploadWork() {
            // Populate classes
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('workClass').innerHTML = '<option value="">Select Class</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
            
            // Display uploaded work
            document.getElementById('uploadedWorkList').innerHTML = uploadedWork.length > 0 ? 
                uploadedWork.map(w => `
                    <div class="report-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><i class="fas fa-file me-2"></i>${w.title}</h6>
                                <p class="mb-1"><small>Class: ${w.class} | Uploaded: ${w.uploadDate}</small></p>
                                <p class="mb-1"><small>${w.description}</small></p>
                                <p class="mb-0"><small>Files: ${w.files.map(f => f.name).join(', ')}</small></p>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteWorkFile(${w.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') : 
                '<p class="text-muted">No uploaded work files yet.</p>';
        }

        function uploadWorkFile() {
            const files = document.getElementById('workFileUpload').files;
            const title = document.getElementById('workTitle').value;
            const workClass = document.getElementById('workClass').value;
            const description = document.getElementById('workDescription').value;

            if (!files || files.length === 0) {
                addNotification('Please select at least one file', 'warning');
                return;
            }
            if (!title) {
                addNotification('Please enter a title', 'warning');
                return;
            }

            const fileList = [];
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                // Check file type
                const validTypes = ['.csv', '.pdf', '.doc', '.docx', '.xls', '.xlsx'];
                const fileExt = '.' + file.name.split('.').pop().toLowerCase();
                if (!validTypes.includes(fileExt)) {
                    addNotification(`Invalid file type: ${file.name}. Please use CSV, PDF, Word, or Excel files.`, 'danger');
                    continue;
                }
                fileList.push({
                    name: file.name,
                    size: file.size,
                    type: file.type
                });
            }

            if (fileList.length === 0) {
                addNotification('No valid files to upload', 'danger');
                return;
            }

            const id = Date.now();
            uploadedWork.push({
                id,
                title,
                class: workClass,
                description,
                files: fileList,
                uploadDate: new Date().toLocaleDateString(),
                uploadedBy: currentUser.name
            });

            saveData();
            renderUploadWork();

            // Clear form
            document.getElementById('workFileUpload').value = '';
            document.getElementById('workTitle').value = '';
            document.getElementById('workClass').value = '';
            document.getElementById('workDescription').value = '';

            addNotification(`Uploaded ${fileList.length} file(s) successfully`, 'success');
        }

        function deleteWorkFile(id) {
            if (confirm('Are you sure you want to delete this work file?')) {
                uploadedWork = uploadedWork.filter(w => w.id !== id);
                saveData();
                renderUploadWork();
                addNotification('Work file deleted', 'success');
            }
        }

        // Calendar Functions
        function renderCalendar() {
            const monthInput = document.getElementById('calendarMonth').value;
            const currentMonth = monthInput ? new Date(monthInput + '-01') : new Date();
            
            // Generate calendar
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            // Empty cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === currentDate);
                
                calendarHTML += `<td class="timetable-cell" style="height: 100px; vertical-align: top; cursor: pointer;" onclick="showDayEvents('${currentDate}')">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayEvents.length > 0) {
                    dayEvents.forEach(e => {
                        const colors = {
                            'Class': '#36A2EB',
                            'Meeting': '#FFCE56',
                            'Exam': '#FF6384',
                            'Event': '#4BC0C0',
                            'Deadline': '#FF9F40'
                        };
                        const color = colors[e.type] || '#cccccc';
                        calendarHTML += `<div style="background: ${color}; padding: 2px; margin: 2px 0; border-radius: 3px; font-size: 0.75rem;" title="${e.title} - ${e.time}">
                            ${e.title}
                        </div>`;
                    });
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            // Fill remaining cells
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('calendarView').innerHTML = calendarHTML;
            
            // Render upcoming events
            const today = new Date().toISOString().split('T')[0];
            const upcoming = calendarEvents
                .filter(e => e.date >= today)
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(0, 5);
            
            document.getElementById('upcomingEventsList').innerHTML = upcoming.length > 0 ?
                upcoming.map(e => `
                    <div class="report-card mb-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><span class="badge" style="background: ${getEventColor(e.type)}">${e.type}</span> ${e.title}</h6>
                                <p class="mb-1"><small><i class="fas fa-calendar me-1"></i>${e.date} at ${e.time}</small></p>
                                <p class="mb-0"><small>${e.description}</small></p>
                            </div>
                            <button class="btn btn-sm btn-danger" onclick="deleteCalendarEvent(${e.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `).join('') :
                '<p class="text-muted">No upcoming events.</p>';
        }

        function getEventColor(type) {
            const colors = {
                'Class': '#36A2EB',
                'Meeting': '#FFCE56',
                'Exam': '#FF6384',
                'Event': '#4BC0C0',
                'Deadline': '#FF9F40'
            };
            return colors[type] || '#cccccc';
        }

        function showDayEvents(date) {
            const dayEvents = calendarEvents.filter(e => e.date === date);
            if (dayEvents.length === 0) {
                addNotification(`No events on ${date}`, 'info');
            } else {
                let message = `Events on ${date}:\n`;
                dayEvents.forEach(e => {
                    message += `\n${e.time} - ${e.title} (${e.type})`;
                });
                alert(message);
            }
        }

        function showAddCalendarEventModal() {
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventType').value = 'Class';
            document.getElementById('eventDescription').value = '';
            new bootstrap.Modal(document.getElementById('addCalendarEventModal')).show();
        }

        function saveCalendarEvent() {
            const title = document.getElementById('eventTitle').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const type = document.getElementById('eventType').value;
            const description = document.getElementById('eventDescription').value;

            if (!title || !date || !time) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }

            const id = Date.now();
            calendarEvents.push({
                id,
                title,
                date,
                time,
                type,
                description,
                createdBy: currentUser.name
            });

            saveData();
            renderCalendar();
            bootstrap.Modal.getInstance(document.getElementById('addCalendarEventModal')).hide();
            addNotification('Calendar event added', 'success');
        }

        function deleteCalendarEvent(id) {
            if (confirm('Are you sure you want to delete this event?')) {
                calendarEvents = calendarEvents.filter(e => e.id !== id);
                saveData();
                renderCalendar();
                addNotification('Calendar event deleted', 'success');
            }
        }

        // HR Services Functions for Teachers
        function renderHRServices() {
            renderLeaveCalendar();
            renderMyLeaveRequests();
        }

        function renderLeaveCalendar() {
            const monthInput = document.getElementById('leaveCalendarMonth');
            if (!monthInput.value) {
                monthInput.value = new Date().toISOString().slice(0, 7);
            }
            const currentMonth = new Date(monthInput.value + '-01');
            
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayLeaves = leaves.filter(l => l.startDate <= currentDate && l.endDate >= currentDate && l.staff === currentUser.name);
                
                calendarHTML += `<td class="text-center" style="height: 80px; vertical-align: top;">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayLeaves.length > 0) {
                    calendarHTML += `<div style="background: #FF6384; padding: 2px; margin: 2px; border-radius: 3px; font-size: 0.7rem;">Leave</div>`;
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('leaveCalendarView').innerHTML = calendarHTML;
        }

        function renderMyLeaveRequests() {
            const myLeaves = leaves.filter(l => l.staff === currentUser.name);
            document.getElementById('myLeaveRequestsTable').innerHTML = myLeaves.length > 0 ? myLeaves.map(l => `
                <tr>
                    <td>${l.type}</td>
                    <td>${l.startDate}</td>
                    <td>${l.endDate}</td>
                    <td>${l.days}</td>
                    <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Pending' ? 'warning' : 'danger'}">${l.status}</span></td>
                    <td>
                        ${l.status === 'Pending' ? `<button class="btn btn-sm btn-danger" onclick="cancelLeaveRequest(${l.id})">Cancel</button>` : ''}
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="text-center text-muted">No leave requests found.</td></tr>';
        }

        function showApplyLeaveModal() {
            const modalHTML = `
                <div class="modal fade" id="applyLeaveModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Apply for Leave</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Leave Type</label>
                                    <select id="leaveType" class="form-control">
                                        <option value="Annual">Annual Leave</option>
                                        <option value="Sick">Sick Leave</option>
                                        <option value="Personal">Personal Leave</option>
                                        <option value="Maternity">Maternity Leave</option>
                                        <option value="Study">Study Leave</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" id="leaveStartDate" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">End Date</label>
                                    <input type="date" id="leaveEndDate" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Reason</label>
                                    <textarea id="leaveReason" class="form-control" rows="3"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="submitLeaveRequest()">Submit</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('applyLeaveModal'));
            modal.show();
            document.getElementById('applyLeaveModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function submitLeaveRequest() {
            const type = document.getElementById('leaveType').value;
            const startDate = document.getElementById('leaveStartDate').value;
            const endDate = document.getElementById('leaveEndDate').value;
            const reason = document.getElementById('leaveReason').value;

            if (!startDate || !endDate || !reason) {
                addNotification('Please fill in all fields', 'warning');
                return;
            }

            const start = new Date(startDate);
            const end = new Date(endDate);
            const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

            const id = Date.now();
            leaves.push({
                id,
                staff: currentUser.name,
                type,
                startDate,
                endDate,
                days,
                reason,
                status: 'Pending',
                appliedDate: new Date().toISOString().split('T')[0]
            });

            saveData();
            renderHRServices();
            bootstrap.Modal.getInstance(document.getElementById('applyLeaveModal')).hide();
            addNotification('Leave request submitted successfully', 'success');
        }

        function cancelLeaveRequest(id) {
            if (confirm('Are you sure you want to cancel this leave request?')) {
                leaves = leaves.filter(l => l.id !== id);
                saveData();
                renderMyLeaveRequests();
                addNotification('Leave request cancelled', 'success');
            }
        }

        // Employee Wellness Functions for Teachers
        function renderEmployeeWellness() {
            renderWellnessActivities();
            renderHealthTips();
            updateWellnessMetrics();
        }

        function updateWellnessMetrics() {
            // Update wellness score and metrics
            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            const userActivities = wellnessActivities.filter(a => a.user === currentUser.name);
            
            document.getElementById('wellnessScore').textContent = Math.min(100, 70 + userActivities.length * 2) + '%';
            document.getElementById('activitiesCount').textContent = userActivities.length;
            document.getElementById('healthTipsCount').textContent = '8';
            document.getElementById('checkInsCount').textContent = userActivities.filter(a => a.type === 'check-in').length;
        }

        function renderWellnessActivities() {
            const activities = [
                { name: 'Morning Yoga', category: 'Fitness', description: '30 minutes yoga session', icon: 'fa-spa' },
                { name: 'Team Walk', category: 'Fitness', description: 'Group walking activity', icon: 'fa-walking' },
                { name: 'Healthy Lunch Workshop', category: 'Nutrition', description: 'Learn healthy eating', icon: 'fa-apple-alt' },
                { name: 'Mental Health Support', category: 'Mental Health', description: 'Counseling session', icon: 'fa-brain' },
                { name: 'Meditation Session', category: 'Mental Health', description: 'Guided meditation', icon: 'fa-om' },
                { name: 'Fitness Challenge', category: 'Fitness', description: 'Monthly step challenge', icon: 'fa-running' }
            ];

            document.getElementById('wellnessActivitiesList').innerHTML = activities.map(a => `
                <div class="card mb-2" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h6><i class="fas ${a.icon} me-2"></i>${a.name}</h6>
                                <p class="mb-0"><small>${a.description}</small></p>
                                <span class="badge bg-secondary">${a.category}</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="enrollInActivity('${a.name}')">Enroll</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderHealthTips() {
            const tips = [
                'Stay hydrated - drink at least 8 glasses of water daily',
                'Take regular breaks during work to reduce stress',
                'Practice good posture while working',
                'Get 7-8 hours of sleep each night',
                'Include fruits and vegetables in every meal',
                'Exercise for at least 30 minutes daily',
                'Practice mindfulness or meditation',
                'Maintain work-life balance'
            ];

            document.getElementById('healthTipsList').innerHTML = tips.map((tip, idx) => `
                <div class="alert alert-light text-dark mb-2">
                    <i class="fas fa-lightbulb me-2"></i>${tip}
                </div>
            `).join('');
        }

        function enrollInActivity(activityName) {
            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            wellnessActivities.push({
                user: currentUser.name,
                activity: activityName,
                date: new Date().toISOString().split('T')[0],
                type: 'enrollment'
            });
            localStorage.setItem('wellnessActivities', JSON.stringify(wellnessActivities));
            addNotification('Enrolled in ' + activityName, 'success');
            updateWellnessMetrics();
        }

        function showAddWellnessActivityModal() {
            const modalHTML = `
                <div class="modal fade" id="addWellnessActivityModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Log Wellness Activity</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="mb-3">
                                    <label class="form-label">Activity</label>
                                    <input type="text" id="activityName" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Duration (minutes)</label>
                                    <input type="number" id="activityDuration" class="form-control">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Date</label>
                                    <input type="date" id="activityDate" class="form-control" value="${new Date().toISOString().split('T')[0]}">
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="saveWellnessActivity()">Save</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('addWellnessActivityModal'));
            modal.show();
            document.getElementById('addWellnessActivityModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function saveWellnessActivity() {
            const name = document.getElementById('activityName').value;
            const duration = document.getElementById('activityDuration').value;
            const date = document.getElementById('activityDate').value;

            if (!name || !duration) {
                addNotification('Please fill in all fields', 'warning');
                return;
            }

            const wellnessActivities = JSON.parse(localStorage.getItem('wellnessActivities') || '[]');
            wellnessActivities.push({
                user: currentUser.name,
                activity: name,
                duration,
                date,
                type: 'logged'
            });
            localStorage.setItem('wellnessActivities', JSON.stringify(wellnessActivities));
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessActivityModal')).hide();
            addNotification('Activity logged successfully', 'success');
            updateWellnessMetrics();
        }

        function saveWellnessTracking() {
            const weight = document.getElementById('weightInput').value;
            const mood = document.getElementById('moodInput').value;

            if (!weight) {
                addNotification('Please enter your weight', 'warning');
                return;
            }

            const wellnessTracking = JSON.parse(localStorage.getItem('wellnessTracking') || '[]');
            wellnessTracking.push({
                user: currentUser.name,
                weight,
                mood,
                date: new Date().toISOString().split('T')[0]
            });
            localStorage.setItem('wellnessTracking', JSON.stringify(wellnessTracking));
            
            addNotification('Wellness data saved', 'success');
        }

        function showWellnessSupportModal() {
            const modalHTML = `
                <div class="modal fade" id="wellnessSupportModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Wellness Support</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <h6>Contact Information</h6>
                                <p><i class="fas fa-phone me-2"></i>Phone: 123-456-7890</p>
                                <p><i class="fas fa-envelope me-2"></i>Email: wellness@school.com</p>
                                <hr>
                                <div class="mb-3">
                                    <label class="form-label">Your Message</label>
                                    <textarea id="supportMessage" class="form-control" rows="4"></textarea>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                <button type="button" class="btn btn-primary" onclick="sendWellnessSupport()">Send</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modal = new bootstrap.Modal(document.getElementById('wellnessSupportModal'));
            modal.show();
            document.getElementById('wellnessSupportModal').addEventListener('hidden.bs.modal', function () {
                this.remove();
            });
        }

        function sendWellnessSupport() {
            const message = document.getElementById('supportMessage').value;
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            bootstrap.Modal.getInstance(document.getElementById('wellnessSupportModal')).hide();
            addNotification('Support request sent successfully', 'success');
        }

        // Employee Wellness Admin Functions
        function renderEmployeeWellnessAdmin() {
            renderWellnessPrograms();
        }

        function renderWellnessPrograms() {
            wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
            
            // If no programs, show sample data
            if (wellnessPrograms.length === 0) {
                wellnessPrograms = [
                    { id: 1, name: 'Fitness Challenge 2024', category: 'Physical Fitness', participants: [], maxParticipants: 50, startDate: '2024-01-01', status: 'Active', duration: 12 },
                    { id: 2, name: 'Mental Health Week', category: 'Mental Health', participants: [], maxParticipants: 100, startDate: '2024-02-15', status: 'Active', duration: 1 },
                    { id: 3, name: 'Nutrition Workshop Series', category: 'Nutrition', participants: [], maxParticipants: 30, startDate: '2024-03-01', status: 'Active', duration: 8 },
                    { id: 4, name: 'Yoga Sessions', category: 'Physical Fitness', participants: [], maxParticipants: 25, startDate: '2024-01-15', status: 'Active', duration: 16 }
                ];
                localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
            }
            
            const searchTerm = document.getElementById('wellnessSearch')?.value.toLowerCase() || '';
            const filteredPrograms = wellnessPrograms.filter(p => 
                p.name.toLowerCase().includes(searchTerm) || 
                p.category.toLowerCase().includes(searchTerm)
            );

            const statusBadgeClass = (status) => {
                switch(status) {
                    case 'Active': return 'success';
                    case 'Upcoming': return 'primary';
                    case 'Completed': return 'secondary';
                    case 'Cancelled': return 'danger';
                    default: return 'info';
                }
            };

            document.getElementById('wellnessProgramsTable').innerHTML = filteredPrograms.length > 0 ? filteredPrograms.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td><span class="badge bg-info">${p.category}</span></td>
                    <td>${p.participants?.length || 0}/${p.maxParticipants}</td>
                    <td>${p.startDate}</td>
                    <td><span class="badge bg-${statusBadgeClass(p.status)}">${p.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewWellnessProgram(${p.id})">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-sm btn-warning" onclick="editWellnessProgram(${p.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWellnessProgram(${p.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="6" class="text-center text-muted">No wellness programs found. Click "Add Wellness Program" to create one.</td></tr>';

            // Update metrics
            const totalParticipants = wellnessPrograms.reduce((sum, p) => sum + (p.participants?.length || 0), 0);
            document.getElementById('totalWellnessParticipants').textContent = totalParticipants;
            document.getElementById('totalWellnessPrograms').textContent = wellnessPrograms.length;
            
            const activePrograms = wellnessPrograms.filter(p => p.status === 'Active').length;
            const engagement = wellnessPrograms.length > 0 ? Math.round((activePrograms / wellnessPrograms.length) * 100) : 0;
            document.getElementById('avgWellnessEngagement').textContent = engagement + '%';
            document.getElementById('wellnessSatisfaction').textContent = '92%';
        }
        
        function deleteWellnessProgram(id) {
            if (confirm('Are you sure you want to delete this wellness program?')) {
                wellnessPrograms = wellnessPrograms.filter(p => p.id !== id);
                localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
                renderWellnessPrograms();
                addNotification('Wellness program deleted', 'warning');
                logAudit('Wellness Program', 'Deleted wellness program', 'Medium');
            }
        }

        function renderWellnessParticipants() {
            const participants = staff.map(s => ({
                name: s.name,
                department: s.department || 'General',
                score: Math.floor(Math.random() * 30) + 70,
                activities: Math.floor(Math.random() * 15) + 5,
                lastCheckIn: new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]
            }));

            document.getElementById('wellnessParticipantsTable').innerHTML = participants.map(p => `
                <tr>
                    <td>${p.name}</td>
                    <td>${p.department}</td>
                    <td><span class="badge bg-${p.score >= 80 ? 'success' : 'warning'}">${p.score}%</span></td>
                    <td>${p.activities}</td>
                    <td>${p.lastCheckIn}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewParticipantDetails('${p.name}')">View</button>
                    </td>
                </tr>
            `).join('');
        }

        function renderWellnessAnalytics() {
            // Placeholder for wellness analytics charts
            addNotification('Wellness analytics loaded', 'info');
        }

        function renderWellnessResourcesAdmin() {
            wellnessResources = JSON.parse(localStorage.getItem('wellnessResources') || '[]');
            
            // If no resources, show sample data
            if (wellnessResources.length === 0) {
                wellnessResources = [
                    { id: 1, title: 'Healthy Eating Guide', type: 'Guide', category: 'Nutrition', views: 145, url: '#' },
                    { id: 2, title: 'Stress Management Tips', type: 'Video', category: 'Mental Health', views: 289, url: '#' },
                    { id: 3, title: 'Fitness Program Guide', type: 'Guide', category: 'Physical Fitness', views: 203, url: '#' }
                ];
                localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
            }

            document.getElementById('wellnessResourcesTable').innerHTML = wellnessResources.length > 0 ? wellnessResources.map(r => `
                <tr>
                    <td><a href="${r.url}" target="_blank" class="text-white">${r.title}</a></td>
                    <td><span class="badge bg-secondary">${r.type}</span></td>
                    <td><span class="badge bg-info">${r.category}</span></td>
                    <td>${r.views}</td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editWellnessResource(${r.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteWellnessResource(${r.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('') : '<tr><td colspan="5" class="text-center text-muted">No wellness resources found.</td></tr>';
        }
        
        function editWellnessResource(id) {
            const resource = wellnessResources.find(r => r.id === id);
            if (resource) {
                document.getElementById('wellnessResourceTitle').value = resource.title;
                document.getElementById('wellnessResourceType').value = resource.type;
                document.getElementById('wellnessResourceCategory').value = resource.category;
                document.getElementById('wellnessResourceUrl').value = resource.url;
                document.getElementById('wellnessResourceDescription').value = resource.description || '';
                
                wellnessResources = wellnessResources.filter(r => r.id !== id);
                showAddWellnessResourceModal();
            }
        }
        
        function deleteWellnessResource(id) {
            if (confirm('Are you sure you want to delete this wellness resource?')) {
                wellnessResources = wellnessResources.filter(r => r.id !== id);
                localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
                renderWellnessResourcesAdmin();
                addNotification('Wellness resource deleted', 'warning');
            }
        }

        // Wellness Program Storage (wellnessPrograms already declared on line 3181)
        wellnessPrograms = JSON.parse(localStorage.getItem('wellnessPrograms') || '[]');
        let wellnessResources = JSON.parse(localStorage.getItem('wellnessResources') || '[]');
        
        function showAddWellnessProgramModal() {
            new bootstrap.Modal(document.getElementById('addWellnessProgramModal')).show();
        }

        function saveWellnessProgram() {
            const name = document.getElementById('wellnessProgramName').value.trim();
            const category = document.getElementById('wellnessProgramCategory').value;
            const description = document.getElementById('wellnessProgramDescription').value.trim();
            const startDate = document.getElementById('wellnessProgramStartDate').value;
            const duration = document.getElementById('wellnessProgramDuration').value;
            const target = document.getElementById('wellnessProgramTarget').value;
            const maxParticipants = document.getElementById('wellnessProgramMaxParticipants').value;
            const facilitator = document.getElementById('wellnessProgramFacilitator').value.trim();
            const status = document.getElementById('wellnessProgramStatus').value;
            
            if (!name || !startDate || !description) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const program = {
                id: Date.now(),
                name,
                category,
                description,
                startDate,
                duration,
                target,
                maxParticipants,
                facilitator,
                status,
                participants: [],
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };
            
            wellnessPrograms.push(program);
            localStorage.setItem('wellnessPrograms', JSON.stringify(wellnessPrograms));
            
            // Clear form
            document.getElementById('wellnessProgramName').value = '';
            document.getElementById('wellnessProgramDescription').value = '';
            document.getElementById('wellnessProgramStartDate').value = '';
            document.getElementById('wellnessProgramDuration').value = '4';
            document.getElementById('wellnessProgramMaxParticipants').value = '20';
            document.getElementById('wellnessProgramFacilitator').value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessProgramModal')).hide();
            renderWellnessPrograms();
            addNotification('Wellness program added successfully!', 'success');
            logAudit('Wellness Program', `Added program: ${name}`, 'Low');
        }

        function showAddWellnessResourceModal() {
            new bootstrap.Modal(document.getElementById('addWellnessResourceModal')).show();
        }
        
        function saveWellnessResource() {
            const title = document.getElementById('wellnessResourceTitle').value.trim();
            const type = document.getElementById('wellnessResourceType').value;
            const category = document.getElementById('wellnessResourceCategory').value;
            const url = document.getElementById('wellnessResourceUrl').value.trim();
            const description = document.getElementById('wellnessResourceDescription').value.trim();
            
            if (!title || !url) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const resource = {
                id: Date.now(),
                title,
                type,
                category,
                url,
                description,
                views: 0,
                createdBy: currentUser.name,
                createdAt: new Date().toISOString()
            };
            
            wellnessResources.push(resource);
            localStorage.setItem('wellnessResources', JSON.stringify(wellnessResources));
            
            // Clear form
            document.getElementById('wellnessResourceTitle').value = '';
            document.getElementById('wellnessResourceUrl').value = '';
            document.getElementById('wellnessResourceDescription').value = '';
            
            bootstrap.Modal.getInstance(document.getElementById('addWellnessResourceModal')).hide();
            renderWellnessResourcesAdmin();
            addNotification('Wellness resource added successfully!', 'success');
            logAudit('Wellness Resource', `Added resource: ${title}`, 'Low');
        }

        function exportWellnessReport() {
            const report = {
                programs: wellnessPrograms,
                resources: wellnessResources,
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `wellness-report-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addNotification('Wellness report exported successfully', 'success');
        }

        function viewWellnessProgram(id) {
            const program = wellnessPrograms.find(p => p.id === id);
            if (program) {
                alert(`Program: ${program.name}\nCategory: ${program.category}\nStart: ${program.startDate}\nDuration: ${program.duration} weeks\nStatus: ${program.status}\nParticipants: ${program.participants.length}/${program.maxParticipants}\n\n${program.description}`);
            }
        }

        function editWellnessProgram(id) {
            const program = wellnessPrograms.find(p => p.id === id);
            if (program) {
                document.getElementById('wellnessProgramName').value = program.name;
                document.getElementById('wellnessProgramCategory').value = program.category;
                document.getElementById('wellnessProgramDescription').value = program.description;
                document.getElementById('wellnessProgramStartDate').value = program.startDate;
                document.getElementById('wellnessProgramDuration').value = program.duration;
                document.getElementById('wellnessProgramTarget').value = program.target;
                document.getElementById('wellnessProgramMaxParticipants').value = program.maxParticipants;
                document.getElementById('wellnessProgramFacilitator').value = program.facilitator;
                document.getElementById('wellnessProgramStatus').value = program.status;
                
                // Remove old and save as new
                wellnessPrograms = wellnessPrograms.filter(p => p.id !== id);
                showAddWellnessProgramModal();
            }
        }

        function viewParticipantDetails(name) {
            addNotification('Viewing details for ' + name, 'info');
        }

        // Update mood value display
        document.addEventListener('DOMContentLoaded', function() {
            const moodInput = document.getElementById('moodInput');
            if (moodInput) {
                moodInput.addEventListener('input', function() {
                    document.getElementById('moodValue').textContent = this.value;
                });
            }
        });

        // Other functions remain the same as before...
        // (Include all other functions from the previous code, like renderAdmissions, saveAdmission, etc.)
        // For brevity, assuming they are included as in the initial code.
        // Add the teachers tabs event listener
        document.addEventListener('DOMContentLoaded', () => {
            const teachersTabs = document.querySelector('#teachersTabs');
            teachersTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#lesson-plans') renderLessonPlans();
                if (target === '#grading') renderGrading();
                if (target === '#resources') renderResources();
                if (target === '#student-progress') renderStudentProgress();
                if (target === '#upload-work') renderUploadWork();
                if (target === '#calendar') renderCalendar();
                if (target === '#hr-services') renderHRServices();
                if (target === '#employee-wellness') renderEmployeeWellness();
            });
            const hrTabs = document.querySelector('#hrTabs');
            hrTabs.addEventListener('shown.bs.tab', e => {
                const target = e.target.getAttribute('href');
                if (target === '#hr-staff') renderStaff();
                if (target === '#hr-payroll') renderPayrolls();
                if (target === '#hr-leaves') renderLeaves();
                if (target === '#hr-performance') renderReviews();
                if (target === '#hr-recruitment') renderJobs();
                if (target === '#hr-audit') renderAudit();
                if (target === '#hr-employee-wellness') renderEmployeeWellnessAdmin();
            });
            if (users.length === 0) {
                users = [
                    { username: 'admin', password: 'admin123', name: 'Admin User', role: 'Admin' },
                    { username: 'teacher', password: 'teacher123', name: 'Teacher User', role: 'Teacher' },
                    { username: 'parent', password: 'parent123', name: 'Parent User', role: 'Parent' },
                    { username: 'student', password: 'student123', name: 'Student User', role: 'Student' }
                ];
                saveData();
            }
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
        });
        // Add notification function
        function addNotification(message, type = 'info') {
            const badge = document.getElementById('notificationBadge');
            let count = parseInt(badge.textContent) + 1 || 1;
            badge.textContent = count;
            badge.style.display = 'block';
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            notifications.unshift({ id: Date.now(), message, type, timestamp: new Date().toISOString() });
            localStorage.setItem('notifications', JSON.stringify(notifications.slice(0, 50)));
        }
        // Render notifications
        document.getElementById('notificationsModal').addEventListener('show.bs.modal', () => {
            const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
            document.getElementById('notificationContent').innerHTML = notifications.map(n => `
                <div class="alert alert-${n.type === 'success' ? 'success' : n.type === 'danger' ? 'danger' : n.type === 'warning' ? 'warning' : 'info'}">
                    ${n.message} <small>${new Date(n.timestamp).toLocaleString()}</small>
                </div>
            `).join('');
            document.getElementById('notificationBadge').style.display = 'none';
            localStorage.removeItem('notifications');
        });

                // Admission Management
        function showAddAdmissionModal() {
            new bootstrap.Modal(document.getElementById('addAdmissionModal')).show();
        }
        function renderAdmissions() {
            // Update the report date in the caption
            const now = new Date();
            const dateStr = now.toISOString().slice(0, 10) + ' ' + now.toTimeString().slice(0, 5);
            document.getElementById('admissionReportDate').textContent = dateStr;
            
            const search = document.getElementById('admissionSearch').value.toLowerCase();
            const filtered = admissions.filter(a => {
                const surname = a.surname || a.name?.split(' ')[0] || '';
                const firstName = a.firstName || a.name?.split(' ').slice(1).join(' ') || '';
                const fullName = firstName + ' ' + surname;
                return surname.toLowerCase().includes(search) || 
                       firstName.toLowerCase().includes(search) || 
                       fullName.toLowerCase().includes(search) ||
                       (a.grade && a.grade.toLowerCase().includes(search));
            });
            document.getElementById('admissionTable').innerHTML = filtered.map(a => {
                const surname = a.surname || a.name?.split(' ')[0] || '';
                const firstName = a.firstName || a.name?.split(' ').slice(1).join(' ') || '';
                return `
                <tr>
                    <td>${a.accession || ''}</td>
                    <td>${surname}</td>
                    <td>${firstName}</td>
                    <td>${a.gender || ''}</td>
                    <td>${a.grade || ''}</td>
                    <td>${a.classValue || ''}</td>
                    <td>${a.cell || ''}</td>
                    <td>${a.email || ''}</td>
                    <td>${a.homeLanguage || ''}</td>
                    <td>${a.fatherName || ''}</td>
                    <td>${a.fatherSurname || ''}</td>
                    <td>${a.fatherEmail || ''}</td>
                    <td>${a.fatherCell || ''}</td>
                    <td>${a.motherName || ''}</td>
                    <td>${a.motherSurname || ''}</td>
                    <td>${a.motherEmail || ''}</td>
                    <td>${a.motherCell || ''}</td>
                </tr>
            `}).join('');
        }
        function saveAdmission() {
            const accession = document.getElementById('admissionAccession').value;
            const surname = document.getElementById('admissionSurname').value;
            const firstName = document.getElementById('admissionFirstName').value;
            const gender = document.getElementById('admissionGender').value;
            const homeLanguage = document.getElementById('admissionHomeLanguage').value;
            const grade = document.getElementById('admissionGrade').value;
            const classValue = document.getElementById('admissionClass').value;
            const cell = document.getElementById('admissionCell').value;
            const email = document.getElementById('admissionEmail').value;
            const fatherName = document.getElementById('admissionFatherName').value;
            const fatherSurname = document.getElementById('admissionFatherSurname').value;
            const fatherEmail = document.getElementById('admissionFatherEmail').value;
            const fatherCell = document.getElementById('admissionFatherCell').value;
            const motherName = document.getElementById('admissionMotherName').value;
            const motherSurname = document.getElementById('admissionMotherSurname').value;
            const motherEmail = document.getElementById('admissionMotherEmail').value;
            const motherCell = document.getElementById('admissionMotherCell').value;
            const username = document.getElementById('admissionUsername').value;
            const password = document.getElementById('admissionPassword').value;
            const status = document.getElementById('admissionStatus').value;
            if (surname && firstName && grade) {
                const id = Date.now();
                const name = surname + ' ' + firstName;
                admissions.push({ 
                    id, name, surname, firstName, accession, grade, classValue, cell, email, 
                    username, password, status, gender, homeLanguage,
                    fatherName, fatherSurname, fatherEmail, fatherCell,
                    motherName, motherSurname, motherEmail, motherCell,
                    saSamsFormat: true
                });
                if (username && password) {
                    users.push({ username, password, name, role: 'Student' });
                }
                
                // Auto-sync to Student Info
                if (status === 'approved' || status === 'Approved' || status === 'enrolled') {
                    syncAdmissionToStudentInfo(id);
                }
                
                saveData();
                renderAdmissions();
                bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
                addNotification('Admission saved with SA-Sams format and synced to Student Info', 'success');
                triggerDashboardUpdate();
            }
        }
        function editAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                document.getElementById('admissionAccession').value = adm.accession || '';
                document.getElementById('admissionSurname').value = adm.surname || adm.name?.split(' ')[0] || '';
                document.getElementById('admissionFirstName').value = adm.firstName || adm.name?.split(' ').slice(1).join(' ') || '';
                document.getElementById('admissionGrade').value = adm.grade;
                document.getElementById('admissionUsername').value = adm.username;
                document.getElementById('admissionPassword').value = adm.password;
                document.getElementById('admissionStatus').value = adm.status;
                // Override save to update
                const saveBtn = document.querySelector('#addAdmissionModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    adm.accession = document.getElementById('admissionAccession').value;
                    adm.surname = document.getElementById('admissionSurname').value;
                    adm.firstName = document.getElementById('admissionFirstName').value;
                    adm.name = adm.surname + ' ' + adm.firstName;
                    adm.grade = document.getElementById('admissionGrade').value;
                    adm.username = document.getElementById('admissionUsername').value;
                    adm.password = document.getElementById('admissionPassword').value;
                    const newStatus = document.getElementById('admissionStatus').value;
                    const statusChanged = adm.status !== newStatus;
                    adm.status = newStatus;
                    
                    // Auto-sync to Student Info if status changed to approved
                    if (statusChanged && (newStatus === 'approved' || newStatus === 'Approved' || newStatus === 'enrolled')) {
                        syncAdmissionToStudentInfo(adm.id);
                    }
                    
                    saveData();
                    renderAdmissions();
                    bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveAdmission;
                    addNotification('Admission updated and synced', 'success');
                    triggerDashboardUpdate();
                };
                new bootstrap.Modal(document.getElementById('addAdmissionModal')).show();
            }
        }
        function deleteAdmission(id) {
            if (confirm('Delete admission?')) {
                admissions = admissions.filter(a => a.id !== id);
                saveData();
                renderAdmissions();
                addNotification('Admission deleted', 'danger');
            }
        }
        function viewAdmissionDocuments(id) {
            alert('Documents for admission ' + id + ' (mock)');
        }
        function searchAdmissions() {
            renderAdmissions();
        }
        function showBulkAdmissionModal() {
            new bootstrap.Modal(document.getElementById('bulkAdmissionModal')).show();
        }
        
        // Advanced Import Algorithm - Intelligently handles missing data and flexible field mapping
        function advancedImportParser(jsonData, fieldMappings, requiredFields = [], autoFillDefaults = {}) {
            const validRecords = [];
            const invalidRecords = [];
            const warnings = [];
            
            jsonData.forEach((row, index) => {
                const record = {};
                let missingRequired = [];
                
                // Apply field mappings with flexible column name recognition
                for (const [targetField, possibleColumns] of Object.entries(fieldMappings)) {
                    let value = null;
                    
                    // Try each possible column name variant
                    for (const col of possibleColumns) {
                        if (row[col] !== undefined && row[col] !== null && row[col] !== '') {
                            value = row[col];
                            break;
                        }
                    }
                    
                    // Apply auto-fill defaults for missing non-required fields
                    if ((value === null || value === '') && autoFillDefaults[targetField] !== undefined) {
                        value = autoFillDefaults[targetField];
                        warnings.push({row: index + 1, field: targetField, message: `Auto-filled with default: ${value}`});
                    }
                    
                    // Auto-generate values for certain fields if missing
                    if ((value === null || value === '') && targetField === 'accession') {
                        value = `AUTO-${Date.now()}-${index}`;
                        warnings.push({row: index + 1, field: targetField, message: 'Auto-generated accession number'});
                    }
                    
                    if ((value === null || value === '') && targetField === 'username') {
                        const name = record.name || record.firstName || '';
                        if (name) {
                            value = name.toLowerCase().replace(/\s+/g, '') + Math.floor(Math.random() * 1000);
                            warnings.push({row: index + 1, field: targetField, message: `Auto-generated username: ${value}`});
                        }
                    }
                    
                    if ((value === null || value === '') && targetField === 'password') {
                        value = 'temp' + Math.floor(Math.random() * 10000);
                        warnings.push({row: index + 1, field: targetField, message: 'Auto-generated temporary password'});
                    }
                    
                    // Enhanced: Infer grade from other fields if missing
                    if ((value === null || value === '') && targetField === 'grade') {
                        // Try to infer from class, level, year fields
                        const gradeFields = ['class', 'level', 'year', 'form'];
                        for (const field of gradeFields) {
                            if (row[field] !== undefined && row[field] !== null && row[field] !== '') {
                                value = row[field];
                                warnings.push({row: index + 1, field: targetField, message: `Inferred grade from '${field}' field: ${value}`});
                                break;
                            }
                        }
                    }
                    
                    // Enhanced: Handle date formats flexibly
                    if (targetField.includes('date') || targetField.includes('Date')) {
                        if (value && typeof value === 'number') {
                            // Excel date serial number conversion
                            const excelEpoch = new Date(1900, 0, 1);
                            const date = new Date(excelEpoch.getTime() + (value - 2) * 86400000);
                            value = date.toISOString().split('T')[0];
                            warnings.push({row: index + 1, field: targetField, message: 'Converted Excel date format'});
                        }
                    }
                    
                    // Enhanced: Clean and normalize text values
                    if (value && typeof value === 'string') {
                        value = value.trim();
                        // Remove extra whitespace
                        value = value.replace(/\s+/g, ' ');
                    }
                    
                    record[targetField] = value || '';
                    
                    // Track missing required fields
                    if (requiredFields.includes(targetField) && (!value || value === '')) {
                        missingRequired.push(targetField);
                    }
                }
                
                // Enhanced Smart name handling with auto-detection
                // Try to detect name format: "Surname, FirstName" or "FirstName Surname"
                if (!record.name && (record.firstName || record.surname)) {
                    record.name = `${record.firstName || ''} ${record.surname || ''}`.trim();
                    if (record.name) {
                        warnings.push({row: index + 1, field: 'name', message: 'Combined from first and last name'});
                    }
                }
                
                // Auto-detect name format and split accordingly
                if (!record.firstName && !record.surname && record.name) {
                    let detectedFormat = 'unknown';
                    
                    // Check if format is "Surname, FirstName"
                    if (record.name.includes(',')) {
                        const parts = record.name.split(',').map(p => p.trim());
                        record.surname = parts[0] || '';
                        record.firstName = parts.slice(1).join(' ') || '';
                        detectedFormat = 'surname,firstname';
                    } 
                    // Check if format is "FirstName Surname" (multiple words)
                    else if (record.name.includes(' ')) {
                        const nameParts = record.name.trim().split(/\s+/);
                        // Assume last word is surname, rest is first name
                        record.surname = nameParts[nameParts.length - 1] || '';
                        record.firstName = nameParts.slice(0, -1).join(' ') || '';
                        detectedFormat = 'firstname surname';
                    }
                    // Single name - treat as first name
                    else {
                        record.firstName = record.name;
                        record.surname = '';
                        detectedFormat = 'single name';
                    }
                    
                    warnings.push({row: index + 1, field: 'name', message: `Auto-detected format (${detectedFormat}) and split into first/last name`});
                }
                
                // Ensure both name formats are available
                if (!record.name && (record.firstName || record.surname)) {
                    record.name = `${record.firstName || ''} ${record.surname || ''}`.trim();
                }
                
                // Enhanced: Try to populate missing required fields with available data
                for (const reqField of requiredFields) {
                    if (!record[reqField] || record[reqField] === '') {
                        // If name is required but missing, try other name fields
                        if (reqField === 'name' && (record.firstName || record.surname)) {
                            record.name = `${record.firstName || ''} ${record.surname || ''}`.trim();
                            if (record.name) {
                                warnings.push({row: index + 1, field: reqField, message: 'Generated name from available fields'});
                                missingRequired = missingRequired.filter(f => f !== reqField);
                            }
                        }
                        // Add more smart inference rules as needed
                    }
                }
                
                // Validate and categorize record
                if (missingRequired.length === 0) {
                    validRecords.push(record);
                } else {
                    // Enhanced: Try to import with partial data if at least name or identifier exists
                    if (record.name || record.accession || record.firstName) {
                        validRecords.push(record);
                        warnings.push({
                            row: index + 1, 
                            field: 'import', 
                            message: `Imported with missing fields (${missingRequired.join(', ')}) - using available information`
                        });
                    } else {
                        invalidRecords.push({
                            row: index + 1,
                            reason: `Missing required fields: ${missingRequired.join(', ')} and no identifying information`,
                            data: record
                        });
                    }
                }
            });
            
            return {
                validRecords,
                invalidRecords,
                warnings,
                summary: {
                    total: jsonData.length,
                    valid: validRecords.length,
                    invalid: invalidRecords.length,
                    warnings: warnings.length
                }
            };
        }
        
        function uploadBulkAdmissions() {
            const file = document.getElementById('admissionsFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData = [];
                    
                    // Handle different file formats
                    if (fileExt === 'csv' || fileExt === 'xlsx' || fileExt === 'xls') {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(sheet);
                    } else if (fileExt === 'pdf') {
                        addNotification('PDF parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    } else if (fileExt === 'doc' || fileExt === 'docx') {
                        addNotification('Word document parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    }
                    
                    if (jsonData.length === 0) {
                        addNotification('No data found in file', 'warning');
                        return;
                    }
                    
                    // Use advanced import algorithm
                    const fieldMappings = {
                        name: ['name', 'Name', 'NAME', 'full_name', 'Full Name', 'fullname'],
                        surname: ['surname', 'Surname', 'SURNAME', 'last_name', 'Last Name', 'lastname', 'LastName'],
                        firstName: ['firstname', 'FirstName', 'firstName', 'first_name', 'First Name', 'FIRST_NAME', 'given_name'],
                        accession: ['accession', 'Accession', 'ACCESSION', 'accession_number', 'Accession Number', 'id', 'ID', 'student_id'],
                        grade: ['grade', 'Grade', 'GRADE', 'class', 'Class', 'CLASS', 'level', 'Level'],
                        status: ['status', 'Status', 'STATUS', 'state', 'State'],
                        username: ['username', 'Username', 'USERNAME', 'user', 'User', 'login'],
                        password: ['password', 'Password', 'PASSWORD', 'pass', 'Pass']
                    };
                    
                    const requiredFields = ['grade'];
                    const autoFillDefaults = {
                        status: 'Pending'
                    };
                    
                    const result = advancedImportParser(jsonData, fieldMappings, requiredFields, autoFillDefaults);
                    
                    // Display preview with advanced information
                    let previewHTML = `<div class="alert alert-info">
                        <strong> Advanced Import Analysis:</strong><br>
                        Total records: ${result.summary.total}<br>
                         Valid records: ${result.summary.valid}<br>
                         Invalid records: ${result.summary.invalid}<br>
                         Auto-corrections applied: ${result.summary.warnings}
                    </div>`;
                    
                    if (result.warnings.length > 0) {
                        previewHTML += `<div class="alert alert-warning">
                            <strong> Auto-Corrections Applied:</strong><br>
                            ${result.warnings.slice(0, 10).map(w => `Row ${w.row}, ${w.field}: ${w.message}`).join('<br>')}
                            ${result.warnings.length > 10 ? `<br>...and ${result.warnings.length - 10} more auto-corrections` : ''}
                        </div>`;
                    }
                    
                    if (result.invalidRecords.length > 0) {
                        previewHTML += `<div class="alert alert-danger">
                            <strong> Invalid Records (will be skipped):</strong><br>
                            ${result.invalidRecords.slice(0, 5).map(r => `Row ${r.row}: ${r.reason}`).join('<br>')}
                            ${result.invalidRecords.length > 5 ? `<br>...and ${result.invalidRecords.length - 5} more invalid records` : ''}
                        </div>`;
                    }
                    
                    if (result.validRecords.length > 0) {
                        previewHTML += `<div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead><tr><th>Name</th><th>Accession</th><th>Grade</th><th>Status</th><th>Username</th></tr></thead>
                                <tbody>
                                    ${result.validRecords.slice(0, 10).map(r => `<tr><td>${r.name || (r.surname + ' ' + r.firstName)}</td><td>${r.accession}</td><td>${r.grade}</td><td>${r.status}</td><td>${r.username}</td></tr>`).join('')}
                                    ${result.validRecords.length > 10 ? `<tr><td colspan="5">...and ${result.validRecords.length - 10} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>`;
                        previewHTML += `<button class="btn btn-primary mt-2" onclick='confirmAdmissionImport(${JSON.stringify(result.validRecords)})'>Import ${result.validRecords.length} Records</button>`;
                    }
                    
                    document.getElementById('admissionsPreview').innerHTML = previewHTML;
                    
                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function confirmAdmissionImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const name = record.name || `${record.surname} ${record.firstName}`.trim();
                admissions.push({
                    id,
                    name: name,
                    surname: record.surname || name.split(' ')[0],
                    firstName: record.firstName || name.split(' ').slice(1).join(' '),
                    accession: record.accession,
                    grade: record.grade,
                    status: record.status,
                    username: record.username,
                    password: record.password
                });
                
                // Create user account if username and password provided
                if (record.username && record.password) {
                    users.push({ 
                        username: record.username, 
                        password: record.password, 
                        name: name, 
                        role: 'Student' 
                    });
                }
            });
            saveData();
            renderAdmissions();
            
            // Auto-sync approved admissions to Student Info
            syncAllApprovedAdmissions();
            
            bootstrap.Modal.getInstance(document.getElementById('bulkAdmissionModal')).hide();
            addNotification(` Successfully imported ${records.length} admissions with advanced algorithm`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} admissions using advanced algorithm`, 'Low');
            triggerDashboardUpdate();
        }
        
        function clearBulkAdmissionNotification() {
            // Clear the preview and file input
            document.getElementById('admissionsFile').value = '';
            document.getElementById('admissionsPreview').innerHTML = '';
            addNotification('Bulk admission import cleared', 'info');
        }
        
        // ========================================
        // SYNC ADMISSION TO STUDENT INFO AND ATTENDANCE
        // ========================================
        
        function syncAdmissionToStudentInfo(admissionId) {
            const admission = admissions.find(a => a.id === admissionId);
            if (!admission) {
                console.error('Admission not found:', admissionId);
                return false;
            }
            
            // Check if student already exists
            const existingStudent = students.find(s => 
                s.accession === admission.accession || 
                (s.name === admission.name && s.grade === admission.grade)
            );
            
            if (existingStudent) {
                console.log('Student already exists in Student Info:', existingStudent.name);
                return false;
            }
            
            // Create student record from admission
            const studentId = Date.now() + Math.random();
            const newStudent = {
                id: studentId,
                number: admission.accession || `STU-${studentId}`,
                name: admission.name || '',
                surname: admission.surname || (admission.name ? admission.name.split(' ')[0] : ''),
                firstName: admission.firstName || (admission.name ? admission.name.split(' ').slice(1).join(' ') : ''),
                gender: admission.gender || 'Not specified',
                grade: admission.grade,
                class: admission.classValue || admission.grade,
                cell: admission.cell || '',
                email: admission.email || '',
                language: admission.homeLanguage || 'English',
                fatherName: admission.fatherName || '',
                fatherSurname: admission.fatherSurname || '',
                fatherEmail: admission.fatherEmail || '',
                fatherCell: admission.fatherCell || '',
                motherName: admission.motherName || '',
                motherSurname: admission.motherSurname || '',
                motherEmail: admission.motherEmail || '',
                motherCell: admission.motherCell || '',
                status: 'Active',
                accession: admission.accession,
                username: admission.username,
                admissionId: admissionId,
                enrolledDate: new Date().toISOString().split('T')[0]
            };
            
            // Add to students array
            students.push(newStudent);
            
            // Initialize attendance record for the student
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) {
                attendanceRecords[today] = {};
            }
            
            // Mark as present for first day
            attendanceRecords[today][studentId] = {
                studentId: studentId,
                studentName: newStudent.name,
                status: 'Present',
                remarks: 'First day - Enrolled from admission',
                markedAt: new Date().toISOString()
            };
            
            // Save all data
            saveData();
            
            // Refresh relevant sections if they're visible
            if (!document.getElementById('students').classList.contains('d-none')) {
                renderStudents();
            }
            if (!document.getElementById('attendance').classList.contains('d-none')) {
                loadAttendance();
            }
            
            console.log('Student synced to Student Info and Attendance:', newStudent.name);
            addNotification(`Student ${newStudent.name} added to Student Info and Attendance`, 'success');
            
            // Log the sync action
            logAudit('Admission Sync', `Synced admission ${admission.name} to Student Info and Attendance`, 'Low');
            
            return true;
        }
        
        // Bulk sync all approved admissions
        function syncAllApprovedAdmissions() {
            const approvedAdmissions = admissions.filter(a => 
                a.status === 'approved' || a.status === 'Approved' || a.status === 'enrolled'
            );
            
            let syncedCount = 0;
            approvedAdmissions.forEach(admission => {
                if (syncAdmissionToStudentInfo(admission.id)) {
                    syncedCount++;
                }
            });
            
            if (syncedCount > 0) {
                addNotification(`Synced ${syncedCount} approved admissions to Student Info`, 'success');
                triggerDashboardUpdate();
            } else {
                addNotification('No new admissions to sync', 'info');
            }
        }

        // Student Management
        function showAddStudentModal() {
            new bootstrap.Modal(document.getElementById('addStudentModal')).show();
        }
        function renderStudents() {
            const search = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => {
                const surname = s.surname || s.name?.split(' ')[0] || '';
                const firstName = s.firstName || s.name?.split(' ').slice(1).join(' ') || '';
                const accession = s.accession || '';
                return surname.toLowerCase().includes(search) || 
                       firstName.toLowerCase().includes(search) || 
                       accession.toLowerCase().includes(search) ||
                       s.grade.toLowerCase().includes(search);
            });
            document.getElementById('studentTable').innerHTML = filtered.map(s => {
                const surname = s.surname || s.name?.split(' ')[0] || '';
                const firstName = s.firstName || s.name?.split(' ').slice(1).join(' ') || '';
                const accession = s.accession || '';
                return `
                <tr>
                    <td>${s.id}</td>
                    <td>${accession}</td>
                    <td>${surname}</td>
                    <td>${firstName}</td>
                    <td>${s.grade}</td>
                    <td>${s.parent}</td>
                    <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                    <td><button class="btn btn-sm btn-info" onclick="viewStudentDocuments(${s.id})">View</button></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="editStudent(${s.id})">Edit</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteStudent(${s.id})">Delete</button>
                    </td>
                </tr>
            `}).join('');
        }
        function saveStudent() {
            const accession = document.getElementById('studentAccession').value;
            const surname = document.getElementById('studentSurname').value;
            const firstName = document.getElementById('studentFirstName').value;
            const idNumber = document.getElementById('studentIdNumber').value;
            const dateOfBirth = document.getElementById('studentDateOfBirth').value;
            const gender = document.getElementById('studentGender').value;
            const homeLanguage = document.getElementById('studentHomeLanguage').value;
            const grade = document.getElementById('studentGrade').value;
            const parent = document.getElementById('studentParent').value;
            const parentContact = document.getElementById('studentParentContact').value;
            const address = document.getElementById('studentAddress').value;
            const educator = document.getElementById('studentEducator').value;
            const status = document.getElementById('studentStatus').value;
            if (surname && firstName && grade) {
                const id = Date.now();
                const name = surname + ' ' + firstName;
                students.push({ 
                    id, name, surname, firstName, accession, grade, parent, status, educator,
                    idNumber, dateOfBirth, gender, homeLanguage, parentContact, address,
                    saSamsFormat: true
                });
                saveData();
                renderStudents();
                integrateEducatorsAsStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                addNotification('Student added with SA-Sams format', 'success');
            }
        }
        function editStudent(id) {
            const stu = students.find(s => s.id === id);
            if (stu) {
                document.getElementById('studentAccession').value = stu.accession || '';
                document.getElementById('studentSurname').value = stu.surname || stu.name?.split(' ')[0] || '';
                document.getElementById('studentFirstName').value = stu.firstName || stu.name?.split(' ').slice(1).join(' ') || '';
                document.getElementById('studentGrade').value = stu.grade;
                document.getElementById('studentParent').value = stu.parent;
                document.getElementById('studentEducator').value = stu.educator;
                document.getElementById('studentStatus').value = stu.status;
                // Override save to update
                const saveBtn = document.querySelector('#addStudentModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = () => {
                    stu.accession = document.getElementById('studentAccession').value;
                    stu.surname = document.getElementById('studentSurname').value;
                    stu.firstName = document.getElementById('studentFirstName').value;
                    stu.name = stu.surname + ' ' + stu.firstName;
                    stu.grade = document.getElementById('studentGrade').value;
                    stu.parent = document.getElementById('studentParent').value;
                    stu.educator = document.getElementById('studentEducator').value;
                    stu.status = document.getElementById('studentStatus').value;
                    saveData();
                    renderStudents();
                    bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                    saveBtn.textContent = 'Save';
                    saveBtn.onclick = saveStudent;
                    addNotification('Student updated', 'success');
                };
                new bootstrap.Modal(document.getElementById('addStudentModal')).show();
            }
        }
        function deleteStudent(id) {
            if (confirm('Delete student?')) {
                students = students.filter(s => s.id !== id);
                saveData();
                renderStudents();
                addNotification('Student deleted', 'danger');
            }
        }
        function viewStudentDocuments(id) {
            alert('Documents for student ' + id + ' (mock)');
        }
        function searchStudents() {
            renderStudents();
        }
        function showBulkStudentModal() {
            new bootstrap.Modal(document.getElementById('bulkStudentModal')).show();
        }
        function uploadBulkStudents() {
            const file = document.getElementById('studentFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData = [];
                    
                    // Handle different file formats
                    if (fileExt === 'csv' || fileExt === 'xlsx' || fileExt === 'xls') {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(sheet);
                    } else if (fileExt === 'pdf') {
                        addNotification('PDF parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    } else if (fileExt === 'doc' || fileExt === 'docx') {
                        addNotification('Word document parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    }
                    
                    if (jsonData.length === 0) {
                        addNotification('No data found in file', 'warning');
                        return;
                    }
                    
                    // Use advanced import algorithm
                    const fieldMappings = {
                        name: ['name', 'Name', 'NAME', 'full_name', 'Full Name', 'fullname', 'student_name'],
                        surname: ['surname', 'Surname', 'SURNAME', 'last_name', 'Last Name', 'lastname', 'LastName'],
                        firstName: ['firstname', 'FirstName', 'firstName', 'first_name', 'First Name', 'FIRST_NAME', 'given_name'],
                        accession: ['accession', 'Accession', 'ACCESSION', 'accession_number', 'Accession Number', 'id', 'ID', 'student_id', 'StudentID'],
                        grade: ['grade', 'Grade', 'GRADE', 'class', 'Class', 'CLASS', 'level', 'Level'],
                        parent: ['parent', 'Parent', 'PARENT', 'guardian', 'Guardian', 'parent_name', 'Parent Name'],
                        educator: ['educator', 'Educator', 'EDUCATOR', 'teacher', 'Teacher', 'TEACHER', 'class_teacher'],
                        status: ['status', 'Status', 'STATUS', 'state', 'State', 'active']
                    };
                    
                    const requiredFields = ['grade'];
                    const autoFillDefaults = {
                        status: 'Active',
                        parent: 'Unknown',
                        educator: 'Unassigned'
                    };
                    
                    const result = advancedImportParser(jsonData, fieldMappings, requiredFields, autoFillDefaults);
                    
                    // Display preview with advanced information
                    let previewHTML = `<div class="alert alert-info">
                        <strong> Advanced Import Analysis:</strong><br>
                        Total records: ${result.summary.total}<br>
                         Valid records: ${result.summary.valid}<br>
                         Invalid records: ${result.summary.invalid}<br>
                         Auto-corrections applied: ${result.summary.warnings}
                    </div>`;
                    
                    if (result.warnings.length > 0) {
                        previewHTML += `<div class="alert alert-warning">
                            <strong> Auto-Corrections Applied:</strong><br>
                            ${result.warnings.slice(0, 10).map(w => `Row ${w.row}, ${w.field}: ${w.message}`).join('<br>')}
                            ${result.warnings.length > 10 ? `<br>...and ${result.warnings.length - 10} more auto-corrections` : ''}
                        </div>`;
                    }
                    
                    if (result.invalidRecords.length > 0) {
                        previewHTML += `<div class="alert alert-danger">
                            <strong> Invalid Records (will be skipped):</strong><br>
                            ${result.invalidRecords.slice(0, 5).map(r => `Row ${r.row}: ${r.reason}`).join('<br>')}
                            ${result.invalidRecords.length > 5 ? `<br>...and ${result.invalidRecords.length - 5} more invalid records` : ''}
                        </div>`;
                    }
                    
                    if (result.validRecords.length > 0) {
                        previewHTML += `<div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead><tr><th>Name</th><th>Grade</th><th>Parent</th><th>Accession</th><th>Educator</th></tr></thead>
                                <tbody>
                                    ${result.validRecords.slice(0, 10).map(r => `<tr><td>${r.name || (r.surname + ' ' + r.firstName)}</td><td>${r.grade}</td><td>${r.parent}</td><td>${r.accession}</td><td>${r.educator}</td></tr>`).join('')}
                                    ${result.validRecords.length > 10 ? `<tr><td colspan="5">...and ${result.validRecords.length - 10} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>`;
                        previewHTML += `<button class="btn btn-primary mt-2" onclick='confirmStudentImport(${JSON.stringify(result.validRecords)})'>Import ${result.validRecords.length} Students</button>`;
                    }
                    
                    document.getElementById('studentPreview').innerHTML = previewHTML;
                    
                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function confirmStudentImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const name = record.name || `${record.surname} ${record.firstName}`.trim();
                students.push({
                    id,
                    name: name,
                    surname: record.surname || name.split(' ')[0],
                    firstName: record.firstName || name.split(' ').slice(1).join(' '),
                    grade: record.grade,
                    parent: record.parent,
                    status: record.status,
                    accession: record.accession,
                    educator: record.educator
                });
            });
            saveData();
            renderStudents();
            integrateEducatorsAsStaff();
            bootstrap.Modal.getInstance(document.getElementById('bulkStudentModal')).hide();
            addNotification(` Successfully imported ${records.length} students with advanced algorithm`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} students using advanced algorithm`, 'Low');
        }
        function resetAllStudents() {
            if (confirm('Are you sure you want to reset ALL students? All student records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Student data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Student Reset',
                        description: `Reset ${students.length} student records`,
                        data: JSON.parse(JSON.stringify(students)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear students
                    students = [];
                    
                    saveData();
                    renderStudents();
                    updateVaultMetrics();
                    addNotification('All students reset and saved to vault', 'warning');
                    logAudit('Student Reset', 'Reset all student records to vault', 'Medium');
                }
            }
        }

        // Attendance Management
        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value;
            const classFilter = document.getElementById('attendanceClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            const records = attendanceRecords[date] || {};
            document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
                const record = records[s.id] || { status: 'Absent' };
                return `
                    <tr>
                        <td>${s.accession || s.id}</td>
                        <td>${s.name}</td>
                        <td><span class="badge bg-${record.status === 'Present' ? 'success' : record.status === 'Late' ? 'warning' : 'danger'}">${record.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAttendanceModal(${s.id}, '${s.name}')">Edit</button></td>
                    </tr>
                `;
            }).join('');
        }
        function showAttendanceModal(id, name) {
            document.getElementById('attendanceStudentId').value = id;
            document.getElementById('attendanceStudentName').textContent = name;
            document.getElementById('attendanceModalDate').value = document.getElementById('attendanceDate').value;
            new bootstrap.Modal(document.getElementById('attendanceModal')).show();
        }
        function saveAttendanceMark() {
            const studentId = document.getElementById('attendanceStudentId').value;
            const date = document.getElementById('attendanceModalDate').value;
            const status = document.getElementById('attendanceStatus').value;
            const notes = document.getElementById('attendanceNotes').value;
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            attendanceRecords[date][studentId] = { status, notes };
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('attendanceModal')).hide();
            addNotification('Attendance marked', 'success');
        }
        function showBulkAttendanceModal() {
            new bootstrap.Modal(document.getElementById('bulkAttendanceModal')).show();
        }
        function bulkMarkAttendance() {
            const date = document.getElementById('bulkAttendanceDate').value;
            const status = document.getElementById('bulkStatus').value;
            const classFilter = document.getElementById('bulkClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            if (!attendanceRecords[date]) attendanceRecords[date] = {};
            filteredStudents.forEach(s => {
                attendanceRecords[date][s.id] = { status };
            });
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('bulkAttendanceModal')).hide();
            addNotification('Bulk attendance marked', 'success');
        }
        
        function showImportAttendanceModal() {
            new bootstrap.Modal(document.getElementById('importAttendanceModal')).show();
        }
        
        function uploadBulkAttendance() {
            const file = document.getElementById('attendanceFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData = [];
                    
                    // Handle different file formats
                    if (fileExt === 'csv' || fileExt === 'xlsx' || fileExt === 'xls') {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(sheet);
                    } else if (fileExt === 'pdf') {
                        addNotification('PDF parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    } else if (fileExt === 'doc' || fileExt === 'docx') {
                        addNotification('Word document parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    }
                    
                    if (jsonData.length === 0) {
                        addNotification('No data found in file', 'warning');
                        return;
                    }
                    
                    // Use advanced import algorithm
                    const fieldMappings = {
                        studentId: ['studentId', 'student_id', 'StudentID', 'id', 'ID', 'student_number'],
                        studentName: ['studentName', 'student_name', 'name', 'Name', 'NAME', 'student', 'Student'],
                        accession: ['accession', 'Accession', 'ACCESSION', 'accession_number'],
                        date: ['date', 'Date', 'DATE', 'attendance_date', 'Attendance Date'],
                        status: ['status', 'Status', 'STATUS', 'attendance', 'Attendance', 'present', 'Present'],
                        notes: ['notes', 'Notes', 'NOTES', 'remarks', 'Remarks', 'comment', 'Comment']
                    };
                    
                    const requiredFields = ['date', 'status'];
                    const autoFillDefaults = {
                        status: 'Present',
                        notes: '',
                        date: new Date().toISOString().split('T')[0]
                    };
                    
                    const result = advancedImportParser(jsonData, fieldMappings, requiredFields, autoFillDefaults);
                    
                    // Match students by name or accession if studentId not provided
                    result.validRecords.forEach(record => {
                        if (!record.studentId) {
                            const student = students.find(s => 
                                (s.name && record.studentName && s.name.toLowerCase() === record.studentName.toLowerCase()) ||
                                (s.accession && record.accession && s.accession === record.accession)
                            );
                            if (student) {
                                record.studentId = student.id;
                                record.matched = true;
                            } else {
                                record.matched = false;
                            }
                        } else {
                            record.matched = true;
                        }
                    });
                    
                    const matchedRecords = result.validRecords.filter(r => r.matched);
                    const unmatchedRecords = result.validRecords.filter(r => !r.matched);
                    
                    // Display preview with advanced information
                    let previewHTML = `<div class="alert alert-info">
                        <strong> Advanced Import Analysis:</strong><br>
                        Total records: ${result.summary.total}<br>
                         Matched students: ${matchedRecords.length}<br>
                         Unmatched students: ${unmatchedRecords.length}<br>
                         Invalid records: ${result.summary.invalid}<br>
                         Auto-corrections applied: ${result.summary.warnings}
                    </div>`;
                    
                    if (result.warnings.length > 0) {
                        previewHTML += `<div class="alert alert-warning">
                            <strong> Auto-Corrections Applied:</strong><br>
                            ${result.warnings.slice(0, 10).map(w => `Row ${w.row}, ${w.field}: ${w.message}`).join('<br>')}
                            ${result.warnings.length > 10 ? `<br>...and ${result.warnings.length - 10} more auto-corrections` : ''}
                        </div>`;
                    }
                    
                    if (unmatchedRecords.length > 0) {
                        previewHTML += `<div class="alert alert-warning">
                            <strong> Unmatched Students (will be skipped):</strong><br>
                            ${unmatchedRecords.slice(0, 5).map(r => `${r.studentName || r.accession || 'Unknown'}`).join('<br>')}
                            ${unmatchedRecords.length > 5 ? `<br>...and ${unmatchedRecords.length - 5} more` : ''}
                        </div>`;
                    }
                    
                    if (result.invalidRecords.length > 0) {
                        previewHTML += `<div class="alert alert-danger">
                            <strong> Invalid Records (will be skipped):</strong><br>
                            ${result.invalidRecords.slice(0, 5).map(r => `Row ${r.row}: ${r.reason}`).join('<br>')}
                            ${result.invalidRecords.length > 5 ? `<br>...and ${result.invalidRecords.length - 5} more invalid records` : ''}
                        </div>`;
                    }
                    
                    if (matchedRecords.length > 0) {
                        previewHTML += `<div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead><tr><th>Student</th><th>Date</th><th>Status</th><th>Notes</th></tr></thead>
                                <tbody>
                                    ${matchedRecords.slice(0, 10).map(r => `<tr><td>${r.studentName || 'ID: ' + r.studentId}</td><td>${r.date}</td><td>${r.status}</td><td>${r.notes}</td></tr>`).join('')}
                                    ${matchedRecords.length > 10 ? `<tr><td colspan="4">...and ${matchedRecords.length - 10} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>`;
                        previewHTML += `<button class="btn btn-primary mt-2" onclick='confirmAttendanceImport(${JSON.stringify(matchedRecords)})'>Import ${matchedRecords.length} Attendance Records</button>`;
                    }
                    
                    document.getElementById('attendancePreview').innerHTML = previewHTML;
                    
                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function confirmAttendanceImport(records) {
            let importedCount = 0;
            records.forEach(record => {
                if (!attendanceRecords[record.date]) {
                    attendanceRecords[record.date] = {};
                }
                attendanceRecords[record.date][record.studentId] = {
                    status: record.status,
                    notes: record.notes
                };
                importedCount++;
            });
            saveData();
            loadAttendance();
            bootstrap.Modal.getInstance(document.getElementById('importAttendanceModal')).hide();
            addNotification(` Successfully imported ${importedCount} attendance records with advanced algorithm`, 'success');
            logAudit('Bulk Import', `Imported ${importedCount} attendance records using advanced algorithm`, 'Low');
        }
        function syncBiometricAttendance() {
            addNotification('Biometric sync simulated', 'info');
            // Mock sync
            const today = new Date().toISOString().split('T')[0];
            if (!attendanceRecords[today]) attendanceRecords[today] = {};
            students.forEach(s => {
                if (!attendanceRecords[today][s.id]) {
                    attendanceRecords[today][s.id] = { status: Math.random() > 0.2 ? 'Present' : 'Absent' };
                }
            });
            saveData();
            loadAttendance();
        }
        
        function resetAttendance() {
            if (confirm('Are you sure you want to reset attendance? All attendance records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Attendance data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Attendance Reset',
                        description: `Reset ${Object.keys(attendanceRecords).length} days of attendance records`,
                        data: JSON.parse(JSON.stringify(attendanceRecords)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear attendance
                    attendanceRecords = {};
                    
                    saveData();
                    loadAttendance();
                    updateVaultMetrics();
                    addNotification('Attendance reset and saved to vault', 'warning');
                    logAudit('Attendance Reset', 'Reset all attendance records to vault', 'Medium');
                }
            }
        }

        // Fee Management
        function renderFees() {
            const search = document.getElementById('feeSearch').value.toLowerCase();
            const filtered = fees.filter(f => 
                students.find(s => s.id === f.studentId)?.name.toLowerCase().includes(search) || search === ''
            );
            document.getElementById('feeTable').innerHTML = filtered.map(f => {
                const student = students.find(s => s.id === f.studentId);
                return `
                    <tr>
                        <td>${student ? student.name : 'Unknown'}</td>
                        <td>R${f.amount.toLocaleString()}</td>
                        <td>${f.dueDate}</td>
                        <td>${f.paidDate || ''}</td>
                        <td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'Pending' ? 'warning' : 'danger'}">${f.status}</span></td>
                        <td><button class="btn btn-sm btn-success" onclick="generateReceipt(${f.id})">Receipt</button></td>
                        <td><button class="btn btn-sm btn-primary" onclick="editFee(${f.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const totalCollected = fees.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
            const outstanding = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const paymentRate = fees.length > 0 ? Math.round((totalCollected / (totalCollected + outstanding)) * 100) : 0;
            document.getElementById('totalCollected').textContent = 'R' + totalCollected.toLocaleString();
            document.getElementById('outstandingFees').textContent = 'R' + outstanding.toLocaleString();
            document.getElementById('overdueFees').textContent = 'R' + overdue.toLocaleString();
            document.getElementById('paymentRate').textContent = paymentRate + '%';
            // History
            document.getElementById('feeHistory').innerHTML = fees.slice(-5).map(f => `
                <div class="report-card">
                    <strong>${students.find(s => s.id === f.studentId)?.name}</strong>: R${f.amount} - ${f.status} on ${f.paidDate || f.dueDate}
                </div>
            `).join('');
        }
        function showGenerateInvoiceModal() {
            document.getElementById('invoiceStudent').innerHTML = students.map(s => `<option value="${s.id}">${s.name} (${s.grade})</option>`).join('');
            new bootstrap.Modal(document.getElementById('generateInvoiceModal')).show();
        }
        function saveInvoice() {
            const studentId = document.getElementById('invoiceStudent').value;
            const amount = parseFloat(document.getElementById('invoiceAmount').value);
            const dueDate = document.getElementById('invoiceDueDate').value;
            const description = document.getElementById('invoiceDescription').value;
            if (studentId && amount && dueDate) {
                const id = Date.now();
                fees.push({ id, studentId, amount, dueDate, description, status: 'Pending', paidDate: '' });
                saveData();
                renderFees();
                bootstrap.Modal.getInstance(document.getElementById('generateInvoiceModal')).hide();
                addNotification('Invoice generated', 'success');
            }
        }
        function editFee(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                // Similar edit logic as above
                alert('Edit fee ' + id + ' (implement modal)');
            }
        }
        function generateReceipt(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                const student = students.find(s => s.id === fee.studentId);
                const receipt = `
                    <div class="payslip-preview">
                        <h4>Receipt #${id}</h4>
                        <p>Student: ${student.name}</p>
                        <p>Amount: R${fee.amount}</p>
                        <p>Date: ${new Date().toLocaleDateString()}</p>
                    </div>
                `;
                document.body.innerHTML += `<div class="modal fade" id="receiptModal"><div class="modal-dialog"><div class="modal-content">${receipt}</div></div></div>`;
                new bootstrap.Modal(document.getElementById('receiptModal')).show();
            }
        }
        function searchFees() {
            renderFees();
        }
        function showBulkUploadFeesModal() {
            new bootstrap.Modal(document.getElementById('bulkUploadFeesModal')).show();
        }
        function uploadBulkFees() {
            // Similar to uploadBulkStudents
            addNotification('Bulk fees uploaded (mock)', 'success');
            bootstrap.Modal.getInstance(document.getElementById('bulkUploadFeesModal')).hide();
        }
        function sendFeeReminders() {
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date());
            overdue.forEach(f => {
                const student = students.find(s => s.id === f.studentId);
                addNotification(`Reminder sent to ${student.name} for R${f.amount}`, 'warning');
            });
            if (overdue.length > 0) {
                addNotification(overdue.length + ' reminders sent', 'info');
            } else {
                addNotification('No overdue fees', 'info');
            }
        }
        
        function resetFees() {
            if (confirm('Are you sure you want to reset all fees? All fee records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Fee data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Fee Reset',
                        description: `Reset ${fees.length} fee records`,
                        data: JSON.parse(JSON.stringify(fees)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear fees
                    fees = [];
                    
                    saveData();
                    renderFees();
                    updateVaultMetrics();
                    addNotification('Fees reset and saved to vault', 'warning');
                    logAudit('Fee Reset', 'Reset all fee records to vault', 'Medium');
                }
            }
        }
        
        function resetAdmissions() {
            if (confirm('Are you sure you want to reset all admissions? All admission records will be saved to the vault and cleared from the system.')) {
                if (confirm('This is your final warning. Admission data will be moved to vault. Continue?')) {
                    // Save to vault
                    const vaultEntry = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        type: 'Admission Reset',
                        description: `Reset ${admissions.length} admission records`,
                        data: JSON.parse(JSON.stringify(admissions)),
                        user: currentUser ? currentUser.name : 'Unknown'
                    };
                    dataVault.push(vaultEntry);
                    
                    // Clear admissions
                    admissions = [];
                    
                    saveData();
                    renderAdmissions();
                    updateVaultMetrics();
                    addNotification('Admissions reset and saved to vault', 'warning');
                    logAudit('Admission Reset', 'Reset all admission records to vault', 'Medium');
                }
            }
        }

        // Timetable Management
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            if (!grade) return;
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            let table = '<table class="table"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
            const times = ['08:00', '09:00', '10:00', '11:00', '12:00', '13:00', '14:00'];
            times.forEach(time => {
                table += `<tr><td>${time}</td>`;
                days.forEach(day => {
                    const slot = timetable[grade]?.[day]?.[time] || '';
                    table += `<td class="timetable-cell editable" onclick="editTimeSlot('${grade}', '${day}', '${time}')">${slot}</td>`;
                });
                table += '</tr>';
            });
            table += '</tbody></table>';
            document.getElementById('timetableContainer').innerHTML = table;
        }
        function showAddTimeSlotModal() {
            document.getElementById('timeSlotGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
        }
        function saveTimeSlot() {
            const grade = document.getElementById('timeSlotGrade').value;
            const day = document.getElementById('timeSlotDay').value;
            const time = document.getElementById('timeSlotTime').value;
            const subject = document.getElementById('timeSlotSubject').value;
            if (!timetable[grade]) timetable[grade] = {};
            if (!timetable[grade][day]) timetable[grade][day] = {};
            timetable[grade][day][time] = subject;
            saveData();
            loadTimetable();
            bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
            addNotification('Time slot added', 'success');
        }
        function editTimeSlot(grade, day, time) {
            document.getElementById('timeSlotGrade').value = grade;
            document.getElementById('timeSlotDay').value = day;
            document.getElementById('timeSlotTime').value = time;
            document.getElementById('timeSlotSubject').value = timetable[grade][day][time] || '';
            // Override to update
            const saveBtn = document.querySelector('#addTimeSlotModal .btn-primary');
            saveBtn.textContent = 'Update';
            saveBtn.onclick = () => {
                timetable[grade][day][time] = document.getElementById('timeSlotSubject').value;
                saveData();
                loadTimetable();
                bootstrap.Modal.getInstance(document.getElementById('addTimeSlotModal')).hide();
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveTimeSlot;
                addNotification('Time slot updated', 'success');
            };
            new bootstrap.Modal(document.getElementById('addTimeSlotModal')).show();
        }
        function checkTimetableConflicts() {
            // Mock conflict check
            addNotification('No conflicts found (mock)', 'success');
        }
        function highlightTeacherSchedule() {
            const teacher = document.getElementById('timetableTeacher').value;
            if (teacher) {
                // Highlight cells with teacher
                document.querySelectorAll('.timetable-cell').forEach(cell => {
                    if (cell.textContent.includes(teacher)) {
                        cell.style.background = 'rgba(255, 255, 0, 0.3)';
                    }
                });
            }
        }

        // Examination Management
        function renderExams() {
            const gradeFilter = document.getElementById('examGradeFilter').value;
            const subjectFilter = document.getElementById('examSubjectFilter').value.toLowerCase();
            const filtered = exams.filter(e => 
                (!gradeFilter || e.grade === gradeFilter) && 
                (!subjectFilter || e.subject.toLowerCase().includes(subjectFilter))
            );
            document.getElementById('examTable').innerHTML = filtered.map(e => `
                <tr>
                    <td>${e.name}</td>
                    <td>${e.date}</td>
                    <td>${e.subject}</td>
                    <td>${e.grade}</td>
                    <td><span class="badge bg-${e.status === 'Completed' ? 'success' : 'warning'}">${e.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editExam(${e.id})">Edit</button></td>
                </tr>
            `).join('');
        }
        function showAddExamModal() {
            document.getElementById('examGrade').innerHTML = [...new Set(students.map(s => s.grade))].map(g => `<option value="${g}">${g}</option>`).join('');
            new bootstrap.Modal(document.getElementById('addExamModal')).show();
        }
        function saveExam() {
            const name = document.getElementById('examName').value;
            const date = document.getElementById('examDate').value;
            const subject = document.getElementById('examSubject').value;
            const grade = document.getElementById('examGrade').value;
            const status = document.getElementById('examStatus').value;
            if (name && date && subject && grade) {
                const id = Date.now();
                exams.push({ id, name, date, subject, grade, status });
                saveData();
                renderExams();
                bootstrap.Modal.getInstance(document.getElementById('addExamModal')).hide();
                addNotification('Exam scheduled', 'success');
            }
        }
        function editExam(id) {
            // Similar edit logic
            alert('Edit exam ' + id + ' (implement)');
        }
        function showEnterMarksModal(examId) {
            document.getElementById('marksExamName').textContent = exams.find(e => e.id === examId)?.name || '';
            const exam = exams.find(e => e.id === examId);
            if (exam) {
                const studentsInGrade = students.filter(s => s.grade === exam.grade);
                document.getElementById('marksTable').innerHTML = studentsInGrade.map(s => `
                    <tr>
                        <td>${s.name}</td>
                        <td><input type="number" class="form-control" min="0" max="100" data-student="${s.id}"></td>
                    </tr>
                `).join('');
                document.getElementById('marksEntry').classList.remove('d-none');
            }
        }
        function saveMarks() {
            const inputs = document.querySelectorAll('#marksTable input');
            inputs.forEach(input => {
                const studentId = input.dataset.student;
                const score = parseFloat(input.value);
                if (score) {
                    const id = Date.now();
                    grades.push({ id, studentId, subject: document.getElementById('marksExamName').textContent, score, comments: '' });
                }
            });
            saveData();
            document.getElementById('marksEntry').classList.add('d-none');
            renderExams();
            addNotification('Marks saved', 'success');
        }
        function generateAllReportCards() {
            students.forEach(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                const avg = studentGrades.length > 0 ? studentGrades.reduce((sum, g) => sum + g.score, 0) / studentGrades.length : 0;
                addNotification(`Report card for ${s.name}: ${Math.round(avg)}%`, 'info');
            });
        }
        function generateHallTickets() {
            exams.forEach(e => {
                if (e.status === 'Scheduled') {
                    students.filter(s => s.grade === e.grade).forEach(s => {
                        addNotification(`Hall ticket for ${s.name} - ${e.name}`, 'info');
                    });
                }
            });
        }

        // HR Management
        function renderHR() {
            // Default to staff
            renderStaff();
        }
        function renderStaff() {
            const search = document.getElementById('staffSearch').value.toLowerCase();
            const roleFilter = document.getElementById('staffFilterRole').value;
            const filtered = staff.filter(s => 
                s.name.toLowerCase().includes(search) && 
                (!roleFilter || s.role === roleFilter)
            );
            document.getElementById('staffTable').innerHTML = filtered.map(s => {
                const expiryDate = new Date(s.certExpiry);
                const isExpired = expiryDate < new Date();
                return `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.role}</td>
                        <td>${s.department}</td>
                        <td>R${s.salary.toLocaleString()}</td>
                        <td>${s.taxNumber}</td>
                        <td>${s.uifNumber}</td>
                        <td><span class="${isExpired ? 'cert-expired' : 'cert-expiry'}">${s.certExpiry}</span></td>
                        <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="showAddStaffModal(${s.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            document.getElementById('totalStaff').textContent = staff.length;
            document.getElementById('activeStaff').textContent = staff.filter(s => s.status === 'Active').length;
            const avgSalary = staff.length > 0 ? Math.round(staff.reduce((sum, s) => sum + s.salary, 0) / staff.length) : 0;
            document.getElementById('avgSalary').textContent = 'R' + avgSalary.toLocaleString();
            const expiringCerts = staff.filter(s => new Date(s.certExpiry) < new Date(Date.now() + 90*24*60*60*1000)).length;
            document.getElementById('expiringCerts').textContent = expiringCerts;
        }
        function showAddStaffModal(editId) {
            if (editId) {
                editingStaffId = editId;
                const staffMember = staff.find(s => s.id === editId);
                if (staffMember) {
                    document.getElementById('staffModalTitle').textContent = 'Edit Staff';
                    document.getElementById('staffName').value = staffMember.name;
                    document.getElementById('staffRole').value = staffMember.role;
                    document.getElementById('staffDepartment').value = staffMember.department;
                    document.getElementById('staffSalary').value = staffMember.salary;
                    document.getElementById('staffTax').value = staffMember.taxNumber;
                    document.getElementById('staffUif').value = staffMember.uifNumber;
                    document.getElementById('staffCertExpiry').value = staffMember.certExpiry;
                    document.getElementById('staffUsername').value = staffMember.username || '';
                    document.getElementById('staffPassword').value = '';
                }
                const saveBtn = document.querySelector('#addStaffModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateStaff;
            } else {
                document.getElementById('staffModalTitle').textContent = 'Add Staff';
                // Clear form
                new FormData(); // Reset
                const saveBtn = document.querySelector('#addStaffModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveStaff;
                editingStaffId = null;
            }
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }
        function saveStaff() {
            const name = document.getElementById('staffName').value;
            const role = document.getElementById('staffRole').value;
            const department = document.getElementById('staffDepartment').value;
            const salary = parseFloat(document.getElementById('staffSalary').value);
            const tax = document.getElementById('staffTax').value;
            const uif = document.getElementById('staffUif').value;
            const certExpiry = document.getElementById('staffCertExpiry').value;
            const username = document.getElementById('staffUsername').value;
            const password = document.getElementById('staffPassword').value;
            if (name && role && salary) {
                const id = Date.now();
                const newStaff = { id, name, role, department, salary, taxNumber: tax, uifNumber: uif, certExpiry, status: 'Active' };
                if (username && password) {
                    newStaff.username = username;
                    users.push({ username, password, name, role });
                }
                staff.push(newStaff);
                saveData();
                renderStaff();
                bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                addNotification('Staff added', 'success');
            }
        }
        function updateStaff() {
            if (editingStaffId) {
                const staffMember = staff.find(s => s.id === editingStaffId);
                if (staffMember) {
                    staffMember.name = document.getElementById('staffName').value;
                    staffMember.role = document.getElementById('staffRole').value;
                    staffMember.department = document.getElementById('staffDepartment').value;
                    staffMember.salary = parseFloat(document.getElementById('staffSalary').value);
                    staffMember.taxNumber = document.getElementById('staffTax').value;
                    staffMember.uifNumber = document.getElementById('staffUif').value;
                    staffMember.certExpiry = document.getElementById('staffCertExpiry').value;
                    const username = document.getElementById('staffUsername').value;
                    const password = document.getElementById('staffPassword').value;
                    if (password) {
                        const existingUser = users.find(u => u.name === staffMember.name);
                        if (existingUser) {
                            existingUser.password = password;
                        } else if (username) {
                            users.push({ username, password, name: staffMember.name, role: staffMember.role });
                        }
                    }
                    saveData();
                    renderStaff();
                    bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
                    addNotification('Staff updated', 'success');
                }
            }
        }
        function syncStaffBiometric() {
            addNotification('Biometric sync for staff simulated', 'info');
        }
        function generateStaffReport() {
            addNotification('Staff report generated (mock PDF)', 'success');
            // Use jsPDF for actual generation
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text('Staff Report', 10, 10);
            doc.save('staff-report.pdf');
        }
        
        function showBulkStaffModal() {
            new bootstrap.Modal(document.getElementById('bulkStaffModal')).show();
        }
        
        function uploadBulkStaff() {
            const file = document.getElementById('staffFile').files[0];
            if (!file) {
                addNotification('Please select a file', 'warning');
                return;
            }
            
            const fileExt = file.name.split('.').pop().toLowerCase();
            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    let jsonData = [];
                    
                    // Handle different file formats
                    if (fileExt === 'csv' || fileExt === 'xlsx' || fileExt === 'xls') {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, {type: 'array'});
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        jsonData = XLSX.utils.sheet_to_json(sheet);
                    } else if (fileExt === 'pdf') {
                        addNotification('PDF parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    } else if (fileExt === 'doc' || fileExt === 'docx') {
                        addNotification('Word document parsing simulated - please use CSV/Excel for best results', 'info');
                        jsonData = [];
                    }
                    
                    if (jsonData.length === 0) {
                        addNotification('No data found in file', 'warning');
                        return;
                    }
                    
                    // Use advanced import algorithm
                    const fieldMappings = {
                        name: ['name', 'Name', 'NAME', 'full_name', 'Full Name', 'fullname', 'employee_name', 'staff_name'],
                        role: ['role', 'Role', 'ROLE', 'position', 'Position', 'job_title', 'Job Title'],
                        department: ['department', 'Department', 'DEPARTMENT', 'dept', 'Dept'],
                        salary: ['salary', 'Salary', 'SALARY', 'wage', 'Wage', 'pay', 'Pay', 'compensation'],
                        taxNumber: ['taxNumber', 'tax_number', 'Tax Number', 'TAX_NUMBER', 'tax', 'Tax', 'tax_id'],
                        uifNumber: ['uifNumber', 'uif_number', 'UIF Number', 'UIF_NUMBER', 'uif', 'UIF'],
                        certExpiry: ['certExpiry', 'cert_expiry', 'Cert Expiry', 'certificate_expiry', 'expiry_date', 'expiry'],
                        status: ['status', 'Status', 'STATUS', 'state', 'State', 'employment_status'],
                        username: ['username', 'Username', 'USERNAME', 'user', 'User', 'login'],
                        password: ['password', 'Password', 'PASSWORD', 'pass', 'Pass']
                    };
                    
                    const requiredFields = ['name', 'role'];
                    const autoFillDefaults = {
                        status: 'Active',
                        department: 'General',
                        salary: 0,
                        taxNumber: 'Not Provided',
                        uifNumber: 'Not Provided',
                        certExpiry: new Date(Date.now() + 365*24*60*60*1000).toISOString().split('T')[0]
                    };
                    
                    const result = advancedImportParser(jsonData, fieldMappings, requiredFields, autoFillDefaults);
                    
                    // Display preview with advanced information
                    let previewHTML = `<div class="alert alert-info">
                        <strong> Advanced Import Analysis:</strong><br>
                        Total records: ${result.summary.total}<br>
                         Valid records: ${result.summary.valid}<br>
                         Invalid records: ${result.summary.invalid}<br>
                         Auto-corrections applied: ${result.summary.warnings}
                    </div>`;
                    
                    if (result.warnings.length > 0) {
                        previewHTML += `<div class="alert alert-warning">
                            <strong> Auto-Corrections Applied:</strong><br>
                            ${result.warnings.slice(0, 10).map(w => `Row ${w.row}, ${w.field}: ${w.message}`).join('<br>')}
                            ${result.warnings.length > 10 ? `<br>...and ${result.warnings.length - 10} more auto-corrections` : ''}
                        </div>`;
                    }
                    
                    if (result.invalidRecords.length > 0) {
                        previewHTML += `<div class="alert alert-danger">
                            <strong> Invalid Records (will be skipped):</strong><br>
                            ${result.invalidRecords.slice(0, 5).map(r => `Row ${r.row}: ${r.reason}`).join('<br>')}
                            ${result.invalidRecords.length > 5 ? `<br>...and ${result.invalidRecords.length - 5} more invalid records` : ''}
                        </div>`;
                    }
                    
                    if (result.validRecords.length > 0) {
                        previewHTML += `<div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                            <table class="table table-sm">
                                <thead><tr><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Status</th></tr></thead>
                                <tbody>
                                    ${result.validRecords.slice(0, 10).map(r => `<tr><td>${r.name}</td><td>${r.role}</td><td>${r.department}</td><td>R${r.salary ? parseFloat(r.salary).toLocaleString() : '0'}</td><td>${r.status}</td></tr>`).join('')}
                                    ${result.validRecords.length > 10 ? `<tr><td colspan="5">...and ${result.validRecords.length - 10} more</td></tr>` : ''}
                                </tbody>
                            </table>
                        </div>`;
                        previewHTML += `<button class="btn btn-primary mt-2" onclick='confirmStaffImport(${JSON.stringify(result.validRecords)})'>Import ${result.validRecords.length} Staff Members</button>`;
                    }
                    
                    document.getElementById('staffPreview').innerHTML = previewHTML;
                    
                } catch (error) {
                    addNotification('Error parsing file: ' + error.message, 'danger');
                    console.error(error);
                }
            };
            
            reader.readAsArrayBuffer(file);
        }
        
        function confirmStaffImport(records) {
            records.forEach(record => {
                const id = Date.now() + Math.random();
                const newStaff = {
                    id,
                    name: record.name,
                    role: record.role,
                    department: record.department,
                    salary: parseFloat(record.salary) || 0,
                    taxNumber: record.taxNumber,
                    uifNumber: record.uifNumber,
                    certExpiry: record.certExpiry,
                    status: record.status
                };
                
                // Create user account if username and password provided
                if (record.username && record.password) {
                    newStaff.username = record.username;
                    users.push({ 
                        username: record.username, 
                        password: record.password, 
                        name: record.name, 
                        role: record.role 
                    });
                }
                
                staff.push(newStaff);
            });
            saveData();
            renderStaff();
            bootstrap.Modal.getInstance(document.getElementById('bulkStaffModal')).hide();
            addNotification(` Successfully imported ${records.length} staff members with advanced algorithm`, 'success');
            logAudit('Bulk Import', `Imported ${records.length} staff members using advanced algorithm`, 'Low');
        }
        function renderPayrolls() {
            const monthFilter = document.getElementById('payrollMonthFilter').value;
            const filtered = monthFilter ? payrolls.filter(p => p.month === monthFilter) : payrolls;
            document.getElementById('payrollTable').innerHTML = filtered.map(p => {
                const staffMember = staff.find(s => s.id === p.staffId);
                const deductions = p.deductions || 0;
                const tax = p.salary * 0.25; // Mock
                const uif = p.salary * hrSettings.uifRate;
                const net = p.salary - deductions - tax - uif;
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${p.salary.toLocaleString()}</td>
                        <td>R${deductions.toLocaleString()}</td>
                        <td>R${tax.toLocaleString()}</td>
                        <td>R${uif.toLocaleString()}</td>
                        <td>R${net.toLocaleString()}</td>
                        <td><button class="btn btn-sm btn-success" onclick="generatePayslip(${p.id})">Payslip</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const totalPay = filtered.reduce((sum, p) => sum + p.salary, 0);
            const totalDed = filtered.reduce((sum, p) => sum + (p.deductions || 0), 0);
            const netPay = totalPay - totalDed;
            const compliance = Math.random() * 100; // Mock
            document.getElementById('totalPayroll').textContent = 'R' + totalPay.toLocaleString();
            document.getElementById('totalDeductions').textContent = 'R' + totalDed.toLocaleString();
            document.getElementById('netPayroll').textContent = 'R' + netPay.toLocaleString();
            document.getElementById('complianceScore').textContent = Math.round(compliance) + '%';
        }
        function showAddPayrollModal() {
            new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
        }
        function savePayroll() {
            const staffId = document.getElementById('payrollStaff').value;
            const month = document.getElementById('payrollMonth').value;
            const salary = parseFloat(document.getElementById('payrollSalary').value);
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            if (staffId && month && salary) {
                const id = Date.now();
                payrolls.push({ id, staffId, month, salary, deductions });
                saveData();
                renderPayrolls();
                bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
                addNotification('Payroll added', 'success');
            }
        }
        function generatePayroll() {
            staff.forEach(s => {
                if (!payrolls.find(p => p.staffId === s.id && p.month === new Date().toISOString().slice(0,7))) {
                    const id = Date.now();
                    payrolls.push({ id, staffId: s.id, month: new Date().toISOString().slice(0,7), salary: s.salary, deductions: 0 });
                }
            });
            saveData();
            renderPayrolls();
            addNotification('Payroll generated', 'success');
        }
        function exportPayrollToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(payrolls.map(p => ({
                ...p,
                staffName: staff.find(s => s.id === p.staffId)?.name || ''
            })));
            XLSX.utils.book_append_sheet(wb, ws, 'Payroll');
            XLSX.writeFile(wb, 'payroll.xlsx');
            addNotification('Payroll exported', 'success');
        }
        function calculateCompliance() {
            addNotification('Compliance checked (mock)', 'info');
        }
        function generatePayslip(id) {
            const payroll = payrolls.find(p => p.id === id);
            if (payroll) {
                const staffMember = staff.find(s => s.id === payroll.staffId);
                const deductions = payroll.deductions || 0;
                const tax = payroll.salary * 0.25;
                const uif = payroll.salary * hrSettings.uifRate;
                const net = payroll.salary - deductions - tax - uif;
                const payslip = `
                    <div class="payslip-preview">
                        <h4>Payslip for ${staffMember.name}</h4>
                        <p>Month: ${payroll.month}</p>
                        <p>Gross: R${payroll.salary.toLocaleString()}</p>
                        <p>Deductions: R${deductions.toLocaleString()}</p>
                        <p>Tax: R${tax.toLocaleString()}</p>
                        <p>UIF: R${uif.toLocaleString()}</p>
                        <p><strong>Net: R${net.toLocaleString()}</strong></p>
                    </div>
                `;
                // Similar modal as receipt
                addNotification('Payslip generated (mock)', 'success');
            }
        }
        function renderLeaves() {
            const dateFilter = document.getElementById('leaveDateFilter').value;
            const filtered = dateFilter ? leaveRequests.filter(l => l.date === dateFilter) : leaveRequests;
            document.getElementById('leavesTable').innerHTML = filtered.map(l => {
                const staffMember = staff.find(s => s.id === l.staffId);
                return `
                    <tr>
                        <td>${l.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${l.type}</td>
                        <td>${l.date}</td>
                        <td>${l.days}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status}</span></td>
                        <td><button class="btn btn-sm btn-primary" onclick="toggleLeaveStatus(${l.id})">Toggle</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            document.getElementById('totalLeaves').textContent = leaveRequests.length;
            document.getElementById('pendingLeaves').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('approvedLeaves').textContent = leaveRequests.filter(l => l.status === 'Approved').length;
            document.getElementById('rejectedLeaves').textContent = leaveRequests.filter(l => l.status === 'Rejected').length;
            // Chart
            const ctx = document.getElementById('leaveChart').getContext('2d');
            if (leaveChart) leaveChart.destroy();
            leaveChart = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Pending', 'Approved', 'Rejected'],
                    datasets: [{
                        data: [leaveRequests.filter(l => l.status === 'Pending').length, leaveRequests.filter(l => l.status === 'Approved').length, leaveRequests.filter(l => l.status === 'Rejected').length],
                        backgroundColor: ['#FFCE56', '#36A2EB', '#FF6384']
                    }]
                },
                options: { responsive: true }
            });
        }
        function showAddLeaveModal() {
            new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
        }
        function saveLeave() {
            const staffId = document.getElementById('leaveStaff').value;
            const type = document.getElementById('leaveType').value;
            const date = document.getElementById('leaveDate').value;
            const days = parseInt(document.getElementById('leaveDays').value);
            if (staffId && date && days) {
                const id = Date.now();
                leaveRequests.push({ id, staffId, type, date, days, status: 'Pending' });
                saveData();
                renderLeaves();
                bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
                addNotification('Leave request added', 'success');
            }
        }
        function toggleLeaveStatus(id) {
            const leave = leaveRequests.find(l => l.id === id);
            if (leave) {
                leave.status = leave.status === 'Pending' ? 'Approved' : leave.status === 'Approved' ? 'Rejected' : 'Pending';
                saveData();
                renderLeaves();
                addNotification('Leave status updated', 'info');
            }
        }
        function generateLeaveReport() {
            addNotification('Leave report generated (mock)', 'success');
        }
        function renderReviews() {
            const dateFilter = document.getElementById('reviewDateFilter').value;
            const filtered = dateFilter ? performanceReviews.filter(r => r.date === dateFilter) : performanceReviews;
            document.getElementById('reviewsTable').innerHTML = filtered.map(r => {
                const staffMember = staff.find(s => s.id === r.staffId);
                return `
                    <tr>
                        <td>${r.id}</td>
                        <td>${staffMember ? staffMember.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td>${r.score}</td>
                        <td>${r.comments}</td>
                        <td><button class="btn btn-sm btn-warning" onclick="editReview(${r.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Metrics
            const avgScore = performanceReviews.length > 0 ? Math.round(performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length) : 0;
            document.getElementById('avgScore').textContent = avgScore;
            document.getElementById('totalReviews').textContent = performanceReviews.length;
            document.getElementById('goalsAchieved').textContent = performanceReviews.filter(r => r.score > 80).length;
            document.getElementById('pendingFeedback').textContent = 0; // Mock
            // Chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Scores'],
                    datasets: [{
                        label: 'Average',
                        data: [avgScore],
                        backgroundColor: '#4BC0C0'
                    }]
                },
                options: { responsive: true }
            });
        }
        function showAddReviewModal() {
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }
        function saveReview() {
            const staffId = document.getElementById('reviewStaff').value;
            const date = document.getElementById('reviewDate').value;
            const score = parseFloat(document.getElementById('reviewScore').value);
            const comments = document.getElementById('reviewComments').value;
            if (staffId && date && score) {
                const id = Date.now();
                performanceReviews.push({ id, staffId, date, score, comments });
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                addNotification('Review added', 'success');
            }
        }
        function editReview(id) {
            editingReviewId = id;
            const review = performanceReviews.find(r => r.id === id);
            if (review) {
                document.getElementById('reviewStaff').value = review.staffId;
                document.getElementById('reviewDate').value = review.date;
                document.getElementById('reviewScore').value = review.score;
                document.getElementById('reviewComments').value = review.comments;
                // Override save
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Update';
                saveBtn.onclick = updateReview;
                new bootstrap.Modal(document.getElementById('addReviewModal')).show();
            }
        }
        function updateReview() {
            const review = performanceReviews.find(r => r.id === editingReviewId);
            if (review) {
                review.staffId = document.getElementById('reviewStaff').value;
                review.date = document.getElementById('reviewDate').value;
                review.score = parseFloat(document.getElementById('reviewScore').value);
                review.comments = document.getElementById('reviewComments').value;
                saveData();
                renderReviews();
                bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
                const saveBtn = document.querySelector('#addReviewModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveReview;
                addNotification('Review updated', 'success');
            }
        }
        function generatePerformanceReport() {
            addNotification('Performance report generated (mock)', 'success');
        }
        function renderJobs() {
            const search = document.getElementById('jobSearch').value.toLowerCase();
            const filtered = jobs.filter(j => j.title.toLowerCase().includes(search));
            document.getElementById('jobTable').innerHTML = filtered.map(j => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.department}</td>
                    <td>${j.applications || 0}</td>
                    <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'danger'}">${j.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editJob(${j.id})">Edit</button> <button class="btn btn-sm btn-info" onclick="showScheduleInterviewModal(${j.id})">Schedule</button></td>
                </tr>
            `).join('');
            // Metrics
            document.getElementById('openPositions').textContent = jobs.filter(j => j.status === 'Open').length;
            document.getElementById('totalApplications').textContent = jobs.reduce((sum, j) => sum + (j.applications || 0), 0);
            document.getElementById('interviewsScheduled').textContent = 0; // Mock
            document.getElementById('hireRate').textContent = '0%'; // Mock
        }
        function showAddJobModal(editId) {
            editingJob = editId || null;
            if (editId) {
                const job = jobs.find(j => j.id === editId);
                if (job) {
                    document.getElementById('jobModalTitle').textContent = 'Edit Job';
                    document.getElementById('jobTitle').value = job.title;
                    document.getElementById('jobDepartment').value = job.department;
                    document.getElementById('jobDescription').value = job.description;
                    document.getElementById('jobStatus').value = job.status;
                    const saveBtn = document.querySelector('#addJobModal .btn-primary');
                    saveBtn.textContent = 'Update';
                    saveBtn.onclick = updateJob;
                }
            } else {
                document.getElementById('jobModalTitle').textContent = 'Add Job';
                // Clear
                const saveBtn = document.querySelector('#addJobModal .btn-primary');
                saveBtn.textContent = 'Save';
                saveBtn.onclick = saveJob;
            }
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }
        function saveJob() {
            const title = document.getElementById('jobTitle').value;
            const department = document.getElementById('jobDepartment').value;
            const description = document.getElementById('jobDescription').value;
            const status = document.getElementById('jobStatus').value;
            if (title && department) {
                const id = Date.now();
                jobs.push({ id, title, department, description, status, applications: 0 });
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                addNotification('Job added', 'success');
            }
        }
        function updateJob() {
            if (editingJob) {
                const job = jobs.find(j => j.id === editingJob);
                if (job) {
                    job.title = document.getElementById('jobTitle').value;
                    job.department = document.getElementById('jobDepartment').value;
                    job.description = document.getElementById('jobDescription').value;
                    job.status = document.getElementById('jobStatus').value;
                    saveData();
                    renderJobs();
                    bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
                    addNotification('Job updated', 'success');
                }
            }
        }
        function editJob(id) {
            showAddJobModal(id);
        }
        function showApplyJobModal() {
            new bootstrap.Modal(document.getElementById('applyJobModal')).show();
        }
        function submitApplication() {
            const jobId = document.getElementById('applyJobSelect').value;
            const name = document.getElementById('applicantName').value;
            const email = document.getElementById('applicantEmail').value;
            const phone = document.getElementById('applicantPhone').value;
            const coverLetter = document.getElementById('applicantCoverLetter').value;
            const job = jobs.find(j => j.id === jobId);
            if (job && name && email) {
                job.applications = (job.applications || 0) + 1;
                // Mock applicant
                addNotification(`Application from ${name} for ${job.title}`, 'info');
                saveData();
                renderJobs();
                bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
            }
        }
        function showScheduleInterviewModal(jobId) {
            // Mock applicant for job
            document.getElementById('interviewApplicant').value = 'Mock Applicant';
            new bootstrap.Modal(document.getElementById('scheduleInterviewModal')).show();
        }
        function saveInterview() {
            const dateTime = document.getElementById('interviewDateTime').value;
            const type = document.getElementById('interviewType').value;
            const notes = document.getElementById('interviewNotes').value;
            if (dateTime) {
                addNotification(`Interview scheduled for ${dateTime}`, 'success');
                bootstrap.Modal.getInstance(document.getElementById('scheduleInterviewModal')).hide();
            }
        }
        function generateRecruitmentReport() {
            addNotification('Recruitment report generated (mock)', 'success');
        }
        function renderAudit() {
            const dateFilter = document.getElementById('auditDateFilter').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            const filtered = auditLog.filter(a => 
                (!dateFilter || a.timestamp.startsWith(dateFilter)) &&
                (!actionFilter || a.action === actionFilter)
            );
            document.getElementById('auditTable').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.timestamp}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                    <td><span class="badge bg-${a.risk === 'High' ? 'danger' : 'warning'}">${a.risk}</span></td>
                </tr>
            `).join('');
            // Metrics
            document.getElementById('totalAudit').textContent = auditLog.length;
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('todayAudit').textContent = auditLog.filter(a => a.timestamp.startsWith(today)).length;
            document.getElementById('highRiskAudit').textContent = auditLog.filter(a => a.risk === 'High').length;
            document.getElementById('complianceIssues').textContent = 0; // Mock
        }
        function generateAuditReport() {
            addNotification('Audit report generated (mock)', 'success');
        }
        function exportAuditToExcel() {
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(auditLog);
            XLSX.utils.book_append_sheet(wb, ws, 'Audit');
            XLSX.writeFile(wb, 'audit.xlsx');
            addNotification('Audit exported', 'success');
        }

        // Communication
        function renderMessages() {
            document.getElementById('messagesContainer').innerHTML = messages.map(m => `
                <div class="chat-message ${m.sender === currentUser.name ? 'chat-user' : 'chat-assistant'}">
                    <strong>${m.sender}:</strong> ${m.text} <small>${m.timestamp}</small>
                </div>
            `).join('');
        }
        function showSendMessageModal() {
            new bootstrap.Modal(document.getElementById('sendMessageModal')).show();
        }
        function sendMessage() {
            const recipient = document.getElementById('messageRecipient').value;
            const text = document.getElementById('messageText').value;
            const viaSMS = document.getElementById('sendViaSMS').checked;
            if (text) {
                const id = Date.now();
                messages.push({ id, sender: currentUser.name, recipient, text, timestamp: new Date().toLocaleString(), viaSMS });
                if (viaSMS) {
                    // Mock SMS
                    addNotification('SMS sent via WinSMS', 'info');
                }
                saveData();
                renderMessages();
                bootstrap.Modal.getInstance(document.getElementById('sendMessageModal')).hide();
                addNotification('Message sent', 'success');
            }
        }
        function viewAnnouncements() {
            announcements.forEach(a => {
                addNotification(a.title + ': ' + a.content, 'info');
            });
        }
        
        // Enhanced Announcements Functions
        function showAnnouncementsModal() {
            renderAnnouncementsList();
            new bootstrap.Modal(document.getElementById('announcementsModal')).show();
        }
        
        function renderAnnouncementsList() {
            const container = document.getElementById('announcementsList');
            if (announcements.length === 0) {
                container.innerHTML = '<p class="text-muted">No announcements yet.</p>';
                return;
            }
            container.innerHTML = announcements.map(a => {
                const priorityClass = a.priority === 'Urgent' ? 'danger' : a.priority === 'High' ? 'warning' : a.priority === 'Medium' ? 'info' : 'secondary';
                return `
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h6 class="card-title">${a.title || 'Untitled'}</h6>
                                <span class="badge bg-${priorityClass}">${a.priority || 'Medium'}</span>
                            </div>
                            <p class="card-text">${a.content || ''}</p>
                            <small class="text-muted">
                                <i class="fas fa-users me-1"></i>${a.audience || 'All'} | 
                                <i class="fas fa-clock me-1"></i>${a.timestamp ? new Date(a.timestamp).toLocaleString() : 'N/A'}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function createAnnouncement() {
            const title = document.getElementById('announcementTitle').value.trim();
            const content = document.getElementById('announcementContent').value.trim();
            const priority = document.getElementById('announcementPriority').value;
            const audience = document.getElementById('announcementAudience').value;
            
            if (!title || !content) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const announcement = {
                id: Date.now(),
                title: title,
                content: content,
                priority: priority,
                audience: audience,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push(announcement);
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Clear form
            document.getElementById('announcementTitle').value = '';
            document.getElementById('announcementContent').value = '';
            document.getElementById('announcementPriority').value = 'Medium';
            document.getElementById('announcementAudience').value = 'All';
            
            renderAnnouncementsList();
            addNotification('Announcement published successfully', 'success');
        }
        
        function createPoster() {
            const title = document.getElementById('posterTitle').value.trim();
            const date = document.getElementById('posterDate').value;
            const time = document.getElementById('posterTime').value;
            const location = document.getElementById('posterLocation').value.trim();
            const description = document.getElementById('posterDescription').value.trim();
            
            if (!title || !date) {
                addNotification('Please provide at least a title and date', 'warning');
                return;
            }
            
            const poster = {
                id: Date.now(),
                type: 'poster',
                title: title,
                date: date,
                time: time,
                location: location,
                description: description,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push({
                id: poster.id,
                title: `Event: ${title}`,
                content: `${description} | Date: ${date} ${time || ''} | Location: ${location}`,
                priority: 'High',
                audience: 'All',
                timestamp: poster.timestamp,
                createdBy: poster.createdBy,
                type: 'poster'
            });
            
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Display poster preview
            document.getElementById('posterPreview').innerHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Poster Created!</h5>
                    <div class="card mt-2" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px;">
                        <h3 class="text-center">${title}</h3>
                        <hr style="border-color: rgba(255,255,255,0.3);">
                        <p><i class="fas fa-calendar me-2"></i><strong>Date:</strong> ${date}</p>
                        ${time ? `<p><i class="fas fa-clock me-2"></i><strong>Time:</strong> ${time}</p>` : ''}
                        ${location ? `<p><i class="fas fa-map-marker-alt me-2"></i><strong>Location:</strong> ${location}</p>` : ''}
                        ${description ? `<p class="mt-3">${description}</p>` : ''}
                    </div>
                </div>
            `;
            
            // Clear form
            document.getElementById('posterTitle').value = '';
            document.getElementById('posterDate').value = '';
            document.getElementById('posterTime').value = '';
            document.getElementById('posterLocation').value = '';
            document.getElementById('posterDescription').value = '';
            
            renderAnnouncementsList();
            addNotification('Poster created and published', 'success');
        }
        
        function uploadVideo() {
            const title = document.getElementById('videoTitle').value.trim();
            const description = document.getElementById('videoDescription').value.trim();
            const videoFile = document.getElementById('videoFile').files[0];
            const videoURL = document.getElementById('videoURL').value.trim();
            
            if (!title) {
                addNotification('Please provide a video title', 'warning');
                return;
            }
            
            if (!videoFile && !videoURL) {
                addNotification('Please upload a video file or provide a video URL', 'warning');
                return;
            }
            
            const video = {
                id: Date.now(),
                type: 'video',
                title: title,
                description: description,
                url: videoURL,
                fileName: videoFile ? videoFile.name : null,
                timestamp: new Date().toISOString(),
                createdBy: currentUser.name
            };
            
            announcements.push({
                id: video.id,
                title: `Video: ${title}`,
                content: description + (videoURL ? ` | ${videoURL}` : ''),
                priority: 'Medium',
                audience: 'All',
                timestamp: video.timestamp,
                createdBy: video.createdBy,
                type: 'video'
            });
            
            localStorage.setItem('announcements', JSON.stringify(announcements));
            
            // Display video preview
            let previewHTML = `
                <div class="alert alert-success">
                    <h5><i class="fas fa-check-circle me-2"></i>Video Uploaded!</h5>
                    <div class="card mt-2">
                        <div class="card-body">
                            <h6>${title}</h6>
                            <p>${description}</p>
            `;
            
            if (videoURL) {
                // Try to embed if it's a YouTube or Vimeo link
                if (videoURL.includes('youtube.com') || videoURL.includes('youtu.be')) {
                    let videoId = '';
                    if (videoURL.includes('youtube.com/watch?v=')) {
                        videoId = videoURL.split('v=')[1].split('&')[0];
                    } else if (videoURL.includes('youtu.be/')) {
                        videoId = videoURL.split('youtu.be/')[1].split('?')[0];
                    }
                    if (videoId) {
                        previewHTML += `<iframe width="100%" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
                    }
                } else {
                    previewHTML += `<p><a href="${videoURL}" target="_blank" class="btn btn-sm btn-primary"><i class="fas fa-external-link-alt me-2"></i>View Video</a></p>`;
                }
            } else if (videoFile) {
                previewHTML += `<p><i class="fas fa-file-video me-2"></i>File: ${videoFile.name}</p>`;
            }
            
            previewHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('videoPreview').innerHTML = previewHTML;
            
            // Clear form
            document.getElementById('videoTitle').value = '';
            document.getElementById('videoDescription').value = '';
            document.getElementById('videoFile').value = '';
            document.getElementById('videoURL').value = '';
            
            renderAnnouncementsList();
            addNotification('Video uploaded and published', 'success');
        }
        
        function clearAllCommunications() {
            if (confirm('Are you sure you want to clear all notifications and messages? This action cannot be undone.')) {
                // Clear notifications
                localStorage.removeItem('notifications');
                document.getElementById('notificationBadge').style.display = 'none';
                document.getElementById('notificationBadge').textContent = '0';
                
                // Clear messages
                messages = [];
                
                // Clear live chat messages
                liveChatMessages = [];
                localStorage.removeItem('liveChatMessages');
                
                saveData();
                renderMessages();
                renderLiveChatMessages();
                
                addNotification('All communications cleared', 'success');
            }
        }
        
        // Live Chat Functionality
        let liveChatMessages = JSON.parse(localStorage.getItem('liveChatMessages') || '[]');
        let liveChatInterval = null;
        
        function startLiveChat() {
            document.getElementById('liveChatContainer').classList.remove('d-none');
            renderLiveChatMessages();
            addNotification('Live chat started! You can now communicate with all students and teachers.', 'success');
            
            // Auto-refresh chat every 2 seconds
            if (liveChatInterval) clearInterval(liveChatInterval);
            liveChatInterval = setInterval(renderLiveChatMessages, 2000);
        }
        
        function closeLiveChat() {
            document.getElementById('liveChatContainer').classList.add('d-none');
            if (liveChatInterval) {
                clearInterval(liveChatInterval);
                liveChatInterval = null;
            }
        }
        
        function sendLiveChatMessage() {
            const input = document.getElementById('liveChatInput');
            const text = input.value.trim();
            
            if (!text) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const message = {
                id: Date.now(),
                sender: currentUser.name,
                role: currentUser.role,
                text: text,
                timestamp: new Date().toISOString()
            };
            
            liveChatMessages.push(message);
            localStorage.setItem('liveChatMessages', JSON.stringify(liveChatMessages));
            
            input.value = '';
            renderLiveChatMessages();
            
            // Scroll to bottom
            const container = document.getElementById('liveChatMessages');
            container.scrollTop = container.scrollHeight;
        }
        
        function renderLiveChatMessages() {
            const container = document.getElementById('liveChatMessages');
            if (!container) return;
            
            // Get last 50 messages
            const recentMessages = liveChatMessages.slice(-50);
            
            let html = '';
            recentMessages.forEach(msg => {
                const isCurrentUser = msg.sender === currentUser.name;
                const alignClass = isCurrentUser ? 'text-end' : 'text-start';
                const bgClass = isCurrentUser ? 'bg-primary' : 'bg-secondary';
                const roleColor = msg.role === 'teacher' ? 'warning' : msg.role === 'admin' ? 'danger' : 'info';
                
                html += `
                    <div class="${alignClass} mb-3">
                        <div class="d-inline-block" style="max-width: 70%;">
                            <div class="mb-1">
                                <span class="badge bg-${roleColor}">${msg.sender}</span>
                                <small class="text-muted ms-2">${new Date(msg.timestamp).toLocaleString()}</small>
                            </div>
                            <div class="p-3 rounded ${bgClass}" style="word-wrap: break-word;">
                                ${msg.text}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html || '<p class="text-center text-muted">No messages yet. Start the conversation!</p>';
        }
        
        function startChat() {
            startLiveChat();
        }

        // Content Management
        function renderContents() {
            const search = document.getElementById('contentSearch').value.toLowerCase();
            const filtered = contents.filter(c => c.title.toLowerCase().includes(search));
            document.getElementById('contentTable').innerHTML = filtered.map(c => `
                <tr>
                    <td>${c.id}</td>
                    <td>${c.title}</td>
                    <td>${c.type}</td>
                    <td><span class="badge bg-${c.status === 'Published' ? 'success' : 'warning'}">${c.status}</span></td>
                    <td><button class="btn btn-sm btn-primary" onclick="editContent(${c.id})">Edit</button></td>
                </tr>
            `).join('');
        }
        function showAddContentModal() {
            new bootstrap.Modal(document.getElementById('addContentModal')).show();
        }
        function saveContent() {
            const title = document.getElementById('contentTitle').value;
            const type = document.getElementById('contentType').value;
            const body = document.getElementById('contentBody').value;
            const status = document.getElementById('contentStatus').value;
            const file = document.getElementById('contentFile').files[0];
            if (title && body) {
                const id = Date.now();
                contents.push({ id, title, type, body, status, file: file ? file.name : '' });
                saveData();
                renderContents();
                bootstrap.Modal.getInstance(document.getElementById('addContentModal')).hide();
                addNotification('Content added', 'success');
            }
        }
        function editContent(id) {
            // Similar edit logic
            alert('Edit content ' + id + ' (implement)');
        }
        function searchContent() {
            renderContents();
        }

        // Reports
        function generateReport() {
            const type = document.getElementById('reportType').value;
            let report = '';
            switch (type) {
                case 'attendance':
                    report = 'Attendance Report: ' + Object.keys(attendanceRecords).length + ' days';
                    break;
                case 'fees':
                    report = 'Fee Report: R' + fees.reduce((sum, f) => sum + f.amount, 0).toLocaleString();
                    break;
                case 'exams':
                    report = 'Exam Report: ' + exams.length + ' exams';
                    break;
                case 'hr':
                    report = 'HR Report: ' + staff.length + ' staff';
                    break;
                case 'incidents':
                    report = `Incident Reports: ${incidentReports.length} total reports<br>
                             High Severity: ${incidentReports.filter(i => i.severity === 'high').length}<br>
                             Medium Severity: ${incidentReports.filter(i => i.severity === 'medium').length}<br>
                             Low Severity: ${incidentReports.filter(i => i.severity === 'low').length}`;
                    break;
                case 'events':
                    const today = new Date().toISOString().split('T')[0];
                    report = `School Events: ${schoolEvents.length} total events<br>
                             Upcoming: ${schoolEvents.filter(e => e.date >= today).length}<br>
                             Past: ${schoolEvents.filter(e => e.date < today).length}<br>
                             Notifications Sent: ${schoolEvents.filter(e => e.notificationsSent > 0).length}`;
                    break;
            }
            document.getElementById('reportOutput').innerHTML = `<div class="report-card">${report}</div>`;
            document.getElementById('reportOutput').classList.remove('d-none');
        }
        
        function viewAllIncidents() {
            const reportOutput = document.getElementById('reportOutput');
            reportOutput.classList.remove('d-none');
            
            let html = '<h4>All Incident Reports</h4>';
            html += '<table class="table table-striped"><thead><tr>';
            html += '<th>Date</th><th>Student</th><th>Type</th><th>Severity</th><th>Description</th><th>Action</th><th>Reporter</th>';
            html += '</tr></thead><tbody>';
            
            incidentReports.forEach(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                html += `<tr>
                    <td>${incident.date}</td>
                    <td>${incident.studentName}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            
            if (incidentReports.length === 0) {
                html = '<p class="text-center text-muted">No incident reports found.</p>';
            }
            
            reportOutput.innerHTML = html;
        }
        
        function exportReport() {
            addNotification('Report exported (mock)', 'success');
        }

        // Settings
        function loadSettings() {
            document.getElementById('smsUsername').value = smsSettings.username;
            document.getElementById('smsPassword').value = smsSettings.password;
            document.getElementById('annualLeaveDays').value = hrSettings.annualLeaveDays;
            document.getElementById('uifRate').value = hrSettings.uifRate * 100;
            if (document.getElementById('chatGPTApiKey')) {
                document.getElementById('chatGPTApiKey').value = chatGPTSettings.apiKey;
                document.getElementById('chatGPTModel').value = chatGPTSettings.model;
            }
            if (document.getElementById('grokApiKey')) {
                document.getElementById('grokApiKey').value = grokSettings.apiKey;
                document.getElementById('grokModel').value = grokSettings.model;
            }
        }
        function saveSMSSettings() {
            smsSettings.username = document.getElementById('smsUsername').value;
            smsSettings.password = document.getElementById('smsPassword').value;
            saveData();
            addNotification('SMS settings saved', 'success');
        }
        function updateHRSettings() {
            hrSettings.annualLeaveDays = parseInt(document.getElementById('annualLeaveDays').value);
            hrSettings.uifRate = parseFloat(document.getElementById('uifRate').value) / 100;
            saveData();
            addNotification('HR settings updated', 'success');
        }
        
        function saveChatGPTSettings() {
            chatGPTSettings.apiKey = document.getElementById('chatGPTApiKey').value;
            chatGPTSettings.model = document.getElementById('chatGPTModel').value;
            chatGPTSettings.enabled = chatGPTSettings.apiKey.length > 0;
            saveData();
            addNotification('ChatGPT API settings saved', 'success');
        }
        
        function saveGrokSettings() {
            grokSettings.apiKey = document.getElementById('grokApiKey').value;
            grokSettings.model = document.getElementById('grokModel').value;
            grokSettings.enabled = grokSettings.apiKey.length > 0;
            saveData();
            addNotification('Grok API settings saved', 'success');
        }
        
        function configureChatGPTAPI() {
            const apiKey = document.getElementById('chatGPTApiKey').value;
            const model = document.getElementById('chatGPTModel').value;
            
            if (!apiKey) {
                addNotification('Please enter a ChatGPT API key', 'warning');
                return;
            }
            
            // Test the API configuration
            addNotification('Testing ChatGPT API configuration...', 'info');
            
            // Mock API test - in real implementation, this would make a test API call
            setTimeout(() => {
                chatGPTSettings.apiKey = apiKey;
                chatGPTSettings.model = model;
                chatGPTSettings.enabled = true;
                saveData();
                addNotification('ChatGPT API configured successfully!', 'success');
                logAudit('API Configuration', 'Configured ChatGPT API', 'Low');
            }, 1000);
        }
        
        function configureGrokAPI() {
            const apiKey = document.getElementById('grokApiKey').value;
            const model = document.getElementById('grokModel').value;
            
            if (!apiKey) {
                addNotification('Please enter a Grok API key', 'warning');
                return;
            }
            
            // Test the API configuration
            addNotification('Testing Grok API configuration...', 'info');
            
            // Mock API test - in real implementation, this would make a test API call
            setTimeout(() => {
                grokSettings.apiKey = apiKey;
                grokSettings.model = model;
                grokSettings.enabled = true;
                saveData();
                addNotification('Grok API configured successfully!', 'success');
                logAudit('API Configuration', 'Configured Grok API', 'Low');
            }, 1000);
        }
        
        function backupData() {
            const data = { ...window }; // Mock full backup
            const blob = new Blob([JSON.stringify(data)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'asms-backup.json';
            a.click();
            addNotification('Data backed up', 'success');
        }
        function restoreData() {
            if (confirm('Restore will overwrite data?')) {
                // Implement file upload and restore
                addNotification('Data restored (mock)', 'success');
            }
        }
        
        // Theme Generator Functions
        const themes = {
            default: {
                name: 'Default Purple',
                primaryGradientStart: '#667eea',
                primaryGradientEnd: '#764ba2',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            ocean: {
                name: 'Ocean Blue',
                primaryGradientStart: '#1e3c72',
                primaryGradientEnd: '#2a5298',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            forest: {
                name: 'Forest Green',
                primaryGradientStart: '#134e5e',
                primaryGradientEnd: '#71b280',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            sunset: {
                name: 'Sunset Orange',
                primaryGradientStart: '#f46b45',
                primaryGradientEnd: '#eea849',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            },
            midnight: {
                name: 'Midnight Dark',
                primaryGradientStart: '#232526',
                primaryGradientEnd: '#414345',
                textColor: '#fff',
                cardBg: 'rgba(255, 255, 255, 0.25)',
                cardBgHover: 'rgba(255, 255, 255, 0.35)',
                sidebarBg: 'rgba(255, 255, 255, 0.15)',
                sidebarBorder: 'rgba(255, 255, 255, 0.3)',
                tableBg: 'rgba(255, 255, 255, 0.1)',
                tableThBg: 'rgba(255, 255, 255, 0.2)',
                btnToggleBg: 'rgba(255, 255, 255, 0.2)'
            }
        };
        
        function applyTheme(themeName) {
            const theme = themes[themeName];
            if (!theme) return;
            
            // Apply CSS variables
            const root = document.documentElement;
            root.style.setProperty('--primary-gradient-start', theme.primaryGradientStart);
            root.style.setProperty('--primary-gradient-end', theme.primaryGradientEnd);
            root.style.setProperty('--text-color', theme.textColor);
            root.style.setProperty('--card-bg', theme.cardBg);
            root.style.setProperty('--card-bg-hover', theme.cardBgHover);
            root.style.setProperty('--sidebar-bg', theme.sidebarBg);
            root.style.setProperty('--sidebar-border', theme.sidebarBorder);
            root.style.setProperty('--table-bg', theme.tableBg);
            root.style.setProperty('--table-th-bg', theme.tableThBg);
            root.style.setProperty('--btn-toggle-bg', theme.btnToggleBg);
            
            // Save to localStorage
            localStorage.setItem('selectedTheme', themeName);
            
            // Update UI to show active theme
            updateThemeSelector(themeName);
            
            // Show notification
            addNotification(`Theme changed to ${theme.name}`, 'success');
        }
        
        function updateThemeSelector(themeName) {
            // Remove active class from all theme options
            document.querySelectorAll('.theme-option').forEach(option => {
                option.classList.remove('active');
            });
            
            // Add active class to selected theme
            const selectedTheme = document.querySelector(`[data-theme="${themeName}"]`);
            if (selectedTheme) {
                selectedTheme.classList.add('active');
            }
        }
        
        function loadSavedTheme() {
            const savedTheme = localStorage.getItem('selectedTheme') || 'default';
            applyTheme(savedTheme);
        }
        
        // Vault Functions
        function updateVaultMetrics() {
            document.getElementById('vaultTotalItems').textContent = dataVault.length;
            document.getElementById('vaultAttendanceResets').textContent = dataVault.filter(v => v.type === 'Attendance Reset').length;
            document.getElementById('vaultStudentResets').textContent = dataVault.filter(v => v.type === 'Student Reset').length;
            document.getElementById('vaultFeeResets').textContent = dataVault.filter(v => v.type === 'Fee Reset').length;
        }
        
        function showVaultViewer() {
            const vaultContent = document.getElementById('vaultContent');
            if (vaultContent.classList.contains('d-none')) {
                vaultContent.classList.remove('d-none');
                renderVaultTable();
            } else {
                vaultContent.classList.add('d-none');
            }
        }
        
        function renderVaultTable() {
            const tbody = document.getElementById('vaultTable');
            tbody.innerHTML = dataVault.slice().reverse().map(item => `
                <tr>
                    <td>${new Date(item.timestamp).toLocaleString()}</td>
                    <td><span class="badge bg-info">${item.type}</span></td>
                    <td>${item.description}<br><small class="text-muted">By: ${item.user}</small></td>
                    <td>
                        <button class="btn btn-sm btn-primary" onclick="viewVaultItem(${item.id})">View</button>
                        <button class="btn btn-sm btn-success" onclick="restoreVaultItem(${item.id})">Restore</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteVaultItem(${item.id})">Delete</button>
                    </td>
                </tr>
            `).join('');
        }
        
        function viewVaultItem(id) {
            const item = dataVault.find(v => v.id === id);
            if (item) {
                const dataPreview = JSON.stringify(item.data, null, 2).substring(0, 500) + '...';
                alert(`Vault Item Details:\n\nType: ${item.type}\nTimestamp: ${new Date(item.timestamp).toLocaleString()}\nDescription: ${item.description}\nUser: ${item.user}\n\nData Preview:\n${dataPreview}`);
            }
        }
        
        function restoreVaultItem(id) {
            const item = dataVault.find(v => v.id === id);
            if (!item) return;
            
            if (confirm(`Restore ${item.type}? This will overwrite current data.`)) {
                switch(item.type) {
                    case 'Attendance Reset':
                        attendanceRecords = JSON.parse(JSON.stringify(item.data));
                        loadAttendance();
                        addNotification('Attendance data restored from vault', 'success');
                        break;
                    case 'Student Reset':
                        students = JSON.parse(JSON.stringify(item.data));
                        renderStudents();
                        addNotification('Student data restored from vault', 'success');
                        break;
                    case 'Admission Reset':
                        admissions = JSON.parse(JSON.stringify(item.data));
                        renderAdmissions();
                        addNotification('Admission data restored from vault', 'success');
                        break;
                    case 'Fee Reset':
                        fees = JSON.parse(JSON.stringify(item.data));
                        renderFees();
                        addNotification('Fee data restored from vault', 'success');
                        break;
                }
                saveData();
                logAudit('Vault Restore', `Restored ${item.type} from vault`, 'Medium');
            }
        }
        
        function deleteVaultItem(id) {
            if (confirm('Delete this vault item permanently?')) {
                dataVault = dataVault.filter(v => v.id !== id);
                saveData();
                renderVaultTable();
                updateVaultMetrics();
                addNotification('Vault item deleted', 'warning');
                logAudit('Vault Delete', 'Deleted vault item', 'Low');
            }
        }
        
        function exportVault() {
            const blob = new Blob([JSON.stringify(dataVault, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `vault-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            addNotification('Vault exported successfully', 'success');
            logAudit('Vault Export', 'Exported vault data', 'Low');
        }
        
        function clearVault() {
            if (confirm('Clear all vault data? This cannot be undone.')) {
                if (confirm('Final warning: All vault items will be permanently deleted.')) {
                    dataVault = [];
                    saveData();
                    renderVaultTable();
                    updateVaultMetrics();
                    addNotification('Vault cleared', 'danger');
                    logAudit('Vault Clear', 'Cleared all vault data', 'High');
                }
            }
        }

        // Parent Portal
        function loadParentPortal() {
            // Mock child
            const child = students.find(s => s.parent === currentUser.name) || students[0];
            document.getElementById('parentChildInfo').innerHTML = `<h4>Child: ${child ? child.name : 'No child'}</h4>`;
            // Attendance
            const recentAttendance = Object.entries(attendanceRecords).slice(-5).map(([date, records]) => {
                const status = records[child.id]?.status || 'Absent';
                return `<p>${date}: ${status}</p>`;
            }).join('');
            document.getElementById('parentAttendance').innerHTML = recentAttendance;
            // Fees
            const parentFees = fees.filter(f => students.find(s => s.id === f.studentId)?.parent === currentUser.name);
            document.getElementById('parentFees').innerHTML = parentFees.map(f => `
                <p>${f.description}: R${f.amount} - ${f.status}</p>
            `).join('');
            // Grades
            const parentGrades = grades.filter(g => students.find(s => s.id === g.studentId)?.parent === currentUser.name);
            document.getElementById('parentGrades').innerHTML = parentGrades.map(g => `
                <p>${g.subject}: ${g.score}%</p>
            `).join('');
            // Announcements
            document.getElementById('parentAnnouncements').innerHTML = announcements.map(a => `<p><strong>${a.title}</strong>: ${a.content}</p>`).join('');
        }

        // Student Module Functions
        
        // Load Student Timetable
        function loadStudentTimetable() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Mock timetable data - in a real system, this would be filtered for the current student's class
            const timetableData = timetable.length > 0 ? timetable : [
                { day: 'Monday', period: '08:00-09:00', subject: 'Mathematics', teacher: 'Mr. Smith' },
                { day: 'Monday', period: '09:00-10:00', subject: 'English', teacher: 'Mrs. Johnson' },
                { day: 'Monday', period: '10:00-11:00', subject: 'Science', teacher: 'Dr. Brown' },
                { day: 'Tuesday', period: '08:00-09:00', subject: 'History', teacher: 'Ms. Davis' },
                { day: 'Tuesday', period: '09:00-10:00', subject: 'Geography', teacher: 'Mr. Wilson' },
                { day: 'Wednesday', period: '08:00-09:00', subject: 'Physical Education', teacher: 'Coach Taylor' },
            ];
            
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            let html = '<div class="table-responsive"><table class="table table-bordered">';
            html += '<thead><tr><th>Time</th>';
            days.forEach(day => html += `<th>${day}</th>`);
            html += '</tr></thead><tbody>';
            
            const periods = ['08:00-09:00', '09:00-10:00', '10:00-11:00', '11:00-12:00', '13:00-14:00', '14:00-15:00'];
            periods.forEach(period => {
                html += `<tr><td><strong>${period}</strong></td>`;
                days.forEach(day => {
                    const slot = timetableData.find(t => t.day === day && t.period === period);
                    if (slot) {
                        html += `<td class="timetable-cell">
                            <div><strong>${slot.subject}</strong></div>
                            <div><small>${slot.teacher}</small></div>
                        </td>`;
                    } else {
                        html += '<td class="timetable-cell">-</td>';
                    }
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            document.getElementById('studentTimetableContainer').innerHTML = html;
        }
        
        // Load Student Examination
        function loadStudentExamination() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Mock exam data
            const upcomingExams = [
                { subject: 'Mathematics', date: '2025-12-01', time: '09:00', duration: '2 hours', status: 'Scheduled' },
                { subject: 'English', date: '2025-12-03', time: '10:00', duration: '1.5 hours', status: 'Scheduled' },
                { subject: 'Science', date: '2025-12-05', time: '09:00', duration: '2 hours', status: 'Scheduled' },
            ];
            
            const pastResults = [
                { subject: 'Mathematics', exam: 'Mid-term', date: '2025-10-15', score: 85, grade: 'B', comments: 'Good work!' },
                { subject: 'English', exam: 'Mid-term', date: '2025-10-16', score: 92, grade: 'A', comments: 'Excellent!' },
                { subject: 'Science', exam: 'Mid-term', date: '2025-10-17', score: 78, grade: 'C', comments: 'Needs improvement' },
            ];
            
            // Update metrics
            document.getElementById('studentUpcomingExams').textContent = upcomingExams.length;
            const avgScore = Math.round(pastResults.reduce((sum, r) => sum + r.score, 0) / pastResults.length);
            document.getElementById('studentAvgScore').textContent = avgScore + '%';
            document.getElementById('studentCompletedExams').textContent = pastResults.length;
            
            // Render upcoming exams
            let examHtml = '';
            upcomingExams.forEach(exam => {
                examHtml += `<tr>
                    <td>${exam.subject}</td>
                    <td>${exam.date}</td>
                    <td>${exam.time}</td>
                    <td>${exam.duration}</td>
                    <td><span class="badge bg-info">${exam.status}</span></td>
                </tr>`;
            });
            document.getElementById('studentExamTable').innerHTML = examHtml || '<tr><td colspan="5" class="text-center">No upcoming exams</td></tr>';
            
            // Render results
            let resultsHtml = '';
            pastResults.forEach(result => {
                const gradeClass = result.grade === 'A' ? 'success' : result.grade === 'B' ? 'primary' : 'warning';
                resultsHtml += `<tr>
                    <td>${result.subject}</td>
                    <td>${result.exam}</td>
                    <td>${result.date}</td>
                    <td>${result.score}%</td>
                    <td><span class="badge bg-${gradeClass}">${result.grade}</span></td>
                    <td>${result.comments}</td>
                </tr>`;
            });
            document.getElementById('studentResultsTable').innerHTML = resultsHtml || '<tr><td colspan="6" class="text-center">No results yet</td></tr>';
        }
        
        // Student Messages Storage
        let studentMessages = JSON.parse(localStorage.getItem('studentMessages') || '[]');
        
        function showSendTeacherMessageModal() {
            new bootstrap.Modal(document.getElementById('sendTeacherMessageModal')).show();
        }
        
        function sendTeacherMessage() {
            const teacher = document.getElementById('teacherRecipient').value;
            const subject = document.getElementById('messageSubject').value.trim();
            const body = document.getElementById('messageBody').value.trim();
            const important = document.getElementById('markImportant').checked;
            
            if (!teacher) {
                addNotification('Please select a teacher', 'warning');
                return;
            }
            
            if (!subject || !body) {
                addNotification('Please fill in the subject and message', 'warning');
                return;
            }
            
            const message = {
                id: Date.now(),
                from: currentUser.name,
                to: teacher,
                subject: subject,
                message: body,
                date: new Date().toISOString().split('T')[0],
                timestamp: new Date().toISOString(),
                read: false,
                important: important,
                type: 'sent'
            };
            
            studentMessages.push(message);
            localStorage.setItem('studentMessages', JSON.stringify(studentMessages));
            
            // Clear form
            document.getElementById('teacherRecipient').value = '';
            document.getElementById('messageSubject').value = '';
            document.getElementById('messageBody').value = '';
            document.getElementById('markImportant').checked = false;
            
            bootstrap.Modal.getInstance(document.getElementById('sendTeacherMessageModal')).hide();
            loadStudentInbox();
            addNotification('Message sent to ' + teacher + ' successfully!', 'success');
        }
        
        // Load Student Inbox
        function loadStudentInbox() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Get messages from localStorage
            studentMessages = JSON.parse(localStorage.getItem('studentMessages') || '[]');
            
            // Get received messages (mock teacher responses)
            const receivedMessages = [
                { 
                    id: 1001, 
                    from: 'Mr. Smith (Mathematics Teacher)',
                    to: currentUser.name,
                    subject: 'Homework Assignment Due',
                    date: '2025-11-15',
                    message: 'Please complete pages 45-47 by Friday.',
                    read: false,
                    important: true,
                    type: 'received'
                },
                { 
                    id: 1002, 
                    from: 'Administration',
                    to: currentUser.name,
                    subject: 'School Event Reminder',
                    date: '2025-11-14',
                    message: 'Sports day is scheduled for next week. Please bring appropriate attire.',
                    read: true,
                    important: false,
                    type: 'received'
                },
                { 
                    id: 1003, 
                    from: 'Mrs. Johnson (English Teacher)',
                    to: currentUser.name,
                    subject: 'Great work on your essay!',
                    date: '2025-11-13',
                    message: 'Your essay showed excellent writing skills. Keep up the good work!',
                    read: true,
                    important: false,
                    type: 'received'
                },
            ];
            
            // Combine sent and received messages
            const allMessages = [...receivedMessages, ...studentMessages.filter(m => m.from === currentUser.name)];
            
            const filter = document.getElementById('studentInboxFilter')?.value || 'all';
            let filteredMessages = allMessages;
            
            if (filter === 'unread') {
                filteredMessages = allMessages.filter(m => !m.read && m.type === 'received');
            } else if (filter === 'important') {
                filteredMessages = allMessages.filter(m => m.important);
            } else if (filter === 'sent') {
                filteredMessages = allMessages.filter(m => m.type === 'sent');
            }
            
            // Sort by date (newest first)
            filteredMessages.sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));
            
            let html = '';
            filteredMessages.forEach(msg => {
                const isSent = msg.type === 'sent';
                const importantBadge = msg.important ? '<span class="badge bg-danger ms-2">Important</span>' : '';
                const sentBadge = isSent ? '<span class="badge bg-success ms-2">Sent</span>' : '';
                const unreadIndicator = !isSent && !msg.read ? '<i class="fas fa-circle text-primary me-2" style="font-size: 8px;"></i>' : '';
                
                html += `
                    <div class="card mb-3" style="background: rgba(255, 255, 255, ${isSent ? '0.05' : '0.1'});">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start">
                                <h5 class="card-title">
                                    ${unreadIndicator}
                                    ${msg.subject}
                                    ${importantBadge}
                                    ${sentBadge}
                                </h5>
                                <small class="text-muted">${msg.date}</small>
                            </div>
                            <h6 class="card-subtitle mb-2 text-muted">
                                ${isSent ? 'To: ' + msg.to : 'From: ' + msg.from}
                            </h6>
                            <p class="card-text">${msg.message}</p>
                        </div>
                    </div>
                `;
            });
            
            document.getElementById('studentInboxContainer').innerHTML = html || '<p class="text-center text-muted">No messages found. Click "Send Message to Teacher" to start a conversation!</p>';
        }
        
        function searchStudentInbox() {
            const searchTerm = document.getElementById('studentInboxSearch').value.toLowerCase();
            // In a real implementation, this would filter messages
            loadStudentInbox();
        }
        
        // Student Work Submissions Storage
        let studentSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
        
        function submitStudentWork() {
            const title = document.getElementById('studentWorkTitle').value.trim();
            const subject = document.getElementById('studentWorkSubject').value;
            const description = document.getElementById('studentWorkDescription').value.trim();
            const filesInput = document.getElementById('studentWorkFiles');
            const files = filesInput.files;
            
            if (!title || !subject) {
                addNotification('Please fill in the assignment title and subject', 'warning');
                return;
            }
            
            if (files.length === 0) {
                addNotification('Please select at least one file to upload', 'warning');
                return;
            }
            
            // Create file list
            const fileList = [];
            for (let i = 0; i < files.length; i++) {
                fileList.push({
                    name: files[i].name,
                    size: files[i].size,
                    type: files[i].type
                });
            }
            
            // Get student details from students array
            const studentDetails = students.find(s => s.name === currentUser.name) || {};
            
            const submission = {
                id: Date.now(),
                student: currentUser.name,
                studentId: studentDetails.id || currentUser.username,
                grade: studentDetails.grade || 'N/A',
                class: studentDetails.class || 'N/A',
                assignment: title,
                subject: subject,
                description: description,
                files: fileList,
                submittedDate: new Date().toISOString().split('T')[0],
                submittedTime: new Date().toISOString(),
                status: 'Under Review',
                gradeValue: '-',
                feedback: 'Waiting for teacher review'
            };
            
            studentSubmissions.push(submission);
            localStorage.setItem('studentSubmissions', JSON.stringify(studentSubmissions));
            
            // Clear form
            document.getElementById('studentWorkTitle').value = '';
            document.getElementById('studentWorkSubject').value = '';
            document.getElementById('studentWorkDescription').value = '';
            filesInput.value = '';
            
            loadStudentUploadWork();
            addNotification('Work submitted successfully!', 'success');
        }
        
        // Load Student Upload Work
        function loadStudentUploadWork() {
            if (!currentUser || currentUser.role !== 'student') return;
            
            // Get submissions for current student
            studentSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const mySubmissions = studentSubmissions.filter(s => s.student === currentUser.name);
            
            // Update metrics
            const submitted = mySubmissions.length;
            const graded = mySubmissions.filter(s => s.status === 'Graded').length;
            const pending = mySubmissions.filter(s => s.status === 'Under Review').length;
            
            document.getElementById('studentSubmittedWork').textContent = submitted;
            document.getElementById('studentPendingWork').textContent = pending;
            document.getElementById('studentGradedWork').textContent = graded;
            
            // Render submissions table
            let html = '';
            mySubmissions.forEach(sub => {
                const statusClass = sub.status === 'Graded' ? 'success' : 'warning';
                const fileNames = sub.files.map(f => f.name).join(', ');
                html += `<tr>
                    <td>${sub.assignment}</td>
                    <td><span class="badge bg-info">${sub.subject}</span></td>
                    <td>${sub.submittedDate}</td>
                    <td><small title="${fileNames}">${sub.files.length} file(s)</small></td>
                    <td><span class="badge bg-${statusClass}">${sub.status}</span></td>
                    <td>${sub.gradeValue || sub.grade || '-'}</td>
                    <td>${sub.feedback}</td>
                </tr>`;
            });
            
            document.getElementById('studentWorkTable').innerHTML = html || '<tr><td colspan="7" class="text-center text-muted">No submissions yet. Submit your first assignment above!</td></tr>';
        }
        
        // Enhanced AI Research
        let researchHistory = [];
        
        async function researchWithAI() {
            const query = document.getElementById('researchQuery').value.trim();
            const category = document.getElementById('researchCategory').value;
            const provider = document.getElementById('aiProvider').value;
            
            if (!query) {
                addNotification('Please enter a research question', 'warning');
                return;
            }
            
            // Save to history
            const researchItem = {
                id: Date.now(),
                query: query,
                category: category,
                provider: provider,
                timestamp: new Date().toLocaleString()
            };
            researchHistory.unshift(researchItem);
            localStorage.setItem('researchHistory', JSON.stringify(researchHistory));
            
            // Show loading state
            document.getElementById('researchResults').innerHTML = `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.15);">
                    <div class="card-body text-center">
                        <div class="spinner-border text-light mb-3" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p>Researching your question using ${provider === 'chatgpt' ? 'ChatGPT' : 'Grok'}...</p>
                    </div>
                </div>
            `;
            
            let response;
            let providerName = provider === 'chatgpt' ? 'ChatGPT' : 'Grok';
            
            // Check which API to use based on provider selection
            if (provider === 'chatgpt') {
                if (chatGPTSettings.enabled && chatGPTSettings.apiKey) {
                    try {
                        response = await callChatGPTAPI(query, category);
                    } catch (error) {
                        console.error('ChatGPT API Error:', error);
                        addNotification('ChatGPT API Error: ' + error.message + '. Using fallback mode.', 'warning');
                        response = generateEnhancedAIResponse(query, category, 'ChatGPT');
                    }
                } else {
                    addNotification('ChatGPT API not configured. Using fallback mode.', 'warning');
                    response = generateEnhancedAIResponse(query, category, 'ChatGPT');
                }
            } else if (provider === 'grok') {
                if (grokSettings.enabled && grokSettings.apiKey) {
                    try {
                        response = await callGrokAPI(query, category);
                    } catch (error) {
                        console.error('Grok API Error:', error);
                        addNotification('Grok API Error: ' + error.message + '. Using fallback mode.', 'warning');
                        response = generateEnhancedAIResponse(query, category, 'Grok');
                    }
                } else {
                    addNotification('Grok API not configured. Using fallback mode.', 'warning');
                    response = generateEnhancedAIResponse(query, category, 'Grok');
                }
            }
            
            document.getElementById('researchResults').innerHTML = `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.15);">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h4><i class="fas fa-brain me-2"></i>Research Results</h4>
                            <div>
                                <span class="badge bg-primary me-2">${category}</span>
                                <span class="badge bg-success">${providerName}</span>
                            </div>
                        </div>
                        <h5 class="text-info mb-3">"${query}"</h5>
                        ${response}
                        <hr>
                        <div class="mt-3">
                            <h6><i class="fas fa-lightbulb me-2"></i>Related Topics to Explore:</h6>
                            <div class="d-flex flex-wrap gap-2">
                                ${generateRelatedTopics(query, category)}
                            </div>
                        </div>
                        <div class="mt-3">
                            <small class="text-muted"><i class="fas fa-clock me-1"></i>Researched on: ${new Date().toLocaleString()} using ${providerName}</small>
                        </div>
                    </div>
                </div>
            `;
            
            loadResearchHistory();
            addNotification('Research completed successfully using ' + providerName + '!', 'success');
        }
        
        async function callChatGPTAPI(query, category) {
            const apiKey = chatGPTSettings.apiKey;
            const model = chatGPTSettings.model;
            
            const systemPrompt = `You are an educational AI assistant helping a student with their research. 
The student is researching in the category: ${category}. 
Provide accurate, educational, and age-appropriate information. 
Include relevant examples, explanations, and suggest further areas of study.`;
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: query }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            return `
                <div class="alert alert-success text-dark">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-robot fa-2x me-3"></i>
                        <div>
                            <h6><strong>ChatGPT-4 Response:</strong></h6>
                            <p style="white-space: pre-wrap;">${aiResponse}</p>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Powered by ChatGPT-4 API</strong> - This response was generated using OpenAI's advanced AI model.
                    </div>
                </div>
            `;
        }
        
        async function callGrokAPI(query, category) {
            const apiKey = grokSettings.apiKey;
            const model = grokSettings.model;
            
            const systemPrompt = `You are an educational AI assistant helping a student with their research. 
The student is researching in the category: ${category}. 
Provide accurate, educational, and age-appropriate information. 
Include relevant examples, explanations, and suggest further areas of study.`;
            
            const response = await fetch('https://api.x.ai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                },
                body: JSON.stringify({
                    model: model,
                    messages: [
                        { role: 'system', content: systemPrompt },
                        { role: 'user', content: query }
                    ],
                    temperature: 0.7,
                    max_tokens: 1000,
                    stream: false
                })
            });
            
            if (!response.ok) {
                throw new Error(`API request failed with status ${response.status}`);
            }
            
            const data = await response.json();
            const aiResponse = data.choices[0].message.content;
            
            return `
                <div class="alert alert-success text-dark">
                    <div class="d-flex align-items-start mb-2">
                        <i class="fas fa-robot fa-2x me-3"></i>
                        <div>
                            <h6><strong>Grok Response:</strong></h6>
                            <p style="white-space: pre-wrap;">${aiResponse}</p>
                        </div>
                    </div>
                    <div class="alert alert-info mt-3 mb-0">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Powered by Grok API</strong> - This response was generated using xAI's advanced AI model.
                    </div>
                </div>
            `;
        }
        
        function generateEnhancedAIResponse(query, category, provider = 'AI') {
            // Enhanced AI response with category-specific content
            const responses = {
                science: {
                    intro: 'Based on scientific research and educational databases:',
                    points: [
                        'Scientific principles and theories related to your question',
                        'Real-world applications and examples',
                        'Key scientists and their contributions',
                        'Current research and developments in this area',
                        'Recommended experiments or observations to learn more'
                    ],
                    sources: ['National Science Database', 'Scientific Research Journals', 'Educational Science Resources']
                },
                mathematics: {
                    intro: 'Mathematical analysis and explanations:',
                    points: [
                        'Core mathematical concepts and formulas',
                        'Step-by-step problem-solving approaches',
                        'Real-world applications of these concepts',
                        'Common mistakes to avoid',
                        'Practice problems and exercises'
                    ],
                    sources: ['Mathematics Education Database', 'Khan Academy Resources', 'Mathematical References']
                },
                history: {
                    intro: 'Historical context and information:',
                    points: [
                        'Historical background and timeline',
                        'Key figures and their roles',
                        'Causes and effects of historical events',
                        'Historical significance and impact',
                        'Primary and secondary sources'
                    ],
                    sources: ['Historical Archives', 'Educational History Resources', 'Academic Historical Journals']
                },
                literature: {
                    intro: 'Literary analysis and insights:',
                    points: [
                        'Literary themes and motifs',
                        'Character analysis and development',
                        'Writing style and techniques',
                        'Historical and cultural context',
                        'Critical interpretations and perspectives'
                    ],
                    sources: ['Literary Databases', 'Classic Literature Archives', 'Literary Criticism Resources']
                },
                geography: {
                    intro: 'Geographic information and analysis:',
                    points: [
                        'Geographic features and characteristics',
                        'Climate and environmental factors',
                        'Population and demographics',
                        'Economic and cultural significance',
                        'Current geographic trends and changes'
                    ],
                    sources: ['Geographic Information Systems', 'World Atlas Database', 'Geographic Education Resources']
                },
                technology: {
                    intro: 'Technology insights and information:',
                    points: [
                        'Current technological developments',
                        'How the technology works',
                        'Applications and use cases',
                        'Future trends and implications',
                        'Learning resources and tutorials'
                    ],
                    sources: ['Technology Research Database', 'Tech Education Platforms', 'Innovation Journals']
                },
                general: {
                    intro: 'Comprehensive research findings:',
                    points: [
                        'Overview and background information',
                        'Key concepts and definitions',
                        'Multiple perspectives and viewpoints',
                        'Practical applications and examples',
                        'Further reading and resources'
                    ],
                    sources: ['Educational Databases', 'Academic Resources', 'Research Libraries']
                }
            };
            
            const categoryData = responses[category] || responses.general;
            
            let html = `
                <div class="alert alert-light text-dark">
                    <p><strong>${categoryData.intro}</strong></p>
                    <ul class="mb-3">
                        ${categoryData.points.map(point => `<li>${point}</li>`).join('')}
                    </ul>
                    <div class="mt-3">
                        <h6><i class="fas fa-book me-2"></i>Sources & References:</h6>
                        <ul>
                            ${categoryData.sources.map(source => `<li>${source}</li>`).join('')}
                        </ul>
                    </div>
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Note:</strong> ${provider} API is not configured or encountered an error. 
                        This is fallback mode with enhanced educational content. 
                        Configure the ${provider} API in Settings for real-time AI-powered research results.
                    </div>
                </div>
            `;
            
            return html;
        }
        
        function generateRelatedTopics(query, category) {
            const topics = {
                science: ['Physics Principles', 'Chemical Reactions', 'Biology Systems', 'Scientific Method'],
                mathematics: ['Algebra', 'Geometry', 'Calculus', 'Statistics', 'Problem Solving'],
                history: ['Ancient Civilizations', 'World Wars', 'Cultural Movements', 'Political History'],
                literature: ['Poetry Analysis', 'Novel Studies', 'Drama', 'Literary Devices', 'Author Studies'],
                geography: ['World Regions', 'Climate Zones', 'Natural Resources', 'Population Studies'],
                technology: ['Programming', 'Artificial Intelligence', 'Cybersecurity', 'Web Development'],
                general: ['Critical Thinking', 'Research Methods', 'Study Skills', 'Time Management']
            };
            
            const categoryTopics = topics[category] || topics.general;
            return categoryTopics.map(topic => 
                `<button class="btn btn-sm btn-outline-light" onclick="document.getElementById('researchQuery').value='${topic}'; researchWithAI();">${topic}</button>`
            ).join('');
        }
        
        function loadResearchHistory() {
            researchHistory = JSON.parse(localStorage.getItem('researchHistory') || '[]');
            
            if (researchHistory.length === 0) {
                document.getElementById('researchHistory').innerHTML = '';
                return;
            }
            
            let html = `
                <div class="card" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header">
                        <h5><i class="fas fa-history me-2"></i>Research History</h5>
                    </div>
                    <div class="card-body">
                        <div class="list-group">
            `;
            
            researchHistory.slice(0, 5).forEach(item => {
                const providerBadge = item.provider ? `<span class="badge bg-success ms-1">${item.provider === 'chatgpt' ? 'ChatGPT' : 'Grok'}</span>` : '';
                html += `
                    <div class="list-group-item" style="background: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${item.query}</h6>
                                <small class="text-muted">
                                    <span class="badge bg-secondary">${item.category}</span>
                                    ${providerBadge}
                                    <i class="fas fa-clock ms-2 me-1"></i>${item.timestamp}
                                </small>
                            </div>
                            <button class="btn btn-sm btn-outline-light" onclick="document.getElementById('researchQuery').value='${item.query}'; document.getElementById('researchCategory').value='${item.category}'; ${item.provider ? `document.getElementById('aiProvider').value='${item.provider}';` : ''} researchWithAI();">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            html += `
                        </div>
                        ${researchHistory.length > 5 ? `<div class="text-center mt-3"><small class="text-muted">Showing 5 of ${researchHistory.length} searches</small></div>` : ''}
                    </div>
                </div>
            `;
            
            document.getElementById('researchHistory').innerHTML = html;
        }
        
        function clearResearch() {
            document.getElementById('researchQuery').value = '';
            document.getElementById('researchResults').innerHTML = '';
            document.getElementById('researchCategory').value = 'general';
        }

        // Read-Only Teachers Info for Admin
        function renderTeachersReadOnly() {
            renderLessonPlansReadOnly();
        }
        
        function renderLessonPlansReadOnly() {
            document.getElementById('roLessonPlansList').innerHTML = lessonPlans.length > 0 ? lessonPlans.map(lp => `
                <div class="lesson-plan">
                    <h5>${lp.title}</h5>
                    <p><strong>Subject:</strong> ${lp.subject} | <strong>Date:</strong> ${lp.date}</p>
                    <p><strong>Objectives:</strong> ${lp.objectives}</p>
                    <p><strong>Activities:</strong> ${lp.activities}</p>
                    <p><strong>Materials:</strong> ${lp.materials}</p>
                </div>
            `).join('') : '<p class="text-muted">No lesson plans available.</p>';
        }
        
        function renderGradingReadOnly() {
            const classes = [...new Set(students.map(s => s.grade))];
            document.getElementById('roGradingClass').innerHTML = '<option value="">Select Class</option>' + 
                classes.map(c => `<option value="${c}">${c}</option>`).join('');
            loadGradingReadOnly();
        }
        
        function loadGradingReadOnly() {
            const classFilter = document.getElementById('roGradingClass').value;
            const filteredStudents = classFilter ? students.filter(s => s.grade === classFilter) : students;
            document.getElementById('roGradingTable').innerHTML = filteredStudents.length > 0 ? filteredStudents.map(s => {
                const studentGrades = grades.filter(g => g.studentId === s.id);
                return studentGrades.length > 0 ? studentGrades.map(sg => `
                    <tr>
                        <td>${s.name}</td>
                        <td>${sg.subject || 'N/A'}</td>
                        <td>${sg.score || ''}</td>
                        <td>${sg.comments || ''}</td>
                    </tr>
                `).join('') : `
                    <tr>
                        <td>${s.name}</td>
                        <td colspan="3" class="text-muted">No grades recorded</td>
                    </tr>
                `;
            }).join('') : '<tr><td colspan="4" class="text-muted">No students found</td></tr>';
        }
        
        function renderResourcesReadOnly() {
            document.getElementById('roResourcesList').innerHTML = resources.length > 0 ? resources.map(r => `
                <div class="lesson-plan">
                    <h5>${r.title}</h5>
                    <p><strong>Type:</strong> ${r.type} | <strong>URL:</strong> <a href="${r.url}" target="_blank">${r.url}</a></p>
                    <p>${r.description}</p>
                </div>
            `).join('') : '<p class="text-muted">No resources available.</p>';
        }
        
        function renderUploadWorkReadOnly() {
            document.getElementById('roUploadedWorkList').innerHTML = uploadedWork.length > 0 ? 
                uploadedWork.map(w => `
                    <div class="report-card mb-2">
                        <div>
                            <h6><i class="fas fa-file me-2"></i>${w.title}</h6>
                            <p class="mb-1"><small>Class: ${w.class} | Uploaded: ${w.uploadDate}</small></p>
                            <p class="mb-1"><small>${w.description}</small></p>
                            <p class="mb-0"><small>Files: ${w.files.map(f => f.name).join(', ')}</small></p>
                        </div>
                    </div>
                `).join('') : 
                '<p class="text-muted">No uploaded work files yet.</p>';
        }
        
        function renderCalendarReadOnly() {
            const monthInput = document.getElementById('roCalendarMonth').value;
            const currentMonth = monthInput ? new Date(monthInput + '-01') : new Date();
            
            // Generate calendar
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startDay = firstDay.getDay();
            
            let calendarHTML = '<table class="table table-bordered">';
            calendarHTML += '<thead><tr>';
            ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'].forEach(day => {
                calendarHTML += `<th class="text-center">${day}</th>`;
            });
            calendarHTML += '</tr></thead><tbody><tr>';
            
            // Empty cells for days before start of month
            for (let i = 0; i < startDay; i++) {
                calendarHTML += '<td></td>';
            }
            
            // Days of the month
            for (let day = 1; day <= daysInMonth; day++) {
                const currentDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const dayEvents = calendarEvents.filter(e => e.date === currentDate);
                
                calendarHTML += `<td class="timetable-cell" style="height: 100px; vertical-align: top;">`;
                calendarHTML += `<strong>${day}</strong><br>`;
                
                if (dayEvents.length > 0) {
                    dayEvents.forEach(e => {
                        const colors = {
                            'Class': '#36A2EB',
                            'Meeting': '#FFCE56',
                            'Exam': '#FF6384',
                            'Event': '#4BC0C0',
                            'Deadline': '#FF9F40'
                        };
                        const color = colors[e.type] || '#cccccc';
                        calendarHTML += `<div style="background: ${color}; padding: 2px; margin: 2px 0; border-radius: 3px; font-size: 0.75rem;" title="${e.title} - ${e.time}">
                            ${e.title}
                        </div>`;
                    });
                }
                
                calendarHTML += '</td>';
                
                if ((startDay + day) % 7 === 0) {
                    calendarHTML += '</tr><tr>';
                }
            }
            
            // Fill remaining cells
            const totalCells = startDay + daysInMonth;
            const remainingCells = totalCells % 7 === 0 ? 0 : 7 - (totalCells % 7);
            for (let i = 0; i < remainingCells; i++) {
                calendarHTML += '<td></td>';
            }
            
            calendarHTML += '</tr></tbody></table>';
            document.getElementById('roCalendarView').innerHTML = calendarHTML;
            
            // Render upcoming events
            const today = new Date().toISOString().split('T')[0];
            const upcoming = calendarEvents
                .filter(e => e.date >= today)
                .sort((a, b) => a.date.localeCompare(b.date))
                .slice(0, 5);
            
            document.getElementById('roUpcomingEventsList').innerHTML = upcoming.length > 0 ?
                upcoming.map(e => `
                    <div class="report-card mb-2">
                        <h6>${e.title}</h6>
                        <p class="mb-1"><small><strong>Date:</strong> ${e.date} | <strong>Time:</strong> ${e.time}</small></p>
                        <p class="mb-1"><small><strong>Type:</strong> ${e.type}</small></p>
                        <p class="mb-0"><small>${e.description}</small></p>
                    </div>
                `).join('') :
                '<p class="text-muted">No upcoming events.</p>';
        }

        // Utility: Log audit
        function logAudit(action, details, risk = 'Low') {
            auditLog.unshift({
                id: Date.now(),
                user: currentUser.name,
                action,
                details,
                risk,
                timestamp: new Date().toISOString()
            });
            saveData();
        }

        // ========================================
        // ONLINE/OFFLINE FUNCTIONALITY
        // ========================================
        
        // Register Service Worker for offline functionality
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);
                    })
                    .catch(error => {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Update online/offline status
        function updateOnlineStatus() {
            isOnline = navigator.onLine;
            const statusIndicator = document.getElementById('statusIndicator');
            if (statusIndicator) {
                if (isOnline) {
                    statusIndicator.className = 'badge bg-success shadow';
                    statusIndicator.innerHTML = '<i class="fas fa-wifi me-1"></i>Online';
                    // Sync offline queue when coming online
                    syncOfflineData();
                } else {
                    statusIndicator.className = 'badge bg-danger shadow';
                    statusIndicator.innerHTML = '<i class="fas fa-wifi-slash me-1"></i>Offline';
                }
            }
        }
        
        // Sync offline data when connection is restored
        function syncOfflineData() {
            if (!isOnline || offlineQueue.length === 0) return;
            
            console.log('Syncing offline data...', offlineQueue.length, 'items');
            
            // Process offline queue
            while (offlineQueue.length > 0) {
                const item = offlineQueue.shift();
                console.log('Processing offline item:', item.type);
                // In a real application, this would sync to a server
                // For now, just save to localStorage
                saveData();
            }
            
            addNotification('Offline data synchronized successfully', 'success');
        }
        
        // Add item to offline queue
        function addToOfflineQueue(type, data) {
            offlineQueue.push({
                type: type,
                data: data,
                timestamp: new Date().toISOString()
            });
            localStorage.setItem('offlineQueue', JSON.stringify(offlineQueue));
        }
        
        // Listen for online/offline events
        window.addEventListener('online', updateOnlineStatus);
        window.addEventListener('offline', updateOnlineStatus);
        
        // ========================================
        // TEACHER CHAT FUNCTIONALITY
        // ========================================
        
        // Render Teacher Chat
        function renderTeacherChat() {
            loadChatStudents();
            loadAdminMessages();
            loadChatHistory();
        }
        
        // Load students list for chat
        function loadChatStudents() {
            const studentsList = document.getElementById('chatStudentsList');
            if (!studentsList) return;
            
            const searchTerm = document.getElementById('studentSearchChat')?.value.toLowerCase() || '';
            const filteredStudents = students.filter(s => 
                s.name.toLowerCase().includes(searchTerm) || 
                s.surname.toLowerCase().includes(searchTerm) ||
                s.grade.toLowerCase().includes(searchTerm)
            );
            
            studentsList.innerHTML = filteredStudents.map(student => `
                <a href="#" class="list-group-item list-group-item-action" 
                   style="background: ${selectedChatStudent?.id === student.id ? 'rgba(255, 255, 255, 0.2)' : 'transparent'}; 
                          border-color: rgba(255, 255, 255, 0.1);"
                   onclick="selectChatStudent(${student.id}); return false;">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-0">${student.name} ${student.surname}</h6>
                            <small class="text-muted">Grade: ${student.grade}</small>
                        </div>
                        <span class="badge bg-primary rounded-pill" style="display: ${hasUnreadMessages(student.id) ? 'inline' : 'none'};">
                            ${getUnreadMessageCount(student.id)}
                        </span>
                    </div>
                </a>
            `).join('');
        }
        
        // Filter chat students
        function filterChatStudents() {
            loadChatStudents();
        }
        
        // Select a student to chat with
        function selectChatStudent(studentId) {
            selectedChatStudent = students.find(s => s.id === studentId);
            if (!selectedChatStudent) return;
            
            document.getElementById('chatStudentName').textContent = 
                `Chat with ${selectedChatStudent.name} ${selectedChatStudent.surname}`;
            document.getElementById('chatMessageInput').disabled = false;
            document.getElementById('sendChatBtn').disabled = false;
            
            loadChatMessages();
            markMessagesAsRead(studentId);
            loadChatStudents(); // Refresh to update unread count
        }
        
        // Load chat messages for selected student
        function loadChatMessages() {
            if (!selectedChatStudent) return;
            
            const container = document.getElementById('chatMessagesContainer');
            const studentChats = teacherChats.filter(chat => 
                chat.studentId === selectedChatStudent.id || chat.recipientId === selectedChatStudent.id
            );
            
            if (studentChats.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No messages yet. Start the conversation!</p>';
                return;
            }
            
            container.innerHTML = studentChats.map(chat => {
                const isSent = chat.senderId === 'teacher';
                return `
                    <div class="mb-3 ${isSent ? 'text-end' : 'text-start'}">
                        <div class="d-inline-block" style="max-width: 70%; background: ${isSent ? 'rgba(0, 123, 255, 0.2)' : 'rgba(255, 255, 255, 0.2)'}; 
                             padding: 10px; border-radius: 10px;">
                            <div style="font-size: 0.9rem;">${chat.message}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                ${new Date(chat.timestamp).toLocaleString()}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Send chat message to student
        function sendChatMessage() {
            if (!selectedChatStudent) return;
            
            const input = document.getElementById('chatMessageInput');
            const message = input.value.trim();
            
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const chatMessage = {
                id: Date.now(),
                senderId: 'teacher',
                senderName: currentUser.name,
                recipientId: selectedChatStudent.id,
                studentId: selectedChatStudent.id,
                message: message,
                timestamp: new Date().toISOString(),
                read: false
            };
            
            teacherChats.push(chatMessage);
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
            
            // Add to offline queue if offline
            if (!isOnline) {
                addToOfflineQueue('chat', chatMessage);
            }
            
            input.value = '';
            loadChatMessages();
            addNotification('Message sent to ' + selectedChatStudent.name, 'success');
            
            // Log the chat
            logAudit('Chat Message', `Sent message to student: ${selectedChatStudent.name}`, 'Low');
        }
        
        // Check if student has unread messages
        function hasUnreadMessages(studentId) {
            return teacherChats.some(chat => 
                chat.studentId === studentId && 
                chat.senderId !== 'teacher' && 
                !chat.read
            );
        }
        
        // Get unread message count
        function getUnreadMessageCount(studentId) {
            return teacherChats.filter(chat => 
                chat.studentId === studentId && 
                chat.senderId !== 'teacher' && 
                !chat.read
            ).length;
        }
        
        // Mark messages as read
        function markMessagesAsRead(studentId) {
            teacherChats.forEach(chat => {
                if (chat.studentId === studentId && chat.senderId !== 'teacher') {
                    chat.read = true;
                }
            });
            localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
        }
        
        // Load admin messages
        function loadAdminMessages() {
            const container = document.getElementById('adminMessagesContainer');
            if (!container) return;
            
            if (adminMessages.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info text-dark">
                        <i class="fas fa-info-circle me-2"></i>
                        No messages from admin yet. You can send a message below.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = adminMessages.map(msg => {
                const isSent = msg.senderId === currentUser.username;
                return `
                    <div class="card mb-3" style="background: ${isSent ? 'rgba(0, 123, 255, 0.1)' : 'rgba(255, 255, 255, 0.1)'};">
                        <div class="card-body">
                            <div class="d-flex justify-content-between">
                                <h6>${msg.subject}</h6>
                                <small class="text-muted">${new Date(msg.timestamp).toLocaleString()}</small>
                            </div>
                            <p class="mb-1">${msg.message}</p>
                            <small class="text-muted">
                                ${isSent ? 'To: Admin' : 'From: ' + msg.senderName}
                            </small>
                            ${!isSent && !msg.replied ? `
                                <button class="btn btn-sm btn-primary mt-2" onclick="replyToAdmin(${msg.id})">
                                    <i class="fas fa-reply me-1"></i>Reply
                                </button>
                            ` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Send message to admin
        function sendAdminMessage() {
            const subject = document.getElementById('adminMessageSubject').value.trim();
            const message = document.getElementById('adminMessageText').value.trim();
            
            if (!subject || !message) {
                addNotification('Please enter both subject and message', 'warning');
                return;
            }
            
            const adminMessage = {
                id: Date.now(),
                senderId: currentUser.username,
                senderName: currentUser.name,
                recipientId: 'admin',
                subject: subject,
                message: message,
                timestamp: new Date().toISOString(),
                read: false,
                replied: false
            };
            
            adminMessages.push(adminMessage);
            localStorage.setItem('adminMessages', JSON.stringify(adminMessages));
            
            // Add to offline queue if offline
            if (!isOnline) {
                addToOfflineQueue('adminMessage', adminMessage);
            }
            
            document.getElementById('adminMessageSubject').value = '';
            document.getElementById('adminMessageText').value = '';
            
            loadAdminMessages();
            addNotification('Message sent to admin successfully', 'success');
            
            logAudit('Admin Message', `Sent message to admin: ${subject}`, 'Low');
        }
        
        // Reply to admin message
        function replyToAdmin(messageId) {
            const message = adminMessages.find(m => m.id === messageId);
            if (!message) return;
            
            document.getElementById('adminMessageSubject').value = 'RE: ' + message.subject;
            document.getElementById('adminMessageText').focus();
            
            // Scroll to the reply form
            document.getElementById('adminMessageText').scrollIntoView({ behavior: 'smooth' });
        }
        
        // Load chat history
        function loadChatHistory() {
            const container = document.getElementById('chatHistoryContainer');
            if (!container) return;
            
            const allChats = [...teacherChats].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );
            
            if (allChats.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">No chat history yet.</p>';
                return;
            }
            
            const groupedChats = {};
            allChats.forEach(chat => {
                const student = students.find(s => s.id === chat.studentId);
                if (!student) return;
                
                const key = student.id;
                if (!groupedChats[key]) {
                    groupedChats[key] = {
                        student: student,
                        messages: []
                    };
                }
                groupedChats[key].messages.push(chat);
            });
            
            container.innerHTML = Object.values(groupedChats).map(group => `
                <div class="card mb-3" style="background: rgba(255, 255, 255, 0.1);">
                    <div class="card-header">
                        <h6>
                            <i class="fas fa-user me-2"></i>
                            ${group.student.name} ${group.student.surname}
                            <span class="badge bg-secondary ms-2">${group.messages.length} messages</span>
                        </h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-2">
                            <strong>Last message:</strong>
                            <p class="mb-1">${group.messages[0].message}</p>
                            <small class="text-muted">${new Date(group.messages[0].timestamp).toLocaleString()}</small>
                        </div>
                        <button class="btn btn-sm btn-primary" onclick="selectChatStudent(${group.student.id}); 
                                document.querySelector('a[href=\\'#chat-students\\']').click();">
                            <i class="fas fa-comments me-1"></i>View Conversation
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        // Clear chat history
        function clearChatHistory() {
            if (confirm('Are you sure you want to clear all chat history? This action cannot be undone.')) {
                teacherChats = [];
                localStorage.setItem('teacherChats', JSON.stringify(teacherChats));
                loadChatHistory();
                addNotification('Chat history cleared', 'info');
                logAudit('Clear Chat History', 'Cleared all teacher chat history', 'Medium');
            }
        }
        
        // Handle Enter key in chat input
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chatMessageInput');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });
            }
        });

        // ========================================
        // EVENTS MANAGEMENT FUNCTIONS
        // ========================================
        
        function loadEventsManagement() {
            renderEventsTable();
            updateEventsMetrics();
            populateEventSelects();
        }
        
        function renderEventsTable() {
            const typeFilter = document.getElementById('eventTypeFilter')?.value || '';
            const dateFilter = document.getElementById('eventDateFilter')?.value || '';
            const searchTerm = document.getElementById('eventSearch')?.value.toLowerCase() || '';
            
            let filteredEvents = schoolEvents;
            
            if (typeFilter) {
                filteredEvents = filteredEvents.filter(e => e.type === typeFilter);
            }
            if (dateFilter) {
                filteredEvents = filteredEvents.filter(e => e.date === dateFilter);
            }
            if (searchTerm) {
                filteredEvents = filteredEvents.filter(e => 
                    e.name.toLowerCase().includes(searchTerm) || 
                    e.location.toLowerCase().includes(searchTerm) ||
                    e.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            const tbody = document.getElementById('eventsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredEvents.map(event => {
                const statusBadge = event.status === 'upcoming' ? 'bg-primary' : 
                                  event.status === 'completed' ? 'bg-success' : 'bg-secondary';
                const notificationBadge = event.notificationsSent ? 
                    `<span class="badge bg-success"><i class="fas fa-check"></i> Sent (${event.notificationsSent})</span>` :
                    `<span class="badge bg-warning"><i class="fas fa-times"></i> Not Sent</span>`;
                
                return `<tr>
                    <td>${event.name}</td>
                    <td><span class="badge bg-info">${event.type}</span></td>
                    <td>${event.date}</td>
                    <td>${event.time}</td>
                    <td>${event.location}</td>
                    <td>${event.participants || 'All'}</td>
                    <td><span class="badge ${statusBadge}">${event.status}</span></td>
                    <td>${notificationBadge}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editEvent(${event.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteEvent(${event.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                        ${!event.notificationsSent ? `<button class="btn btn-sm btn-success" onclick="sendEventNotifications(${event.id})">
                            <i class="fas fa-bell"></i> Send
                        </button>` : ''}
                    </td>
                </tr>`;
            }).join('');
        }
        
        function updateEventsMetrics() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('totalEvents').textContent = schoolEvents.length;
            document.getElementById('upcomingEvents').textContent = schoolEvents.filter(e => e.date >= today).length;
            document.getElementById('pastEvents').textContent = schoolEvents.filter(e => e.date < today).length;
            document.getElementById('eventNotificationsSent').textContent = schoolEvents.filter(e => e.notificationsSent > 0).length;
        }
        
        function filterEvents() {
            renderEventsTable();
        }
        
        function showAddEventModal() {
            const modal = new bootstrap.Modal(document.getElementById('addEventModal'));
            modal.show();
            
            // Handle participants selection
            document.getElementById('eventParticipants').addEventListener('change', function() {
                const specificGradesContainer = document.getElementById('specificGradesContainer');
                if (this.value === 'specific') {
                    specificGradesContainer.classList.remove('d-none');
                } else {
                    specificGradesContainer.classList.add('d-none');
                }
            });
        }
        
        function addEvent() {
            const name = document.getElementById('eventName').value.trim();
            const type = document.getElementById('eventType').value;
            const date = document.getElementById('eventDate').value;
            const time = document.getElementById('eventTime').value;
            const location = document.getElementById('eventLocation').value.trim();
            const description = document.getElementById('eventDescription').value.trim();
            const participants = document.getElementById('eventParticipants').value;
            const specificGrades = document.getElementById('eventSpecificGrades')?.value || '';
            const sendNotification = document.getElementById('eventSendNotification').checked;
            
            if (!name || !type || !date || !time || !location) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: type,
                date: date,
                time: time,
                location: location,
                description: description,
                participants: participants === 'specific' ? specificGrades : participants,
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString()
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Event added successfully!', 'success');
            logAudit('Add Event', `Added event: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('eventName').value = '';
            document.getElementById('eventType').value = '';
            document.getElementById('eventDate').value = '';
            document.getElementById('eventTime').value = '';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventDescription').value = '';
        }
        
        function showAddExcursionModal() {
            const modal = new bootstrap.Modal(document.getElementById('addExcursionModal'));
            modal.show();
        }
        
        function addExcursion() {
            const name = document.getElementById('excursionName').value.trim();
            const date = document.getElementById('excursionDate').value;
            const time = document.getElementById('excursionTime').value;
            const destination = document.getElementById('excursionDestination').value.trim();
            const cost = document.getElementById('excursionCost').value;
            const description = document.getElementById('excursionDescription').value.trim();
            const grades = document.getElementById('excursionGrades').value.trim();
            const deadline = document.getElementById('excursionDeadline').value;
            const sendNotification = document.getElementById('excursionSendNotification').checked;
            
            if (!name || !date || !time || !destination) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: 'excursion',
                date: date,
                time: time,
                location: destination,
                description: `${description}\nCost: R${cost || '0'}\nPermission deadline: ${deadline || 'TBA'}`,
                participants: grades || 'All',
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString(),
                cost: cost,
                deadline: deadline
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addExcursionModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Excursion added successfully!', 'success');
            logAudit('Add Excursion', `Added excursion: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('excursionName').value = '';
            document.getElementById('excursionDate').value = '';
            document.getElementById('excursionTime').value = '';
            document.getElementById('excursionDestination').value = '';
            document.getElementById('excursionCost').value = '';
            document.getElementById('excursionDescription').value = '';
            document.getElementById('excursionGrades').value = '';
            document.getElementById('excursionDeadline').value = '';
        }
        
        function showAddFundraisingModal() {
            const modal = new bootstrap.Modal(document.getElementById('addFundraisingModal'));
            modal.show();
        }
        
        function addFundraising() {
            const name = document.getElementById('fundraisingName').value.trim();
            const date = document.getElementById('fundraisingDate').value;
            const time = document.getElementById('fundraisingTime').value;
            const location = document.getElementById('fundraisingLocation').value.trim();
            const goal = document.getElementById('fundraisingGoal').value;
            const description = document.getElementById('fundraisingDescription').value.trim();
            const contact = document.getElementById('fundraisingContact').value.trim();
            const sendNotification = document.getElementById('fundraisingSendNotification').checked;
            
            if (!name || !date || !time || !location) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const event = {
                id: Date.now(),
                name: name,
                type: 'fundraising',
                date: date,
                time: time,
                location: location,
                description: `${description}\nFundraising Goal: R${goal || '0'}\nContact: ${contact || 'School Office'}`,
                participants: 'All',
                status: date >= new Date().toISOString().split('T')[0] ? 'upcoming' : 'completed',
                notificationsSent: 0,
                createdAt: new Date().toISOString(),
                goal: goal
            };
            
            schoolEvents.push(event);
            saveData();
            
            if (sendNotification) {
                sendEventNotifications(event.id);
            }
            
            bootstrap.Modal.getInstance(document.getElementById('addFundraisingModal')).hide();
            renderEventsTable();
            updateEventsMetrics();
            addNotification('Fundraising event added successfully!', 'success');
            logAudit('Add Fundraising', `Added fundraising: ${name}`, 'Low');
            
            // Clear form
            document.getElementById('fundraisingName').value = '';
            document.getElementById('fundraisingDate').value = '';
            document.getElementById('fundraisingTime').value = '';
            document.getElementById('fundraisingLocation').value = '';
            document.getElementById('fundraisingGoal').value = '';
            document.getElementById('fundraisingDescription').value = '';
            document.getElementById('fundraisingContact').value = '';
        }
        
        function sendEventNotifications(eventId) {
            const event = schoolEvents.find(e => e.id === eventId);
            if (!event) return;
            
            // Simulate sending notifications
            let recipientCount = 0;
            
            // In a real system, this would send actual notifications
            // For now, we'll just simulate it
            
            // Notify parents
            if (event.participants === 'all' || event.participants === 'students' || event.participants === 'parents') {
                recipientCount += students.length; // All parents
            }
            
            // Notify teachers
            if (event.participants === 'all' || event.participants === 'staff') {
                recipientCount += staff.filter(s => s.role === 'Teacher').length;
            }
            
            event.notificationsSent = recipientCount;
            event.notificationSentAt = new Date().toISOString();
            saveData();
            
            renderEventsTable();
            addNotification(`Notifications sent to ${recipientCount} recipients`, 'success');
            
            // Add to notification system
            addNotification(`Event Notification: ${event.name} on ${event.date} at ${event.time}. Location: ${event.location}`, 'info');
        }
        
        function editEvent(eventId) {
            addNotification('Edit functionality coming soon!', 'info');
        }
        
        function deleteEvent(eventId) {
            if (confirm('Are you sure you want to delete this event?')) {
                const eventIndex = schoolEvents.findIndex(e => e.id === eventId);
                if (eventIndex > -1) {
                    const event = schoolEvents[eventIndex];
                    schoolEvents.splice(eventIndex, 1);
                    saveData();
                    renderEventsTable();
                    updateEventsMetrics();
                    addNotification('Event deleted successfully', 'success');
                    logAudit('Delete Event', `Deleted event: ${event.name}`, 'Medium');
                }
            }
        }
        
        function showUpcomingEventsCalendar() {
            addNotification('Calendar view coming soon!', 'info');
        }
        
        function populateEventSelects() {
            // Populate meeting teacher select
            const meetingTeacherSelect = document.getElementById('meetingTeacher');
            if (meetingTeacherSelect) {
                const teachers = staff.filter(s => s.role === 'Teacher');
                meetingTeacherSelect.innerHTML = '<option value="">Select Teacher *</option>' +
                    teachers.map(t => `<option value="${t.id}">${t.name}</option>`).join('');
            }
            
            // Populate incident student select
            const incidentStudentSelect = document.getElementById('incidentStudent');
            if (incidentStudentSelect) {
                incidentStudentSelect.innerHTML = '<option value="">Select Student *</option>' +
                    students.map(s => `<option value="${s.id}">${s.name} ${s.surname || ''} (${s.grade || 'N/A'})</option>`).join('');
            }
        }
        
        // ========================================
        // PARENT PORTAL FUNCTIONS
        // ========================================
        
        function showRequestMeetingModal() {
            populateEventSelects();
            const modal = new bootstrap.Modal(document.getElementById('requestMeetingModal'));
            modal.show();
        }
        
        function submitMeetingRequest() {
            const teacherId = document.getElementById('meetingTeacher').value;
            const type = document.getElementById('meetingType').value;
            const date = document.getElementById('meetingDate').value;
            const time = document.getElementById('meetingTime').value;
            const reason = document.getElementById('meetingReason').value.trim();
            const contact = document.getElementById('meetingContact').value.trim();
            
            if (!teacherId || !type || !date || !time || !reason) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const teacher = staff.find(s => s.id == teacherId);
            if (!teacher) {
                addNotification('Teacher not found', 'error');
                return;
            }
            
            const request = {
                id: Date.now(),
                parentName: currentUser.name,
                teacherId: teacherId,
                teacherName: teacher.name,
                type: type,
                requestedDate: date,
                requestedTime: time,
                reason: reason,
                contact: contact,
                status: 'pending',
                createdAt: new Date().toISOString()
            };
            
            meetingRequests.push(request);
            saveData();
            
            bootstrap.Modal.getInstance(document.getElementById('requestMeetingModal')).hide();
            loadParentMeetingRequests();
            addNotification('Meeting request submitted successfully!', 'success');
            
            // Clear form
            document.getElementById('meetingTeacher').value = '';
            document.getElementById('meetingType').value = '';
            document.getElementById('meetingDate').value = '';
            document.getElementById('meetingTime').value = '';
            document.getElementById('meetingReason').value = '';
            document.getElementById('meetingContact').value = '';
        }
        
        function loadParentMeetingRequests() {
            if (!currentUser || currentUser.role !== 'parent') return;
            
            const myRequests = meetingRequests.filter(r => r.parentName === currentUser.name);
            const tbody = document.getElementById('parentMeetingRequestsTable');
            
            if (!tbody) return;
            
            tbody.innerHTML = myRequests.map(req => {
                const statusBadge = req.status === 'pending' ? 'bg-warning' : 
                                  req.status === 'approved' ? 'bg-success' : 'bg-danger';
                return `<tr>
                    <td>${req.teacherName}</td>
                    <td><span class="badge bg-info">${req.type}</span></td>
                    <td>${req.requestedDate}</td>
                    <td>${req.requestedTime}</td>
                    <td><span class="badge ${statusBadge}">${req.status}</span></td>
                    <td>${req.notes || '-'}</td>
                </tr>`;
            }).join('');
        }
        
        function sendParentChat() {
            const input = document.getElementById('parentChatInput');
            const message = input.value.trim();
            
            if (!message) {
                addNotification('Please enter a message', 'warning');
                return;
            }
            
            const chatMessage = {
                id: Date.now(),
                from: currentUser.name,
                role: 'parent',
                message: message,
                timestamp: new Date().toISOString()
            };
            
            // Add to a parent chat array (you can extend this)
            let parentChats = JSON.parse(localStorage.getItem('parentChats') || '[]');
            parentChats.push(chatMessage);
            localStorage.setItem('parentChats', JSON.stringify(parentChats));
            
            input.value = '';
            loadParentChatMessages();
            addNotification('Message sent!', 'success');
        }
        
        function loadParentChatMessages() {
            const container = document.getElementById('parentChatMessages');
            if (!container) return;
            
            let parentChats = JSON.parse(localStorage.getItem('parentChats') || '[]');
            
            if (parentChats.length === 0) {
                container.innerHTML = '<p class="text-center text-muted">No messages yet. Start a conversation!</p>';
                return;
            }
            
            container.innerHTML = parentChats.map(chat => {
                const isSent = chat.role === 'parent';
                return `
                    <div class="mb-3 ${isSent ? 'text-end' : 'text-start'}">
                        <div class="d-inline-block" style="max-width: 70%; background: ${isSent ? 'rgba(0, 123, 255, 0.2)' : 'rgba(255, 255, 255, 0.2)'}; 
                             padding: 10px; border-radius: 10px;">
                            <small class="text-muted">${chat.from}</small>
                            <div style="font-size: 0.9rem;">${chat.message}</div>
                            <small class="text-muted" style="font-size: 0.75rem;">
                                ${new Date(chat.timestamp).toLocaleString()}
                            </small>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.scrollTop = container.scrollHeight;
        }
        
        function loadParentIncidents() {
            if (!currentUser || currentUser.role !== 'parent') return;
            
            // Get child's student ID (in a real system, this would be properly linked)
            const childStudent = students[0]; // Simplified for demo
            if (!childStudent) return;
            
            const typeFilter = document.getElementById('parentIncidentTypeFilter')?.value || '';
            const dateFilter = document.getElementById('parentIncidentDateFilter')?.value || '';
            
            let filteredIncidents = incidentReports.filter(i => i.studentId == childStudent.id);
            
            if (typeFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.type === typeFilter);
            }
            if (dateFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.date === dateFilter);
            }
            
            const tbody = document.getElementById('parentIncidentsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredIncidents.map(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                return `<tr>
                    <td>${incident.date}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            }).join('');
            
            if (filteredIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No incident reports found.</td></tr>';
            }
        }
        
        // ========================================
        // INCIDENT REPORT FUNCTIONS
        // ========================================
        
        function showAddIncidentModal() {
            populateEventSelects();
            const modal = new bootstrap.Modal(document.getElementById('addIncidentModal'));
            // Set current date and reporter
            document.getElementById('incidentDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('incidentReporter').value = currentUser.name;
            modal.show();
        }
        
        function addIncidentReport() {
            const studentId = document.getElementById('incidentStudent').value;
            const type = document.getElementById('incidentType').value;
            const severity = document.getElementById('incidentSeverity').value;
            const date = document.getElementById('incidentDate').value;
            const description = document.getElementById('incidentDescription').value.trim();
            const action = document.getElementById('incidentAction').value.trim();
            const reportedBy = document.getElementById('incidentReporter').value.trim();
            
            if (!studentId || !type || !severity || !date || !description) {
                addNotification('Please fill in all required fields', 'warning');
                return;
            }
            
            const student = students.find(s => s.id == studentId);
            if (!student) {
                addNotification('Student not found', 'error');
                return;
            }
            
            const incident = {
                id: Date.now(),
                studentId: studentId,
                studentName: student.name + ' ' + (student.surname || ''),
                type: type,
                severity: severity,
                date: date,
                description: description,
                action: action,
                reportedBy: reportedBy,
                createdAt: new Date().toISOString()
            };
            
            incidentReports.push(incident);
            saveData();
            
            bootstrap.Modal.getInstance(document.getElementById('addIncidentModal')).hide();
            addNotification('Incident report added successfully!', 'success');
            logAudit('Add Incident', `Added incident report for ${student.name}`, 'Medium');
            
            // Clear form
            document.getElementById('incidentStudent').value = '';
            document.getElementById('incidentType').value = '';
            document.getElementById('incidentSeverity').value = '';
            document.getElementById('incidentDescription').value = '';
            document.getElementById('incidentAction').value = '';
        }
        
        // ========================================
        // TEACHER INCIDENT REPORT FUNCTIONS
        // ========================================
        
        function loadTeacherIncidents() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            
            const typeFilter = document.getElementById('teacherIncidentTypeFilter')?.value || '';
            const studentFilter = document.getElementById('teacherIncidentStudentFilter')?.value || '';
            const dateFilter = document.getElementById('teacherIncidentDateFilter')?.value || '';
            
            let filteredIncidents = incidentReports;
            
            if (typeFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.type === typeFilter);
            }
            if (studentFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.studentId == studentFilter);
            }
            if (dateFilter) {
                filteredIncidents = filteredIncidents.filter(i => i.date === dateFilter);
            }
            
            // Populate student filter if not already populated
            const studentSelect = document.getElementById('teacherIncidentStudentFilter');
            if (studentSelect && studentSelect.options.length === 1) {
                students.forEach(student => {
                    const option = document.createElement('option');
                    option.value = student.id;
                    option.textContent = `${student.name} ${student.surname || ''} (${student.grade || 'N/A'})`;
                    studentSelect.appendChild(option);
                });
            }
            
            const tbody = document.getElementById('teacherIncidentsTable');
            if (!tbody) return;
            
            tbody.innerHTML = filteredIncidents.map(incident => {
                const severityBadge = incident.severity === 'high' ? 'bg-danger' : 
                                    incident.severity === 'medium' ? 'bg-warning' : 'bg-info';
                return `<tr>
                    <td>${incident.date}</td>
                    <td>${incident.studentName}</td>
                    <td><span class="badge bg-secondary">${incident.type}</span></td>
                    <td><span class="badge ${severityBadge}">${incident.severity}</span></td>
                    <td>${incident.description}</td>
                    <td>${incident.action || '-'}</td>
                    <td>${incident.reportedBy}</td>
                </tr>`;
            }).join('');
            
            if (filteredIncidents.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">No incident reports found.</td></tr>';
            }
        }
        
        // ========================================
        // WORK VAULT FUNCTIONS
        // ========================================
        
        function renderWorkVault() {
            if (!currentUser || currentUser.role !== 'teacher') return;
            
            // Get all student submissions from localStorage
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            
            // Get filter values
            const studentFilter = document.getElementById('workVaultStudentFilter')?.value || '';
            const classFilter = document.getElementById('workVaultClassFilter')?.value || '';
            const dateFilter = document.getElementById('workVaultDateFilter')?.value || '';
            const searchTerm = document.getElementById('workVaultSearch')?.value.toLowerCase() || '';
            
            // Apply filters
            let filteredSubmissions = allSubmissions;
            
            if (studentFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.student === studentFilter);
            }
            if (classFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.grade === classFilter || s.class === classFilter);
            }
            if (dateFilter) {
                filteredSubmissions = filteredSubmissions.filter(s => s.submittedDate === dateFilter);
            }
            if (searchTerm) {
                filteredSubmissions = filteredSubmissions.filter(s => 
                    s.assignment.toLowerCase().includes(searchTerm) || 
                    s.subject.toLowerCase().includes(searchTerm) ||
                    s.student.toLowerCase().includes(searchTerm) ||
                    s.description?.toLowerCase().includes(searchTerm)
                );
            }
            
            // Populate student filter if not already done
            const studentSelect = document.getElementById('workVaultStudentFilter');
            if (studentSelect && studentSelect.options.length === 1) {
                const uniqueStudents = [...new Set(allSubmissions.map(s => s.student))];
                uniqueStudents.forEach(studentName => {
                    const option = document.createElement('option');
                    option.value = studentName;
                    option.textContent = studentName;
                    studentSelect.appendChild(option);
                });
            }
            
            // Populate class filter if not already done
            const classSelect = document.getElementById('workVaultClassFilter');
            if (classSelect && classSelect.options.length === 1) {
                const uniqueClasses = [...new Set(allSubmissions.map(s => s.grade || s.class).filter(c => c && c !== 'N/A'))];
                uniqueClasses.sort();
                uniqueClasses.forEach(className => {
                    const option = document.createElement('option');
                    option.value = className;
                    option.textContent = className;
                    classSelect.appendChild(option);
                });
            }
            
            // Update metrics
            const today = new Date().toISOString().split('T')[0];
            const todaySubmissions = allSubmissions.filter(s => s.submittedDate === today).length;
            const uniqueStudents = [...new Set(allSubmissions.map(s => s.student))].length;
            
            // Get submissions from this week
            const oneWeekAgo = new Date();
            oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);
            const oneWeekAgoStr = oneWeekAgo.toISOString().split('T')[0];
            const weekSubmissions = allSubmissions.filter(s => s.submittedDate >= oneWeekAgoStr).length;
            
            document.getElementById('totalSubmissions').textContent = allSubmissions.length;
            document.getElementById('todaySubmissions').textContent = todaySubmissions;
            document.getElementById('uniqueStudents').textContent = uniqueStudents;
            document.getElementById('weekSubmissions').textContent = weekSubmissions;
            
            // Render submissions list
            const listContainer = document.getElementById('workVaultList');
            if (!listContainer) return;
            
            if (filteredSubmissions.length === 0) {
                listContainer.innerHTML = `
                    <div class="alert alert-info text-center">
                        <i class="fas fa-info-circle me-2"></i>
                        No submissions found. ${searchTerm || studentFilter || classFilter || dateFilter ? 'Try adjusting your filters.' : 'Students will see their submissions here after uploading.'}
                    </div>
                `;
                return;
            }
            
            // Sort by submitted date (newest first)
            filteredSubmissions.sort((a, b) => new Date(b.submittedTime || b.submittedDate) - new Date(a.submittedTime || a.submittedDate));
            
            const html = filteredSubmissions.map(submission => {
                const statusClass = submission.status === 'Graded' ? 'success' : 
                                  submission.status === 'Under Review' ? 'warning' : 'info';
                const fileNames = submission.files.map(f => f.name).join(', ');
                const filesDisplay = submission.files.map(f => 
                    `<span class="badge bg-secondary me-1" title="${f.size} bytes">${f.name}</span>`
                ).join('');
                
                return `
                    <div class="card mb-3" style="background: rgba(255, 255, 255, 0.1); border-left: 4px solid rgba(99, 102, 241, 0.8);">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h5 class="mb-2">
                                        <i class="fas fa-file-alt me-2"></i>${submission.assignment}
                                        <span class="badge bg-${statusClass} ms-2">${submission.status}</span>
                                    </h5>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-user me-1"></i>Student:</strong> ${submission.student}
                                        <span class="badge bg-info ms-2">${submission.grade || submission.class || 'N/A'}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-book me-1"></i>Subject:</strong> 
                                        <span class="badge bg-primary">${submission.subject}</span>
                                    </div>
                                    <div class="mb-2">
                                        <strong><i class="fas fa-calendar me-1"></i>Submitted:</strong> ${submission.submittedDate}
                                        ${submission.submittedTime ? `<small class="text-muted ms-1">(${new Date(submission.submittedTime).toLocaleTimeString()})</small>` : ''}
                                    </div>
                                    ${submission.description ? `
                                        <div class="mb-2">
                                            <strong><i class="fas fa-comment me-1"></i>Description:</strong><br>
                                            <small>${submission.description}</small>
                                        </div>
                                    ` : ''}
                                    <div class="mb-2">
                                        <strong><i class="fas fa-paperclip me-1"></i>Files (${submission.files.length}):</strong><br>
                                        ${filesDisplay}
                                    </div>
                                </div>
                                <div class="col-md-4 text-end">
                                    <div class="mb-2">
                                        <strong>Grade:</strong> ${submission.gradeValue || submission.grade || '-'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Feedback:</strong><br>
                                        <small>${submission.feedback || 'No feedback yet'}</small>
                                    </div>
                                    <button class="btn btn-sm btn-primary mb-2" onclick="gradeSubmission(${submission.id})">
                                        <i class="fas fa-pen me-1"></i>Grade Work
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="viewSubmissionDetails(${submission.id})">
                                        <i class="fas fa-eye me-1"></i>View Details
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            listContainer.innerHTML = html;
        }
        
        // Grade submission function
        function gradeSubmission(submissionId) {
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const submission = allSubmissions.find(s => s.id === submissionId);
            
            if (!submission) {
                addNotification('Submission not found', 'error');
                return;
            }
            
            const grade = prompt(`Enter grade for "${submission.assignment}" (e.g., A, B, C, 85%, etc.):`, submission.gradeValue || '');
            if (grade === null) return; // User cancelled
            
            const feedback = prompt('Enter feedback for the student:', submission.feedback || '');
            if (feedback === null) return; // User cancelled
            
            // Update submission
            submission.gradeValue = grade || '-';
            submission.grade = grade || '-';
            submission.feedback = feedback || 'No feedback provided';
            submission.status = grade ? 'Graded' : 'Under Review';
            submission.gradedDate = new Date().toISOString().split('T')[0];
            submission.gradedBy = currentUser.name;
            
            // Save back to localStorage
            localStorage.setItem('studentSubmissions', JSON.stringify(allSubmissions));
            
            // Refresh display
            renderWorkVault();
            addNotification('Work graded successfully!', 'success');
            
            // Log the action
            logAudit('Grade Work', `Graded ${submission.assignment} for ${submission.student}`, 'Low');
        }
        
        // View submission details
        function viewSubmissionDetails(submissionId) {
            const allSubmissions = JSON.parse(localStorage.getItem('studentSubmissions') || '[]');
            const submission = allSubmissions.find(s => s.id === submissionId);
            
            if (!submission) {
                addNotification('Submission not found', 'error');
                return;
            }
            
            const filesList = submission.files.map(f => `- ${f.name} (${(f.size / 1024).toFixed(2)} KB)`).join('\n');
            
            alert(`Submission Details:
            
Assignment: ${submission.assignment}
Student: ${submission.student}
Grade/Class: ${submission.grade || submission.class || 'N/A'}
Subject: ${submission.subject}
Submitted: ${submission.submittedDate}
Status: ${submission.status}
Grade: ${submission.gradeValue || submission.grade || '-'}

Description:
${submission.description || 'No description provided'}

Files:
${filesList}

Feedback:
${submission.feedback || 'No feedback yet'}`);
        }

        // Search debounces
        document.getElementById('admissionSearch').addEventListener('input', debounce(renderAdmissions, 300));
        document.getElementById('studentSearch').addEventListener('input', debounce(renderStudents, 300));
        document.getElementById('feeSearch').addEventListener('input', debounce(renderFees, 300));
        document.getElementById('contentSearch').addEventListener('input', debounce(renderContents, 300));
        document.getElementById('staffSearch').addEventListener('input', debounce(renderStaff, 300));
        document.getElementById('jobSearch').addEventListener('input', debounce(renderJobs, 300));

        // Initialize
        loadData();
        populateSelects();
        loadSavedTheme(); // Load saved theme on page load
        document.getElementById('payrollMonthFilter').value = new Date().toISOString().slice(0,7);
        document.getElementById('bulkAttendanceDate').value = new Date().toISOString().split('T')[0];
        if (document.getElementById('calendarMonth')) {
            document.getElementById('calendarMonth').value = new Date().toISOString().slice(0,7);
        }
        if (document.getElementById('roCalendarMonth')) {
            document.getElementById('roCalendarMonth').value = new Date().toISOString().slice(0,7);
        }
        
        // Initialize online/offline status
        updateOnlineStatus();
        
        // Load chat data
        teacherChats = JSON.parse(localStorage.getItem('teacherChats') || '[]');
        adminMessages = JSON.parse(localStorage.getItem('adminMessages') || '[]');
        offlineQueue = JSON.parse(localStorage.getItem('offlineQueue') || '[]');
    </script>
</body>
</html>
