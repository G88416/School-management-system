<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: #fff;
            min-height: 100vh;
        }
        .sidebar {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.2);
            height: 100vh;
            position: fixed;
            width: 260px;
            padding: 20px;
            overflow-y: auto;
            transition: width 0.3s ease;
            z-index: 1000;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link {
            color: #fff;
            font-weight: 500;
            margin-bottom: 10px;
            padding: 12px;
            border-radius: 10px;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }
        .sidebar .nav-link.active {
            background: rgba(255, 255, 255, 0.3);
            font-weight: 600;
        }
        .content {
            margin-left: 260px;
            padding: 40px;
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric {
            background: rgba(255, 255, 255, 0.15);
            border: none;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            transition: transform 0.3s;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            backdrop-filter: blur(15px);
            color: #333;
        }
        .btn-toggle-sidebar {
            position: fixed;
            top: 20px;
            left: 270px;
            z-index: 1001;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card {
            width: 100%;
            max-width: 450px;
            padding: 2.5rem;
            border-radius: 20px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(15px);
        }
        .login-title {
            font-weight: 700;
            color: #1e3c72;
            text-align: center;
        }
        .report-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 10px 0;
            backdrop-filter: blur(10px);
        }
        .timetable-cell {
            padding: 10px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            margin: 2px;
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message {
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 10px;
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        .nav-tabs .nav-link { color: #333; }
        .nav-tabs .nav-link.active { color: #1e3c72; border-color: #1e3c72; }
        .pagination { justify-content: center; margin-top: 20px; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
            .modal-lg { max-width: 95%; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>
    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>
        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>
        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>
        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4" width="400" height="200"></canvas>
            </section>
            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-success mb-3" onclick="showAdmissionFormModal()">Fill Application Form (MX-4051)</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-info mb-3" onclick="importClassListPDF()">Import Class List PDF (MX-4051)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>
            <!-- New Admission Form Modal (Integrated from MX-4051 PDF) -->
            <div class="modal fade" id="admissionFormModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Admission Application Form (MX-4051)</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <ul class="nav nav-tabs" id="formTabs" role="tablist">
                                <li class="nav-item" role="presentation"><button class="nav-link active" id="learner-tab" data-bs-toggle="tab" data-bs-target="#learner" type="button">Learner Info</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="medical-tab" data-bs-toggle="tab" data-bs-target="#medical" type="button">Medical Info</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="parent-tab" data-bs-toggle="tab" data-bs-target="#parent" type="button">Parent/Guardian</button></li>
                                <li class="nav-item" role="presentation"><button class="nav-link" id="docs-tab" data-bs-toggle="tab" data-bs-target="#docs" type="button">Documents</button></li>
                            </ul>
                            <div class="tab-content" id="formTabContent">
                                <div class="tab-pane fade show active" id="learner" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Grade Applied For</label>
                                            <input type="text" class="form-control" id="appliedGrade" required>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Highest Grade Passed</label>
                                            <input type="text" class="form-control" id="highestGrade">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Year When Grade was Passed</label>
                                            <input type="text" class="form-control" id="yearPassed">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Accession No.</label>
                                            <input type="text" class="form-control" id="accessionNo">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Surname</label>
                                            <input type="text" class="form-control" id="surname" required>
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Initials</label>
                                            <input type="text" class="form-control" id="initials">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>First Name</label>
                                            <input type="text" class="form-control" id="firstName" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Nick Name</label>
                                            <input type="text" class="form-control" id="nickName">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Other Names</label>
                                            <input type="text" class="form-control" id="otherNames">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Date of Birth (YYYY-MM-DD)</label>
                                            <input type="date" class="form-control" id="dob" required>
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Race</label>
                                            <input type="text" class="form-control" id="race">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Gender</label>
                                            <select class="form-control" id="gender">
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>SA ID of Residence / Passport No.</label>
                                        <input type="text" class="form-control" id="idNumber">
                                    </div>
                                    <div class="mb-3">
                                        <label>Citizenship</label>
                                        <input type="text" class="form-control" id="citizenship">
                                    </div>
                                    <div class="mb-3">
                                        <label>Physical Address of Residence</label>
                                        <textarea class="form-control" id="physicalAddress"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Home Telephone</label>
                                            <input type="tel" class="form-control" id="homeTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Emergency Telephone</label>
                                            <input type="tel" class="form-control" id="emergencyTel">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Learner Cell</label>
                                            <input type="tel" class="form-control" id="learnerCell">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Learner Email Address</label>
                                            <input type="email" class="form-control" id="learnerEmail">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Home Language</label>
                                            <input type="text" class="form-control" id="homeLanguage">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Preferred Language of Learner</label>
                                            <input type="text" class="form-control" id="preferredLanguage">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Preferred Language of Instruction</label>
                                        <input type="text" class="form-control" id="instructionLanguage">
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="boarder">
                                        <label class="form-check-label">Boarder</label>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4">
                                            <label class="form-label">Deceased Parent</label>
                                            <select class="form-control">
                                                <option>Mother</option>
                                                <option>Father</option>
                                                <option>Both</option>
                                                <option>None</option>
                                            </select>
                                        </div>
                                        <div class="col-md-8 mb-3">
                                            <label>Mode of Transport</label>
                                            <input type="text" class="form-control" id="transportMode">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Name of Previous School</label>
                                            <input type="text" class="form-control" id="prevSchoolName">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Previous School Address</label>
                                            <input type="text" class="form-control" id="prevSchoolAddress">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-4 mb-3">
                                            <label>Province</label>
                                            <input type="text" class="form-control" id="province">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Country</label>
                                            <input type="text" class="form-control" id="country">
                                        </div>
                                        <div class="col-md-4 mb-3">
                                            <label>Previous School Type</label>
                                            <select class="form-control">
                                                <option>Formal</option>
                                                <option>Non Formal</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="medical" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Number</label>
                                            <input type="text" class="form-control" id="medAidNum">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Main Member</label>
                                            <input type="text" class="form-control" id="medAidMain">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Medical Aid Name</label>
                                            <input type="text" class="form-control" id="medAidName">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Doctor Name</label>
                                            <input type="text" class="form-control" id="doctorName">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Doctor Telephone Number</label>
                                            <input type="tel" class="form-control" id="doctorTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Dexterity of Learner</label>
                                            <select class="form-control" id="dexterity">
                                                <option>Right Handed</option>
                                                <option>Left Handed</option>
                                                <option>Ambidextrous</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Medical Condition</label>
                                        <textarea class="form-control" id="medCondition" rows="3"></textarea>
                                    </div>
                                    <div class="mb-3">
                                        <label>Special Problems Requiring Counseling</label>
                                        <textarea class="form-control" id="specialProblems" rows="3"></textarea>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="socialGrant">
                                        <label class="form-check-label">Reg. Social Grant</label>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="parent" role="tabpanel">
                                    <div class="row">
                                        <div class="col-md-3 mb-3">
                                            <label>Title</label>
                                            <input type="text" class="form-control" id="parentTitle">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>Initials</label>
                                            <input type="text" class="form-control" id="parentInitials">
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>Surname</label>
                                            <input type="text" class="form-control" id="parentSurname" required>
                                        </div>
                                        <div class="col-md-3 mb-3">
                                            <label>First Name</label>
                                            <input type="text" class="form-control" id="parentFirstName">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Gender</label>
                                            <select class="form-control" id="parentGender">
                                                <option>Male</option>
                                                <option>Female</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Race / Passport Number</label>
                                            <input type="text" class="form-control" id="parentRace">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Residential Street Address</label>
                                        <textarea class="form-control" id="parentResidential"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Occupational Street Address</label>
                                            <input type="text" class="form-control" id="parentOccupational">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Employer</label>
                                            <input type="text" class="form-control" id="employer">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Occupation</label>
                                            <input type="text" class="form-control" id="occupation">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Occupation</label>
                                            <input type="text" class="form-control" id="spouseOccupation">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Marital Status</label>
                                            <select class="form-control" id="maritalStatus">
                                                <option>Married</option>
                                                <option>Single</option>
                                                <option>Divorced</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Does Learner Live with Parent?</label>
                                            <select class="form-control">
                                                <option>Yes</option>
                                                <option>No</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Correspondence Details Surname</label>
                                        <input type="text" class="form-control" id="correspondenceSurname">
                                    </div>
                                    <div class="mb-3">
                                        <label>Postal Address</label>
                                        <textarea class="form-control" id="postalAddress"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Fax Telephone</label>
                                            <input type="tel" class="form-control" id="faxTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Work Telephone</label>
                                            <input type="tel" class="form-control" id="workTel">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Work Telephone</label>
                                            <input type="tel" class="form-control" id="spouseWorkTel">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Cell Number</label>
                                            <input type="tel" class="form-control" id="cellNumber">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Spouse Cell Number</label>
                                            <input type="tel" class="form-control" id="spouseCell">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>E-Mail Address</label>
                                            <input type="email" class="form-control" id="email">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Spouse E-Mail Address</label>
                                        <input type="email" class="form-control" id="spouseEmail">
                                    </div>
                                    <div class="mb-3">
                                        <label>Declaration: I declare that the above information is accurate and correct.</label>
                                        <textarea class="form-control" id="declaration" rows="2">I declare that to the best of my knowledge, the above information is accurate and correct.</textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                            <label>Name of Parent/Guardian (Print)</label>
                                            <input type="text" class="form-control" id="parentNamePrint">
                                        </div>
                                        <div class="col-md-6 mb-3">
                                            <label>Signature of Parent/Guardian</label>
                                            <input type="text" class="form-control" id="signature" placeholder="Type signature">
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label>Date</label>
                                        <input type="date" class="form-control" id="parentDate">
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="docs" role="tabpanel">
                                    <p><strong>Required Documents:</strong></p>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc1">
                                        <label class="form-check-label">1. Report from Previous School</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc2">
                                        <label class="form-check-label">2. Copy of Birth Certificate</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc3">
                                        <label class="form-check-label">3. Proof of Residence</label>
                                    </div>
                                    <div class="form-check mb-2">
                                        <input class="form-check-input" type="checkbox" id="doc4">
                                        <label class="form-check-label">4. Transfer Letter from Previous School</label>
                                    </div>
                                    <div class="mb-3">
                                        <label>Upload Files</label>
                                        <input type="file" class="form-control" id="docUpload" multiple accept=".pdf,.jpg,.png">
                                    </div>
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <label>Number of other Children at school</label>
                                            <input type="number" class="form-control" id="otherChildrenNum">
                                        </div>
                                        <div class="col-md-6">
                                            <label>Position in the family (e.g. 1st)</label>
                                            <input type="text" class="form-control" id="familyPosition">
                                        </div>
                                    </div>
                                    <div id="otherChildrenList">
                                        <!-- Dynamic list for other children -->
                                    </div>
                                    <button type="button" class="btn btn-secondary" onclick="addOtherChild()">Add Other Child</button>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="submitAdmissionForm()">Submit & Generate PDF</button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <nav aria-label="Student pagination">
                    <ul class="pagination" id="studentPagination"></ul>
                </nav>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Accession</th><th>Name</th><th>Grade</th><th>Educator</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>
            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>
            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>
            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                </div>
                <div id="timetableGrid" class="row"></div>
            </section>
            <!-- Examinations -->
            <section id="exams" class="section d-none">
                <h2>Examinations</h2>
                <button class="btn btn-primary mb-3" onclick="addExam()">Add Exam</button>
                <table class="table table-striped">
                    <thead><tr><th>Subject</th><th>Date</th><th>Grade</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
            </section>
            <!-- HR Management -->
            <section id="hr" class="section d-none admin-only non-student">
                <h2>HR Management</h2>
                <ul class="nav nav-tabs">
                    <li class="nav-item"><a class="nav-link active" href="#" onclick="showHRSub('staff')">Staff</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('payroll')">Payroll</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('leaves')">Leaves</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('reviews')">Performance</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('recruitment')">Recruitment</a></li>
                    <li class="nav-item"><a class="nav-link" href="#" onclick="showHRSub('audit')">Audit</a></li>
                </ul>
                <div id="hrContent">
                    <div id="staffSub">
                        <table class="table">
                            <thead><tr><th>Name</th><th>Role</th><th>Salary</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div id="payrollSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Month</th><th>Salary</th><th>Net Pay</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div id="leavesSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Type</th><th>Days</th><th>Status</th></tr></thead>
                            <tbody id="leaveTable"></tbody>
                        </table>
                    </div>
                    <div id="reviewsSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Staff</th><th>Date</th><th>Score</th><th>Comments</th></tr></thead>
                            <tbody id="reviewTable"></tbody>
                        </table>
                    </div>
                    <div id="recruitmentSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Job Title</th><th>Department</th><th>Applications</th><th>Status</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div id="auditSub" style="display:none;">
                        <table class="table">
                            <thead><tr><th>Timestamp</th><th>User</th><th>Action</th><th>Details</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>
            <!-- Communication -->
            <section id="communication" class="section d-none">
                <h2>Communication</h2>
                <p>Demo communication tools.</p>
            </section>
            <!-- Content -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <p>Demo content upload.</p>
            </section>
            <!-- Reports -->
            <section id="reports" class="section d-none admin-only non-student">
                <h2>Reports</h2>
                <button class="btn btn-primary" onclick="generateReport('attendance')">Attendance Report</button>
                <button class="btn btn-primary" onclick="generateReport('fees')">Fee Report</button>
            </section>
            <!-- Settings -->
            <section id="settings" class="section d-none admin-only non-student">
                <h2>Settings</h2>
                <p>Demo settings.</p>
            </section>
            <!-- AI Research -->
            <section id="aiResearch" class="section d-none student-only">
                <h2>AI Research Assistant</h2>
                <div id="chatContainer" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; padding: 10px; background: rgba(255,255,255,0.1);">
                    <div class="chat-message chat-assistant">Hello! How can I help with your research?</div>
                </div>
                <div class="input-group mt-3">
                    <input type="text" id="chatInput" class="form-control" placeholder="Ask a question...">
                    <button class="btn btn-primary" onclick="sendMessage()">Send</button>
                </div>
            </section>
        </div>
    </div>
    <!-- Notifications Modal -->
    <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="notificationContent">
                    <p>Demo notifications: 3 unread messages and 1 fee reminder.</p>
                </div>
            </div>
        </div>
    </div>
    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let staff = [];
        let admissions = [];
        let attendance = [];
        let fees = [];
        let timetable = [];
        let exams = [];
        let payrolls = [];
        let leaveRequests = [];
        let performanceReviews = [];
        let jobs = [];
        let auditLog = [];
        let uifRate = 0.01;
        let editingJob = null;
        let editingReview = null;
        let performanceChart = null;
        let dashboardChart = null;

        // Robust saveData with try-catch and auto-backup
        function saveData() {
            try {
                localStorage.setItem('students', JSON.stringify(students));
                localStorage.setItem('staff', JSON.stringify(staff));
                localStorage.setItem('admissions', JSON.stringify(admissions));
                localStorage.setItem('fees', JSON.stringify(fees));
                localStorage.setItem('payrolls', JSON.stringify(payrolls));
                localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
                localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
                localStorage.setItem('jobs', JSON.stringify(jobs));
                localStorage.setItem('auditLog', JSON.stringify(auditLog));
                // Auto-backup every 5 min
                setTimeout(() => {
                    localStorage.setItem('backup', JSON.stringify({students, staff, admissions, fees}));
                }, 300000);
                logAudit('Data Saved', 'Auto-save');
            } catch (e) {
                console.error('Save error:', e);
                alert('Error saving data: ' + e.message);
            }
        }

        // Load with validation
        function loadData() {
            try {
                students = JSON.parse(localStorage.getItem('students') || '[]');
                students = students.filter(s => s.id && s.name && typeof s.id === 'number');
                staff = JSON.parse(localStorage.getItem('staff') || '[]');
                admissions = JSON.parse(localStorage.getItem('admissions') || '[]');
                fees = JSON.parse(localStorage.getItem('fees') || '[]');
                payrolls = JSON.parse(localStorage.getItem('payrolls') || '[]');
                leaveRequests = JSON.parse(localStorage.getItem('leaveRequests') || '[]');
                performanceReviews = JSON.parse(localStorage.getItem('performanceReviews') || '[]');
                jobs = JSON.parse(localStorage.getItem('jobs') || '[]');
                auditLog = JSON.parse(localStorage.getItem('auditLog') || '[]');
                if (students.length === 0) loadDemoData();
            } catch (e) {
                console.error('Load error:', e);
                loadDemoData();
            }
        }

        // Updated demo data with MX-4051 class lists (77 parsed, cleaned)
        function loadDemoData() {
            students = [
  {
    "id": 1,
    "name": "CHAUK Nobule",
    "grade": "1A",
    "parent": "Parent 1",
    "status": "Active",
    "accession": "2890",
    "educator": "TBD"
  },
  {
    "id": 2,
    "name": "FATLANI Kgetumets e",
    "grade": "1A",
    "parent": "Parent 2",
    "status": "Active",
    "accession": "2528",
    "educator": "TBD"
  },
  {
    "id": 3,
    "name": "KANA Dumpho ",
    "grade": "1A",
    "parent": "Parent 3",
    "status": "Active",
    "accession": "2558",
    "educator": "TBD"
  },
  {
    "id": 4,
    "name": "LEBA NA J a m a l a",
    "grade": "1A",
    "parent": "Parent 4",
    "status": "Active",
    "accession": "2498",
    "educator": "TBD"
  },
  {
    "id": 5,
    "name": "LUSINE Jama",
    "grade": "1A",
    "parent": "Parent 5",
    "status": "Active",
    "accession": "2445",
    "educator": "TBD"
  },
  {
    "id": 6,
    "name": "MABASOE Vus i",
    "grade": "1A",
    "parent": "Parent 6",
    "status": "Active",
    "accession": "2565",
    "educator": "TBD"
  },
  {
    "id": 7,
    "name": "MAHLANGU Sandile",
    "grade": "1A",
    "parent": "Parent 7",
    "status": "Active",
    "accession": "2370",
    "educator": "TBD"
  },
  {
    "id": 8,
    "name": "MANCHIDI Khumo",
    "grade": "1A",
    "parent": "Parent 8",
    "status": "Active",
    "accession": "3476",
    "educator": "TBD"
  },
  {
    "id": 9,
    "name": "MATHEBULA Lungi",
    "grade": "1A",
    "parent": "Parent 9",
    "status": "Active",
    "accession": "2577",
    "educator": "TBD"
  },
  {
    "id": 10,
    "name": "MONDLI Thabo",
    "grade": "1A",
    "parent": "Parent 10",
    "status": "Active",
    "accession": "2917",
    "educator": "TBD"
  },
  {
    "id": 11,
    "name": "NOWENYAMA Ph i l ip",
    "grade": "1A",
    "parent": "Parent 11",
    "status": "Active",
    "accession": "2570",
    "educator": "TBD"
  },
  {
    "id": 12,
    "name": "PHALANE Outlwile",
    "grade": "1A",
    "parent": "Parent 12",
    "status": "Active",
    "accession": "2573",
    "educator": "TBD"
  },
  {
    "id": 13,
    "name": "RAKOMA Outlwile",
    "grade": "1A",
    "parent": "Parent 13",
    "status": "Active",
    "accession": "2496",
    "educator": "TBD"
  },
  {
    "id": 14,
    "name": "SEROKO Amogelang",
    "grade": "1A",
    "parent": "Parent 14",
    "status": "Active",
    "accession": "2436",
    "educator": "TBD"
  },
  {
    "id": 15,
    "name": "SHUMBA Zodwa",
    "grade": "1A",
    "parent": "Parent 15",
    "status": "Active",
    "accession": "2333",
    "educator": "TBD"
  },
  {
    "id": 16,
    "name": "THABOAGALE Aleng",
    "grade": "1A",
    "parent": "Parent 16",
    "status": "Active",
    "accession": "20128",
    "educator": "TBD"
  },
  {
    "id": 17,
    "name": "KHUMALO Meiswe",
    "grade": "1B",
    "parent": "Parent 17",
    "status": "Active",
    "accession": "2542",
    "educator": "TBD"
  },
  {
    "id": 18,
    "name": "MAHLANGU Abigai l",
    "grade": "1B",
    "parent": "Parent 18",
    "status": "Active",
    "accession": "2403",
    "educator": "TBD"
  },
  {
    "id": 19,
    "name": "MAKOLA Nthulo m",
    "grade": "1B",
    "parent": "Parent 19",
    "status": "Active",
    "accession": "2548",
    "educator": "TBD"
  },
  {
    "id": 20,
    "name": "MANABANI Mingobi",
    "grade": "1B",
    "parent": "Parent 20",
    "status": "Active",
    "accession": "2559",
    "educator": "TBD"
  },
  {
    "id": 21,
    "name": "SEHWANG Kgatisi le",
    "grade": "1B",
    "parent": "Parent 21",
    "status": "Active",
    "accession": "2532",
    "educator": "TBD"
  },
  {
    "id": 22,
    "name": "TLADI Mas ego",
    "grade": "1B",
    "parent": "Parent 22",
    "status": "Active",
    "accession": "2535",
    "educator": "TBD"
  },
  {
    "id": 23,
    "name": "YUDA Kga ng a",
    "grade": "1B",
    "parent": "Parent 23",
    "status": "Active",
    "accession": "2504",
    "educator": "TBD"
  },
  {
    "id": 24,
    "name": "YUDA Kang a",
    "grade": "1B",
    "parent": "Parent 24",
    "status": "Active",
    "accession": "2530",
    "educator": "TBD"
  },
  {
    "id": 25,
    "name": "CHIVAM Jabu",
    "grade": "2A",
    "parent": "Parent 25",
    "status": "Active",
    "accession": "2408",
    "educator": "TBD"
  },
  {
    "id": 26,
    "name": "LEPAKU Ontlametso",
    "grade": "2A",
    "parent": "Parent 26",
    "status": "Active",
    "accession": "2448",
    "educator": "TBD"
  },
  {
    "id": 27,
    "name": "LETSIBKO Lesedi",
    "grade": "2A",
    "parent": "Parent 27",
    "status": "Active",
    "accession": "2407",
    "educator": "TBD"
  },
  {
    "id": 28,
    "name": "MANYIKE Oratile",
    "grade": "2A",
    "parent": "Parent 28",
    "status": "Active",
    "accession": "2496",
    "educator": "TBD"
  },
  {
    "id": 29,
    "name": "MASINGAIZE Oratile",
    "grade": "2A",
    "parent": "Parent 29",
    "status": "Active",
    "accession": "2449",
    "educator": "TBD"
  },
  {
    "id": 30,
    "name": "MASINGAIZE Ramblio e",
    "grade": "2A",
    "parent": "Parent 30",
    "status": "Active",
    "accession": "2549",
    "educator": "TBD"
  },
  {
    "id": 31,
    "name": "MDLUNGU Makuya",
    "grade": "2A",
    "parent": "Parent 31",
    "status": "Active",
    "accession": "2512",
    "educator": "TBD"
  },
  {
    "id": 32,
    "name": "MOKHTHU Labonono",
    "grade": "2A",
    "parent": "Parent 32",
    "status": "Active",
    "accession": "2547",
    "educator": "TBD"
  },
  {
    "id": 33,
    "name": "MOSHMAN Benuso",
    "grade": "2A",
    "parent": "Parent 33",
    "status": "Active",
    "accession": "2491",
    "educator": "TBD"
  },
  {
    "id": 34,
    "name": "NKOBI Mots i",
    "grade": "2A",
    "parent": "Parent 34",
    "status": "Active",
    "accession": "2440",
    "educator": "TBD"
  },
  {
    "id": 35,
    "name": "NYAMUKA Omphile",
    "grade": "2A",
    "parent": "Parent 35",
    "status": "Active",
    "accession": "2345",
    "educator": "TBD"
  },
  {
    "id": 36,
    "name": "NYAMUKA Omphile",
    "grade": "2A",
    "parent": "Parent 36",
    "status": "Active",
    "accession": "2453",
    "educator": "TBD"
  },
  {
    "id": 37,
    "name": "RAMOKGATLA Bokamoso",
    "grade": "2A",
    "parent": "Parent 37",
    "status": "Active",
    "accession": "2406",
    "educator": "TBD"
  },
  {
    "id": 38,
    "name": "TICKTLA Samuel",
    "grade": "2A",
    "parent": "Parent 38",
    "status": "Active",
    "accession": "2411",
    "educator": "TBD"
  },
  {
    "id": 39,
    "name": "XOZWA Precious",
    "grade": "2A",
    "parent": "Parent 39",
    "status": "Active",
    "accession": "2573",
    "educator": "TBD"
  },
  {
    "id": 40,
    "name": "NYAMOROP Nuia",
    "grade": "2A",
    "parent": "Parent 40",
    "status": "Active",
    "accession": "2412",
    "educator": "TBD"
  },
  {
    "id": 41,
    "name": "HAMZAT Mercy",
    "grade": "3A",
    "parent": "Parent 41",
    "status": "Active",
    "accession": "2211",
    "educator": "TBD"
  },
  {
    "id": 42,
    "name": "KHOBZA Kga si",
    "grade": "3A",
    "parent": "Parent 42",
    "status": "Active",
    "accession": "2315",
    "educator": "TBD"
  },
  {
    "id": 43,
    "name": "LEBADE Prince",
    "grade": "3A",
    "parent": "Parent 43",
    "status": "Active",
    "accession": "2302",
    "educator": "TBD"
  },
  {
    "id": 44,
    "name": "MALATYE Faith",
    "grade": "3A",
    "parent": "Parent 44",
    "status": "Active",
    "accession": "2328",
    "educator": "TBD"
  },
  {
    "id": 45,
    "name": "MAREDIOMBE Brian",
    "grade": "3A",
    "parent": "Parent 45",
    "status": "Active",
    "accession": "2572",
    "educator": "TBD"
  },
  {
    "id": 46,
    "name": "MASLELA Dino ",
    "grade": "3A",
    "parent": "Parent 46",
    "status": "Active",
    "accession": "2314",
    "educator": "TBD"
  },
  {
    "id": 47,
    "name": "MOKLAPA Nomaso ",
    "grade": "3A",
    "parent": "Parent 47",
    "status": "Active",
    "accession": "2502",
    "educator": "TBD"
  },
  {
    "id": 48,
    "name": "MOTENJ Kgabulo ",
    "grade": "3A",
    "parent": "Parent 48",
    "status": "Active",
    "accession": "2844",
    "educator": "TBD"
  },
  {
    "id": 49,
    "name": "NGOBENI Matjala",
    "grade": "3A",
    "parent": "Parent 49",
    "status": "Active",
    "accession": "2323",
    "educator": "TBD"
  },
  {
    "id": 50,
    "name": "NIYAVIMBO Sonia",
    "grade": "3A",
    "parent": "Parent 50",
    "status": "Active",
    "accession": "2595",
    "educator": "TBD"
  },
  {
    "id": 51,
    "name": "RAKGOKANE Thabo",
    "grade": "3A",
    "parent": "Parent 51",
    "status": "Active",
    "accession": "2349",
    "educator": "TBD"
  },
  {
    "id": 52,
    "name": "RATSHIVHADLO Oupa",
    "grade": "3A",
    "parent": "Parent 52",
    "status": "Active",
    "accession": "2296",
    "educator": "TBD"
  },
  {
    "id": 53,
    "name": "SADEGE Khuliso",
    "grade": "3A",
    "parent": "Parent 53",
    "status": "Active",
    "accession": "2418",
    "educator": "TBD"
  },
  {
    "id": 54,
    "name": "ZINDERE Wajeed",
    "grade": "3A",
    "parent": "Parent 54",
    "status": "Active",
    "accession": "2415",
    "educator": "TBD"
  },
  {
    "id": 55,
    "name": "AGYAPONG Princess",
    "grade": "4A",
    "parent": "Parent 55",
    "status": "Active",
    "accession": "2203",
    "educator": "TBD"
  },
  {
    "id": 56,
    "name": "DZIKUSO Ravisho",
    "grade": "4A",
    "parent": "Parent 56",
    "status": "Active",
    "accession": "2125",
    "educator": "TBD"
  },
  {
    "id": 57,
    "name": "LANDANE Thabo",
    "grade": "4A",
    "parent": "Parent 57",
    "status": "Active",
    "accession": "2113",
    "educator": "TBD"
  },
  {
    "id": 58,
    "name": "LONDEW Amelia",
    "grade": "4A",
    "parent": "Parent 58",
    "status": "Active",
    "accession": "2804",
    "educator": "TBD"
  },
  {
    "id": 59,
    "name": "MANYEKANE Kholekile",
    "grade": "4A",
    "parent": "Parent 59",
    "status": "Active",
    "accession": "2470",
    "educator": "TBD"
  },
  {
    "id": 60,
    "name": "MOSHOELE Thabiso",
    "grade": "4A",
    "parent": "Parent 60",
    "status": "Active",
    "accession": "2430",
    "educator": "TBD"
  },
  {
    "id": 61,
    "name": "MUGABE Oletile",
    "grade": "4A",
    "parent": "Parent 61",
    "status": "Active",
    "accession": "2515",
    "educator": "TBD"
  },
  {
    "id": 62,
    "name": "MUSSA Sean ",
    "grade": "4A",
    "parent": "Parent 62",
    "status": "Active",
    "accession": "2877",
    "educator": "TBD"
  },
  {
    "id": 63,
    "name": "NDLOVU Innocent ",
    "grade": "4A",
    "parent": "Parent 63",
    "status": "Active",
    "accession": "2977",
    "educator": "TBD"
  },
  {
    "id": 64,
    "name": "NKWALA Amoeng",
    "grade": "4A",
    "parent": "Parent 64",
    "status": "Active",
    "accession": "2716",
    "educator": "TBD"
  },
  {
    "id": 65,
    "name": "ZIMBA Agnes",
    "grade": "4A",
    "parent": "Parent 65",
    "status": "Active",
    "accession": "2182",
    "educator": "TBD"
  },
  {
    "id": 66,
    "name": "BOYS Gina ",
    "grade": "5A",
    "parent": "Parent 66",
    "status": "Active",
    "accession": "2405",
    "educator": "TBD"
  },
  {
    "id": 67,
    "name": "CHIRUME Mafundo",
    "grade": "5A",
    "parent": "Parent 67",
    "status": "Active",
    "accession": "2026",
    "educator": "TBD"
  },
  {
    "id": 68,
    "name": "MAHANGU Jayde",
    "grade": "5A",
    "parent": "Parent 68",
    "status": "Active",
    "accession": "2123",
    "educator": "TBD"
  },
  {
    "id": 69,
    "name": "MAKOVER Kim",
    "grade": "5A",
    "parent": "Parent 69",
    "status": "Active",
    "accession": "2103",
    "educator": "TBD"
  },
  {
    "id": 70,
    "name": "MALEPHO Zwewdhu",
    "grade": "5A",
    "parent": "Parent 70",
    "status": "Active",
    "accession": "2105",
    "educator": "TBD"
  },
  {
    "id": 71,
    "name": "MNISI Lehlogonolo",
    "grade": "5A",
    "parent": "Parent 71",
    "status": "Active",
    "accession": "2574",
    "educator": "TBD"
  },
  {
    "id": 72,
    "name": "NCOBE Chris",
    "grade": "5A",
    "parent": "Parent 72",
    "status": "Active",
    "accession": "2509",
    "educator": "TBD"
  },
  {
    "id": 73,
    "name": "KNOANE Thobiso",
    "grade": "5A",
    "parent": "Parent 73",
    "status": "Active",
    "accession": "2825",
    "educator": "TBD"
  },
  {
    "id": 74,
    "name": "PHEANE Gafisi",
    "grade": "5A",
    "parent": "Parent 74",
    "status": "Active",
    "accession": "2900",
    "educator": "TBD"
  },
  {
    "id": 75,
    "name": "SEFAKO Thandi",
    "grade": "5A",
    "parent": "Parent 75",
    "status": "Active",
    "accession": "2425",
    "educator": "TBD"
  },
  {
    "id": 76,
    "name": "SHIBAMBU Nthoko",
    "grade": "5A",
    "parent": "Parent 76",
    "status": "Active",
    "accession": "2307",
    "educator": "TBD"
  },
  {
    "id": 77,
    "name": "TLADI Botumelo",
    "grade": "5A",
    "parent": "Parent 77",
    "status": "Active",
    "accession": "2011",
    "educator": "TBD"
  }
];
            staff = [
                { id: 1, name: 'John Doe', role: 'Teacher', department: 'Mathematics', salary: 35000, taxNumber: '123456789', uifNumber: 'UIF001', status: 'Active', certifications: [{id:1, name:'PGCE', expiry:'2026-06-01'}], currentBalance: 21, age: 35 },
                { id: 2, name: 'Jane Smith', role: 'Admin', department: 'HR', salary: 28000, taxNumber: '987654321', uifNumber: 'UIF002', status: 'Active', certifications: [], currentBalance: 21, age: 42 },
                { id: 3, name: 'Bob Johnson', role: 'Support', department: 'IT', salary: 25000, taxNumber: '456789123', uifNumber: 'UIF003', status: 'Active', certifications: [{id:2, name:'CompTIA', expiry:'2025-12-01'}], currentBalance: 21, age: 28 }
            ];
            payrolls = staff.map(s => ({ 
                id: Date.now() + s.id, 
                staffId: s.id, 
                month: '2025-11', 
                salary: s.salary, 
                deductions: 500, 
                tax: calculatePAYE(s.salary), 
                uif: Math.min(s.salary * uifRate, 177.12) 
            }));
            leaveRequests = [{ id: 1, staffId: 1, date: '2025-11-20', type: 'Annual', reason: 'Vacation', days: 5, status: 'Pending' }];
            performanceReviews = [{ id: 1, staffId: 1, date: '2025-10-01', score: 85, comments: 'Good performance', goals: [{id:1, description: 'Complete training', status: 'Achieved'}] }];
            jobs = [{ id: 1, title: 'Math Teacher', department: 'Education', description: 'Teach grades 8-12', status: 'Open', applications: [] }];
            saveData();
        }

        // Login function with validation
        function login() {
            try {
                const user = document.getElementById('username').value.trim();
                const pass = document.getElementById('password').value;
                const logins = {
                    'admin': 'admin123',
                    'teacher': 'teacher123',
                    'parent': 'parent123',
                    'student': 'student123'
                };
                if (logins[user] && logins[user] === pass) {
                    currentUser = { role: user, name: user.charAt(0).toUpperCase() + user.slice(1) };
                    updateVisibility();
                    document.getElementById('loginPage').style.display = 'none';
                    document.getElementById('appContainer').style.display = 'block';
                    loadData();
                    showSection('dashboard');
                    updateDashboard();
                    logAudit('Login', user);
                } else {
                    alert('Invalid credentials');
                }
            } catch (e) {
                console.error('Login error:', e);
                alert('Login error: ' + e.message);
            }
        }

        function updateVisibility() {
            const role = currentUser ? currentUser.role : '';
            document.querySelectorAll('.admin-only').forEach(el => el.style.display = role === 'admin' ? 'block' : 'none');
            document.querySelectorAll('.teacher-only').forEach(el => el.style.display = role === 'teacher' ? 'block' : 'none');
            document.querySelectorAll('.parent-only').forEach(el => el.style.display = role === 'parent' ? 'block' : 'none');
            document.querySelectorAll('.student-only').forEach(el => el.style.display = role === 'student' ? 'block' : 'none');
            document.querySelectorAll('.non-student').forEach(el => el.style.display = role !== 'student' ? 'block' : 'none');
        }

        function biometricLogin() {
            alert('Biometric login simulation - use fingerprint.');
            login(); // Demo
        }

        function showSection(section) {
            try {
                document.querySelectorAll('.section').forEach(s => s.classList.add('d-none'));
                document.getElementById(section).classList.remove('d-none');
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                document.querySelector(`[onclick="showSection('${section}')"]`).parentElement.querySelector('.nav-link').classList.add('active');
                switch (section) {
                    case 'dashboard':
                        updateDashboard();
                        break;
                    case 'students':
                        renderStudents(1);
                        break;
                    case 'admission':
                        renderAdmissions();
                        break;
                    case 'attendance':
                        loadAttendance();
                        break;
                    case 'fees':
                        loadFees();
                        break;
                    case 'timetable':
                        loadTimetable();
                        break;
                    case 'exams':
                        renderExams();
                        break;
                    case 'hr':
                        showHRSub('staff');
                        break;
                    case 'aiResearch':
                        // Chat ready
                        break;
                }
            } catch (e) {
                console.error('Section switch error:', e);
            }
        }

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const btn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
        }

        // Admission functions
        function showAddAdmissionModal() {
            const modalId = 'addAdmissionModal';
            if (document.getElementById(modalId)) document.getElementById(modalId).remove();
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">New Admission</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="text" class="form-control mb-2" id="newAdmName" placeholder="Name" required>
                                <input type="text" class="form-control mb-2" id="newAdmGrade" placeholder="Grade" required>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="addAdmission()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById(modalId)).show();
        }

        function addAdmission() {
            const name = document.getElementById('newAdmName').value.trim();
            const grade = document.getElementById('newAdmGrade').value.trim();
            if (name && grade && validateName(name)) {
                admissions.push({id: Date.now(), name, grade, status: 'Pending', date: new Date().toISOString()});
                saveData();
                renderAdmissions();
                bootstrap.Modal.getInstance(document.getElementById('addAdmissionModal')).hide();
                document.getElementById('addAdmissionModal').remove();
                logAudit('Admission Added', name);
            } else {
                alert('Valid name and grade required');
            }
        }

        function renderAdmissions() {
            try {
                const table = document.getElementById('admissionTable');
                table.innerHTML = admissions.map(a => `
                    <tr>
                        <td>${a.id}</td>
                        <td>${a.name}</td>
                        <td>${a.grade || 'N/A'}</td>
                        <td><span class="badge bg-${a.status === 'Approved' ? 'success' : 'warning'}">${a.status}</span></td>
                        <td><i class="fas fa-file-pdf"></i></td>
                        <td><button class="btn btn-sm btn-success" onclick="approveAdmission(${a.id})">Approve</button> <button class="btn btn-sm btn-danger" onclick="rejectAdmission(${a.id})">Reject</button></td>
                    </tr>
                `).join('');
            } catch (e) {
                console.error('Render admissions error:', e);
            }
        }

        function approveAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm) {
                adm.status = 'Approved';
                students.push({
                    id: Date.now(),
                    name: adm.name,
                    grade: adm.grade,
                    parent: 'TBD',
                    status: 'Active',
                    accession: adm.accessionNo || ''
                });
                saveData();
                renderAdmissions();
                renderStudents(1);
                logAudit('Admission Approved', adm.name);
            }
        }

        function rejectAdmission(id) {
            const adm = admissions.find(a => a.id === id);
            if (adm && confirm('Reject admission?')) {
                adm.status = 'Rejected';
                saveData();
                renderAdmissions();
                logAudit('Admission Rejected', adm.name);
            }
        }

        function searchAdmissions() {
            const term = document.getElementById('admissionSearch').value.toLowerCase();
            const filtered = admissions.filter(a => a.name.toLowerCase().includes(term) || a.grade.toLowerCase().includes(term));
            document.getElementById('admissionTable').innerHTML = filtered.map(a => /* same tr as above */).join('');
        }

        function showAdmissionFormModal() {
            new bootstrap.Modal(document.getElementById('admissionFormModal')).show();
        }

        function showBulkAdmissionModal() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            const data = new Uint8Array(ev.target.result);
                            const wb = XLSX.read(data, {type: 'array'});
                            const ws = wb.Sheets[wb.SheetNames[0]];
                            const json = XLSX.utils.sheet_to_json(ws);
                            json.forEach(row => {
                                if (row.name && row.grade) {
                                    admissions.push({id: Date.now() + Math.random(), name: row.name, grade: row.grade, status: 'Pending'});
                                }
                            });
                            saveData();
                            renderAdmissions();
                            alert(`${json.length} records imported`);
                        } catch (err) {
                            alert('Import error: ' + err.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
        }

        function submitAdmissionForm() {
            try {
                // Basic validation
                if (!document.getElementById('surname').value.trim() || !document.getElementById('firstName').value.trim() || !document.getElementById('dob').value) {
                    return alert('Please fill required fields (Surname, First Name, DOB)');
                }
                // Collect all fields (simplified)
                const formData = {
                    appliedGrade: document.getElementById('appliedGrade').value,
                    highestGrade: document.getElementById('highestGrade').value,
                    yearPassed: document.getElementById('yearPassed').value,
                    accessionNo: document.getElementById('accessionNo').value,
                    surname: document.getElementById('surname').value.trim(),
                    initials: document.getElementById('initials').value.trim(),
                    firstName: document.getElementById('firstName').value.trim(),
                    nickName: document.getElementById('nickName').value.trim(),
                    otherNames: document.getElementById('otherNames').value.trim(),
                    dob: document.getElementById('dob').value,
                    race: document.getElementById('race').value.trim(),
                    gender: document.getElementById('gender').value,
                    idNumber: document.getElementById('idNumber').value.trim(),
                    citizenship: document.getElementById('citizenship').value.trim(),
                    physicalAddress: document.getElementById('physicalAddress').value.trim(),
                    homeTel: document.getElementById('homeTel').value.trim(),
                    emergencyTel: document.getElementById('emergencyTel').value.trim(),
                    learnerCell: document.getElementById('learnerCell').value.trim(),
                    learnerEmail: document.getElementById('learnerEmail').value.trim(),
                    homeLanguage: document.getElementById('homeLanguage').value.trim(),
                    preferredLanguage: document.getElementById('preferredLanguage').value.trim(),
                    instructionLanguage: document.getElementById('instructionLanguage').value.trim(),
                    boarder: document.getElementById('boarder').checked,
                    prevSchoolName: document.getElementById('prevSchoolName').value.trim(),
                    prevSchoolAddress: document.getElementById('prevSchoolAddress').value.trim(),
                    province: document.getElementById('province').value.trim(),
                    country: document.getElementById('country').value.trim(),
                    medAidNum: document.getElementById('medAidNum').value.trim(),
                    medAidMain: document.getElementById('medAidMain').value.trim(),
                    medAidName: document.getElementById('medAidName').value.trim(),
                    doctorName: document.getElementById('doctorName').value.trim(),
                    doctorTel: document.getElementById('doctorTel').value.trim(),
                    medCondition: document.getElementById('medCondition').value.trim(),
                    specialProblems: document.getElementById('specialProblems').value.trim(),
                    dexterity: document.getElementById('dexterity').value,
                    socialGrant: document.getElementById('socialGrant').checked,
                    parentTitle: document.getElementById('parentTitle').value.trim(),
                    parentInitials: document.getElementById('parentInitials').value.trim(),
                    parentSurname: document.getElementById('parentSurname').value.trim(),
                    parentFirstName: document.getElementById('parentFirstName').value.trim(),
                    parentGender: document.getElementById('parentGender').value,
                    parentRace: document.getElementById('parentRace').value.trim(),
                    parentResidential: document.getElementById('parentResidential').value.trim(),
                    parentOccupational: document.getElementById('parentOccupational').value.trim(),
                    employer: document.getElementById('employer').value.trim(),
                    occupation: document.getElementById('occupation').value.trim(),
                    spouseOccupation: document.getElementById('spouseOccupation').value.trim(),
                    maritalStatus: document.getElementById('maritalStatus').value,
                    correspondenceSurname: document.getElementById('correspondenceSurname').value.trim(),
                    postalAddress: document.getElementById('postalAddress').value.trim(),
                    faxTel: document.getElementById('faxTel').value.trim(),
                    workTel: document.getElementById('workTel').value.trim(),
                    spouseWorkTel: document.getElementById('spouseWorkTel').value.trim(),
                    cellNumber: document.getElementById('cellNumber').value.trim(),
                    spouseCell: document.getElementById('spouseCell').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    spouseEmail: document.getElementById('spouseEmail').value.trim(),
                    declaration: document.getElementById('declaration').value.trim(),
                    parentNamePrint: document.getElementById('parentNamePrint').value.trim(),
                    signature: document.getElementById('signature').value.trim(),
                    parentDate: document.getElementById('parentDate').value,
                    doc1: document.getElementById('doc1').checked,
                    doc2: document.getElementById('doc2').checked,
                    doc3: document.getElementById('doc3').checked,
                    doc4: document.getElementById('doc4').checked,
                    otherChildrenNum: document.getElementById('otherChildrenNum').value,
                    familyPosition: document.getElementById('familyPosition').value.trim()
                };
                // Sanitize
                Object.keys(formData).forEach(key => {
                    if (typeof formData[key] === 'string') formData[key] = formData[key].replace(/<script>/gi, '');
                });
                // Save
                admissions.push({ id: Date.now(), ...formData, status: 'Pending', date: new Date().toISOString() });
                saveData();
                renderAdmissions();
                // Generate PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;
                doc.text('Bophelong Community Independent School - Admission Form (MX-4051)', 10, y);
                y += 10;
                doc.text(`Surname: ${formData.surname}`, 10, y);
                y += 10;
                doc.text(`First Name: ${formData.firstName}`, 10, y);
                y += 10;
                doc.text(`DOB: ${formData.dob}`, 10, y);
                // Add more fields as needed
                doc.save('admission_application.pdf');
                bootstrap.Modal.getInstance(document.getElementById('admissionFormModal')).hide();
                alert('Form submitted and PDF generated successfully!');
                logAudit('Admission Form Submitted', `${formData.surname} ${formData.firstName}`);
            } catch (e) {
                console.error('Form submit error:', e);
                alert('Error submitting form: ' + e.message);
                // Fallback export
                exportToExcel([formData], 'admission_form');
            }
        }

        function addOtherChild() {
            const list = document.getElementById('otherChildrenList');
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Name">
                    </div>
                    <div class="col-md-5">
                        <input type="text" class="form-control" placeholder="Grade">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger btn-sm" onclick="this.parentElement.parentElement.remove()">Remove</button>
                    </div>
                </div>
            `;
            list.appendChild(div);
        }

        function importClassListPDF() {
            try {
                alert('Simulating import of MX-4051 Class List PDF. 77 students loaded from OCR parse.');
                loadDemoData();
                renderStudents(1);
                logAudit('Class List PDF Imported', 'MX-4051 - 77 students');
            } catch (e) {
                console.error('Import error:', e);
                alert('Error importing PDF: ' + e.message);
            }
        }

        // Student functions
        function showAddStudentModal() {
            const modalId = 'addStudentModal';
            if (document.getElementById(modalId)) document.getElementById(modalId).remove();
            const modalHtml = `
                <div class="modal fade" id="${modalId}" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">Add Student</h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <input type="text" class="form-control mb-2" id="newStuName" placeholder="Name" required>
                                <input type="text" class="form-control mb-2" id="newStuGrade" placeholder="Grade" required>
                                <input type="text" class="form-control mb-2" id="newStuParent" placeholder="Parent">
                                <input type="text" class="form-control" id="newStuAccession" placeholder="Accession">
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                <button type="button" class="btn btn-primary" onclick="addStudent()">Add</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            new bootstrap.Modal(document.getElementById(modalId)).show();
        }

        function addStudent() {
            const name = document.getElementById('newStuName').value.trim();
            const grade = document.getElementById('newStuGrade').value.trim();
            const parent = document.getElementById('newStuParent').value.trim() || 'TBD';
            const accession = document.getElementById('newStuAccession').value.trim();
            if (name && grade && validateName(name)) {
                const newId = students.length ? Math.max(...students.map(s => s.id)) + 1 : 1;
                students.push({id: newId, name, grade, parent, status: 'Active', accession, educator: 'TBD'});
                saveData();
                renderStudents(1);
                bootstrap.Modal.getInstance(document.getElementById('addStudentModal')).hide();
                document.getElementById('addStudentModal').remove();
                logAudit('Student Added', name);
            } else {
                alert('Valid name and grade required');
            }
        }

        function editStudent(id) {
            const s = students.find(ss => ss.id === id);
            if (s) {
                const newName = prompt('Edit Name:', s.name);
                if (newName !== null && validateName(newName)) {
                    s.name = newName.trim();
                    saveData();
                    renderStudents(1);
                    logAudit('Student Updated', s.name);
                }
            }
        }

        function renderStudents(page = 1, perPage = 50) {
            try {
                const start = (page - 1) * perPage;
                const end = start + perPage;
                const paginated = students.slice(start, end);
                document.getElementById('studentTable').innerHTML = paginated.map(s => `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.accession || 'N/A'}</td>
                        <td>${s.name}</td>
                        <td>${s.grade}</td>
                        <td>${s.educator || 'N/A'}</td>
                        <td>${s.parent}</td>
                        <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                        <td><i class="fas fa-file-pdf"></i></td>
                        <td><button class="btn btn-sm btn-info" onclick="editStudent(${s.id})">Edit</button></td>
                    </tr>
                `).join('');
                const totalPages = Math.ceil(students.length / perPage);
                let pagHtml = '<li class="page-item"><a class="page-link" href="#" onclick="renderStudents(1)">First</a></li>';
                for (let i = 1; i <= totalPages; i++) {
                    pagHtml += `<li class="page-item ${i === page ? 'active' : ''}"><a class="page-link" href="#" onclick="renderStudents(${i})">${i}</a></li>`;
                }
                pagHtml += '<li class="page-item"><a class="page-link" href="#" onclick="renderStudents(' + totalPages + ')">Last</a></li>';
                document.getElementById('studentPagination').innerHTML = pagHtml;
            } catch (e) {
                console.error('Render students error:', e);
                document.getElementById('studentTable').innerHTML = '<tr><td colspan="9">Error loading students</td></tr>';
            }
        }

        function searchStudents() {
            const term = document.getElementById('studentSearch').value.toLowerCase();
            const filtered = students.filter(s => s.name.toLowerCase().includes(term) || s.grade.toLowerCase().includes(term));
            // For simplicity, reload full and filter in render, but here demo reload
            renderStudents(1);
            alert(`${filtered.length} students found for "${term}"`);
        }

        // Attendance functions
        function loadAttendance() {
            try {
                const date = document.getElementById('attendanceDate').value;
                const classFilter = document.getElementById('attendanceClass').value;
                // Populate classes if empty
                if (document.querySelector('#attendanceClass option[value!=""]').length === 0) {
                    const classes = [...new Set(students.map(s => s.grade))].sort();
                    classes.forEach(c => {
                        const opt = document.createElement('option');
                        opt.value = c;
                        opt.textContent = c;
                        document.getElementById('attendanceClass').appendChild(opt);
                    });
                }
                let filtered = students;
                if (classFilter) filtered = filtered.filter(s => s.grade === classFilter);
                document.getElementById('attendanceTable').innerHTML = filtered.map(s => {
                    const status = 'Present'; // Demo, in real from attendance data
                    return `
                        <tr>
                            <td>${s.id}</td>
                            <td>${s.name}</td>
                            <td><span class="badge bg-${status === 'Present' ? 'success' : 'danger'}">${status}</span></td>
                            <td><button class="btn btn-sm btn-warning" onclick="toggleAttendance(${s.id}, '${date}')">Toggle</button></td>
                        </tr>
                    `;
                }).join('');
            } catch (e) {
                console.error('Load attendance error:', e);
            }
        }

        function markAllPresent() {
            alert('All students marked present for today.');
            loadAttendance();
        }

        function syncBiometricAttendance() {
            alert('Biometric attendance synced.');
            loadAttendance();
        }

        function toggleAttendance(id, date) {
            // Simulate toggle
            alert(`Toggled attendance for student ${id} on ${date}`);
            loadAttendance();
        }

        // Fee functions
        function loadFees() {
            try {
                if (fees.length === 0) {
                    students.forEach(s => {
                        const paid = Math.random() > 0.3;
                        fees.push({
                            id: Date.now() + s.id,
                            studentId: s.id,
                            amount: 5000 + Math.random() * 2000,
                            dueDate: '2025-12-01',
                            paidDate: paid ? new Date().toISOString().split('T')[0] : '',
                            status: paid ? 'Paid' : 'Pending'
                        });
                    });
                    saveData();
                }
                updateFeeMetrics();
                renderFees();
            } catch (e) {
                console.error('Load fees error:', e);
            }
        }

        function updateFeeMetrics() {
            const paidFees = fees.filter(f => f.status === 'Paid');
            const pendingFees = fees.filter(f => f.status === 'Pending');
            const totalCollected = paidFees.reduce((sum, f) => sum + f.amount, 0);
            const outstanding = pendingFees.reduce((sum, f) => sum + f.amount, 0);
            const overdue = pendingFees.filter(f => new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const rate = fees.length > 0 ? (totalCollected / (totalCollected + outstanding) * 100).toFixed(0) : 0;
            document.getElementById('totalCollected').textContent = `R${totalCollected.toLocaleString()}`;
            document.getElementById('outstandingFees').textContent = `R${outstanding.toLocaleString()}`;
            document.getElementById('overdueFees').textContent = `R${overdue.toLocaleString()}`;
            document.getElementById('paymentRate').textContent = `${rate}%`;
        }

        function renderFees() {
            document.getElementById('feeTable').innerHTML = fees.map(f => {
                const s = students.find(ss => ss.id === f.studentId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>R${f.amount.toLocaleString()}</td>
                        <td>${f.dueDate}</td>
                        <td>${f.paidDate || 'N/A'}</td>
                        <td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'danger'}">${f.status}</span></td>
                        <td><button class="btn btn-sm btn-info" onclick="generateReceipt(${f.id})">Receipt</button></td>
                        <td>${f.status === 'Pending' ? `<button class="btn btn-sm btn-success" onclick="markPaid(${f.id})">Mark Paid</button>` : ''}</td>
                    </tr>
                `;
            }).join('');
        }

        function markPaid(id) {
            const f = fees.find(ff => ff.id === id);
            if (f) {
                f.status = 'Paid';
                f.paidDate = new Date().toISOString().split('T')[0];
                saveData();
                loadFees();
                logAudit('Fee Marked Paid', `Student ID ${f.studentId}`);
            }
        }

        function generateReceipt(id) {
            const f = fees.find(ff => ff.id === id);
            if (f) {
                const s = students.find(ss => ss.id === f.studentId);
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;
                doc.text('Fee Receipt - Bophelong School', 10, y); y += 10;
                doc.text(`Student: ${s.name}`, 10, y); y += 10;
                doc.text(`Amount: R${f.amount.toLocaleString()}`, 10, y); y += 10;
                doc.text(`Date: ${f.paidDate || new Date().toLocaleDateString()}`, 10, y);
                doc.save(`receipt_${f.id}.pdf`);
            }
        }

        function showGenerateInvoiceModal() {
            alert('Generate invoice for selected students (demo).');
        }

        function showBulkUploadFeesModal() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        try {
                            const data = new Uint8Array(ev.target.result);
                            const wb = XLSX.read(data, {type: 'array'});
                            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
                            json.forEach(row => {
                                if (row.studentId && row.amount && row.dueDate) {
                                    fees.push({
                                        id: Date.now() + Math.random(),
                                        studentId: parseInt(row.studentId),
                                        amount: parseFloat(row.amount),
                                        dueDate: row.dueDate,
                                        status: 'Pending'
                                    });
                                }
                            });
                            saveData();
                            renderFees();
                            alert('Bulk fees uploaded');
                        } catch (err) {
                            alert('Upload error: ' + err.message);
                        }
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
        }

        function sendFeeReminders() {
            const pending = fees.filter(f => f.status === 'Pending');
            alert(`${pending.length} reminders sent for pending fees.`);
            logAudit('Fee Reminders Sent', pending.length.toString());
        }

        function searchFees() {
            const term = document.getElementById('feeSearch').value.toLowerCase();
            const filtered = fees.filter(f => {
                const s = students.find(ss => ss.id === f.studentId);
                return s.name.toLowerCase().includes(term);
            });
            document.getElementById('feeTable').innerHTML = filtered.map(f => /* same as renderFees */).join('');
        }

        // Timetable
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            const grid = document.getElementById('timetableGrid');
            grid.innerHTML = '';
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            const times = ['8:00', '9:00', '10:00', '11:00', '12:00'];
            days.forEach(day => {
                const col = document.createElement('div');
                col.className = 'col-md-2';
                col.innerHTML = `<h6>${day}</h6>`;
                times.forEach(time => {
                    col.innerHTML += `<div class="timetable-cell editable" onclick="editTimetable('${day}', '${time}')">${grade ? 'Math' : 'Subject'}</div>`;
                });
                grid.appendChild(col);
            });
        }

        function editTimetable(day, time) {
            const subject = prompt(`Subject for ${day} ${time}:`);
            if (subject) {
                // Save to timetable
                timetable.push({day, time, subject, grade: document.getElementById('timetableGrade').value});
                saveData();
                loadTimetable();
            }
        }

        // Exams
        function renderExams() {
            document.getElementById('examTable').innerHTML = exams.map(e => `
                <tr>
                    <td>${e.subject}</td>
                    <td>${e.date}</td>
                    <td>${e.grade}</td>
                    <td><button class="btn btn-sm btn-info" onclick="editExam('${e.id}')">Edit</button></td>
                </tr>
            `).join('');
        }

        function addExam() {
            const subject = prompt('Subject:');
            const date = prompt('Date (YYYY-MM-DD):');
            const grade = prompt('Grade:');
            if (subject && date && grade) {
                exams.push({id: Date.now(), subject, date, grade});
                saveData();
                renderExams();
            }
        }

        function editExam(id) {
            // Similar to edit student
            alert('Edit exam demo');
        }

        // HR functions
        function showHRSub(sub) {
            document.querySelectorAll('#hrContent > div').forEach(d => d.style.display = 'none');
            document.getElementById(sub + 'Sub').style.display = 'block';
            switch (sub) {
                case 'staff':
                    renderStaff();
                    break;
                case 'payroll':
                    renderPayrolls();
                    break;
                case 'leaves':
                    renderLeaves();
                    break;
                case 'reviews':
                    renderReviews();
                    break;
                case 'recruitment':
                    renderJobs();
                    break;
                case 'audit':
                    renderAudit();
                    break;
            }
        }

        function renderStaff() {
            document.getElementById('staffTable').innerHTML = staff.map(s => `
                <tr>
                    <td>${s.name}</td>
                    <td>${s.role}</td>
                    <td>R${s.salary.toLocaleString()}</td>
                    <td><button class="btn btn-sm btn-info" onclick="generatePayslip(${s.id})">Payslip</button> <button class="btn btn-sm btn-warning" onclick="addLeave(${s.id})">Leave</button></td>
                </tr>
            `).join('');
        }

        function renderPayrolls() {
            document.getElementById('payrollTable').innerHTML = payrolls.map(p => {
                const s = staff.find(ss => ss.id === p.staffId);
                const net = p.salary - p.deductions - p.tax - p.uif;
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${p.salary.toLocaleString()}</td>
                        <td>R${net.toLocaleString()}</td>
                    </tr>
                `;
            }).join('');
        }

        function generatePayslip(id) {
            const s = staff.find(ss => ss.id === id);
            const p = payrolls.find(pp => pp.staffId === id && pp.month === new Date().toISOString().slice(0,7));
            if (s && p) {
                const net = p.salary - p.deductions - p.tax - p.uif;
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                let y = 10;
                doc.text('Payslip', 10, y); y += 10;
                doc.text(`Name: ${s.name}`, 10, y); y += 10;
                doc.text(`Month: ${p.month}`, 10, y); y += 10;
                doc.text(`Gross Salary: R${p.salary.toLocaleString()}`, 10, y); y += 10;
                doc.text(`Deductions: R${p.deductions.toLocaleString()}`, 10, y); y += 10;
                doc.text(`Tax: R${p.tax.toLocaleString()}`, 10, y); y += 10;
                doc.text(`UIF: R${p.uif.toLocaleString()}`, 10, y); y += 10;
                doc.text(`Net Pay: R${net.toLocaleString()}`, 10, y);
                doc.save(`payslip_${s.id}_${p.month}.pdf`);
                logAudit('Payslip Generated', s.name);
            }
        }

        function renderLeaves() {
            document.getElementById('leaveTable').innerHTML = leaveRequests.map(l => {
                const s = staff.find(ss => ss.id === l.staffId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${l.type}</td>
                        <td>${l.days}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : 'warning'}">${l.status}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function addLeave(id) {
            const days = prompt('Days:');
            const type = prompt('Type (Annual/Sick):');
            if (days && type) {
                leaveRequests.push({id: Date.now(), staffId: id, type, days: parseInt(days), status: 'Pending'});
                saveData();
                renderLeaves();
            }
        }

        function renderReviews() {
            document.getElementById('reviewTable').innerHTML = performanceReviews.map(r => {
                const s = staff.find(ss => ss.id === r.staffId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td>${r.score}</td>
                        <td>${r.comments}</td>
                    </tr>
                `;
            }).join('');
        }

        function renderJobs() {
            document.getElementById('jobTable').innerHTML = jobs.map(j => `
                <tr>
                    <td>${j.title}</td>
                    <td>${j.department}</td>
                    <td>${j.applications ? j.applications.length : 0}</td>
                    <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'secondary'}">${j.status}</span></td>
                </tr>
            `).join('');
        }

        function renderAudit() {
            document.getElementById('auditTable').innerHTML = auditLog.slice(0, 50).map(a => `
                <tr>
                    <td>${new Date(a.timestamp).toLocaleString()}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                </tr>
            `).join('');
        }

        function calculatePAYE(salary) {
            return Math.round(salary * 0.18); // Demo 18% tax
        }

        function logAudit(action, details, risk = 'Low') {
            if (!currentUser) return;
            auditLog.unshift({
                id: Date.now(),
                timestamp: new Date().toISOString(),
                user: currentUser.name,
                action,
                details,
                risk
            });
            if (auditLog.length > 1000) auditLog = auditLog.slice(0, 1000);
            saveData();
        }

        // Export to Excel
        function exportToExcel(data, filename) {
            try {
                const ws = XLSX.utils.json_to_sheet(data);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Data');
                XLSX.writeFile(wb, `${filename}.xlsx`);
            } catch (e) {
                alert('Export error: ' + e.message);
            }
        }

        // Validation helper
        function validateName(name) {
            return name.length > 1 && !/<script/.test(name);
        }

        function validateEmail(email) {
            return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
        }

        // Dashboard update
        function updateDashboard() {
            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('todayAttendance').textContent = '85%'; // Demo
            document.getElementById('pendingFees').textContent = 'R15,200'; // Demo
            document.getElementById('upcomingExams').textContent = exams.length;
            document.getElementById('totalStaffDash').textContent = staff.length;
            document.getElementById('pendingLeavesDash').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('openPositionsDash').textContent = jobs.filter(j => j.status === 'Open').length;
            document.getElementById('avgPerformanceDash').textContent = '78%'; // Demo
            // Chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if (dashboardChart) dashboardChart.destroy();
            dashboardChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['Students', 'Staff', 'Pending Fees', 'Exams'],
                    datasets: [{
                        label: 'Metrics',
                        data: [students.length, staff.length, 15200, exams.length],
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // Logout
        function logout() {
            currentUser = null;
            updateVisibility();
            document.getElementById('appContainer').style.display = 'none';
            document.getElementById('loginPage').style.display = 'flex';
            logAudit('Logout', currentUser ? currentUser.name : 'Unknown');
        }

        // Reports
        function generateReport(type) {
            let data = [];
            switch (type) {
                case 'attendance':
                    data = students.map(s => ({name: s.name, status: 'Present'})); // Demo
                    break;
                case 'fees':
                    data = fees;
                    break;
            }
            exportToExcel(data, `${type}_report`);
            logAudit('Report Generated', type);
        }

        // AI Chat
        function sendMessage() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (msg && validateName(msg)) {
                const container = document.getElementById('chatContainer');
                container.innerHTML += `<div class="chat-message chat-user">${msg}</div>`;
                // Demo response
                setTimeout(() => {
                    container.innerHTML += `<div class="chat-message chat-assistant">Thank you for your question on "${msg}". Based on current knowledge, here's a summary: [AI response placeholder]. For more, ask specifics!</div>`;
                    container.scrollTop = container.scrollHeight;
                }, 500);
                input.value = '';
            }
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('parentDate').value = new Date().toISOString().split('T')[0];
            // Notification demo
            document.getElementById('notificationBadge').textContent = '3';
            document.getElementById('notificationBadge').style.display = 'block';
            window.onerror = (msg, url, line) => alert(`App error: ${msg} at line ${line}`);
        });
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
