<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced School Management System (ASMS) - Bophelong Independent School</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://js.stripe.com/v3/"></script> <!-- Stripe SDK -->
    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background: linear-gradient(135deg, #1e3c72, #2a5298); 
            color: #fff; 
            min-height: 100vh;
        }
        .sidebar { 
            background: rgba(255, 255, 255, 0.1); 
            backdrop-filter: blur(10px); 
            border-right: 1px solid rgba(255, 255, 255, 0.2); 
            height: 100vh; 
            position: fixed; 
            width: 260px; 
            padding: 20px; 
            overflow-y: auto; 
            transition: width 0.3s ease; 
            z-index: 1000; 
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.3);
        }
        .sidebar.collapsed { width: 70px; }
        .sidebar.collapsed .nav-text { display: none; }
        .sidebar .nav-link { 
            color: #fff; 
            font-weight: 500; 
            margin-bottom: 10px; 
            padding: 12px; 
            border-radius: 10px; 
            transition: all 0.3s; 
            backdrop-filter: blur(5px);
        }
        .sidebar .nav-link:hover { 
            background: rgba(255, 255, 255, 0.2); 
            transform: translateX(5px); 
        }
        .sidebar .nav-link.active { 
            background: rgba(255, 255, 255, 0.3); 
            font-weight: 600;
        }
        .content { 
            margin-left: 260px; 
            padding: 40px; 
            transition: margin-left 0.3s ease; 
            min-height: 100vh;
        }
        .content.expanded { margin-left: 70px; }
        .card-metric { 
            background: rgba(255, 255, 255, 0.15); 
            border: none; 
            border-radius: 15px; 
            backdrop-filter: blur(10px); 
            transition: transform 0.3s; 
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }
        .card-metric:hover { transform: translateY(-8px); }
        .table { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            overflow: hidden; 
            backdrop-filter: blur(10px);
        }
        .table th { background: rgba(255, 255, 255, 0.2); color: #fff; }
        .modal-content { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 20px; 
            backdrop-filter: blur(15px); 
            color: #333;
        }
        .btn-toggle-sidebar { 
            position: fixed; 
            top: 20px; 
            left: 270px; 
            z-index: 1001; 
            background: rgba(255, 255, 255, 0.2); 
            border: none; 
            color: #fff;
        }
        .btn-toggle-sidebar.expanded { left: 80px; }
        #notificationBell { 
            position: fixed; 
            top: 20px; 
            right: 20px; 
            z-index: 1100; 
        }
        .admin-only { display: block; }
        .teacher-only { display: none; }
        .parent-only { display: none; }
        .student-only { display: none; }
        .non-student { display: block; }
        .dark-mode { filter: brightness(0.8); }
        .login-page { 
            min-height: 100vh; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            background: linear-gradient(135deg, #1e3c72, #2a5298);
        }
        .login-card { 
            width: 100%; 
            max-width: 450px; 
            padding: 2.5rem; 
            border-radius: 20px; 
            background: rgba(255, 255, 255, 0.95); 
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.3); 
            backdrop-filter: blur(15px);
        }
        .login-title { 
            font-weight: 700; 
            color: #1e3c72; 
            text-align: center;
        }
        .report-card { 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 15px; 
            padding: 20px; 
            margin: 10px 0; 
            backdrop-filter: blur(10px);
        }
        .timetable-cell { 
            padding: 10px; 
            text-align: center; 
            border: 1px solid rgba(255, 255, 255, 0.3); 
            border-radius: 8px; 
            margin: 2px; 
            background: rgba(255, 255, 255, 0.1);
        }
        .chat-message { 
            margin-bottom: 10px; 
            padding: 10px; 
            border-radius: 10px; 
        }
        .chat-user { background: rgba(255, 255, 255, 0.2); }
        .chat-assistant { background: rgba(0, 255, 0, 0.1); }
        .editable { cursor: pointer; }
        .editable:hover { background: rgba(255, 255, 255, 0.2); }
        .payslip-preview { background: white; color: black; padding: 20px; border-radius: 10px; }
        .hr-chart { height: 300px; }
        .leave-calendar { height: 400px; }
        .applicant-stage { cursor: pointer; }
        .cert-expiry { color: #ffc107; }
        .cert-expired { color: #dc3545; }
        @media (max-width: 768px) {
            .sidebar { width: 70px; }
            .sidebar .nav-text { display: none; }
            .content { margin-left: 70px; }
            .btn-toggle-sidebar { left: 80px; }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-page">
        <div class="login-card">
            <div class="text-center mb-4">
                <i class="fas fa-school fa-3x text-primary mb-3"></i>
                <h3 class="login-title">ASMS - Bophelong Independent School</h3>
                <p class="text-muted">Advanced School Management System</p>
            </div>
            <form id="loginForm" onsubmit="event.preventDefault(); login();">
                <div class="mb-3">
                    <label class="form-label">Username</label>
                    <input type="text" id="username" class="form-control" placeholder="Enter username" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Password</label>
                    <input type="password" id="password" class="form-control" placeholder="Enter password" required>
                </div>
                <button type="submit" class="btn btn-primary w-100 mb-3">
                    <i class="fas fa-sign-in-alt me-2"></i>Login
                </button>
                <button type="button" class="btn btn-secondary w-100 mb-3" onclick="biometricLogin()">
                    <i class="fas fa-fingerprint me-2"></i>Biometric Login
                </button>
                <div class="login-demo">
                    <p class="mb-1"><strong>Admin:</strong> admin / admin123</p>
                    <p class="mb-1"><strong>Teacher:</strong> teacher / teacher123</p>
                    <p class="mb-1"><strong>Parent:</strong> parent / parent123</p>
                    <p class="mb-0"><strong>Student:</strong> student / student123</p>
                </div>
            </form>
        </div>
    </div>

    <!-- Main App -->
    <div class="app-container" id="appContainer" style="display:none;">
        <!-- Notification Bell -->
        <div id="notificationBell">
            <button class="btn btn-warning rounded-circle shadow" style="width:50px;height:50px;" data-bs-toggle="modal" data-bs-target="#notificationsModal">
                <i class="fas fa-bell fa-lg"></i>
                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display:none;">0</span>
            </button>
        </div>

        <button class="btn btn-sm btn-light btn-toggle-sidebar" onclick="toggleSidebar()"><i class="fas fa-bars"></i></button>

        <div class="sidebar">
            <h4 class="mb-4 text-center"><i class="fas fa-school me-2"></i><span class="nav-text">ASMS</span></h4>
            <ul class="nav flex-column">
                <li class="admin-only non-student"><a href="#dashboard" class="nav-link active" onclick="showSection('dashboard')"><i class="fas fa-tachometer-alt me-2"></i><span class="nav-text">Dashboard</span></a></li>
                <li class="non-student"><a href="#admission" class="nav-link" onclick="showSection('admission')"><i class="fas fa-user-plus me-2"></i><span class="nav-text">Admission</span></a></li>
                <li class="non-student"><a href="#students" class="nav-link" onclick="showSection('students')"><i class="fas fa-users me-2"></i><span class="nav-text">Student Info</span></a></li>
                <li class="non-student"><a href="#attendance" class="nav-link" onclick="showSection('attendance')"><i class="fas fa-clock me-2"></i><span class="nav-text">Attendance</span></a></li>
                <li class="non-student"><a href="#fees" class="nav-link" onclick="showSection('fees')"><i class="fas fa-money-bill-wave me-2"></i><span class="nav-text">Fee Management</span></a></li>
                <li><a href="#timetable" class="nav-link" onclick="showSection('timetable')"><i class="fas fa-calendar-alt me-2"></i><span class="nav-text">Timetable</span></a></li>
                <li><a href="#exams" class="nav-link" onclick="showSection('exams')"><i class="fas fa-file-alt me-2"></i><span class="nav-text">Examinations</span></a></li>
                <li class="admin-only non-student"><a href="#hr" class="nav-link" onclick="showSection('hr')"><i class="fas fa-user-tie me-2"></i><span class="nav-text">HR Management</span></a></li>
                <li class="non-student"><a href="#communication" class="nav-link" onclick="showSection('communication')"><i class="fas fa-comments me-2"></i><span class="nav-text">Communication</span></a></li>
                <li><a href="#content" class="nav-link" onclick="showSection('content')"><i class="fas fa-book me-2"></i><span class="nav-text">Content</span></a></li>
                <li class="admin-only non-student"><a href="#reports" class="nav-link" onclick="showSection('reports')"><i class="fas fa-chart-bar me-2"></i><span class="nav-text">Reports</span></a></li>
                <li class="admin-only non-student"><a href="#settings" class="nav-link" onclick="showSection('settings')"><i class="fas fa-cog me-2"></i><span class="nav-text">Settings</span></a></li>
                <li class="student-only"><a href="#aiResearch" class="nav-link" onclick="showSection('aiResearch')"><i class="fas fa-robot me-2"></i><span class="nav-text">AI Research</span></a></li>
                <li><a href="#" class="nav-link text-danger" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i><span class="nav-text">Logout</span></a></li>
            </ul>
        </div>

        <div class="content">
            <!-- Dashboard -->
            <section id="dashboard" class="section">
                <h2>School Dashboard</h2>
                <div class="row mt-4">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Students</h5><h3 id="totalStudents">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Today's Attendance</h5><h3 id="todayAttendance">0%</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Fees</h5><h3 id="pendingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Upcoming Exams</h5><h3 id="upcomingExams">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaffDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeavesDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositionsDash">0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Performance</h5><h3 id="avgPerformanceDash">0%</h3></div></div>
                </div>
                <canvas id="dashboardChart" class="mt-4"></canvas>
            </section>

            <!-- Admission Management -->
            <section id="admission" class="section d-none">
                <h2>Admission Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddAdmissionModal()">New Application</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkAdmissionModal()">Bulk Import (CSV/Excel)</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search admissions..." id="admissionSearch">
                    <button class="btn btn-outline-secondary" onclick="searchAdmissions()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="admissionTable"></tbody>
                </table>
            </section>

            <!-- Student Information System -->
            <section id="students" class="section d-none">
                <h2>Student Information System</h2>
                <button class="btn btn-primary mb-3" onclick="showAddStudentModal()">Add Student</button>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search student..." id="studentSearch">
                    <button class="btn btn-outline-secondary" onclick="searchStudents()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Grade</th><th>Parent</th><th>Status</th><th>Documents</th><th>Actions</th></tr></thead>
                    <tbody id="studentTable"></tbody>
                </table>
            </section>

            <!-- Attendance Management -->
            <section id="attendance" class="section d-none">
                <h2>Attendance Management</h2>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <input type="date" id="attendanceDate" class="form-control" onchange="loadAttendance()">
                    </div>
                    <div class="col-md-4">
                        <select id="attendanceClass" class="form-control" onchange="loadAttendance()">
                            <option value="">All Classes</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-success mb-3" onclick="markAllPresent()">Mark All Present</button>
                <button class="btn btn-info mb-3" onclick="syncBiometricAttendance()">Sync Biometric Attendance</button>
                <table class="table table-striped">
                    <thead><tr><th>ID</th><th>Name</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="attendanceTable"></tbody>
                </table>
            </section>

            <!-- Fee Management -->
            <section id="fees" class="section d-none">
                <h2>Fee Management</h2>
                <button class="btn btn-primary mb-3" onclick="showGenerateInvoiceModal()">Generate Invoice</button>
                <button class="btn btn-secondary mb-3" onclick="showBulkUploadFeesModal()">Bulk Import (CSV/Excel)</button>
                <button class="btn btn-warning mb-3" onclick="sendFeeReminders()">Send Reminders</button>
                <div class="row mb-3">
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Collected</h5><h3 id="totalCollected">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Outstanding</h5><h3 id="outstandingFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Overdue</h5><h3 id="overdueFees">R0</h3></div></div>
                    <div class="col-md-3"><div class="card card-metric p-3"><h5>Payment Rate</h5><h3 id="paymentRate">0%</h3></div></div>
                </div>
                <div class="input-group mb-3 w-50">
                    <input type="text" class="form-control" placeholder="Search fees..." id="feeSearch">
                    <button class="btn btn-outline-secondary" onclick="searchFees()">Search</button>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Student</th><th>Amount</th><th>Due Date</th><th>Paid Date</th><th>Status</th><th>Receipt</th><th>Actions</th></tr></thead>
                    <tbody id="feeTable"></tbody>
                </table>
                <div id="feeHistory" class="mt-4"></div>
            </section>

            <!-- Timetable Management -->
            <section id="timetable" class="section d-none">
                <h2>Timetable Management</h2>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="timetableGrade" class="form-control" onchange="loadTimetable()">
                            <option value="">Select Grade</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <select id="timetableTeacher" class="form-control" onchange="highlightTeacherSchedule()">
                            <option value="">Select Teacher</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-primary" onclick="showAddTimeSlotModal()">Add Time Slot</button>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-warning" onclick="checkTimetableConflicts()">Check Conflicts</button>
                    </div>
                </div>
                <div id="timetableContainer"></div>
            </section>

            <!-- Examination Management -->
            <section id="exams" class="section d-none">
                <h2>Examination Management</h2>
                <button class="btn btn-primary mb-3" onclick="showAddExamModal()">Schedule Exam</button>
                <button class="btn btn-info mb-3" onclick="showEnterMarksModal()">Enter Marks</button>
                <button class="btn btn-success mb-3" onclick="generateAllReportCards()">Generate All Report Cards</button>
                <button class="btn btn-warning mb-3" onclick="generateHallTickets()">Generate Hall Tickets</button>
                <div class="row mb-3">
                    <div class="col-md-4">
                        <select id="examGradeFilter" class="form-control" onchange="renderExams()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="examSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderExams, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Exam</th><th>Date</th><th>Subject</th><th>Grade</th><th>Status</th><th>Actions</th></tr></thead>
                    <tbody id="examTable"></tbody>
                </table>
                <div id="marksEntry" class="mt-4 d-none">
                    <h3>Enter Marks for <span id="marksExamName"></span></h3>
                    <table class="table table-striped">
                        <thead><tr><th>Student</th><th>Marks</th></tr></thead>
                        <tbody id="marksTable"></tbody>
                    </table>
                    <button class="btn btn-primary" onclick="saveMarks()">Save</button>
                </div>
            </section>

            <!-- Enhanced HR Management -->
            <section id="hr" class="section d-none admin-only">
                <h2>Human Resource Management</h2>
                <ul class="nav nav-tabs mb-3">
                    <li class="nav-item">
                        <a class="nav-link active" data-bs-toggle="tab" href="#hr-staff">Staff</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-payroll">Payroll</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-leaves">Leaves</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-performance">Performance</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-recruitment">Recruitment</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" data-bs-toggle="tab" href="#hr-audit">Audit Trail</a>
                    </li>
                </ul>
                <div class="tab-content">
                    <div class="tab-pane fade show active" id="hr-staff">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddStaffModal()">Add Staff</button>
                                <button class="btn btn-secondary ms-2" onclick="syncStaffBiometric()">Sync Biometric</button>
                                <button class="btn btn-info ms-2" onclick="generateStaffReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="text" class="form-control" placeholder="Search staff..." id="staffSearch" oninput="debounce(renderStaff, 300)()">
                                    <select id="staffFilterRole" class="form-select" style="max-width: 150px;" onchange="renderStaff()">
                                        <option value="">All Roles</option>
                                        <option value="Teacher">Teacher</option>
                                        <option value="Admin">Admin</option>
                                        <option value="Support">Support</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Staff</h5><h3 id="totalStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Active</h5><h3 id="activeStaff">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Salary</h5><h3 id="avgSalary">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Expiring Certs</h5><h3 id="expiringCerts">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Name</th><th>Role</th><th>Department</th><th>Salary</th><th>Tax #</th><th>UIF #</th><th>Cert Expiry</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="staffTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-payroll">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddPayrollModal()">Add Payroll</button>
                                <button class="btn btn-info ms-2" onclick="generatePayroll()">Generate Payroll</button>
                                <button class="btn btn-success ms-2" onclick="exportPayrollToExcel()">Export Payroll</button>
                                <button class="btn btn-warning ms-2" onclick="calculateCompliance()">Check Compliance</button>
                            </div>
                            <div class="col-md-6">
                                <input type="month" id="payrollMonthFilter" class="form-control" onchange="renderPayrolls()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Payroll</h5><h3 id="totalPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Deductions</h5><h3 id="totalDeductions">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Net Payroll</h5><h3 id="netPayroll">R0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Score</h5><h3 id="complianceScore">100%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Staff</th><th>Month</th><th>Salary</th><th>Deductions</th><th>PAYE Tax</th><th>UIF</th><th>Net</th><th>Actions</th></tr></thead>
                            <tbody id="payrollTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-leaves">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddLeaveModal()">Add Leave Request</button>
                                <button class="btn btn-info ms-2" onclick="viewLeaveCalendar()">View Calendar</button>
                            </div>
                            <div class="col-md-6">
                                <input type="date" id="leaveDateFilter" class="form-control" onchange="loadLeaveRequests()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Pending Leaves</h5><h3 id="pendingLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Approved</h5><h3 id="approvedLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Rejected</h5><h3 id="rejectedLeaves">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Balance</h5><h3 id="avgLeaveBalance">0 days</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Staff</th><th>Date</th><th>Type</th><th>Reason</th><th>Status</th><th>Balance</th><th>Actions</th></tr></thead>
                            <tbody id="leaveTable"></tbody>
                        </table>
                        <div id="leaveCalendar" class="mt-3 d-none"></div>
                    </div>
                    <div class="tab-pane fade" id="hr-performance">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddReviewModal()">Add Review</button>
                                <button class="btn btn-info ms-2" onclick="showGoalSettingModal()">Set Goals</button>
                                <button class="btn btn-success ms-2" onclick="generatePerformanceReport()">Generate Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" id="reviewSearch" class="form-control" placeholder="Search reviews..." oninput="debounce(renderReviews, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Avg Score</h5><h3 id="avgScore">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Reviews</h5><h3 id="totalReviews">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Goals Achieved</h5><h3 id="goalsAchieved">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Feedback Pending</h5><h3 id="feedbackPending">0</h3></div></div>
                        </div>
                        <canvas id="performanceChart" class="hr-chart mb-3"></canvas>
                        <table class="table table-striped">
                            <thead><tr><th>Staff</th><th>Date</th><th>Score</th><th>Goals</th><th>Comments</th><th>Actions</th></tr></thead>
                            <tbody id="reviewTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-recruitment">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-primary" onclick="showAddJobModal()">Add Position</button>
                                <button class="btn btn-info ms-2" onclick="showApplyJobModal()">Apply (Demo)</button>
                                <button class="btn btn-success ms-2" onclick="generateRecruitmentReport()">Report</button>
                            </div>
                            <div class="col-md-6">
                                <input type="text" id="jobSearch" class="form-control" placeholder="Search jobs..." oninput="debounce(renderJobs, 300)()">
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Open Positions</h5><h3 id="openPositions">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Applications</h5><h3 id="totalApplications">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Interviews Scheduled</h5><h3 id="interviewsScheduled">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Hire Rate</h5><h3 id="hireRate">0%</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>ID</th><th>Title</th><th>Department</th><th>Applications</th><th>Status</th><th>Actions</th></tr></thead>
                            <tbody id="jobTable"></tbody>
                        </table>
                    </div>
                    <div class="tab-pane fade" id="hr-audit">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <button class="btn btn-secondary" onclick="exportAuditToExcel()">Export Audit</button>
                                <button class="btn btn-info ms-2" onclick="generateAuditReport()">Report</button>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group">
                                    <input type="date" id="auditDateFilter" class="form-control" onchange="renderAudit()">
                                    <select id="auditActionFilter" class="form-select" style="max-width: 200px;" onchange="renderAudit()">
                                        <option value="">All Actions</option>
                                        <option value="Added">Added</option>
                                        <option value="Updated">Updated</option>
                                        <option value="Deleted">Deleted</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row mb-3">
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Total Entries</h5><h3 id="totalAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Today</h5><h3 id="todayAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>High Risk</h5><h3 id="highRiskAudit">0</h3></div></div>
                            <div class="col-md-3"><div class="card card-metric p-3"><h5>Compliance Issues</h5><h3 id="complianceIssues">0</h3></div></div>
                        </div>
                        <table class="table table-striped">
                            <thead><tr><th>Time</th><th>User</th><th>Action</th><th>Details</th><th>Risk Level</th></tr></thead>
                            <tbody id="auditTable"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Communication Module -->
            <section id="communication" class="section d-none">
                <h2>Communication Hub</h2>
                <div class="row mb-3">
                    <div class="col-md-6">
                        <textarea id="messageText" class="form-control" rows="3" placeholder="Type message..."></textarea>
                    </div>
                    <div class="col-md-3">
                        <select id="messageRecipient" class="form-control">
                            <option value="all">All</option>
                            <option value="parents">Parents</option>
                            <option value="students">Students</option>
                            <option value="staff">Staff</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <button class="btn btn-success w-100" onclick="sendMessage()">Send Message</button>
                    </div>
                </div>
                <div id="messageHistory" class="mt-3"></div>
            </section>

            <!-- Content Module -->
            <section id="content" class="section d-none">
                <h2>Content Management</h2>
                <p>This comprehensive module hosts subjects, interventions, online lessons, textbooks, examinations, and work due. Filter by grade and subject for easy access.</p>
                <button class="btn btn-primary mb-3" onclick="showUploadContentModal()">Upload Content</button>
                <div class="row mb-3">
                    <div class="col-md-3">
                        <select id="contentGradeFilter" class="form-control" onchange="renderContent()">
                            <option value="">All Grades</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <input type="text" id="contentSubjectFilter" class="form-control" placeholder="Filter by Subject" oninput="debounce(renderContent, 300)()">
                    </div>
                </div>
                <table class="table table-striped">
                    <thead><tr><th>Type</th><th>Name</th><th>Grade</th><th>Subject</th><th>Actions</th></tr></thead>
                    <tbody id="contentTable"></tbody>
                </table>
            </section>

            <!-- Reports -->
            <section id="reports" class="section d-none admin-only">
                <h2>Reports & Analytics</h2>
                <div class="row">
                    <div class="col-md-4"><button class="btn btn-primary w-100 mb-3" onclick="exportToExcel(students, 'students')">Export Students</button></div>
                    <div class="col-md-4"><button class="btn btn-success w-100 mb-3" onclick="exportToExcel(fees, 'fees')">Export Fees</button></div>
                    <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="exportToExcel(attendanceRecords, 'attendance')">Export Attendance</button></div>
                    <div class="col-md-4"><button class="btn btn-warning w-100 mb-3" onclick="exportToExcel(staff, 'staff')">Export Staff</button></div>
                    <div class="col-md-4"><button class="btn btn-danger w-100 mb-3" onclick="exportToExcel(payrolls, 'payrolls')">Export Payrolls</button></div>
                    <div class="col-md-4"><button class="btn btn-secondary w-100 mb-3" onclick="exportToExcel(leaveRequests, 'leaves')">Export Leaves</button></div>
                    <div class="col-md-4"><button class="btn btn-primary w-100 mb-3" onclick="exportToExcel(performanceReviews, 'performance')">Export Performance</button></div>
                    <div class="col-md-4"><button class="btn btn-info w-100 mb-3" onclick="exportToExcel(jobs, 'recruitment')">Export Recruitment</button></div>
                </div>
            </section>

            <!-- Settings -->
            <section id="settings" class="section d-none admin-only">
                <h2>System Settings</h2>
                <div class="form-check form-switch mb-3">
                    <input class="form-check-input" type="checkbox" id="darkModeSwitch" onchange="toggleDarkMode(this.checked)">
                    <label class="form-check-label" for="darkModeSwitch">Dark Mode</label>
                </div>
                <h5>School Year</h5>
                <input type="text" id="schoolYear" class="form-control w-50" value="2025">
                <h5 class="mt-3">HR Settings</h5>
                <div class="row">
                    <div class="col-md-4">
                        <label>Annual Leave Days</label>
                        <input type="number" id="annualLeaveDays" class="form-control" value="21">
                    </div>
                    <div class="col-md-4">
                        <label>Sick Leave Days (36 months)</label>
                        <input type="number" id="sickLeaveDays" class="form-control" value="30">
                    </div>
                    <div class="col-md-4">
                        <label>Maternity Leave Months</label>
                        <input type="number" id="maternityLeaveMonths" class="form-control" value="4">
                    </div>
                </div>
                <button class="btn btn-primary mt-3" onclick="saveHRSettings()">Save Settings</button>
            </section>

            <!-- AI Research Module (Student Only) -->
            <section id="aiResearch" class="section d-none">
                <h2>AI Research Module - Powered by Grok</h2>
                <div class="mb-3">
                    <label>API Key (obtain from https://x.ai/api):</label>
                    <input type="text" id="grokApiKey" class="form-control" placeholder="Enter your xAI API Key">
                </div>
                <div id="chatHistory" class="border p-3 mb-3" style="height: 400px; overflow-y: auto;"></div>
                <div class="input-group">
                    <textarea id="grokQuery" class="form-control" rows="2" placeholder="Enter your research query..."></textarea>
                    <button class="btn btn-primary" onclick="sendGrokQuery()">Send</button>
                </div>
            </section>
        </div>
    </div>

    <!-- Modals -->
    <!-- Staff Modal - Enhanced with certifications -->
    <div class="modal fade" id="addStaffModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 id="staffModalTitle">Add Staff</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <input type="text" id="staffName" class="form-control mb-3" placeholder="Name" required>
                            <select id="staffRole" class="form-control mb-3" required>
                                <option value="">Select Role</option>
                                <option value="Teacher">Teacher</option>
                                <option value="Admin">Admin</option>
                                <option value="Support">Support</option>
                            </select>
                            <input type="text" id="staffDepartment" class="form-control mb-3" placeholder="Department">
                            <input type="number" id="staffSalary" class="form-control mb-3" placeholder="Salary" min="0" required>
                            <input type="text" id="staffTaxNumber" class="form-control mb-3" placeholder="Tax Number">
                            <input type="text" id="staffUifNumber" class="form-control mb-3" placeholder="UIF Number">
                            <select id="staffStatus" class="form-control mb-3">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <h6>Certifications</h6>
                            <div id="certificationsList"></div>
                            <button class="btn btn-sm btn-outline-primary" onclick="addCertification()">Add Cert</button>
                        </div>
                    </div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveStaff()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Certification Modal -->
    <div class="modal fade" id="addCertModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Certification</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="certName" class="form-control mb-3" placeholder="Certification Name">
                    <input type="date" id="certExpiry" class="form-control mb-3">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveCertification()">Add</button></div>
            </div>
        </div>
    </div>

    <!-- Payroll Modal - Enhanced with SA Tax Calculation -->
    <div class="modal fade" id="addPayrollModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 id="payrollModalTitle">Add Payroll</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select id="payrollStaff" class="form-control mb-3" required onchange="calculateTax()">
                        <option value="">Select Staff</option>
                    </select>
                    <input type="month" id="payrollMonth" class="form-control mb-3" required>
                    <input type="number" id="payrollSalary" class="form-control mb-3" placeholder="Salary" min="0" required onchange="calculateTax()">
                    <input type="number" id="payrollDeductions" class="form-control mb-3" placeholder="Deductions" min="0" onchange="calculateTax()">
                    <input type="number" id="payrollUIF" class="form-control mb-3" placeholder="UIF (1% max)" min="0" max="1">
                    <div id="payrollTaxDisplay" class="mb-3"></div>
                    <input type="number" id="payrollTax" class="form-control mb-3" placeholder="PAYE Tax" readonly>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="savePayroll()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Leave Modal - Enhanced with SA Leave Types -->
    <div class="modal fade" id="addLeaveModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 id="leaveModalTitle">Add Leave Request</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select id="leaveStaff" class="form-control mb-3" required>
                        <option value="">Select Staff</option>
                    </select>
                    <input type="date" id="leaveDate" class="form-control mb-3" required>
                    <select id="leaveType" class="form-control mb-3">
                        <option value="Annual">Annual (21 days)</option>
                        <option value="Sick">Sick (30 days/36 months)</option>
                        <option value="Maternity">Maternity (4 months)</option>
                        <option value="Family">Family Responsibility (3 days)</option>
                    </select>
                    <textarea id="leaveReason" class="form-control mb-3" rows="3" placeholder="Reason" required></textarea>
                    <input type="number" id="leaveDays" class="form-control mb-3" placeholder="Number of Days" min="1" required>
                    <div id="leaveBalanceDisplay" class="mb-3"></div>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveLeave()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Leave Status Modal -->
    <div class="modal fade" id="leaveStatusModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Update Leave Status</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select id="leaveStatus" class="form-control mb-3">
                        <option value="Pending">Pending</option>
                        <option value="Approved">Approved</option>
                        <option value="Rejected">Rejected</option>
                    </select>
                    <textarea id="leaveComments" class="form-control mb-3" rows="2" placeholder="Comments (optional)"></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveLeaveStatus()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Performance Review Modal - Enhanced with Goals -->
    <div class="modal fade" id="addReviewModal">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header"><h5 id="reviewModalTitle">Add Performance Review</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select id="reviewStaff" class="form-control mb-3" required>
                        <option value="">Select Staff</option>
                    </select>
                    <input type="date" id="reviewDate" class="form-control mb-3" required>
                    <input type="number" id="reviewScore" class="form-control mb-3" min="0" max="100" placeholder="Score (0-100)" required>
                    <textarea id="reviewComments" class="form-control mb-3" rows="3" placeholder="Comments"></textarea>
                    <h6>Goals</h6>
                    <div id="goalsList"></div>
                    <button class="btn btn-sm btn-outline-primary" onclick="addGoal()">Add Goal</button>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveReview()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Goal Modal -->
    <div class="modal fade" id="addGoalModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Add Goal</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="goalDescription" class="form-control mb-3" placeholder="Goal Description">
                    <input type="date" id="goalTargetDate" class="form-control mb-3">
                    <select id="goalStatus" class="form-control mb-3">
                        <option value="Pending">Pending</option>
                        <option value="In Progress">In Progress</option>
                        <option value="Achieved">Achieved</option>
                    </select>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveGoal()">Add</button></div>
            </div>
        </div>
    </div>

    <!-- Recruitment Job Modal - Enhanced with Stages -->
    <div class="modal fade" id="addJobModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5 id="jobModalTitle">Add Job Position</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="jobTitle" class="form-control mb-3" placeholder="Title" required>
                    <input type="text" id="jobDepartment" class="form-control mb-3" placeholder="Department">
                    <textarea id="jobDescription" class="form-control mb-3" rows="3" placeholder="Description" required></textarea>
                    <select id="jobStatus" class="form-control mb-3">
                        <option value="Open">Open</option>
                        <option value="Closed">Closed</option>
                    </select>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveJob()">Save</button></div>
            </div>
        </div>
    </div>

    <!-- Application Modal - Enhanced with Stages -->
    <div class="modal fade" id="applyJobModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Apply for Job</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <select id="applyJobSelect" class="form-control mb-3">
                        <option value="">Select Position</option>
                    </select>
                    <input type="text" id="applicantName" class="form-control mb-3" placeholder="Your Name" required>
                    <input type="email" id="applicantEmail" class="form-control mb-3" placeholder="Email" required>
                    <input type="tel" id="applicantPhone" class="form-control mb-3" placeholder="Phone">
                    <textarea id="applicantCoverLetter" class="form-control mb-3" rows="3" placeholder="Cover Letter"></textarea>
                    <input type="file" id="applicantResume" class="form-control" accept=".pdf,.docx">
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="submitApplication()">Apply</button></div>
            </div>
        </div>
    </div>

    <!-- Interview Scheduling Modal -->
    <div class="modal fade" id="scheduleInterviewModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Schedule Interview</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <input type="text" id="interviewApplicant" class="form-control mb-3" placeholder="Applicant Name" readonly>
                    <input type="datetime-local" id="interviewDateTime" class="form-control mb-3">
                    <select id="interviewType" class="form-control mb-3">
                        <option value="Phone">Phone</option>
                        <option value="Video">Video</option>
                        <option value="In-Person">In-Person</option>
                    </select>
                    <textarea id="interviewNotes" class="form-control mb-3" rows="2" placeholder="Notes"></textarea>
                </div>
                <div class="modal-footer"><button class="btn btn-primary" onclick="saveInterview()">Schedule</button></div>
            </div>
        </div>
    </div>

    <!-- Payslip Modal -->
    <div class="modal fade" id="payslipModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header"><h5>Payslip</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body payslip-preview">
                    <p><strong>Staff:</strong> <span id="payslipStaff"></span></p>
                    <p><strong>Period:</strong> <span id="payslipPeriod"></span></p>
                    <p><strong>Gross Salary:</strong> <span id="payslipSalary"></span></p>
                    <p><strong>Deductions:</strong> <span id="payslipDeductions"></span></p>
                    <p><strong>PAYE Tax:</strong> <span id="payslipTax"></span></p>
                    <p><strong>UIF:</strong> <span id="payslipUIF"></span></p>
                    <p><strong>Net Pay:</strong> <span id="payslipNet"></span></p>
                    <p id="payslipTaxNumber"></p>
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" onclick="downloadPayslipPDF()">Download PDF</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications Modal (Dynamic) -->
    <div class="modal fade" id="notificationsModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Notifications</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="notificationContent">No new notifications.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentUser = null;
        let students = [];
        let admissions = [];
        let attendanceRecords = [];
        let fees = [];
        let exams = [];
        let timetables = {};
        let documents = {};
        let marks = {};
        let messages = [];
        let content = [];
        let staff = [];
        let payrolls = [];
        let leaveRequests = [];
        let performanceReviews = [];
        let jobs = [];
        let auditLog = [];
        let hrSettings = { annualLeaveDays: 21, sickLeaveDays: 30, maternityLeaveMonths: 4 };
        let editingStaff = null;
        let editingPayroll = null;
        let editingLeave = null;
        let editingReview = null;
        let editingJob = null;
        let currentMarksExam = null;
        let performanceChart = null;
        let timeSlots = [
            { start: '08:00', end: '08:30' },
            { start: '08:30', end: '09:00' },
            { start: '09:00', end: '09:30' },
            { start: '09:30', end: '10:00' },
            { start: '10:00', end: '10:30' },
            { start: '10:30', end: '11:00' },
            { start: '11:00', end: '11:30' },
            { start: '11:30', end: '12:00' }
        ];
        const uifRate = 0.01;

        // FIXED LOGIN FUNCTION
        function login() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();

            let role = null;
            let name = '';

            if (username === 'admin' && password === 'admin123') {
                role = 'admin';
                name = 'Admin User';
            } else if (username === 'teacher' && password === 'teacher123') {
                role = 'teacher';
                name = 'Teacher User';
            } else if (username === 'parent' && password === 'parent123') {
                role = 'parent';
                name = 'Parent User';
            } else if (username === 'student' && password === 'student123') {
                role = 'student';
                name = 'Student User';
            } else {
                alert('Invalid username or password. Please check the demo credentials.');
                return;
            }

            currentUser = { name, role };

            // Hide login, show app
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';

            // Toggle visibility based on role (override CSS defaults)
            document.querySelectorAll('.admin-only').forEach(el => {
                el.style.display = role === 'admin' ? 'block' : 'none';
            });
            document.querySelectorAll('.teacher-only').forEach(el => {
                el.style.display = role === 'teacher' ? 'block' : 'none';
            });
            document.querySelectorAll('.parent-only').forEach(el => {
                el.style.display = role === 'parent' ? 'block' : 'none';
            });
            document.querySelectorAll('.student-only').forEach(el => {
                el.style.display = role === 'student' ? 'block' : 'none';
            });
            document.querySelectorAll('.non-student').forEach(el => {
                el.style.display = role !== 'student' ? 'block' : 'none';
            });

            // Initialize app after login
            initApp();

            // Show dashboard by default
            showSection('dashboard');

            alert(`Welcome, ${name}! (${role.toUpperCase()})`);
        }

        // Biometric Login (simulates admin login for ease)
        function biometricLogin() {
            document.getElementById('username').value = 'admin';
            document.getElementById('password').value = 'admin123';
            login();  // Auto-triggers login
        }

        // Logout function
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                document.getElementById('loginPage').style.display = 'flex';
                document.getElementById('appContainer').style.display = 'none';
                // Reset all sections to hidden
                document.querySelectorAll('.section').forEach(section => {
                    section.classList.add('d-none');
                });
                // Reset nav active
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                // Clear form inputs
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                // Reset visibility to defaults (via CSS)
                document.querySelectorAll('[class*="only"], .non-student').forEach(el => {
                    el.style.display = '';
                });
            }
        }

        // Utility: Safe JSON parse
        function safeParseJSON(key, defaultValue) {
            try {
                const item = localStorage.getItem(key);
                return item ? JSON.parse(item) : defaultValue;
            } catch (e) {
                console.error(`Error parsing ${key}:`, e);
                return defaultValue;
            }
        }

        // Load data from localStorage
        function loadData() {
            students = safeParseJSON('students', []);
            admissions = safeParseJSON('admissions', []);
            attendanceRecords = safeParseJSON('attendanceRecords', []);
            fees = safeParseJSON('fees', []);
            exams = safeParseJSON('exams', []);
            timetables = safeParseJSON('timetables', {});
            documents = safeParseJSON('documents', {});
            marks = safeParseJSON('marks', {});
            messages = safeParseJSON('messages', []);
            content = safeParseJSON('content', []);
            staff = safeParseJSON('staff', []);
            payrolls = safeParseJSON('payrolls', []);
            leaveRequests = safeParseJSON('leaveRequests', []);
            performanceReviews = safeParseJSON('performanceReviews', []);
            jobs = safeParseJSON('jobs', []);
            auditLog = safeParseJSON('auditLog', []);
            hrSettings = safeParseJSON('hrSettings', hrSettings);
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('students', JSON.stringify(students));
            localStorage.setItem('admissions', JSON.stringify(admissions));
            localStorage.setItem('attendanceRecords', JSON.stringify(attendanceRecords));
            localStorage.setItem('fees', JSON.stringify(fees));
            localStorage.setItem('exams', JSON.stringify(exams));
            localStorage.setItem('timetables', JSON.stringify(timetables));
            localStorage.setItem('documents', JSON.stringify(documents));
            localStorage.setItem('marks', JSON.stringify(marks));
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('content', JSON.stringify(content));
            localStorage.setItem('staff', JSON.stringify(staff));
            localStorage.setItem('payrolls', JSON.stringify(payrolls));
            localStorage.setItem('leaveRequests', JSON.stringify(leaveRequests));
            localStorage.setItem('performanceReviews', JSON.stringify(performanceReviews));
            localStorage.setItem('jobs', JSON.stringify(jobs));
            localStorage.setItem('auditLog', JSON.stringify(auditLog));
            localStorage.setItem('hrSettings', JSON.stringify(hrSettings));
        }

        // Debounce utility
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Show section
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.add('d-none');
            });
            document.getElementById(sectionId).classList.remove('d-none');
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            // Re-render if needed
            if (window[`render${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`]) {
                window[`render${sectionId.charAt(0).toUpperCase() + sectionId.slice(1)}`]();
            }
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            const content = document.querySelector('.content');
            const btn = document.querySelector('.btn-toggle-sidebar');
            sidebar.classList.toggle('collapsed');
            content.classList.toggle('expanded');
            btn.classList.toggle('expanded');
        }

        // Initialize app
        function initApp() {
            loadData();
            populateSelects();
            renderAllSections();
            // Notifications demo
            setInterval(() => {
                if (Math.random() > 0.8 && currentUser) {
                    document.getElementById('notificationBadge').style.display = 'block';
                    document.getElementById('notificationBadge').textContent = Math.floor(Math.random() * 10) + 1;
                }
            }, 30000);
        }

        // Populate selects (students, staff, grades, etc.)
        function populateSelects() {
            // Students
            const studentSelects = document.querySelectorAll('select[id*="Student"], select[id*="student"]');
            studentSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Student</option>' + students.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
            // Staff
            const staffSelects = document.querySelectorAll('select[id*="Staff"], select[id*="staff"]');
            staffSelects.forEach(select => {
                select.innerHTML = '<option value="">Select Staff</option>' + staff.map(s => `<option value="${s.id}">${s.name}</option>`).join('');
            });
            // Grades
            const grades = ['Grade 1', 'Grade 2', 'Grade 3', 'Grade 4', 'Grade 5', 'Grade 6', 'Grade 7', 'Grade 8', 'Grade 9', 'Grade 10', 'Grade 11', 'Grade 12'];
            document.querySelectorAll('select[id*="Grade"], select[id*="grade"], select[id*="Class"], select[id*="class"]').forEach(select => {
                if (select.id.includes('attendanceClass') || select.id.includes('timetableGrade') || select.id.includes('examGradeFilter') || select.id.includes('contentGradeFilter')) {
                    select.innerHTML = '<option value="">All Grades</option>' + grades.map(g => `<option value="${g}">${g}</option>`).join('');
                }
            });
            // Subjects
            const subjects = ['Math', 'English', 'Science', 'History', 'Geography', 'Art'];
            document.querySelectorAll('select[id*="Subject"]').forEach(select => {
                select.innerHTML = '<option value="">All Subjects</option>' + subjects.map(sub => `<option value="${sub}">${sub}</option>`).join('');
            });
            // Teachers for timetable
            document.getElementById('timetableTeacher').innerHTML = '<option value="">Select Teacher</option>' + staff.filter(s => s.role === 'Teacher').map(t => `<option value="${t.id}">${t.name}</option>`).join('');
        }

        // Render all sections
        function renderAllSections() {
            renderStudents();
            renderAdmissions();
            renderAttendance();
            renderFees();
            renderTimetable();
            renderExams();
            renderCommunication();
            renderContent();
            renderHR();
            renderDashboard();
        }

        // Dashboard render
        function renderDashboard() {
            document.getElementById('totalStudents').textContent = students.length;
            const today = new Date().toISOString().split('T')[0];
            const todayAtt = attendanceRecords.filter(a => a.date === today);
            const attRate = todayAtt.length ? (todayAtt.filter(a => a.status === 'Present').length / todayAtt.length * 100).toFixed(0) : 0;
            document.getElementById('todayAttendance').textContent = attRate + '%';
            const pending = fees.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            document.getElementById('pendingFees').textContent = 'R' + pending.toFixed(2);
            const upcoming = exams.filter(e => new Date(e.date) > new Date() && new Date(e.date) < new Date(Date.now() + 7*24*60*60*1000)).length;
            document.getElementById('upcomingExams').textContent = upcoming;
            document.getElementById('totalStaffDash').textContent = staff.length;
            document.getElementById('pendingLeavesDash').textContent = leaveRequests.filter(l => l.status === 'Pending').length;
            document.getElementById('openPositionsDash').textContent = jobs.filter(j => j.status === 'Open').length;
            const avgPerf = performanceReviews.reduce((sum, r) => sum + r.score, 0) / performanceReviews.length || 0;
            document.getElementById('avgPerformanceDash').textContent = avgPerf.toFixed(0) + '%';
            // Chart
            const ctx = document.getElementById('dashboardChart').getContext('2d');
            if (window.dashboardChart) window.dashboardChart.destroy();
            window.dashboardChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Students', 'Staff', 'Exams'],
                    datasets: [{ data: [students.length, staff.length, exams.length], backgroundColor: ['#007bff', '#28a745', '#ffc107'] }]
                }
            });
        }

        // Admissions functions (abbreviated for brevity - implement as in original)
        function showAddAdmissionModal() {
            alert('New Admission Modal - Implement form for application details');
        }

        function showBulkAdmissionModal() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv,.xlsx';
            input.onchange = e => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = ev => {
                        const data = new Uint8Array(ev.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const sheet = workbook.Sheets[workbook.SheetNames[0]];
                        const json = XLSX.utils.sheet_to_json(sheet);
                        admissions.push(...json.map((row, i) => ({ id: Date.now() + i, ...row, status: 'Pending' })));
                        saveData();
                        renderAdmissions();
                    };
                    reader.readAsArrayBuffer(file);
                }
            };
            input.click();
        }

        function searchAdmissions() {
            const term = document.getElementById('admissionSearch').value.toLowerCase();
            renderAdmissions(term);
        }

        function renderAdmissions(searchTerm = '') {
            let filtered = admissions.filter(a => a.name.toLowerCase().includes(searchTerm));
            document.getElementById('admissionTable').innerHTML = filtered.map(a => `
                <tr>
                    <td>${a.id}</td>
                    <td>${a.name}</td>
                    <td>${a.grade || '-'}</td>
                    <td><span class="badge bg-${a.status === 'Approved' ? 'success' : 'warning'}">${a.status}</span></td>
                    <td>${a.documents ? Object.keys(a.documents).length : 0}</td>
                    <td><button class="btn btn-sm btn-info">View</button></td>
                </tr>
            `).join('');
        }

        // Students functions (similar pattern)
        function showAddStudentModal() {
            const newStudent = { id: Date.now(), name: 'New Student', grade: 'Grade 1', parent: 'Parent Name', status: 'Active' };
            students.push(newStudent);
            saveData();
            renderStudents();
        }

        function searchStudents() {
            const term = document.getElementById('studentSearch').value.toLowerCase();
            renderStudents(term);
        }

        function renderStudents(searchTerm = '') {
            let filtered = students.filter(s => s.name.toLowerCase().includes(searchTerm));
            document.getElementById('studentTable').innerHTML = filtered.map(s => `
                <tr>
                    <td>${s.id}</td>
                    <td>${s.name}</td>
                    <td>${s.grade}</td>
                    <td>${s.parent}</td>
                    <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'warning'}">${s.status}</span></td>
                    <td>${s.documents ? Object.keys(s.documents).length : 0}</td>
                    <td><button class="btn btn-sm btn-info" onclick="editStudent(${s.id})">Edit</button></td>
                </tr>
            `).join('');
        }

        function editStudent(id) {
            alert(`Edit Student ${id}`);
        }

        // Attendance functions
        function loadAttendance() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            const cls = document.getElementById('attendanceClass').value;
            renderAttendance(date, cls);
        }

        function markAllPresent() {
            const date = document.getElementById('attendanceDate').value || new Date().toISOString().split('T')[0];
            students.forEach(s => {
                if (!attendanceRecords.find(a => a.studentId === s.id && a.date === date)) {
                    attendanceRecords.push({ studentId: s.id, date, status: 'Present' });
                } else {
                    const rec = attendanceRecords.find(a => a.studentId === s.id && a.date === date);
                    rec.status = 'Present';
                }
            });
            saveData();
            renderAttendance(date);
        }

        function syncBiometricAttendance() {
            alert('Biometric sync simulated - marking random attendance');
            markAllPresent();
        }

        function renderAttendance(date = new Date().toISOString().split('T')[0], cls = '') {
            let filteredStudents = students;
            if (cls) filteredStudents = students.filter(s => s.grade === cls);
            const attForDate = attendanceRecords.filter(a => a.date === date);
            document.getElementById('attendanceTable').innerHTML = filteredStudents.map(s => {
                const status = attForDate.find(a => a.studentId === s.id)?.status || 'Absent';
                return `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td><span class="badge bg-${status === 'Present' ? 'success' : 'danger'}">${status}</span></td>
                        <td><button class="btn btn-sm btn-${status === 'Present' ? 'warning' : 'success'}" onclick="toggleAttendance(${s.id}, '${date}', '${status}')">Toggle</button></td>
                    </tr>
                `;
            }).join('');
        }

        function toggleAttendance(studentId, date, currentStatus) {
            const index = attendanceRecords.findIndex(a => a.studentId === studentId && a.date === date);
            if (index > -1) {
                attendanceRecords[index].status = currentStatus === 'Present' ? 'Absent' : 'Present';
            } else {
                attendanceRecords.push({ studentId, date, status: 'Present' });
            }
            saveData();
            loadAttendance();
        }

        // Fees functions
        function showGenerateInvoiceModal() {
            const studentId = prompt('Student ID:');
            if (studentId) {
                const student = students.find(s => s.id == studentId);
                if (student) {
                    const invoice = { id: Date.now(), studentId, amount: 5000, dueDate: new Date(Date.now() + 30*24*60*60*1000).toISOString().split('T')[0], status: 'Pending' };
                    fees.push(invoice);
                    saveData();
                    renderFees();
                } else {
                    alert('Student not found');
                }
            }
        }

        function showBulkUploadFeesModal() {
            alert('Bulk fees upload - Implement file reader similar to admissions');
        }

        function sendFeeReminders() {
            const overdue = fees.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date());
            alert(`${overdue.length} reminders sent via email/SMS!`);
        }

        function searchFees() {
            const term = document.getElementById('feeSearch').value.toLowerCase();
            renderFees(term);
        }

        function renderFees(searchTerm = '') {
            let filtered = fees.filter(f => students.find(s => s.id === f.studentId)?.name.toLowerCase().includes(searchTerm));
            const totalCollected = filtered.filter(f => f.status === 'Paid').reduce((sum, f) => sum + f.amount, 0);
            const outstanding = filtered.filter(f => f.status === 'Pending').reduce((sum, f) => sum + f.amount, 0);
            const overdue = filtered.filter(f => f.status === 'Pending' && new Date(f.dueDate) < new Date()).reduce((sum, f) => sum + f.amount, 0);
            const rate = filtered.length ? (totalCollected / (totalCollected + outstanding) * 100).toFixed(0) : 0;
            document.getElementById('totalCollected').textContent = 'R' + totalCollected.toFixed(2);
            document.getElementById('outstandingFees').textContent = 'R' + outstanding.toFixed(2);
            document.getElementById('overdueFees').textContent = 'R' + overdue.toFixed(2);
            document.getElementById('paymentRate').textContent = rate + '%';
            document.getElementById('feeTable').innerHTML = filtered.map(f => {
                const s = students.find(st => st.id === f.studentId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>R${f.amount.toFixed(2)}</td>
                        <td>${f.dueDate}</td>
                        <td>${f.paidDate || '-'}</td>
                        <td><span class="badge bg-${f.status === 'Paid' ? 'success' : 'warning'}">${f.status}</span></td>
                        <td><button class="btn btn-sm btn-info" onclick="generateReceipt(${f.id})">Receipt</button></td>
                        <td><button class="btn btn-sm btn-success" onclick="markPaid(${f.id})">Mark Paid</button></td>
                    </tr>
                `;
            }).join('');
            document.getElementById('feeHistory').innerHTML = '<h5>Payment History</h5><p>Demo: Last payment on ' + new Date().toDateString() + '</p>';
        }

        function markPaid(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                fee.status = 'Paid';
                fee.paidDate = new Date().toISOString().split('T')[0];
                saveData();
                renderFees();
                alert('Fee marked as paid!');
            }
        }

        function generateReceipt(id) {
            const fee = fees.find(f => f.id === id);
            if (fee) {
                alert('Receipt generated for ID ' + id + ' - Amount: R' + fee.amount + '\n(Implement PDF export)');
            }
        }

        // Timetable functions
        function loadTimetable() {
            const grade = document.getElementById('timetableGrade').value;
            if (grade) {
                timetables[grade] = timetables[grade] || Array(5).fill().map(() => timeSlots.map(() => ({ label: '', teacher: '' })));
                renderTimetable(grade);
            }
        }

        function highlightTeacherSchedule() {
            const teacherId = document.getElementById('timetableTeacher').value;
            document.querySelectorAll('.timetable-cell').forEach(cell => {
                cell.style.background = cell.dataset.teacher === teacherId ? 'rgba(255, 255, 0, 0.3)' : 'rgba(255, 255, 255, 0.1)';
            });
        }

        function showAddTimeSlotModal() {
            const grade = document.getElementById('timetableGrade').value;
            if (!grade) return alert('Select a grade first');
            const day = prompt('Day (0=Monday to 4=Friday):');
            const slot = prompt('Slot (0-7):');
            const subject = prompt('Subject:');
            const teacherId = prompt('Teacher ID:');
            if (grade && day !== null && slot !== null && subject) {
                const d = parseInt(day);
                const sl = parseInt(slot);
                if (d >= 0 && d < 5 && sl >= 0 && sl < 8) {
                    if (!timetables[grade]) timetables[grade] = Array(5).fill().map(() => timeSlots.map(() => ({ label: '', teacher: '' })));
                    timetables[grade][d][sl] = { label: subject, teacher: teacherId };
                    saveData();
                    renderTimetable(grade);
                } else {
                    alert('Invalid day or slot');
                }
            }
        }

        function checkTimetableConflicts() {
            const grade = document.getElementById('timetableGrade').value;
            if (!timetables[grade]) return alert('No timetable loaded');
            const conflicts = [];
            staff.filter(s => s.role === 'Teacher').forEach(t => {
                let count = 0;
                timetables[grade].flat().forEach(slot => { if (slot.teacher === t.id) count++; });
                if (count > 8) conflicts.push(t.name); // More than 8 periods
            });
            alert(conflicts.length ? `Conflicts for teachers: ${conflicts.join(', ')}` : 'No conflicts found');
        }

        function renderTimetable(grade = '') {
            if (!grade) return;
            const container = document.getElementById('timetableContainer');
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday'];
            let html = '<table class="table"><thead><tr><th>Time</th>' + days.map(d => `<th>${d}</th>`).join('') + '</tr></thead><tbody>';
            timeSlots.forEach((slot, i) => {
                html += `<tr><td>${slot.start} - ${slot.end}</td>`;
                for (let day = 0; day < 5; day++) {
                    const ts = timetables[grade]?.[day]?.[i] || { label: '', teacher: '' };
                    html += `<td class="timetable-cell editable" data-teacher="${ts.teacher}" onclick="editTimeSlot('${grade}', ${day}, ${i})">${ts.label}</td>`;
                }
                html += '</tr>';
            });
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function editTimeSlot(grade, day, slot) {
            const subject = prompt('Subject (or empty to clear):');
            if (subject !== null) {
                timetables[grade][day][slot].label = subject;
                const teacher = prompt('Teacher ID (optional):') || '';
                timetables[grade][day][slot].teacher = teacher;
                saveData();
                renderTimetable(grade);
            }
        }

        // Exams functions
        function showAddExamModal() {
            const name = prompt('Exam Name:');
            const date = prompt('Date (YYYY-MM-DD):');
            const subject = prompt('Subject:');
            const grade = prompt('Grade:');
            if (name && date && !isNaN(Date.parse(date))) {
                exams.push({ id: Date.now(), name, date, subject, grade, status: 'Scheduled' });
                saveData();
                renderExams();
                alert('Exam scheduled!');
            } else {
                alert('Invalid input');
            }
        }

        function showEnterMarksModal() {
            currentMarksExam = prompt('Exam ID to enter marks for:');
            if (currentMarksExam) {
                const exam = exams.find(e => e.id == currentMarksExam);
                if (exam) {
                    document.getElementById('marksExamName').textContent = exam.name;
                    document.getElementById('marksEntry').classList.remove('d-none');
                    renderMarks();
                } else {
                    alert('Exam not found');
                }
            }
        }

        function renderExams() {
            const grade = document.getElementById('examGradeFilter').value;
            const subject = document.getElementById('examSubjectFilter').value.toLowerCase();
            let filtered = exams.filter(e => (!grade || e.grade === grade) && (!subject || e.subject.toLowerCase().includes(subject)));
            document.getElementById('examTable').innerHTML = filtered.map(e => `
                <tr>
                    <td>${e.name}</td>
                    <td>${e.date}</td>
                    <td>${e.subject}</td>
                    <td>${e.grade}</td>
                    <td><span class="badge bg-info">${e.status}</span></td>
                    <td><button class="btn btn-sm btn-info" onclick="enterMarks(${e.id})">Enter Marks</button></td>
                </tr>
            `).join('');
        }

        function enterMarks(examId) {
            currentMarksExam = examId;
            const exam = exams.find(e => e.id === examId);
            document.getElementById('marksExamName').textContent = exam ? exam.name : 'Unknown';
            document.getElementById('marksEntry').classList.remove('d-none');
            renderMarks();
        }

        function renderMarks() {
            const exam = exams.find(e => e.id == currentMarksExam);
            if (!exam) return;
            const gradeStudents = students.filter(s => s.grade === exam.grade);
            document.getElementById('marksTable').innerHTML = gradeStudents.map(s => {
                const mark = marks[exam.id]?.[s.id] || 0;
                return `<tr><td>${s.name}</td><td><input type="number" class="form-control" value="${mark}" min="0" max="100" onchange="updateMark(${s.id}, this.value)"></td></tr>`;
            }).join('');
        }

        function updateMark(studentId, value) {
            if (!marks[currentMarksExam]) marks[currentMarksExam] = {};
            marks[currentMarksExam][studentId] = parseFloat(value) || 0;
            saveData();
        }

        function saveMarks() {
            document.getElementById('marksEntry').classList.add('d-none');
            alert('Marks saved successfully!');
        }

        function generateAllReportCards() {
            alert('Report cards generated for all students (check console for demo)');
            console.log('Report cards:', marks);
        }

        function generateHallTickets() {
            alert('Hall tickets generated for upcoming exams');
        }

        // Communication
        function sendMessage() {
            const text = document.getElementById('messageText').value.trim();
            const recipient = document.getElementById('messageRecipient').value;
            if (text && currentUser) {
                messages.push({ id: Date.now(), text, recipient, sender: currentUser.name, date: new Date().toISOString() });
                saveData();
                renderCommunication();
                document.getElementById('messageText').value = '';
                alert('Message sent to ' + recipient + '!');
            } else {
                alert('Please enter a message');
            }
        }

        function renderCommunication() {
            document.getElementById('messageHistory').innerHTML = messages.slice(-10).map(m => `
                <div class="chat-message ${m.sender === currentUser?.name ? 'chat-user' : 'chat-assistant'}">
                    <strong>${m.sender}</strong> to ${m.recipient}: ${m.text} <small>${new Date(m.date).toLocaleString()}</small>
                </div>
            `).join('');
        }

        // Content
        function showUploadContentModal() {
            const type = prompt('Type (lesson/textbook/exam/work):');
            const name = prompt('Name:');
            const grade = prompt('Grade:');
            const subject = prompt('Subject:');
            if (name && type && grade && subject) {
                content.push({ id: Date.now(), type, name, grade, subject, uploaded: new Date().toISOString() });
                saveData();
                renderContent();
                alert('Content uploaded!');
            }
        }

        function renderContent() {
            const grade = document.getElementById('contentGradeFilter').value;
            const subject = document.getElementById('contentSubjectFilter').value.toLowerCase();
            let filtered = content.filter(c => (!grade || c.grade === grade) && (!subject || c.subject.toLowerCase().includes(subject)));
            document.getElementById('contentTable').innerHTML = filtered.map(c => `
                <tr>
                    <td><span class="badge bg-primary">${c.type}</span></td>
                    <td>${c.name}</td>
                    <td>${c.grade}</td>
                    <td>${c.subject}</td>
                    <td><button class="btn btn-sm btn-info" onclick="downloadContent(${c.id})">Download</button></td>
                </tr>
            `).join('');
        }

        function downloadContent(id) {
            const item = content.find(c => c.id === id);
            if (item) alert(`Downloading ${item.name}... (Demo - implement file download)`);
        }

        // Reports export
        function exportToExcel(data, type) {
            const ws = XLSX.utils.json_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, type);
            XLSX.writeFile(wb, `${type}_${new Date().toISOString().slice(0,10)}.xlsx`);
            alert(`${type} exported!`);
        }

        // Settings
        function toggleDarkMode(enabled) {
            document.body.classList.toggle('dark-mode', enabled);
            localStorage.setItem('darkMode', enabled);
        }

        function saveHRSettings() {
            hrSettings.annualLeaveDays = parseInt(document.getElementById('annualLeaveDays').value) || 21;
            hrSettings.sickLeaveDays = parseInt(document.getElementById('sickLeaveDays').value) || 30;
            hrSettings.maternityLeaveMonths = parseInt(document.getElementById('maternityLeaveMonths').value) || 4;
            saveData();
            alert('HR Settings saved!');
        }

        // AI Research (Grok integration)
        async function sendGrokQuery() {
            const query = document.getElementById('grokQuery').value.trim();
            const apiKey = document.getElementById('grokApiKey').value.trim();
            if (!query) return alert('Enter a query');
            if (!apiKey) return alert('Enter your xAI API key from https://x.ai/api');
            const historyDiv = document.getElementById('chatHistory');
            historyDiv.innerHTML += `<div class="chat-user">You: ${query}</div><div class="loading">Grok is thinking...</div>`;
            historyDiv.scrollTop = historyDiv.scrollHeight;
            try {
                const response = await fetch('https://api.x.ai/v1/chat/completions', {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${apiKey}`, 
                        'Content-Type': 'application/json' 
                    },
                    body: JSON.stringify({
                        model: 'grok-beta',
                        messages: [{ role: 'user', content: query }],
                        stream: false,
                        temperature: 0.7
                    })
                });
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                const reply = data.choices[0]?.message?.content || 'No response received';
                historyDiv.innerHTML = historyDiv.innerHTML.replace('<div class="loading">Grok is thinking...</div>', `<div class="chat-assistant">Grok: ${reply}</div>`);
                document.getElementById('grokQuery').value = '';
                historyDiv.scrollTop = historyDiv.scrollHeight;
            } catch (e) {
                historyDiv.innerHTML += `<div class="chat-assistant text-danger">Error: ${e.message}</div>`;
                historyDiv.scrollTop = historyDiv.scrollHeight;
            }
        }

        // HR Functions (Staff)
        function showAddStaffModal(editId = null) {
            editingStaff = editId ? staff.find(s => s.id === editId) : null;
            document.getElementById('staffModalTitle').textContent = editingStaff ? 'Edit Staff' : 'Add Staff';
            if (editingStaff) {
                document.getElementById('staffName').value = editingStaff.name;
                document.getElementById('staffRole').value = editingStaff.role;
                // Populate other fields...
            }
            // Render certifications
            const certList = document.getElementById('certificationsList');
            certList.innerHTML = (editingStaff?.certifications || []).map(cert => `
                <div class="d-flex justify-content-between mb-2">
                    <span>${cert.name} - Expires: ${cert.expiry}</span>
                    <button class="btn btn-sm btn-danger" onclick="removeCert(${cert.id})">Remove</button>
                </div>
            `).join('');
            new bootstrap.Modal(document.getElementById('addStaffModal')).show();
        }

        function saveStaff() {
            const name = document.getElementById('staffName').value.trim();
            const role = document.getElementById('staffRole').value;
            const department = document.getElementById('staffDepartment').value;
            const salary = parseFloat(document.getElementById('staffSalary').value) || 0;
            const taxNumber = document.getElementById('staffTaxNumber').value;
            const uifNumber = document.getElementById('staffUifNumber').value;
            const status = document.getElementById('staffStatus').value;
            const certifications = Array.from(document.querySelectorAll('#certificationsList .cert-item')).map(el => ({
                id: Date.now() + Math.random(),
                name: el.dataset.name,
                expiry: el.dataset.expiry
            }));
            if (!name || !role || salary <= 0) return alert('Please fill required fields');
            if (editingStaff) {
                editingStaff.name = name;
                editingStaff.role = role;
                editingStaff.department = department;
                editingStaff.salary = salary;
                editingStaff.taxNumber = taxNumber;
                editingStaff.uifNumber = uifNumber;
                editingStaff.status = status;
                editingStaff.certifications = certifications;
            } else {
                staff.push({ 
                    id: Date.now(), 
                    name, role, department, salary, taxNumber, uifNumber, status, 
                    certifications, age: 30 // Demo
                });
            }
            saveData();
            renderStaff();
            bootstrap.Modal.getInstance(document.getElementById('addStaffModal')).hide();
            logAudit(editingStaff ? 'Updated Staff' : 'Added Staff', name);
            editingStaff = null;
        }

        function addCertification() {
            new bootstrap.Modal(document.getElementById('addCertModal')).show();
        }

        function saveCertification() {
            const name = document.getElementById('certName').value.trim();
            const expiry = document.getElementById('certExpiry').value;
            if (name && expiry) {
                const certList = document.getElementById('certificationsList');
                const certId = Date.now();
                certList.innerHTML += `
                    <div class="d-flex justify-content-between mb-2 cert-item" data-name="${name}" data-expiry="${expiry}">
                        <span>${name} - Expires: ${expiry}</span>
                        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();">Remove</button>
                    </div>
                `;
                document.getElementById('certName').value = '';
                document.getElementById('certExpiry').value = '';
            }
            bootstrap.Modal.getInstance(document.getElementById('addCertModal')).hide();
        }

        function renderStaff() {
            const searchTerm = document.getElementById('staffSearch').value.toLowerCase();
            const roleFilter = document.getElementById('staffFilterRole').value;
            let filtered = staff.filter(s => s.name.toLowerCase().includes(searchTerm) && (!roleFilter || s.role === roleFilter));
            const active = filtered.filter(s => s.status === 'Active').length;
            const avgSalary = filtered.reduce((sum, s) => sum + s.salary, 0) / filtered.length || 0;
            const expiringCerts = filtered.reduce((count, s) => count + (s.certifications?.filter(c => new Date(c.expiry) < new Date(Date.now() + 90*24*60*60*1000)).length || 0), 0);
            document.getElementById('totalStaff').textContent = filtered.length;
            document.getElementById('activeStaff').textContent = active;
            document.getElementById('avgSalary').textContent = 'R' + avgSalary.toFixed(0);
            document.getElementById('expiringCerts').textContent = expiringCerts;
            document.getElementById('staffTable').innerHTML = filtered.map(s => {
                const nextExpiry = s.certifications?.reduce((min, c) => new Date(c.expiry) < new Date(min) ? c.expiry : min, Infinity) || '';
                const expiryClass = new Date(nextExpiry) < new Date() ? 'cert-expired' : 'cert-expiry';
                return `
                    <tr>
                        <td>${s.id}</td>
                        <td>${s.name}</td>
                        <td>${s.role}</td>
                        <td>${s.department}</td>
                        <td>R${s.salary.toFixed(0)}</td>
                        <td>${s.taxNumber}</td>
                        <td>${s.uifNumber}</td>
                        <td><span class="${expiryClass}">${nextExpiry || 'N/A'}</span></td>
                        <td><span class="badge bg-${s.status === 'Active' ? 'success' : 'secondary'}">${s.status}</span></td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="showAddStaffModal(${s.id})">Edit</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteStaff(${s.id})">Delete</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function deleteStaff(id) {
            if (confirm('Delete this staff member?')) {
                const name = staff.find(s => s.id === id)?.name || 'Unknown';
                staff = staff.filter(s => s.id !== id);
                saveData();
                renderStaff();
                logAudit('Deleted Staff', name, 'High');
                alert('Staff deleted');
            }
        }

        // Payroll functions
        function showAddPayrollModal(editId = null) {
            editingPayroll = editId ? payrolls.find(p => p.id === editId) : null;
            document.getElementById('payrollModalTitle').textContent = editingPayroll ? 'Edit Payroll' : 'Add Payroll';
            populateStaffSelect(document.getElementById('payrollStaff'), staff);
            if (editingPayroll) {
                document.getElementById('payrollStaff').value = editingPayroll.staffId;
                document.getElementById('payrollMonth').value = editingPayroll.month;
                document.getElementById('payrollSalary').value = editingPayroll.salary;
                document.getElementById('payrollDeductions').value = editingPayroll.deductions || 0;
                document.getElementById('payrollUIF').value = editingPayroll.uif || 0;
                document.getElementById('payrollTax').value = editingPayroll.tax || 0;
            } else {
                document.getElementById('payrollMonth').value = new Date().toISOString().slice(0, 7);
            }
            calculateTax();
            new bootstrap.Modal(document.getElementById('addPayrollModal')).show();
        }

        function populateStaffSelect(select, staffList) {
            select.innerHTML = '<option value="">Select Staff</option>' + staffList.map(s => `<option value="${s.id}">${s.name} (${s.role})</option>`).join('');
        }

        function calculateTax() {
            const salary = parseFloat(document.getElementById('payrollSalary').value) || 0;
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            const taxable = salary - deductions;
            // Simple SA PAYE demo (2025 brackets approximate)
            let tax = 0;
            if (taxable > 237100) tax = (taxable - 237100) * 0.45 + 110098;
            else if (taxable > 195850) tax = (taxable - 195850) * 0.41 + 81730;
            // ... (add more brackets)
            else tax = taxable * 0.18; // Basic
            const uif = Math.min(salary * uifRate, 177.12);
            document.getElementById('payrollTax').value = tax.toFixed(2);
            document.getElementById('payrollTaxDisplay').innerHTML = `<small>Taxable: R${taxable.toFixed(2)} | Estimated PAYE: R${tax.toFixed(2)} | UIF: R${uif.toFixed(2)}</small>`;
        }

        function savePayroll() {
            const staffId = parseInt(document.getElementById('payrollStaff').value);
            const month = document.getElementById('payrollMonth').value;
            const salary = parseFloat(document.getElementById('payrollSalary').value) || 0;
            const deductions = parseFloat(document.getElementById('payrollDeductions').value) || 0;
            const tax = parseFloat(document.getElementById('payrollTax').value) || 0;
            const uif = parseFloat(document.getElementById('payrollUIF').value) || 0;
            if (!staffId || !month || salary <= 0) return alert('Please fill required fields');
            if (editingPayroll) {
                editingPayroll.staffId = staffId;
                editingPayroll.month = month;
                editingPayroll.salary = salary;
                editingPayroll.deductions = deductions;
                editingPayroll.tax = tax;
                editingPayroll.uif = uif;
            } else {
                payrolls.push({ id: Date.now(), staffId, month, salary, deductions, tax, uif });
            }
            saveData();
            renderPayrolls();
            bootstrap.Modal.getInstance(document.getElementById('addPayrollModal')).hide();
            logAudit('Payroll ' + (editingPayroll ? 'Updated' : 'Added'), month);
            editingPayroll = null;
        }

        function generatePayroll() {
            const month = document.getElementById('payrollMonthFilter').value;
            if (!month) return alert('Select a month');
            staff.forEach(s => {
                if (!payrolls.find(p => p.staffId === s.id && p.month === month)) {
                    const salary = s.salary;
                    const deductions = 0; // Demo
                    const tax = calculatePAYE(salary); // Implement full function
                    const uif = Math.min(salary * uifRate, 177.12);
                    payrolls.push({ id: Date.now(), staffId: s.id, month, salary, deductions, tax, uif });
                }
            });
            saveData();
            renderPayrolls();
            alert('Payroll generated for ' + month);
        }

        function calculatePAYE(salary) {
            // Full SA PAYE calculation (simplified for 2025)
            const brackets = [
                { threshold: 237100, rate: 0.45, cumulative: 110098 },
                { threshold: 195850, rate: 0.41, cumulative: 81730 },
                { threshold: 154200, rate: 0.36, cumulative: 54940 },
                { threshold: 102640, rate: 0.31, cumulative: 15468 },
                { threshold: 100000, rate: 0.26, cumulative: 14656 },
                { threshold: 0, rate: 0.18, cumulative: 0 }
            ];
            for (let b of brackets) {
                if (salary > b.threshold) return (salary - b.threshold) * b.rate + b.cumulative;
            }
            return 0;
        }

        function exportPayrollToExcel() {
            exportToExcel(payrolls, 'payroll');
        }

        function calculateCompliance() {
            const score = payrolls.length ? (payrolls.filter(p => p.tax > 0 && p.uif > 0).length / payrolls.length * 100).toFixed(0) : 100;
            alert('Compliance score: ' + score + '%');
        }

        function renderPayrolls() {
            const month = document.getElementById('payrollMonthFilter').value;
            let filtered = payrolls.filter(p => !month || p.month === month);
            const totalPayroll = filtered.reduce((sum, p) => sum + p.salary, 0);
            const totalDeductions = filtered.reduce((sum, p) => sum + p.deductions, 0);
            const netPayroll = filtered.reduce((sum, p) => sum + (p.salary - p.deductions - p.tax - p.uif), 0);
            document.getElementById('totalPayroll').textContent = 'R' + totalPayroll.toFixed(2);
            document.getElementById('totalDeductions').textContent = 'R' + totalDeductions.toFixed(2);
            document.getElementById('netPayroll').textContent = 'R' + netPayroll.toFixed(2);
            const complianceScore = filtered.length ? (filtered.filter(p => p.tax && p.uif).length / filtered.length * 100).toFixed(0) : 100;
            document.getElementById('complianceScore').textContent = complianceScore + '%';
            document.getElementById('payrollTable').innerHTML = filtered.map(p => {
                const s = staff.find(st => st.id === p.staffId);
                const net = p.salary - p.deductions - p.tax - p.uif;
                return `
                    <tr>
                        <td>${p.id}</td>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${p.month}</td>
                        <td>R${p.salary.toFixed(2)}</td>
                        <td>R${p.deductions.toFixed(2)}</td>
                        <td>R${p.tax.toFixed(2)}</td>
                        <td>R${p.uif.toFixed(2)}</td>
                        <td>R${net.toFixed(2)}</td>
                        <td>
                            <button class="btn btn-sm btn-info me-1" onclick="showAddPayrollModal(${p.id})">Edit</button>
                            <button class="btn btn-sm btn-success" onclick="viewPayslip(${p.id})">Payslip</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function viewPayslip(id) {
            const payroll = payrolls.find(p => p.id === id);
            if (payroll) {
                const s = staff.find(st => st.id === payroll.staffId);
                document.getElementById('payslipStaff').textContent = s ? s.name : 'Unknown';
                document.getElementById('payslipPeriod').textContent = payroll.month;
                document.getElementById('payslipSalary').textContent = 'R' + payroll.salary.toFixed(2);
                document.getElementById('payslipDeductions').textContent = 'R' + payroll.deductions.toFixed(2);
                document.getElementById('payslipTax').textContent = 'R' + payroll.tax.toFixed(2);
                document.getElementById('payslipUIF').textContent = 'R' + payroll.uif.toFixed(2);
                const net = payroll.salary - payroll.deductions - payroll.tax - payroll.uif;
                document.getElementById('payslipNet').textContent = 'R' + net.toFixed(2);
                document.getElementById('payslipTaxNumber').innerHTML = `<strong>Tax Number:</strong> ${s ? s.taxNumber : 'N/A'}`;
                new bootstrap.Modal(document.getElementById('payslipModal')).show();
            }
        }

        function downloadPayslipPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const element = document.querySelector('.payslip-preview');
            doc.html(element, {
                callback: function (doc) {
                    doc.save(`payslip_${new Date().toISOString().slice(0,10)}.pdf`);
                },
                x: 10,
                y: 10,
                width: 190,
                windowWidth: 800
            });
        }

        function syncStaffBiometric() {
            alert('Biometric sync for staff completed (demo)');
        }

        function generateStaffReport() {
            exportToExcel(staff, 'staff_report');
        }

        // Leaves functions
        function showAddLeaveModal(editId = null) {
            editingLeave = editId ? leaveRequests.find(l => l.id === editId) : null;
            document.getElementById('leaveModalTitle').textContent = editingLeave ? 'Edit Leave' : 'Add Leave';
            populateStaffSelect(document.getElementById('leaveStaff'), staff);
            if (editingLeave) {
                document.getElementById('leaveStaff').value = editingLeave.staffId;
                document.getElementById('leaveDate').value = editingLeave.date;
                document.getElementById('leaveType').value = editingLeave.type;
                document.getElementById('leaveReason').value = editingLeave.reason;
                document.getElementById('leaveDays').value = editingLeave.days;
            }
            new bootstrap.Modal(document.getElementById('addLeaveModal')).show();
        }

        function saveLeave() {
            const staffId = parseInt(document.getElementById('leaveStaff').value);
            const date = document.getElementById('leaveDate').value;
            const type = document.getElementById('leaveType').value;
            const reason = document.getElementById('leaveReason').value.trim();
            const days = parseInt(document.getElementById('leaveDays').value) || 1;
            if (!staffId || !date || !reason || days < 1) return alert('Please fill required fields');
            if (editingLeave) {
                editingLeave.staffId = staffId;
                editingLeave.date = date;
                editingLeave.type = type;
                editingLeave.reason = reason;
                editingLeave.days = days;
            } else {
                leaveRequests.push({ id: Date.now(), staffId, date, type, reason, days, status: 'Pending', balance: 0 });
            }
            saveData();
            renderLeaves();
            bootstrap.Modal.getInstance(document.getElementById('addLeaveModal')).hide();
            logAudit('Leave Request ' + (editingLeave ? 'Updated' : 'Added'), reason);
            editingLeave = null;
        }

        function loadLeaveRequests() {
            renderLeaves();
        }

        function renderLeaves() {
            const date = document.getElementById('leaveDateFilter').value;
            let filtered = leaveRequests.filter(l => !date || l.date === date);
            const pending = filtered.filter(l => l.status === 'Pending').length;
            const approved = filtered.filter(l => l.status === 'Approved').length;
            const rejected = filtered.filter(l => l.status === 'Rejected').length;
            const avgBalance = staff.reduce((sum, s) => sum + (s.currentBalance || hrSettings.annualLeaveDays), 0) / staff.length || 0;
            document.getElementById('pendingLeaves').textContent = pending;
            document.getElementById('approvedLeaves').textContent = approved;
            document.getElementById('rejectedLeaves').textContent = rejected;
            document.getElementById('avgLeaveBalance').textContent = avgBalance.toFixed(0) + ' days';
            document.getElementById('leaveTable').innerHTML = filtered.map(l => {
                const s = staff.find(st => st.id === l.staffId);
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${l.date}</td>
                        <td>${l.type}</td>
                        <td>${l.reason}</td>
                        <td><span class="badge bg-${l.status === 'Approved' ? 'success' : l.status === 'Rejected' ? 'danger' : 'warning'}">${l.status}</span></td>
                        <td>${l.balance || 0}</td>
                        <td><button class="btn btn-sm btn-info" onclick="showLeaveStatusModal(${l.id})">Update Status</button></td>
                    </tr>
                `;
            }).join('');
        }

        function showLeaveStatusModal(id) {
            editingLeaveId = id; // Temp var for status update
            document.getElementById('leaveStatus').value = leaveRequests.find(l => l.id === id)?.status || 'Pending';
            document.getElementById('leaveComments').value = '';
            new bootstrap.Modal(document.getElementById('leaveStatusModal')).show();
        }

        let editingLeaveId = null; // Temp for status

        function saveLeaveStatus() {
            const status = document.getElementById('leaveStatus').value;
            const comments = document.getElementById('leaveComments').value.trim();
            if (editingLeaveId) {
                const leave = leaveRequests.find(l => l.id === editingLeaveId);
                if (leave) {
                    leave.status = status;
                    leave.comments = comments;
                    if (status === 'Approved') {
                        const s = staff.find(st => st.id === leave.staffId);
                        if (s) {
                            s.currentBalance = (s.currentBalance || hrSettings.annualLeaveDays) - leave.days;
                        }
                    }
                    saveData();
                    renderLeaves();
                    logAudit(`Leave ${status}`, leave.reason, status === 'Rejected' ? 'Medium' : 'Low');
                }
            }
            bootstrap.Modal.getInstance(document.getElementById('leaveStatusModal')).hide();
            editingLeaveId = null;
        }

        function viewLeaveCalendar() {
            alert('Leave calendar view (implement FullCalendar integration)');
            document.getElementById('leaveCalendar').innerHTML = '<div class="leave-calendar">Demo Calendar: No leaves today</div>';
            document.getElementById('leaveCalendar').classList.remove('d-none');
        }

        // Performance functions
        function showAddReviewModal(editId = null) {
            editingReview = editId ? performanceReviews.find(r => r.id === editId) : null;
            document.getElementById('reviewModalTitle').textContent = editingReview ? 'Edit Review' : 'Add Review';
            populateStaffSelect(document.getElementById('reviewStaff'), staff);
            if (editingReview) {
                document.getElementById('reviewStaff').value = editingReview.staffId;
                document.getElementById('reviewDate').value = editingReview.date;
                document.getElementById('reviewScore').value = editingReview.score;
                document.getElementById('reviewComments').value = editingReview.comments;
            }
            // Goals list
            const goalsList = document.getElementById('goalsList');
            goalsList.innerHTML = (editingReview?.goals || []).map(g => `
                <div class="d-flex justify-content-between mb-1">
                    <span>${g.description} (${g.status})</span>
                    <button class="btn btn-sm btn-danger" onclick="removeGoal(${g.id})">Remove</button>
                </div>
            `).join('');
            new bootstrap.Modal(document.getElementById('addReviewModal')).show();
        }

        function addGoal() {
            new bootstrap.Modal(document.getElementById('addGoalModal')).show();
        }

        function saveGoal() {
            const description = document.getElementById('goalDescription').value.trim();
            const targetDate = document.getElementById('goalTargetDate').value;
            const status = document.getElementById('goalStatus').value;
            if (description) {
                const goalsList = document.getElementById('goalsList');
                const goalId = Date.now();
                goalsList.innerHTML += `
                    <div class="d-flex justify-content-between mb-1 goal-item" data-id="${goalId}" data-desc="${description}" data-date="${targetDate}" data-status="${status}">
                        <span>${description} - Target: ${targetDate || 'N/A'} (${status})</span>
                        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove();">Remove</button>
                    </div>
                `;
                document.getElementById('goalDescription').value = '';
                document.getElementById('goalTargetDate').value = '';
                document.getElementById('goalStatus').value = 'Pending';
            }
            bootstrap.Modal.getInstance(document.getElementById('addGoalModal')).hide();
        }

        function saveReview() {
            const staffId = parseInt(document.getElementById('reviewStaff').value);
            const date = document.getElementById('reviewDate').value;
            const score = parseFloat(document.getElementById('reviewScore').value) || 0;
            const comments = document.getElementById('reviewComments').value.trim();
            const goals = Array.from(document.querySelectorAll('.goal-item')).map(el => ({
                id: parseInt(el.dataset.id),
                description: el.dataset.desc,
                targetDate: el.dataset.date,
                status: el.dataset.status
            }));
            if (!staffId || !date || score < 0 || score > 100) return alert('Please fill required fields (score 0-100)');
            if (editingReview) {
                editingReview.staffId = staffId;
                editingReview.date = date;
                editingReview.score = score;
                editingReview.comments = comments;
                editingReview.goals = goals;
            } else {
                performanceReviews.push({ id: Date.now(), staffId, date, score, comments, goals });
            }
            saveData();
            renderReviews();
            bootstrap.Modal.getInstance(document.getElementById('addReviewModal')).hide();
            logAudit('Performance Review ' + (editingReview ? 'Updated' : 'Added'), comments);
            editingReview = null;
        }

        function showGoalSettingModal() {
            alert('Goal setting modal (integrate with reviews)');
        }

        function generatePerformanceReport() {
            exportToExcel(performanceReviews, 'performance_reviews');
        }

        function renderReviews() {
            const searchTerm = document.getElementById('reviewSearch').value.toLowerCase();
            let filtered = performanceReviews.filter(r => staff.find(s => s.id === r.staffId)?.name.toLowerCase().includes(searchTerm));
            const avgScore = filtered.reduce((sum, r) => sum + r.score, 0) / filtered.length || 0;
            const total = filtered.length;
            const goalsAchieved = filtered.reduce((sum, r) => sum + (r.goals?.filter(g => g.status === 'Achieved').length || 0), 0);
            const feedbackPending = filtered.filter(r => !r.comments).length;
            document.getElementById('avgScore').textContent = avgScore.toFixed(1);
            document.getElementById('totalReviews').textContent = total;
            document.getElementById('goalsAchieved').textContent = goalsAchieved;
            document.getElementById('feedbackPending').textContent = feedbackPending;
            document.getElementById('reviewTable').innerHTML = filtered.map(r => {
                const s = staff.find(st => st.id === r.staffId);
                const achieved = r.goals ? r.goals.filter(g => g.status === 'Achieved').length : 0;
                const totalGoals = r.goals ? r.goals.length : 0;
                return `
                    <tr>
                        <td>${s ? s.name : 'Unknown'}</td>
                        <td>${r.date}</td>
                        <td>${r.score}</td>
                        <td>${achieved}/${totalGoals}</td>
                        <td>${r.comments || 'N/A'}</td>
                        <td><button class="btn btn-sm btn-info" onclick="showAddReviewModal(${r.id})">Edit</button></td>
                    </tr>
                `;
            }).join('');
            // Chart
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChart) performanceChart.destroy();
            performanceChart = new Chart(ctx, {
                type: 'radar',
                data: { 
                    labels: ['Avg Score', 'Total Reviews', 'Goals Achieved', 'Pending Feedback'],
                    datasets: [{ 
                        data: [avgScore, total, goalsAchieved, feedbackPending], 
                        backgroundColor: 'rgba(54, 162, 235, 0.2)',
                        borderColor: 'rgba(54, 162, 235, 1)'
                    }] 
                }
            });
        }

        // Recruitment functions
        function showAddJobModal(editId = null) {
            editingJob = editId ? jobs.find(j => j.id === editId) : null;
            document.getElementById('jobModalTitle').textContent = editingJob ? 'Edit Job' : 'Add Job';
            if (editingJob) {
                document.getElementById('jobTitle').value = editingJob.title;
                document.getElementById('jobDepartment').value = editingJob.department;
                document.getElementById('jobDescription').value = editingJob.description;
                document.getElementById('jobStatus').value = editingJob.status;
            }
            new bootstrap.Modal(document.getElementById('addJobModal')).show();
        }

        function saveJob() {
            const title = document.getElementById('jobTitle').value.trim();
            const department = document.getElementById('jobDepartment').value;
            const description = document.getElementById('jobDescription').value.trim();
            const status = document.getElementById('jobStatus').value;
            if (!title || !description) return alert('Title and description required');
            if (editingJob) {
                editingJob.title = title;
                editingJob.department = department;
                editingJob.description = description;
                editingJob.status = status;
            } else {
                jobs.push({ id: Date.now(), title, department, description, status, applications: [] });
            }
            saveData();
            renderJobs();
            bootstrap.Modal.getInstance(document.getElementById('addJobModal')).hide();
            logAudit('Job ' + (editingJob ? 'Updated' : 'Added'), title);
            editingJob = null;
        }

        function showApplyJobModal() {
            populateJobSelect();
            new bootstrap.Modal(document.getElementById('applyJobModal')).show();
        }

        function populateJobSelect() {
            document.getElementById('applyJobSelect').innerHTML = '<option value="">Select Position</option>' + 
                jobs.filter(j => j.status === 'Open').map(j => `<option value="${j.id}">${j.title} - ${j.department}</option>`).join('');
        }

        function submitApplication() {
            const jobId = parseInt(document.getElementById('applyJobSelect').value);
            const name = document.getElementById('applicantName').value.trim();
            const email = document.getElementById('applicantEmail').value.trim();
            const phone = document.getElementById('applicantPhone').value;
            const coverLetter = document.getElementById('applicantCoverLetter').value.trim();
            if (!jobId || !name || !email) return alert('Please fill required fields');
            const job = jobs.find(j => j.id === jobId);
            if (job) {
                const app = { 
                    id: Date.now(), 
                    name, 
                    email, 
                    phone, 
                    coverLetter, 
                    stage: 'Applied', 
                    resume: document.getElementById('applicantResume').files[0]?.name || 'No resume' 
                };
                job.applications.push(app);
                saveData();
                renderJobs();
                alert('Application submitted successfully!');
                bootstrap.Modal.getInstance(document.getElementById('applyJobModal')).hide();
            }
        }

        function renderJobs() {
            const searchTerm = document.getElementById('jobSearch').value.toLowerCase();
            let filtered = jobs.filter(j => j.title.toLowerCase().includes(searchTerm));
            const open = filtered.filter(j => j.status === 'Open').length;
            const totalApps = filtered.reduce((sum, j) => sum + (j.applications?.length || 0), 0);
            const interviews = filtered.reduce((sum, j) => sum + (j.applications?.filter(a => a.stage === 'Interview').length || 0), 0);
            const hireRate = totalApps ? (filtered.reduce((sum, j) => sum + (j.applications?.filter(a => a.stage === 'Hired').length || 0), 0) / totalApps * 100).toFixed(0) : 0;
            document.getElementById('openPositions').textContent = open;
            document.getElementById('totalApplications').textContent = totalApps;
            document.getElementById('interviewsScheduled').textContent = interviews;
            document.getElementById('hireRate').textContent = hireRate + '%';
            document.getElementById('jobTable').innerHTML = filtered.map(j => `
                <tr>
                    <td>${j.id}</td>
                    <td>${j.title}</td>
                    <td>${j.department || 'N/A'}</td>
                    <td>${j.applications ? j.applications.length : 0}</td>
                    <td><span class="badge bg-${j.status === 'Open' ? 'success' : 'secondary'}">${j.status}</span></td>
                    <td><button class="btn btn-sm btn-info" onclick="viewJobApplications(${j.id})">View Applications</button></td>
                </tr>
            `).join('');
        }

        function viewJobApplications(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (job && job.applications) {
                let appsHtml = job.applications.map(a => `
                    <div class="border p-2 mb-2">
                        <strong>${a.name}</strong> (${a.email})<br>
                        Stage: <span class="applicant-stage badge bg-info" onclick="updateAppStage(${a.id}, '${jobId}')">${a.stage}</span><br>
                        ${a.coverLetter ? `Cover: ${a.coverLetter.substring(0, 50)}...` : ''}<br>
                        ${a.stage === 'Applied' ? `<button class="btn btn-sm btn-success mt-1" onclick="scheduleInterviewForApp('${a.id}', '${jobId}')">Schedule Interview</button>` : ''}
                    </div>
                `).join('');
                if (!appsHtml) appsHtml = '<p>No applications yet.</p>';
                document.getElementById('notificationContent').innerHTML = `<h6>Applications for ${job.title}</h6>${appsHtml}`;
                new bootstrap.Modal(document.getElementById('notificationsModal')).show(); // Reuse modal for demo
            }
        }

        function updateAppStage(appId, jobId) {
            const stages = ['Applied', 'Screened', 'Interview', 'Offer', 'Hired'];
            const currentStage = jobs.find(j => j.id === parseInt(jobId))?.applications.find(a => a.id === appId)?.stage || 'Applied';
            const newStage = prompt(`Current: ${currentStage}\nNew stage (${stages.join(', ')}):`);
            if (stages.includes(newStage)) {
                const job = jobs.find(j => j.id === parseInt(jobId));
                const app = job.applications.find(a => a.id === appId);
                if (app) {
                    app.stage = newStage;
                    saveData();
                    renderJobs();
                    alert('Stage updated to ' + newStage);
                }
            }
        }

        function scheduleInterviewForApp(appId, jobId) {
            // Set applicant name for modal
            const job = jobs.find(j => j.id === parseInt(jobId));
            const app = job.applications.find(a => a.id === appId);
            if (app) {
                document.getElementById('interviewApplicant').value = app.name;
                // Show modal with prefilled
                new bootstrap.Modal(document.getElementById('scheduleInterviewModal')).show();
            }
        }

        function saveInterview() {
            const applicant = document.getElementById('interviewApplicant').value;
            const dateTime = document.getElementById('interviewDateTime').value;
            const type = document.getElementById('interviewType').value;
            const notes = document.getElementById('interviewNotes').value;
            if (applicant && dateTime) {
                alert(`Interview scheduled for ${applicant} on ${dateTime} (${type})\nNotes: ${notes}`);
                bootstrap.Modal.getInstance(document.getElementById('scheduleInterviewModal')).hide();
            } else {
                alert('Date and time required');
            }
        }

        function generateRecruitmentReport() {
            exportToExcel(jobs, 'recruitment_report');
        }

        // Audit functions
        function logAudit(action, details, risk = 'Low', complianceIssue = false) {
            if (!currentUser) return;
            auditLog.unshift({ 
                id: Date.now(), 
                timestamp: new Date().toISOString(), 
                user: currentUser.name, 
                action, 
                details, 
                risk, 
                complianceIssue 
            });
            if (auditLog.length > 1000) auditLog = auditLog.slice(0, 1000); // Limit size
            saveData();
        }

        function renderAudit() {
            const date = document.getElementById('auditDateFilter').value;
            const actionFilter = document.getElementById('auditActionFilter').value;
            let filtered = auditLog.filter(a => 
                (!date || a.timestamp.startsWith(date)) && 
                (!actionFilter || a.action.includes(actionFilter))
            );
            const total = filtered.length;
            const today = filtered.filter(a => new Date(a.timestamp).toDateString() === new Date().toDateString()).length;
            const highRisk = filtered.filter(a => a.risk === 'High').length;
            const complianceIssues = filtered.filter(a => a.complianceIssue).length;
            document.getElementById('totalAudit').textContent = total;
            document.getElementById('todayAudit').textContent = today;
            document.getElementById('highRiskAudit').textContent = highRisk;
            document.getElementById('complianceIssues').textContent = complianceIssues;
            document.getElementById('auditTable').innerHTML = filtered.slice(0, 50).map(a => `
                <tr>
                    <td>${new Date(a.timestamp).toLocaleString()}</td>
                    <td>${a.user}</td>
                    <td>${a.action}</td>
                    <td>${a.details}</td>
                    <td><span class="badge bg-${a.risk === 'High' ? 'danger' : a.risk === 'Medium' ? 'warning' : 'success'}">${a.risk}</span></td>
                </tr>
            `).join('');
        }

        function exportAuditToExcel() {
            exportToExcel(auditLog, 'audit_log');
        }

        function generateAuditReport() {
            alert('Audit report generated (export includes details)');
            exportAuditToExcel();
        }

        // HR render aggregator
        function renderHR() {
            renderStaff();
            renderPayrolls();
            renderLeaves();
            renderReviews();
            renderJobs();
            renderAudit();
        }

        // Demo data on first load
        if (localStorage.getItem('students') === null) {
            students = Array.from({length: 50}, (_, i) => ({ 
                id: i+1, 
                name: `Student ${i+1}`, 
                grade: `Grade ${Math.floor(i/5)+1}`, 
                parent: `Parent ${i+1}`, 
                status: 'Active' 
            }));
            staff = [
                { id: 1, name: 'John Doe', role: 'Teacher', department: 'Mathematics', salary: 35000, taxNumber: '123456789', uifNumber: 'UIF001', status: 'Active', certifications: [{id:1, name:'PGCE', expiry:'2026-06-01'}], currentBalance: 21, age: 35 },
                { id: 2, name: 'Jane Smith', role: 'Admin', department: 'HR', salary: 28000, taxNumber: '987654321', uifNumber: 'UIF002', status: 'Active', certifications: [], currentBalance: 21, age: 42 },
                { id: 3, name: 'Bob Johnson', role: 'Support', department: 'IT', salary: 25000, taxNumber: '456789123', uifNumber: 'UIF003', status: 'Active', certifications: [{id:2, name:'CompTIA', expiry:'2025-12-01'}], currentBalance: 21, age: 28 }
            ];
            // Add demo payrolls, leaves, etc.
            payrolls = staff.map(s => ({ 
                id: Date.now() + s.id, 
                staffId: s.id, 
                month: '2025-11', 
                salary: s.salary, 
                deductions: 500, 
                tax: calculatePAYE(s.salary), 
                uif: Math.min(s.salary * uifRate, 177.12) 
            }));
            leaveRequests = [{ id: 1, staffId: 1, date: '2025-11-20', type: 'Annual', reason: 'Vacation', days: 5, status: 'Pending' }];
            performanceReviews = [{ id: 1, staffId: 1, date: '2025-10-01', score: 85, comments: 'Good performance', goals: [{id:1, description: 'Complete training', status: 'Achieved'}] }];
            jobs = [{ id: 1, title: 'Math Teacher', department: 'Education', description: 'Teach grades 8-12', status: 'Open', applications: [] }];
            saveData();
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', () => {
            // Dark mode
            const darkMode = localStorage.getItem('darkMode') === 'true';
            if (document.getElementById('darkModeSwitch')) document.getElementById('darkModeSwitch').checked = darkMode;
            toggleDarkMode(darkMode);
            // Defaults
            document.getElementById('attendanceDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('payrollMonthFilter').value = new Date().toISOString().slice(0, 7);
            document.getElementById('leaveDateFilter').value = '';
            document.getElementById('auditDateFilter').value = '';
            // Notification modal handler
            document.querySelector('[data-bs-target="#notificationsModal"]').addEventListener('click', () => {
                document.getElementById('notificationContent').innerHTML = '<p>Demo notifications: 3 unread messages and 1 fee reminder.</p>';
            });
        });

        // Polyfill for older browsers if needed, but assume modern
    </script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
